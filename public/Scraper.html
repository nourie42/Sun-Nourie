<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gas Station Prospector (UNDER CONSTRUCTION)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .spinner { border-top-color: #7c3aed; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex flex-col items-center">
  <div class="bg-white rounded-3xl shadow-2xl overflow-hidden max-w-7xl w-full">
    <div class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white p-8 text-center">
      <h1 class="text-4xl font-bold mb-2">‚õΩ Gas Station Prospector (UNDER CONSTRUCTION)</h1>
      <p class="text-lg opacity-90">Find and analyze branded and unbranded gas station opportunities</p>
    </div>

    <div class="flex justify-between items-center p-4">
      <button id="refreshBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">üîÑ Refresh</button>
    </div>

    <div class="md:flex">
      <!-- Sidebar -->
      <div class="md:w-1/3 bg-gray-50 p-6 border-r border-gray-200">
        <div class="mb-6">
          <label class="block font-semibold text-gray-800 mb-3">Search Type</label>
          <div class="space-y-3">
            <label class="flex items-start p-4 bg-white rounded-xl shadow-sm border cursor-pointer">
              <input type="radio" name="searchType" value="branded" checked class="mt-1" />
              <div class="ml-3"><strong>Branded Sites</strong></div>
            </label>
            <label class="flex items-start p-4 bg-white rounded-xl shadow-sm border cursor-pointer">
              <input type="radio" name="searchType" value="unbranded" class="mt-1" />
              <div class="ml-3"><strong>Unbranded Sites</strong></div>
            </label>
          </div>
        </div>

        <div class="mb-6">
          <label class="block font-semibold text-gray-800 mb-3">Search Method</label>
          <div class="space-y-3">
            <label class="flex items-start p-4 bg-white rounded-xl shadow-sm border cursor-pointer">
              <input type="radio" name="inputMethod" value="area" checked class="mt-1" />
              <div class="ml-3"><strong>Area Search</strong></div>
            </label>
            <label class="flex items-start p-4 bg-white rounded-xl shadow-sm border cursor-pointer">
              <input type="radio" name="inputMethod" value="upload" class="mt-1" />
              <div class="ml-3"><strong>Upload List (CSV/XLSX/XLS)</strong> ‚Äî uses <em>column B</em> for addresses</div>
            </label>
          </div>
        </div>

        <div id="areaSearchInputs" class="space-y-4">
          <input type="text" id="locationInput" placeholder="Enter city or address" class="w-full p-3 border-2 border-gray-300 rounded-lg" />
          <input type="number" id="radiusInput" value="5" min="1" max="50" class="w-full p-3 border-2 border-gray-300 rounded-lg" />
        </div>

        <div id="uploadInputs" class="space-y-4 hidden">
          <input id="fileInput" type="file" accept=".csv,.xlsx,.xls" class="w-full" />
        </div>

        <button id="searchBtn" class="w-full mt-8 p-4 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-xl font-bold text-lg" disabled>üîç Start Prospecting</button>
      </div>

      <!-- Results Panel -->
      <div class="md:w-2/3 p-6 relative">
        <div id="loadingOverlay" class="absolute inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-10 hidden">
          <div class="spinner w-16 h-16 border-4 border-gray-200 rounded-full"></div>
          <div class="mt-4 text-xl font-medium text-gray-700">Working...</div>
          <div id="progressInfo" class="mt-1 text-sm text-gray-500"></div>
        </div>

        <div id="resultsContent">
          <div class="flex items-center justify-between pb-4 border-b border-gray-200 mb-4">
            <div id="resultsCount" class="text-2xl font-bold text-gray-800">No results yet</div>
            <div class="flex gap-2">
              <button id="exportBtn" class="bg-green-500 text-white py-2 px-4 rounded-lg hidden">üì• Export</button>
            </div>
          </div>
          <!-- CHANGED: removed max-h and overflow so results fill right side fully -->
          <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Map BELOW all results/list -->
  <div id="map" class="w-full h-48 mt-4 border rounded-lg"></div>

  <script>
    // Keys (embedded per your request)
    const GOOGLE_MAPS_API_KEY = 'AIzaSyBKkUjhXbYeIA3jDMxvS8fExTlcPMIchs8';
    const OPENAI_API_KEY = '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';

    let map, placesService, geocoder;
    let currentResults = [];
    let markers = [];

    const PRIORITY_BRANDS = ['Marathon','Citgo','Valero','Exxon','BP','Shell'];
    const EXCLUDED_CHAINS = ['Sheetz','Wawa','RaceTrac','Race Trac','Circle K','7-Eleven','7-11','Cumberland Farms','QuikTrip','QT','Speedway','Casey','Murphy','Murphy USA','Sunoco','GetGo','Pilot','Flying J','Love','Love\'s','Travel Centers','TA','Petro','Costco','Sam\'s Club','BJ\'s','Kroger','Albertsons','Safeway','H-E-B','Walmart'];

    // Load Google Maps
    (function loadGoogleMapsAPI(){
      const s=document.createElement('script');
      s.src=`https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&callback=initMap`;
      s.async=true; s.defer=true; document.head.appendChild(s);
    })();

    window.initMap = () => {
      map = new google.maps.Map(document.getElementById('map'), { center: { lat: 35.7796, lng: -78.6382 }, zoom: 8 });
      placesService = new google.maps.places.PlacesService(map);
      geocoder = new google.maps.Geocoder();
      document.getElementById('searchBtn').disabled = false;
    };

    document.getElementById('refreshBtn').onclick = () => window.location.reload();
    document.querySelectorAll('input[name="inputMethod"]').forEach(r => {
      r.addEventListener('change', () => {
        const isUpload = r.value === 'upload';
        document.getElementById('areaSearchInputs').classList.toggle('hidden', isUpload);
        document.getElementById('uploadInputs').classList.toggle('hidden', !isUpload);
      });
    });

    const ui = {
      overlay: document.getElementById('loadingOverlay'),
      progress: document.getElementById('progressInfo'),
      resultsCount: document.getElementById('resultsCount'),
      resultsGrid: document.getElementById('resultsGrid'),
      exportBtn: document.getElementById('exportBtn')
    };

    document.getElementById('searchBtn').onclick = startSearch;

    async function startSearch(){
      const searchType = document.querySelector('input[name="searchType"]:checked').value;
      const method = document.querySelector('input[name="inputMethod"]:checked').value;
      ui.overlay.classList.remove('hidden');
      ui.progress.textContent = 'Starting...';
      try {
        if (method === 'upload') {
          const file = document.getElementById('fileInput').files?.[0];
          if (!file) { alert('Please select a file'); return; }
          await searchByUpload(file, searchType);
        } else {
          const location = document.getElementById('locationInput').value.trim();
          const radius = parseFloat(document.getElementById('radiusInput').value) || 5;
          if (!location) { alert('Enter a location'); return; }
          await searchByArea(location, radius, searchType);
        }
      } finally { ui.overlay.classList.add('hidden'); }
    }

    // === Area search ===
    function searchByArea(location, radiusMiles, searchType){
      return new Promise((resolve) => {
        ui.progress.textContent = 'Geocoding area...';
        geocoder.geocode({ address: location }, (results, status) => {
          if (status !== 'OK' || !results?.[0]) { alert('Location not found'); return resolve(); }
          const center = results[0].geometry.location; map.setCenter(center); map.setZoom(12);
          ui.progress.textContent = 'Searching gas stations...';
          const req = { location: center, radius: radiusMiles * 1609.34, type: 'gas_station' };
          placesService.nearbySearch(req, async (places, s) => {
            if (s === google.maps.places.PlacesServiceStatus.OK && places?.length) {
              await processResults(places, searchType);
            } else { alert('No stations found around this area.'); }
            resolve();
          });
        });
      });
    }

    // === Upload helpers (column B addresses) ===
    function readAddressesFromCSV(text){
      return text.split(/\r?\n/).map(l => l.trim()).filter(Boolean).slice(1)
        .map(line => line.split(',')[1] ? line.split(',')[1].replace(/\"/g,'').trim() : '').filter(Boolean);
    }
    async function readAddressesFromExcel(file){
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type: 'array' });
      const firstSheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
      return rows.slice(1).map(r => (r?.[1] || '').toString().trim()).filter(Boolean);
    }

    async function searchByUpload(file, searchType){
      ui.progress.textContent = 'Reading file...';
      let addresses = [];
      const name = file.name.toLowerCase();
      if (name.endsWith('.csv')) addresses = readAddressesFromCSV(await file.text());
      else if (name.endsWith('.xlsx') || name.endsWith('.xls')) addresses = await readAddressesFromExcel(file);
      if (!addresses.length) { alert('No valid addresses in column B'); return; }

      const allPlaces = [];
      for (let i = 0; i < addresses.length; i++) {
        ui.progress.textContent = `Geocoding ${i + 1} / ${addresses.length}...`;
        // eslint-disable-next-line no-await-in-loop
        await new Promise(res => {
          geocoder.geocode({ address: addresses[i] }, (results, status) => {
            if (status === 'OK' && results?.[0]) {
              const center = results[0].geometry.location;
              const req = { location: center, radius: 1609.34, type: 'gas_station' };
              placesService.nearbySearch(req, (places, s) => {
                if (s === google.maps.places.PlacesServiceStatus.OK) allPlaces.push(...places);
                res();
              });
            } else res();
          });
        });
        // eslint-disable-next-line no-await-in-loop
        await new Promise(r => setTimeout(r, 200));
      }
      if (!allPlaces.length) { alert('No stations found near uploaded addresses'); return; }
      await processResults(allPlaces, searchType);
    }

    // === GPT image scoring ===
    async function analyzeWithChatGPTImage(item){
      const system = `You are an expert visual inspector of gas-station PHOTOS. Return STRICT JSON: {\\"score\\": int 1..10, \\"reason\\": string <= 140 chars}. Score ONLY what you SEE. BRANDED: older-looking equipment => HIGHER score. UNBRANDED: newer-looking equipment => HIGHER score.`;
      const userText = `Context: name=${item.name}; brand=${item.brand}; is_unbranded=${item.isUnbranded}; address=${item.address}. Analyze the attached photo per rules.`;
      const payload = {
        model: 'gpt-4o-mini',
        response_format: { type: 'json_object' },
        temperature: 0.2,
        messages: [
          { role: 'system', content: system },
          { role: 'user', content: [ { type: 'text', text: userText }, { type: 'image_url', image_url: { url: item.imageUrl } } ] }
        ]
      };
      try {
        const resp = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${OPENAI_API_KEY}` },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) throw new Error('OpenAI HTTP ' + resp.status);
        const data = await resp.json();
        const txt = data.choices?.[0]?.message?.content || '{}';
        const json = JSON.parse(txt);
        let score = parseInt(json.score, 10);
        if (!Number.isFinite(score)) score = 5;
        score = Math.min(10, Math.max(1, score));
        const reason = (json.reason || 'Image-based score').toString();
        return { score, reason };
      } catch(e){ return { score:5, reason:'Fallback error' }; }
    }

    async function processResults(places, searchType){
      ui.progress.textContent = 'Analyzing results...';
      const byId = {}; places.forEach(p => { byId[p.place_id] = p; });
      const uniq = Object.values(byId);

      const base = uniq.map(p => {
        const nameLc = (p.name || '').toLowerCase();
        let brand = 'Independent';
        for (const b of PRIORITY_BRANDS) if (nameLc.includes(b.toLowerCase())) brand = b;
        const excluded = EXCLUDED_CHAINS.some(ch => nameLc.includes(ch.toLowerCase()));
        const isUnbranded = (brand === 'Independent' && !excluded);
        const lat = p.geometry.location.lat();
        const lng = p.geometry.location.lng();
        const placesPhoto = p.photos && p.photos.length ? p.photos[0].getUrl({ maxWidth: 640, maxHeight: 480 }) : null;
        const streetViewFallback = `https://maps.googleapis.com/maps/api/streetview?size=640x480&location=${lat},${lng}&key=${GOOGLE_MAPS_API_KEY}`;
        const imageUrl = placesPhoto || streetViewFallback;
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.name)}&query_place_id=${p.place_id}`;
        return { id:p.place_id, name:p.name, address:p.vicinity||p.formatted_address||'‚Äî', lat,lng,brand,excluded,isUnbranded,imageUrl,mapsUrl };
      }).filter(item => searchType==='branded' ? item.brand!=='Independent'&&!item.excluded : item.isUnbranded);

      if (!base.length) { alert('No qualifying stations'); return; }

      const analyzed=[];
      for (let i=0;i<base.length;i++){
        const result = await analyzeWithChatGPTImage(base[i]);
        analyzed.push({ ...base[i], aiScore: result.score, aiReason: result.reason });
        ui.progress.textContent = `Scored ${i+1} / ${base.length}`;
        // gentle pacing
        await new Promise(r=>setTimeout(r,120));
      }

      currentResults = analyzed.sort((a,b)=>(b.aiScore||0)-(a.aiScore||0));
      renderResults();
    }

    function renderResults(){
      ui.resultsCount.textContent = `Found ${currentResults.length} Qualified Prospects`;
      ui.exportBtn.classList.toggle('hidden', currentResults.length === 0);

      // Cards
      ui.resultsGrid.innerHTML = currentResults.map(r=>`
        <div class="bg-white rounded-xl shadow overflow-hidden">
          <div class="relative w-full h-40 bg-gray-200">
            <img src="${r.imageUrl}" class="w-full h-full object-cover"/>
            ${r.brand !== 'Independent' ? `<span class="absolute top-2 right-2 bg-indigo-600 text-white text-xs px-2 py-1 rounded">${r.brand}</span>` : `<span class="absolute top-2 right-2 bg-emerald-600 text-white text-xs px-2 py-1 rounded">Unbranded</span>`}
          </div>
          <div class="p-4">
            <div class="text-sm text-gray-500">Score</div>
            <div class="flex items-center gap-2 text-lg font-bold">${r.aiScore ?? '‚Äî'} / 10 <span class="text-xs font-medium text-gray-500">${r.aiReason ? `‚Äî ${r.aiReason}` : ''}</span></div>
            <div class="mt-2 font-semibold text-gray-800">${r.name}</div>
            <div class="text-sm text-gray-600">${r.address}</div>
          </div>
        </div>`).join('');

      // Map markers below list
      if (typeof google !== 'undefined' && map) {
        // clear old markers
        markers.forEach(m=>m.setMap(null));
        markers = [];
        const bounds = new google.maps.LatLngBounds();
        currentResults.forEach(r => {
          const pos = { lat: r.lat, lng: r.lng };
          const marker = new google.maps.Marker({ position: pos, map, title: r.name });
          const info = new google.maps.InfoWindow({ content: `<strong>${r.name}</strong><br>${r.address}<br>Score: ${r.aiScore}/10` });
          marker.addListener('click', () => info.open(map, marker));
          markers.push(marker);
          bounds.extend(pos);
        });
        if (currentResults.length) map.fitBounds(bounds);
      }
    }

    // Export (CSV with reasons)
    ui.exportBtn.addEventListener('click', () => {
      if (!currentResults.length) return;
      let csv = 'Rank,Name,Brand,Unbranded,Address,Score,Reason,Latitude,Longitude,ImageURL,MapsURL\n';
      currentResults.forEach((r,i)=>{
        const row = [i+1, r.name, r.brand, r.isUnbranded, r.address, r.aiScore, r.aiReason, r.lat, r.lng, r.imageUrl, r.mapsUrl]
          .map(v => '"' + String(v ?? '').replaceAll('"','""') + '"').join(',');
        csv += row + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `gas_station_prospects_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
