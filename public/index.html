<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PA Roads with AADT (PennDOT + RMSS)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .legend { background: white; padding: 8px 10px; border-radius: 4px; line-height: 1.3; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
    .legend h4 { margin: 0 0 6px; font: 14px/1.2 sans-serif; }
    .legend div { font: 12px/1.2 sans-serif; }
    .topbar { position: absolute; z-index: 1000; top: 10px; left: 50px; background: rgba(255,255,255,0.95); padding: 6px 10px; border-radius: 4px; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
    .topbar label { font: 13px/1.2 sans-serif; margin-right: 6px; }
    .topbar select { font: 13px/1.2 sans-serif; }
  </style>
</head>
<body>
<div id="map"></div>
<div class="topbar">
  <label for="metric">Color by:</label>
  <select id="metric">
    <option value="CUR_AADT">PennDOT AADT (CUR_AADT)</option>
    <option value="RMSS_CUR_AADT_WAVG">RMSS AADT (weighted)</option>
    <option value="RMSS_ADTT_WAVG">RMSS Trucks/day (weighted)</option>
    <option value="RMSS_TRK_PCT_WAVG">RMSS Truck % (weighted)</option>
  </select>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script>
  // Basic map
  const map = L.map('map').setView([40.9, -77.7], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  // Address search (Nominatim via leaflet-control-geocoder)
  const geocoder = L.Control.geocoder({ defaultMarkGeocode: false }).on('markgeocode', function(e) {
    const center = e.geocode.center;
    L.marker(center).addTo(map);
    map.setView(center, 15);
    selectNearest(center.lat, center.lng);
  }).addTo(map);

  // Legend
  const legend = L.control({position:'bottomleft'});
  legend.onAdd = function() {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = '<h4>Segment color</h4><div id="legend-bins"></div>';
    return div;
  };
  legend.addTo(map);

  // Utility: color ramp
  function getColor(v, breaks) {
    if (v == null || isNaN(v)) return '#999999';
    for (let i = 0; i < breaks.length; i++) {
      if (v <= breaks[i]) return ['#f2f0f7','#cbc9e2','#9e9ac8','#756bb1','#54278f'][i];
    }
    return '#2c115f';
  }

  function updateLegend(breaks, label) {
    const el = document.getElementById('legend-bins');
    const labels = [];
    let prev = 0;
    for (let i=0; i<breaks.length; i++) {
      const from = i===0 ? 0 : breaks[i-1];
      const to = breaks[i];
      labels.push('<div><span style="display:inline-block;width:12px;height:12px;background:'+getColor(to,breaks)+';margin-right:6px;border:1px solid #888"></span>' +
                  from.toLocaleString() + '–' + to.toLocaleString() + '</div>');
    }
    labels.push('<div><span style="display:inline-block;width:12px;height:12px;background:'+getColor(breaks[breaks.length-1]+1,breaks)+';margin-right:6px;border:1px solid #888"></span>' +
                '>'+breaks[breaks.length-1].toLocaleString()+'</div>');
    el.innerHTML = '<div style="margin-bottom:6px;font-weight:600">'+label+'</div>' + labels.join('');
  }

  // Load GeoJSON (sample included; replace with full file when available)
  const DATA_URL = 'data/PA_Roads_with_AADT_sample.geojson';

  const layer = L.geoJSON(null, {
    style: { weight: 2, opacity: 1 },
    onEachFeature: function(feat, lyr) {
      const p = feat.properties || {};
      const html = `<b>${p.STREET_NAM || 'Unnamed'}</b><br/>
        PennDOT AADT: ${p.CUR_AADT ?? 'n/a'}<br/>
        RMSS AADT (weighted): ${p.RMSS_CUR_AADT_WAVG ?? 'n/a'}<br/>
        Trucks/day (weighted): ${p.RMSS_ADTT_WAVG ?? 'n/a'}<br/>
        Truck % (weighted): ${p.RMSS_TRK_PCT_WAVG ?? 'n/a'}<br/>
        Route: ${p.ST_RT_NO || ''}, County: ${p.CTY_CODE || ''}, NLF_ID: ${p.NLF_ID || ''}`;
      lyr.bindPopup(html);
    }
  }).addTo(map);

  let features = null;

  fetch(DATA_URL).then(r => r.json()).then(geo => {
    features = geo;
    layer.addData(geo);
    try { map.fitBounds(layer.getBounds(), {padding:[20,20]}); } catch(e) {}
    colorize(); // initial render
  });

  function computeBreaks(values) {
    values = values.filter(v => v != null && !isNaN(v)).sort((a,b)=>a-b);
    if (values.length === 0) return [0,1,2,3,4];
    const quantiles = [0.5, 0.7, 0.85, 0.95, 0.99];
    const breaks = quantiles.map(q => values[Math.floor(q * (values.length-1))]);
    return breaks;
  }

  function colorize() {
    const metric = document.getElementById('metric').value;
    const vals = [];
    layer.eachLayer(l => {
      const v = l.feature?.properties?.[metric];
      if (v != null && !isNaN(v)) vals.push(Number(v));
    });
    const breaks = computeBreaks(vals);
    updateLegend(breaks, metric);

    layer.setStyle(f => {
      const v = f.properties ? Number(f.properties[metric]) : null;
      return { color: getColor(v, breaks), weight: 2, opacity: 0.9 };
    });
  }

  document.getElementById('metric').addEventListener('change', colorize);

  // Snap to nearest road after geocoding
  function selectNearest(lat, lng) {
    if (!features) return;
    const pt = turf.point([lng, lat]);
    let best = {dist: Infinity, layer: null};
    layer.eachLayer(lyr => {
      const g = lyr.feature.geometry;
      if (g.type === 'MultiLineString') {
        for (const line of g.coordinates) {
          const ln = { type:'LineString', coordinates: line };
          const snap = turf.nearestPointOnLine(ln, pt);
          if (snap.properties.dist < best.dist) {
            best = {dist: snap.properties.dist, layer: lyr};
          }
        }
      }
    });
    if (best.layer) {
      best.layer.openPopup();
      map.fitBounds(best.layer.getBounds(), {maxZoom: 17});
    }
  }
</script>
</body>
</html>
