<!-- public/index.html — Fuel IQ UI (full file, updated as requested)
     Changes:
     - Move/resize primary Estimate button under AADT override (full-width).
     - Remove secondary "Run Estimate" button under the estimate card.
     - Autocomplete fully locks after a selection until the user deletes back before the committed text.
     - Main map draws AADT dots first, then competitors, and brings competitors to front.
     - Math & Assumptions now uses server breakdown (calc_breakdown) so it ALWAYS matches the estimate. Fallback kept only if server breakdown missing.
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sunoco, LP Fuel IQ - Fuel Site Analyzer</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>

  <style>
    :root { --bg:#0b0e15; --panel:#111725; --panel2:#0f1421; --line:#263145; --text:#eaeef7; --muted:#97a3b8; --brand:#0ea5e9; --brand2:#22d3ee; --pill:#0f1929; }
    *{ box-sizing:border-box; }
    body{ background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:0; padding-bottom:84px; }
    .wrap{ max-width:1120px; margin:24px auto; padding:0 16px; }
    header{ display:flex; align-items:center; gap:14px; margin-bottom:6px; }
    header h1{ font-size:28px; margin:0; letter-spacing:.2px; }
    .build{ margin-left:auto; font-size:12px; color:#8aa2c0; }
    .instructions{ margin:4px 0 12px; color:#cfe3ff; font-size:13px; }

    .card{ background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line); border-radius:12px; padding:16px; margin:12px 0; }
    label{ display:block; font-weight:600; margin:8px 0 6px; color:#d8e3f6; }
    input, select{ width:100%; padding:12px; border-radius:10px; border:1px solid var(--line); background:#0b1220; color:#eaeef7; }
    button{ background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#fff; border:0; padding:12px 16px; border-radius:10px; font-weight:700; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    /* align four inputs at same top level */
    .row{ display:grid; grid-template-columns:1.6fr 0.7fr 0.7fr 0.8fr; gap:12px; align-items:start; }
    @media (max-width:980px){ .row{ grid-template-columns:1fr; } }

    .toolbar{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:12px; }
    .muted{ color:var(--muted); }
    .subtle{ font-size:12px; opacity:.9; }

    #map,#aadtMap{ height:420px; border-radius:12px; border:1px solid var(--line); position: relative; }
    #overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(11,14,21,.55); border-radius:12px; font-weight:800; color:#cde9ff; font-size:18px; padding:20px; text-align:center; }

    #svWrap{ margin-top:10px; }
    #sv{ width:100%; height:380px; border:0; border-radius:12px; border:1px solid var(--line); background:#0b1220; }

    .ac-wrap{ position:relative; }
    .ac-list{ position:absolute; top:100%; left:0; right:0; z-index:30; margin-top:6px; background:#0b1220; border:1px solid var(--line); border-radius:12px; max-height:320px; overflow:auto; box-shadow: 0 18px 36px rgba(0,0,0,.35); }
    .ac-item{ padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,.04); }
    .ac-item:last-child{ border-bottom:0; }
    .ac-item:hover, .ac-item.active{ background:#101a2b; }
    .badge{ display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--line); background:var(--pill); color:#a9c5ff; margin-left:8px; }

    details summary{ cursor:pointer; }
    .adv-line{ display:flex; align-items:center; gap:16px; flex-wrap:wrap; margin-top:12px; }
    .chip{ display:inline-flex; align-items:center; gap:8px; background:#0f1929; border:1px solid var(--line); padding:8px 10px; border-radius:999px; font-size:13px; }
    .chip input{ width:auto; accent-color:#22d3ee; }
    .radio-row{ display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; }

    .hero{ display:flex; justify-content:space-between; align-items:flex-end; gap:12px; }
    .hero .num{ font-size:44px; font-weight:900; letter-spacing:.5px; }
    .hero .sub{ font-size:13px; color:#a9b6d0; }

    .footerbar{ position:fixed; left:0; right:0; bottom:0; background:linear-gradient(180deg,#0c1220,#0a0f1a); border-top:1px solid var(--line); padding:10px 16px; display:flex; justify-content:center; gap:12px; z-index:50; }

    .aadt-tabs { display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin:8px 0 12px; }
    .aadt-tab { display:inline-block; padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:var(--pill); color:#fff; text-decoration:none; font-weight:700; font-size:13px; letter-spacing:.2px; }
    .aadt-tab:hover { background:#101a2b; }

    /* STOP alert */
    .stop-alert { display:none; position:sticky; top:0; z-index:60; margin-bottom:12px; }
    .stop-inner { display:flex; align-items:center; gap:14px; padding:12px 14px; border-radius:12px; border:2px solid #b91c1c; background:linear-gradient(135deg,#7f1d1d,#991b1b); color:#fff; box-shadow:0 12px 24px rgba(0,0,0,.35); }
    .stop-sign { width:52px; height:52px; flex:0 0 52px; border-radius:12px; background:#dc2626; border:4px solid #fca5a5; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:14px; }

    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; border-bottom:1px solid rgba(255,255,255,.06); padding:8px 6px; }
    th { font-size:12px; color:#cfd8ea; }
    tr:hover { background: rgba(255,255,255,.03); }
    .small { font-size:12px; color:#a9b6d0; }

    /* Bigger, full-width primary button under AADT override */
    #go { width:100%; padding:16px; font-size:18px; margin-top:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Sunoco, LP Fuel IQ - Fuel Site Analyzer</h1>
      <span class="build">UI v2025‑09‑19</span>
      <a href="developments.html" style="padding:8px 14px; background:#22d3ee; border-radius:8px; color:#00121e; font-weight:600; text-decoration:none;">Developments Search</a>
      <a href="PA_Signals_AADT_Radius_Map_Final_Generated.html" style="padding:8px 14px; background:#f87171; border-radius:8px; color:#00121e; font-weight:600; text-decoration:none;">PA AADT Map</a>
      <a href="Scraper.html" style="padding:8px 14px; background:#34d399; border-radius:8px; color:#00121e; font-weight:600; text-decoration:none;">Prospector</a>
    </header>

    <!-- STOP banner -->
    <div id="stopBox" class="stop-alert">
      <div class="stop-inner">
        <div class="stop-sign">STOP</div>
        <div id="stopText" style="font-weight:800;">Major development identified.</div>
      </div>
    </div>

    <nav class="aadt-tabs" aria-label="State AADT Quick Links">
      <span class="muted">State AADT Quick Links:</span>
      <a class="aadt-tab" href="https://opendata.dc.gov/datasets/DCGIS::2023-traffic-volume/explore" target="_blank" rel="noopener noreferrer">DC</a>
      <a class="aadt-tab" href="https://gis-fdot.opendata.arcgis.com/datasets/fdot::annual-average-daily-traffic-tda/explore" target="_blank" rel="noopener noreferrer">FL</a>
      <a class="aadt-tab" href="https://gdottrafficdata.drakewell.com/publicmultinodemap.asp" target="_blank" rel="noopener noreferrer">GA</a>
      <a class="aadt-tab" href="https://mhd.public.ms2soft.com/tcds/tsearch.asp?loc=Mhd&mod" target="_blank" rel="noopener noreferrer">MA</a>
      <a class="aadt-tab" href="https://nysdottrafficdata.drakewell.com/publicmultinodemap.asp" target="_blank" rel="noopener noreferrer">NY</a>
      <a class="aadt-tab" href="https://scdottrafficdata.drakewell.com/publicmultinodemap.asp" target="_blank" rel="noopener noreferrer">SC</a>
      <a class="aadt-tab" href="https://www.arcgis.com/apps/webappviewer/index.html?id=35e4c06de0f84a9c9f3fe18e67cd2c92" target="_blank" rel="noopener noreferrer">VA</a>
      <a class="aadt-tab" href="https://ncdot.public.ms2soft.com/tdms.ui_core/trafficviewer" target="_blank" rel="noopener noreferrer">NC</a>
    </nav>

    <div class="instructions">
      <b>Instructions:</b> Enter Address, Click <i>Estimate</i>. Do not exit your browser or let your phone screen shut off until results are ready. Click <i>Advanced Options</i> to make changes.
    </div>

    <!-- Inputs -->
    <div class="card">
      <div class="row">
        <div>
          <label>Site search</label>
          <div class="ac-wrap">
            <input id="addr" placeholder="Enter business or address" autocomplete="off" />
            <div id="ac" class="ac-list" style="display:none;"></div>
          </div>
          <div class="muted subtle" style="margin-top:6px" id="apiStatus">API Status: checking…</div>
        </div>
        <div><label>Regular MPDs</label><input id="mpds" type="number" value="3" min="1"/></div>
        <div><label>Diesel MPDs</label><input id="diesel" type="number" value="0" min="0"/></div>
        <div><label>AADT override</label><input id="aadtOverride" type="number"/><button id="go">Estimate</button></div>
      </div>
      <div class="toolbar">
        <span class="muted">Baseline ceiling (AADT×2%×8×30) • competition rule • pricing effect • caps • road layout</span>
      </div>
    </div>

    <!-- Math & Assumptions (always visible) -->
    <div class="card" id="mathCard">
      <b>Math & Assumptions (always shown)</b>
      <div id="mathTable" class="small" style="margin-top:8px; line-height:1.6">—</div>
    </div>

    <!-- Advanced -->
    <div class="card">
      <details>
        <summary><b>Advanced options</b></summary>
        <div class="adv-line">
          <label class="chip"><input type="checkbox" id="ex_large_dev"> Large residential or commercial developments being built (+7.5%)</label>
          <label class="chip"><input type="checkbox" id="ex_hours18"> Operating hours 18h (−7.5%)</label>
          <label class="chip"><input type="checkbox" id="ex_highincome"> Higher-income trade area (+2.5%)</label>
          <label class="chip"><input type="checkbox" id="ex_lowrating"> Ratings below 4.0 / Poorly run site (−30%)</label>
          <label class="chip"><input type="checkbox" id="ex_competitive_pricing"> Competitive site gas pricing (+10%)</label>
          <label class="chip"><input type="checkbox" id="ex_rural"> Rural Location Bonus (No competition within 3 miles) (+30%)</label>
        </div>
        <div style="margin-top:8px;">
          <label><b>Gas pricing vs area</b></label>
          <div class="radio-row">
            <label class="chip"><input type="radio" name="pricepos" value="below"> Below competition (+10%)</label>
            <label class="chip"><input type="radio" name="pricepos" value="inline" checked> In line (0%)</label>
            <label class="chip"><input type="radio" name="pricepos" value="above"> Above competition (−10%)</label>
          </div>
        </div>
        <div class="adv-line">
          <span class="chip" id="addExtra" style="cursor:pointer;">+ Add adj. (%)</span>
          <span id="activeExtras" class="subtle"></span>
        </div>
        <div id="extraList" style="margin-top:8px;"></div>
      </details>
    </div>

    <!-- Estimate -->
    <div class="card" id="estimateCard">
      <div class="hero">
        <div>
          <div>Adjusted Base Estimate (LOW)</div>
          <div class="num" id="estNum">—</div>
          <div class="sub" id="estRange">Full range: —</div>
        </div>
        <div class="right sub">
          <div>Year-2: <b id="y2">—</b></div>
          <div>Year-3: <b id="y3">—</b></div>
        </div>
      </div>
      <hr/>
      <div id="aadtBanner" class="muted">—</div>
      <div id="compLine" class="muted">—</div>
      <!-- removed extra Run Estimate button -->
    </div>

    <!-- Main Map & SV -->
    <div class="card">
      <div class="muted">Map: Site & competitors (1.5 mi) + AADT dots + ⭐ AADT used</div>
      <div id="map"><div id="overlay" class="muted">—</div></div>
      <div id="svWrap"><div class="muted" style="margin-top:10px;">Street View</div><iframe id="sv" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div>
    </div>

    <!-- AADT sources (second map + table) -->
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <div class="muted">AADT Sources (within 1 mile)</div>
        <div id="aadtSourceLine" class="small">Source: state’s official AADT layer</div>
      </div>
      <div id="aadtMap" style="margin-top:8px;"></div>
      <div style="margin-top:10px; overflow:auto;">
        <table id="aadtTable">
          <thead>
            <tr>
              <th>Distance</th><th>AADT (Year)</th><th>Route</th><th>Location</th><th>Source</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Developments -->
    <div class="card"><div id="devs" class="muted">—</div></div>

    <!-- Rating + GPT Summary -->
    <div class="card"><b>Google Rating</b><div id="ratingLine" class="muted">—</div></div>
    <div class="card"><b>Summary (GPT)</b><div id="summary" class="muted">—</div></div>
  </div>

  <div class="footerbar"><button id="exportPDF">Export to PDF</button></div>

  <script>
/* =================== Helpers & State =================== */
const $ = (id) => document.getElementById(id);
const apiStatus = $("apiStatus"), aadtBanner = $("aadtBanner"), compLine = $("compLine"),
      overlay = $("overlay"), svFrame = $("sv"), outNum = $("estNum"), outRange = $("estRange"),
      outY2 = $("y2"), outY3 = $("y3"), devsBox = $("devs"),
      summaryBox = $("summary"), ratingLine = $("ratingLine"),
      addrInput = $("addr"), acBox = $("ac"), goBtn = $("go"),
      addExtraBtn = $("addExtra"), extraList = $("extraList"), activeExtras = $("activeExtras"),
      ex_large_dev = $("ex_large_dev"), ex_hours18 = $("ex_hours18"), ex_highincome = $("ex_highincome"),
      ex_lowrating = $("ex_lowrating"), ex_competitive_pricing = $("ex_competitive_pricing"),
      ex_rural = $("ex_rural"), aadtSourceLine = $("aadtSourceLine"), mathTableEl = $("mathTable");

let map, layer, mapReady = false, selectedCoords = null, selectedPlaceId = null;
let aadtMap, aadtLayer, aadtReady = false;
let acItems = [], acActive = -1;
let acCommitted = false;
let lastCommittedText = "";
let addressLocked = false;

/* Utils */
function fmt(n){ return (n??0).toLocaleString(undefined,{maximumFractionDigits:0}); }
function esc(s){ return (s??"").toString().replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;"," >":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function setOverlayWorking(){ overlay.textContent = "Working…"; overlay.style.display = "flex"; }
function clearOverlay(){ overlay.style.display = "none"; }

/* =================== Map + Street View =================== */
function initMap(){ if(mapReady) return;
  map = L.map("map",{zoomControl:true}); window.map = map;
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap"}).addTo(map);
  layer = L.layerGroup().addTo(map); mapReady = true;
}
function initAADTMap(){ if(aadtReady) return;
  aadtMap = L.map("aadtMap",{zoomControl:true}); window.aadtMap = aadtMap;
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap"}).addTo(aadtMap);
  aadtLayer = L.layerGroup().addTo(aadtMap); aadtReady = true;
}
function updateStreetView(lat, lon){
  svFrame.src = `https://maps.google.com/maps?q=&layer=c&cbll=${lat},${lon}&cbp=12,0,,0,0&output=svembed`;
}
function renderAADTMarkers(list, used) {
  if (!Array.isArray(list)) return;
  for (const rec of list) {
    if (!Number.isFinite(rec.lat) || !Number.isFinite(rec.lon) || !Number.isFinite(rec.aadt)) continue;
    const val = rec.aadt;
    let color;
    if (val >= 30000) color = "#be123c";
    else if (val >= 20000) color = "#f97316";
    else if (val >= 10000) color = "#eab308";
    else color = "#84cc16";
    L.circleMarker([rec.lat, rec.lon], {
      radius: 5, weight: 1, color, fillColor: color, fillOpacity: 0.8
    }).addTo(layer).bindPopup("AADT: " + fmt(val) + (rec.year?` (${rec.year})`:""));
  }
  if (used && Number.isFinite(used.lat) && Number.isFinite(used.lon)) {
    L.marker([used.lat, used.lon], {
      title: "AADT used",
      icon: L.divIcon({
        className: "aadt-used",
        html: '<div style="font-size:18px;">⭐</div>',
        iconSize: [24,24],
        iconAnchor: [12,12]
      })
    }).addTo(layer).bindPopup(`<b>USED AADT</b><br>${fmt(used.aadt)}${used.year?` (${used.year})`:''}<br>${esc(used.route||'')}`);
  }
}
function initOrUpdateMainMap(m){
  if(!mapReady) initMap();
  layer.clearLayers();
  if(!m || !m.site){ setOverlayWorking(); return; }
  const site = [m.site.lat, m.site.lon];
  L.marker(site,{title:"Site"}).addTo(layer).bindPopup("<b>Site</b>");
  const pts = [site];

  // Draw AADT dots FIRST so competitors appear above them
  if (m.aadt) renderAADTMarkers(m.aadt, m.aadt_used);

  // Then competitors (1.5 mi), bring to front
  for(const c of (m.competitors||[])){
    if(!Number.isFinite(c.lat)||!Number.isFinite(c.lon)) continue;
    pts.push([c.lat,c.lon]);
    const dot = L.circleMarker([c.lat,c.lon],{
      radius:7, weight:1.5, color:c.heavy?"#ff7f50":"#4ade80", fillColor:c.heavy?"#ff7f50":"#4ade80", fillOpacity:.95
    }).addTo(layer).bindPopup(`${esc(c.name||"Fuel")} • ${c.miles} mi`);
    if (dot.bringToFront) dot.bringToFront();
  }

  map.fitBounds(L.latLngBounds(pts).pad(0.25));
  clearOverlay(); updateStreetView(site[0], site[1]);
}

/* =================== Second map + table =================== */
function initOrUpdateAADTMap(site, items, used){
  if(!aadtReady) initAADTMap();
  aadtLayer.clearLayers();
  if(!site) return;
  const siteLL = [site.lat, site.lon];
  const bounds = [siteLL];
  L.marker(siteLL,{title:"Site"}).addTo(aadtLayer).bindPopup("<b>Site</b>");

  for (const s of (items||[])) {
    const color = s.aadt >= 30000 ? "#be123c" : s.aadt >= 20000 ? "#f97316" : s.aadt >= 10000 ? "#eab308" : "#84cc16";
    L.circleMarker([s.lat, s.lon], { radius: 5, weight:1, color, fillColor: color, fillOpacity:.85 })
      .addTo(aadtLayer)
      .bindPopup(`<b>${fmt(s.aadt)}${s.year?` (${s.year})`:''}</b><br>${esc(s.route||'')}${s.location?`<br>${esc(s.location)}`:''}<br><span class="small">~${s.miles} mi</span>`);
    bounds.push([s.lat, s.lon]);
  }
  if (used && Number.isFinite(used.lat) && Number.isFinite(used.lon)) {
    L.marker([used.lat, used.lon], {
      title: "AADT used",
      icon: L.divIcon({ className:"aadt-used-2", html:'<div style="font-size:18px;">⭐</div>', iconSize:[24,24], iconAnchor:[12,12] })
    }).addTo(aadtLayer).bindPopup(`<b>USED AADT</b><br>${fmt(used.aadt)}${used.year?` (${used.year})`:''}<br>${esc(used.route||'')}`);
    bounds.push([used.lat, used.lon]);
  }
  aadtMap.fitBounds(L.latLngBounds(bounds).pad(0.25));
}
function renderAADTTable(items){
  const tb = document.querySelector("#aadtTable tbody");
  tb.innerHTML = (items||[]).map(s => {
    const src = s.source_url ? `<a href="${s.source_url}" target="_blank">Source</a>` : "";
    return `<tr>
      <td>~${s.miles} mi</td>
      <td>${fmt(s.aadt)}${s.year?` <span class="small">(${s.year})</span>`:''}</td>
      <td>${esc(s.route||'')}</td>
      <td>${esc(s.location||'')}</td>
      <td>${src}</td>
    </tr>`;
  }).join("");
}

/* =================== Advanced pills =================== */
function pills(){
  const p=[];
  if(ex_large_dev.checked) p.push("+7.5% Large development nearby");
  if(ex_hours18.checked)  p.push("−7.5% 18h ops");
  if(ex_highincome.checked) p.push("+2.5% Higher-income");
  if(ex_lowrating.checked)  p.push("−30% Rating < 4.0");
  if(ex_competitive_pricing.checked) p.push("+10% Competitive site gas pricing");
  if(ex_rural.checked) p.push("+30% Rural bonus (0 comps within 3 mi)");
  activeExtras.innerHTML = p.map(x=>`<span class="badge">${esc(x)}</span>`).join(" ");
}
[ex_large_dev,ex_hours18,ex_highincome,ex_lowrating,ex_competitive_pricing,ex_rural].forEach(el=>el.addEventListener("change",pills));

function addExtraRow(pct="",note=""){
  const row=document.createElement("div");
  row.style.marginTop="6px";
  row.innerHTML=`<span class="chip"><input class="extraPct" type="number" step="0.1" style="width:90px" placeholder="% e.g. 5 or -3" value="${pct}">
  <input class="extraNote" style="width:320px" placeholder="Comment" value="${esc(note)}"> <button class="rm" type="button">×</button></span>`;
  row.querySelector(".rm").addEventListener("click",()=>row.remove());
  extraList.appendChild(row);
}
addExtraBtn.addEventListener("click",()=>addExtraRow());

function collectExtras(){
  const out=[];
  if(ex_large_dev.checked) out.push({pct:7.5, note:"Large residential/commercial developments"});
  if(ex_hours18.checked)  out.push({pct:-7.5, note:"18h ops"});
  if(ex_highincome.checked) out.push({pct:2.5, note:"Higher income"});
  if(ex_lowrating.checked)  out.push({pct:-30, note:"Rating < 4.0"});
  if(ex_competitive_pricing.checked)  out.push({pct:10, note:"Competitive site gas pricing"});
  for(const chip of extraList.querySelectorAll(".chip")){
    const pct = +chip.querySelector(".extraPct").value;
    const note = chip.querySelector(".extraNote").value.trim();
    if(Number.isFinite(pct)) out.push({pct, note});
  }
  return out;
}
function getFlags(){ return { rural: ex_rural.checked === true }; }
function getPricePosition(){ const r=document.querySelector('input[name="pricepos"]:checked'); return r ? r.value : "inline"; }

/* =================== API helpers ====================== */
async function safeJSON(url,opts){ const r=await fetch(url,opts); const t=await r.text(); try{ return JSON.parse(t);}catch{ throw new Error("Bad JSON"); } }
async function callEstimate(){
  const body = {
    address: addrInput.value.trim(),
    mpds: +$("mpds").value || 0,
    diesel: +$("diesel").value || 0,
    advanced: { extra: collectExtras(), flags: getFlags(), price_position: getPricePosition() }
  };
  if(selectedCoords){ body.siteLat = selectedCoords.lat; body.siteLon = selectedCoords.lon; }
  const ov = +( $("aadtOverride").value || "" );
  if(Number.isFinite(ov) && ov > 0) body.aadtOverride = ov;
  return await safeJSON("/estimate", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
}

/* =================== Math rendering ======================== */
/* Server-aligned math: uses server 'calc_breakdown' so numbers ALWAYS match */
function renderMathFromServer(d){
  if(!mathTableEl){ return; }
  const B = d && d.calc_breakdown;
  if(!B){
    renderMathFallback(buildCalcFallback(d)); // as last resort
    return;
  }
  const inputs = d.inputs || {};
  const aadtUsed = inputs.aadt_used ?? null;

  // Rebuild server steps (replicates server order/logic)
  const baseline = B.baseline || 0;
  const compAfter = B.compRule?.afterComp ?? baseline;
  const baseMult = B.compRule?.baseMult ?? 1;
  const heavyPen = B.compRule?.heavyPenalty ?? 0;
  const compMult = B.compRule?.compMult ?? 1;

  // Caps
  const capEquip = B.caps?.capEquip ?? compAfter;
  const capSoft = B.caps?.capSoftTotal ?? compAfter;
  const capHard = B.caps?.capHardTotal ?? compAfter;
  const minCap = Math.min(compAfter, capEquip, capHard);
  const softPenaltyApplied = compAfter > capSoft;
  const afterCap = Math.round(softPenaltyApplied ? minCap * 0.9 : minCap);

  // Pricing + extras
  const priceMult = B.priceMult ?? 1;
  const afterPrice = Math.round(afterCap * priceMult);
  const extrasMult = B.extrasMult ?? 1;
  const afterExtras = Math.round(afterPrice * extrasMult); // should equal B.preClamp
  const preClamp = B.preClamp ?? afterExtras;

  // Final clamp to baseline and final outputs
  const finalBase = B.finalClampedToBaseline ?? Math.min(preClamp, baseline);
  const low = d?.estimate?.low ?? d?.low ?? finalBase;
  const high = d?.estimate?.range ? d.estimate.range.split("–")[1] : (d?.high ?? Math.round(finalBase * 1.06));
  const y2 = d?.estimate?.year2 ?? d?.year2 ?? Math.round(finalBase * 1.027);
  const y3 = d?.estimate?.year3 ?? d?.year3 ?? Math.round(finalBase * 1.027 * 1.0125);

  const rows = [
    `<b>Baseline ceiling</b> = AADT ${fmt(aadtUsed)} × 2% × 8 × 30 = <b>${fmt(baseline)}</b>`,
    `Competition rule: base ${baseMult.toFixed?.(2) ?? baseMult} − heavy ${heavyPen.toFixed?.(2) ?? heavyPen} = × ${compMult.toFixed?.(2) ?? compMult} → <b>${fmt(compAfter)}</b>`,
    `Capacity caps (equipment/soft/hard): ${fmt(capEquip)} / ${fmt(capSoft)} / ${fmt(capHard)}${softPenaltyApplied ? " • soft penalty −10%" : ""} → <b>${fmt(afterCap)}</b>`,
    `Pricing factor: × ${priceMult} → <b>${fmt(afterPrice)}</b>`,
    `Extras: × ${extrasMult} → <b>${fmt(preClamp)}</b>`,
    `Baseline clamp: min(pre‑clamp, baseline) → <b>${fmt(finalBase)}</b>`,
    `<b>Final (LOW)</b>: <b>${fmt(low)}</b> • Range: ${d?.estimate?.range || (fmt(low) + "–" + fmt(high))} • Y2: ${fmt(y2)} • Y3: ${fmt(y3)}`
  ];
  mathTableEl.innerHTML = rows.map(r=>`<div>${r}</div>`).join('');
}

/* Legacy fallback kept ONLY if server breakdown missing */
function buildCalcFallback(d){
  try{
    const aadt = (d?.map?.aadt_used?.aadt) || (+( $("aadtOverride").value || 0)) || null;
    const mpd = +( $("mpds").value || 0 );
    const diesel = +( $("diesel").value || 0 );
    const pct_stopping = 0.02, gal_per_stop = 8, days = 30;
    if(!aadt) return null;
    const ceiling = aadt * pct_stopping * gal_per_stop * days;
    const mpd_cap = (mpd + diesel) * 10 * 60 * 16 * 30;
    const after_cap = Math.min(ceiling, mpd_cap);
    const price = getPricePosition()==='below'?1.10:(getPricePosition()==='above'?0.90:1.00);
    const comp = 1.00;
    const laneF=1, accessF=1, ctxF=1;
    const extras = collectExtras().map(e=>({label:e.note||"Adj", mult: 1 + (e.pct||0)/100}));
    let v = after_cap * comp * price * laneF * accessF * ctxF;
    for(const e of extras) v *= e.mult;
    return {
      aadt, pct_stopping, gal_per_stop, days, ceiling,
      regular_mpd: mpd, diesel_mpd: diesel, mpd_cap,
      competition_factor: comp, pricing_factor: price,
      lane_factor: laneF, access_factor: accessF, context_factor: ctxF,
      extra_factors: extras,
      after_cap, after_comp: after_cap*comp, after_pricing: after_cap*comp*price,
      after_roadway: after_cap*comp*price*laneF*accessF*ctxF,
      after_extras: v,
      low: Math.round(v), high: Math.round(v*1.25), year2: Math.round(v*1.05), year3: Math.round(v*1.08),
      _note: "UI fallback calc"
    };
  }catch{return null;}
}
function renderMathFallback(calc){
  if(!mathTableEl) return;
  if(!calc){ mathTableEl.innerHTML = '<em>— (no calc available)</em>'; return; }
  const extras = (calc.extra_factors||[]).map(e=>`${esc(e.label||'Adj')}: × ${e.mult}`).join(' • ') || '—';
  const rows = [
    `<b>Baseline ceiling</b> = AADT ${fmt(calc.aadt)} × ${(calc.pct_stopping*100).toFixed(1)}% × ${calc.gal_per_stop} × ${calc.days} = <b>${fmt(calc.ceiling)}</b>`,
    `Capacity cap (MPDs ${calc.regular_mpd}+${calc.diesel_mpd} diesel): <b>${fmt(calc.mpd_cap)}</b>`,
    `After cap: <b>${fmt(calc.after_cap)}</b>`,
    `Competition factor: × ${calc.competition_factor} → <b>${fmt(calc.after_comp)}</b>`,
    `Pricing factor: × ${calc.pricing_factor} → <b>${fmt(calc.after_pricing)}</b>`,
    `Roadway: lanes × access × context = ${calc.lane_factor} × ${calc.access_factor} × ${calc.context_factor} → <b>${fmt(calc.after_roadway)}</b>`,
    `Extras: ${extras} → <b>${fmt(calc.after_extras)}</b>`,
    `<b>Final (LOW)</b>: <b>${fmt(calc.low)}</b> • Range: ${fmt(calc.low)}–${fmt(calc.high)} • Y2: ${fmt(calc.year2)} • Y3: ${fmt(calc.year3)}`
  ];
  mathTableEl.innerHTML = rows.map(r=>`<div>${r}</div>`).join('');
}

/* =================== Rendering ======================== */
function renderAll(d){
  // Estimate header (from server)
  outNum.textContent = fmt(d.estimate?.low ?? d.low ?? 0);
  const rangeTxt = d.estimate?.range || (d.low!=null && d.high!=null ? `${fmt(d.low)}–${fmt(d.high)}` : "—");
  outRange.textContent = "Full range: " + rangeTxt;
  outY2.textContent = fmt(d.estimate?.year2 ?? d.year2 ?? 0);
  outY3.textContent = fmt(d.estimate?.year3 ?? d.year3 ?? 0);

  // Math: prefer server breakdown; fallback if absent
  if (d.calc_breakdown) renderMathFromServer(d);
  else renderMathFallback(buildCalcFallback(d));

  // Banners
  aadtBanner.textContent = d.aadtText || "—";
  compLine.textContent = d.competitionText || "—";

  // STOP: CSV development stripe + list
  if (Array.isArray(d.csv) && d.csv.length) {
    const lines = d.csv.slice(0,6).map(x => {
      const nm = esc(x.name || "");
      const st = esc(x.status || "");
      const dtl = x.details ? ` • ${esc(x.details)}` : "";
      const dt  = x.date ?    ` • ${esc(x.date)}`    : "";
      return `${nm}${st ? ` • ${st}` : ''}${dtl}${dt}`;
    }).join(" // ");
    document.getElementById("stopText").innerHTML = `Development flagged: <b>${lines}</b>`;
    document.getElementById("stopBox").style.display = "block";
    devsBox.innerHTML = "<ul>"+d.csv.map(x => `<li>${esc(x.name||'')} • ${esc(x.status||'')}${x.details?` • ${esc(x.details)}`:''}${x.date?` • ${esc(x.date)}`:''}</li>`).join("")+"</ul>";
  } else {
    document.getElementById("stopBox").style.display = "none";
    devsBox.innerHTML = "<em>no CSV developments</em>";
  }

  // Summary (GPT)
  summaryBox.textContent = (d.summary || "").trim() || "—";

  // Maps
  initOrUpdateMainMap(d.map);

  // Second map + table (1 mile)
  if (d?.map?.site) {
    fetch(`/aadt/nearby?lat=${encodeURIComponent(d.map.site.lat)}&lon=${encodeURIComponent(d.map.site.lon)}&radiusMi=1`)
      .then(r => r.json()).then(j => {
        if (j.ok) {
          initOrUpdateAADTMap(d.map.site, j.items, d.map.aadt_used || null);
          renderAADTTable(j.items);
          const st = j.state || "NC";
          const srcMap = {
            NC: "NCDOT AADT Stations (official)",
            VA: "VDOT Traffic Volume ADT (official)",
            DC: "DDOT 2023 Traffic Volume (official)",
            FL: "FDOT AADT (TDA/RCI) (official)"
          };
          aadtSourceLine.textContent = "Source: " + (srcMap[st] || "official state AADT");
        }
      }).catch(()=>{});
  }

  // Rating
  showRating(addrInput.value.trim());
}

/* =================== Rating helpers =================== */
async function resolvePlaceIdIfNeeded(address){
  if (selectedPlaceId) return selectedPlaceId;
  try {
    const r = await fetch("/google/findplace?input=" + encodeURIComponent(address));
    const j = await r.json();
    if (j.ok && j.place_id) { selectedPlaceId = j.place_id; return j.place_id; }
  } catch {}
  return null;
}
async function showRating(address){
  let rating = null, total = null;
  const pid = await resolvePlaceIdIfNeeded(address);
  if (pid) {
    try {
      const r = await fetch("/google/rating?place_id=" + encodeURIComponent(pid));
      const j = await r.json();
      if (j.ok) { rating = j.rating ?? null; total = j.total ?? null; }
    } catch {}
  }
  if ((rating == null || rating === undefined) && selectedCoords) {
    try {
      const r2 = await fetch("/google/rating_by_location?lat=" + encodeURIComponent(selectedCoords.lat) + "&lon=" + encodeURIComponent(selectedCoords.lon));
      const j2 = await r2.json();
      if (j2.ok) { rating = j2.rating ?? null; total = j2.total ?? null; }
    } catch {}
  }
  ratingLine.innerHTML = (rating != null && rating !== undefined) ? `\u2B50 ${rating} (${total||0} reviews)` : "—";
}

/* =================== Autocomplete (hard lock on commit) =================== */
function hideAc(){ acBox.style.display = "none"; acActive = -1; }
function commitAddress(display, coords, placeId){
  lastCommittedText = (display || "").trim();
  acCommitted = true;      // lock
  addressLocked = true;    // hard lock until user deletes back before committed text
  acItems = [];
  hideAc();
  addrInput.value = display;
  selectedCoords = coords || null;
  selectedPlaceId = placeId || null;
}
function chooseAc(i){
  const it = acItems[i];
  if (!it) return;
  const coords = (Number.isFinite(it.lat) && Number.isFinite(it.lon)) ? { lat: it.lat, lon: it.lon } : null;
  commitAddress(it.display, coords, it.place_id || null);
  addrInput.blur(); // collapse keyboard
}
async function googleSearch(q){
  try {
    const r = await fetch("/google/autocomplete?input=" + encodeURIComponent(q));
    const j = await r.json();
    if(!j.ok) return [];
    return (j.items||[]).map(it => ({...it, type:"Google", score:1.3}));
  } catch { return []; }
}
async function nominatimSearch(q){
  try {
    const r = await fetch("https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=6&countrycodes=us&q=" + encodeURIComponent(q));
    const a = await r.json();
    return a.map(row => ({ type:"OSM", display:row.display_name, lat:+row.lat, lon:+row.lon, score:0.6 }));
  } catch { return []; }
}
function renderAc(list){
  if(!list.length){ hideAc(); return; }
  acBox.innerHTML = list.map((it,i) =>
    `<div class="ac-item${i===acActive?" active":""}" data-i="${i}">${esc(it.display)} <span class="badge">${it.type}</span></div>`
  ).join("");
  [...acBox.children].forEach(el => el.onclick = () => chooseAc(+el.dataset.i));
  acBox.style.display = "block";
}
addrInput.addEventListener("input", () => {
  const q = addrInput.value.trim();

  // Hard lock: if the user hasn't deleted back before the committed text, keep AC hidden
  if (addressLocked) {
    if (q.length >= lastCommittedText.length && q.startsWith(lastCommittedText)) {
      hideAc(); return;
    } else {
      addressLocked = false; // user cleared or edited earlier chars; unlock
      acCommitted = false;
    }
  }

  if (acCommitted) {
    if (q === lastCommittedText) { hideAc(); return; }
    acCommitted = false; // unlock only if they truly edit
  }
  if (q.length < 3) { hideAc(); return; }
  Promise.all([googleSearch(q), nominatimSearch(q)]).then(([g,n])=>{
    acItems = [...g, ...n].slice(0, 8);
    renderAc(acItems);
  });
});
addrInput.addEventListener("blur", () => { setTimeout(hideAc, 120); });
document.addEventListener("keydown", (e) => { if (e.key === "Escape") hideAc(); });
document.addEventListener("pointerdown", (e) => {
  if (e.target !== addrInput && !acBox.contains(e.target)) hideAc();
});

/* =================== Main events ====================== */
function tidyUI(){ hideAc(); }
async function onEstimateClick(){
  if(!addrInput.value.trim() && !selectedCoords){
    alert("Please select a valid address first.");
    return;
  }
  try {
    goBtn.disabled = true; setOverlayWorking(); tidyUI();
    const resp = await callEstimate();
    if (!resp || resp.ok !== true) { alert("Estimate failed: " + (resp?.status || "Unknown error")); return; }
    renderAll(resp); pills();
  } catch (e) {
    alert("Error: " + (e?.message || e));
  } finally {
    goBtn.disabled = false; clearOverlay();
  }
}
goBtn.addEventListener("click", onEstimateClick);
addrInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); onEstimateClick(); } });

/* =================== PDF Export ======================= */
document.getElementById("exportPDF").addEventListener("click", async ()=>{
  const { jsPDF } = window.jspdf || {};
  if(!jsPDF){ alert("PDF lib failed to load"); return; }
  const doc=new jsPDF({unit:"pt",format:"a4"});
  const pageW=595, pageH=842, margin=36, contentW=pageW - margin*2;

  doc.setFont("helvetica","bold"); doc.setFontSize(18);
  doc.text("Sunoco, LP Fuel IQ — Fuel Site Analyzer", margin, margin+6);

  doc.setFont("helvetica","normal"); doc.setFontSize(11);
  const lines = doc.splitTextToSize(document.getElementById("summary").innerText || "", contentW);
  doc.text(lines, margin, margin+28);

  let cursorY = margin + 28 + lines.length*14 + 16;

  const key = [
    `Address: ${document.getElementById("addr").value || "-"}`,
    `MPDs: ${document.getElementById("mpds").value}   Diesel: ${document.getElementById("diesel").value}`,
    document.getElementById("aadtBanner").innerText,
    `Estimate (LOW): ${document.getElementById("estNum").innerText}  |  Range: ${document.getElementById("estRange").innerText.replace("Full range: ","")}`,
    document.getElementById("compLine").innerText
  ].join("\n");
  const keyLines = doc.splitTextToSize(key, contentW);
  doc.text(keyLines, margin, cursorY);
  cursorY += keyLines.length*14 + 12;

  // Add math table
  const mathTxt = (document.getElementById('mathTable')?.innerText || '').trim();
  if (mathTxt) {
    const mathLines = doc.splitTextToSize("Math & Assumptions:\n" + mathTxt, contentW);
    if (cursorY + mathLines.length*14 > pageH - margin) { doc.addPage(); cursorY = margin; }
    doc.setFont("helvetica","bold"); doc.text("Math & Assumptions", margin, cursorY); cursorY += 14;
    doc.setFont("helvetica","normal"); doc.text(mathLines, margin, cursorY);
    cursorY += mathLines.length*14 + 12;
  }

  const mapImg = await new Promise(resolve=>{
    if(!window.leafletImage || !window.map){ resolve(null); return; }
    leafletImage(window.map, function(err, canvas){
      if(err){ resolve(null); return; }
      resolve(canvas.toDataURL("image/png"));
    });
  });

  const imgW = contentW, imgH = 260;
  if (mapImg) {
    if (cursorY + imgH > pageH - margin) { doc.addPage(); cursorY = margin; }
    doc.setFont("helvetica","bold"); doc.text("Map & Competitors (1.5 mi)", margin, cursorY);
    cursorY += 12;
    doc.addImage(mapImg, "PNG", margin, cursorY, imgW, imgH);
    cursorY += imgH + 12;
  }

  // Include AADT table text
  const tbl = document.getElementById("aadtTable").innerText || "";
  const devLines = doc.splitTextToSize("AADT Sources (1 mi):\n" + tbl, contentW);
  if (cursorY + devLines.length*14 > pageH - margin) { doc.addPage(); cursorY = margin; }
  doc.setFont("helvetica","bold"); doc.text("AADT Sources", margin, cursorY); cursorY += 14;
  doc.setFont("helvetica","normal"); doc.text(devLines, margin, cursorY);

  doc.save("FuelIQ_Site_Analyzer.pdf");
});

/* =================== Init ============================== */
document.addEventListener("DOMContentLoaded", async () => {
  try {
    const r = await fetch("/google/status");
    const j = await r.json();
    apiStatus.textContent = j.ok ? "API: Google — Working" : `API: Google — ${j.status}`;
  } catch { apiStatus.textContent = "API: Google — unavailable"; }
});
overlay.textContent="—";
  </script>
</body>
</html>
