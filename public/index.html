<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sunoco LP Gas Station Analyzer</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root {
      --bg:#0b0e15; --panel:#111725; --panel2:#0f1421; --line:#263145;
      --text:#eaeef7; --muted:#97a3b8; --brand:#0ea5e9; --brand2:#22d3ee; --pill:#0f1929;
    }
    *{ box-sizing:border-box; }
    body { background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap { max-width: 1120px; margin: 24px auto; padding: 0 16px; }
    header { display:flex; align-items:center; gap:14px; margin-bottom:16px; }
    header .logo { width:46px; height:46px; border-radius:10px;
      background: radial-gradient(60% 60% at 30% 30%, var(--brand2), transparent 60%),
                  linear-gradient(145deg, var(--brand), var(--panel2));
      box-shadow: 0 10px 30px rgba(14,165,233,.25), inset 0 0 12px rgba(34,211,238,.2);
    }
    header h1 { font-size: 28px; margin:0; letter-spacing:.3px; }
    .card { background:linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--line); border-radius:14px; padding:16px; margin:14px 0;
      box-shadow: 0 12px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.02); }
    label { display:block; font-weight:600; margin:8px 0 6px; color:#d8e3f6; }
    input {
      width:100%; padding:12px 12px; border-radius:10px; border:1px solid var(--line);
      background:#0b1220; color:var(--text); outline:none;
    }
    .row { display:grid; grid-template-columns: 1.8fr 0.8fr 0.8fr; gap:12px; }
    @media (max-width: 900px){ .row{ grid-template-columns:1fr; } }
    button {
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:white; border:0; padding:12px 18px; border-radius:12px; font-weight:700; cursor:pointer;
      box-shadow: 0 10px 24px rgba(14,165,233,.35);
    }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .muted { color:var(--muted); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }
    .right { text-align:right; }
    #map { height:420px; border-radius:12px; border:1px solid var(--line); position: relative; }
    #mapOverlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(11,14,21,.55); border-radius:12px; font-weight:700; color:#cde9ff; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
    .summary { white-space: pre-wrap; }
    /* Autocomplete dropdown */
    .ac-wrap { position:relative; }
    .ac-list {
      position:absolute; top:100%; left:0; right:0; z-index:30; margin-top:6px;
      background:#0b1220; border:1px solid var(--line); border-radius:12px;
      max-height:320px; overflow:auto; box-shadow: 0 18px 36px rgba(0,0,0,.35);
    }
    .ac-item { padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,.04); }
    .ac-item:last-child { border-bottom:0; }
    .ac-item:hover, .ac-item.active { background:#101a2b; }
    .badge { display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px;
      border:1px solid var(--line); background:var(--pill); color:#a9c5ff; margin-left:8px; }
    .h3 { font-weight:700; font-size:16px; margin:0 0 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"></div>
      <h1>Sunoco LP Gas Station Analyzer</h1>
    </header>

    <div class="card">
      <div class="row">
        <div>
          <label>Site search (address or business name)</label>
          <div class="ac-wrap">
            <input id="addr" placeholder="e.g., 4173 Knightdale Blvd, Knightdale NC  — or — Sheetz Knightdale" autocomplete="off" />
            <div id="ac" class="ac-list" style="display:none;"></div>
          </div>
        </div>
        <div>
          <label>Regular MPDs</label>
          <input id="mpds" type="number" value="3" />
        </div>
        <div>
          <label>Diesel positions (optional)</label>
          <input id="diesel" type="number" value="0" />
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <button id="go">Estimate</button>
        <span class="muted">Results include AADT sanity, competition (your rules), multi-source developments, capacity cap, and a detailed summary.</span>
      </div>
    </div>

    <div class="card">
      <div id="out" class="muted">—</div>
    </div>

    <div class="card">
      <div class="h3">Map: site & competition (1 mile) <span class="badge">read-only</span></div>
      <div id="map"><div id="mapOverlay" class="muted">—</div></div>
    </div>

    <div class="card">
      <div class="h3">Developments (multi-source)</div>
      <div id="devs" class="muted">—</div>
    </div>

    <div class="card">
      <div class="h3">Summary</div>
      <div id="summary" class="summary muted">—</div>
    </div>

    <div class="card">
      <details>
        <summary>Debug</summary>
        <pre id="debug" class="mono muted">/ waiting…</pre>
      </details>
    </div>
  </div>

<script>
/* ===== Globals & helpers ===== */
const $ = id => document.getElementById(id);
const out = $("out"), debug = $("debug"), goBtn = $("go");
const acBox = $("ac"), addrInput = $("addr");
const mapOverlay = $("mapOverlay");
let map, markersLayer, mapInited=false, selectedCoords=null; // {lat, lon}

function setOut(html){ out.innerHTML = html; }
function setDebug(obj){ debug.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2); }
function fmt(n){ return (n ?? 0).toLocaleString(undefined, { maximumFractionDigits: 0 }); }
function esc(s){ return (s ?? "").toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function setOverlay(msg){ mapOverlay.textContent = msg; mapOverlay.style.display = "flex"; }
function clearOverlay(){ mapOverlay.style.display = "none"; }

/* ===== Hybrid Autocomplete (Nominatim + Overpass fuel POIs) ===== */
let acTimer=null, acItems=[], acIndex=-1;

/** Query Nominatim for addresses/POIs */
async function nominatimSearch(q){
  const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=8&countrycodes=us&q=${encodeURIComponent(q)}`;
  const r = await fetch(url);
  if (!r.ok) return [];
  const arr = await r.json();
  return arr.map(row=>{
    const a=row.address||{};
    const line = [
      row.namedetails?.name || a.house_number,
      a.road || a.pedestrian || a.residential || a.footway,
      a.city || a.town || a.village || a.hamlet || a.county,
      a.state, a.postcode
    ].filter(Boolean).join(", ") || row.display_name;
    return { type:"Address", display: line, lat:+row.lat, lon:+row.lon };
  });
}

/** Get a coarse center for the query so Overpass can search nearby fuel POIs */
async function geocodeCenter(q){
  try{
    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=us&q=${encodeURIComponent(q)}`;
    const r = await fetch(url);
    if(!r.ok) return null;
    const a = await r.json();
    if(!a?.length) return null;
    return { lat:+a[0].lat, lon:+a[0].lon };
  }catch{ return null; }
}

/** Query Overpass for fuel businesses near a center, then filter by the user's query tokens */
async function overpassFuelPOIsNear(center, q){
  if(!center) return [];
  const radiusM = 15000; // 15km for generous catchment during typing
  const data = `
    [out:json][timeout:25];
    (
      node(around:${radiusM},${center.lat},${center.lon})["amenity"="fuel"];
      way(around:${radiusM},${center.lat},${center.lon})["amenity"="fuel"];
    );
    out center tags;
  `;
  try{
    const ep = "https://overpass-api.de/api/interpreter";
    const r = await fetch(ep, {
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded" },
      body: "data="+encodeURIComponent(data)
    });
    if(!r.ok) return [];
    const json = await r.json();
    let items = [];
    const toks = q.toLowerCase().split(/\s+/).filter(Boolean);
    for(const el of json.elements||[]){
      const t = el.tags||{};
      const name = t.brand || t.name || "";
      if(!name) continue;
      const hay = (name + " " + (t["addr:street"]||"") + " " + (t["addr:city"]||"")).toLowerCase();
      // keep only if all tokens appear somewhere
      const ok = toks.every(tok => hay.includes(tok));
      if(!ok) continue;
      const lat = el.lat ?? el.center?.lat;
      const lon = el.lon ?? el.center?.lon;
      if(lat==null || lon==null) continue;
      items.push({ type:"Station", display:name, lat:+lat, lon:+lon });
    }
    // de-dupe by name+coords
    const seen = new Set();
    items = items.filter(it => {
      const k = `${it.display}|${it.lat.toFixed(5)}|${it.lon.toFixed(5)}`;
      if(seen.has(k)) return false; seen.add(k); return true;
    });
    // trim to 10
    return items.slice(0,10);
  }catch{ return []; }
}

/** Render the merged suggestion list */
function renderAcList(list){
  if (!list.length){ hideAc(); return; }
  acIndex = -1;
  acBox.innerHTML = list.map((it,i)=>`
    <div class="ac-item" data-i="${i}">
      ${esc(it.display)} <span class="badge">${it.type}</span>
      <div class="muted" style="font-size:12px">${it.lat.toFixed(5)}, ${it.lon.toFixed(5)}</div>
    </div>
  `).join("");
  [...acBox.children].forEach(el=>{
    el.addEventListener("mouseenter",()=> setActive(+el.dataset.i));
    el.addEventListener("click",()=> chooseAc(+el.dataset.i));
  });
  acBox.style.display = "block";
}

/* events */
addrInput.addEventListener("input", async ()=>{
  const q = addrInput.value.trim();
  selectedCoords = null;
  hideAc();
  if (!q || q.length < 3) return;

  if (acTimer) clearTimeout(acTimer);
  acTimer = setTimeout(async ()=>{
    try{
      const [addrList, center] = await Promise.all([nominatimSearch(q), geocodeCenter(q)]);
      const fuelList = await overpassFuelPOIsNear(center, q);
      // merge + de-dupe (prefer Station first, then Address)
      const merged = [...fuelList, ...addrList];
      // unique by display+coords
      const seen = new Set(); const final=[];
      for(const it of merged){
        const k = `${it.display}|${it.lat.toFixed(5)}|${it.lon.toFixed(5)}`;
        if(!seen.has(k)){ seen.add(k); final.push(it); }
      }
      acItems = final.slice(0, 12);
      renderAcList(acItems);
    }catch(_){}
  }, 250);
});

addrInput.addEventListener("keydown",(e)=>{
  if (acBox.style.display === "none") return;
  if (e.key === "ArrowDown"){ e.preventDefault(); moveAc(1); }
  else if (e.key === "ArrowUp"){ e.preventDefault(); moveAc(-1); }
  else if (e.key === "Enter"){ if (acIndex >=0){ e.preventDefault(); chooseAc(acIndex); } }
  else if (e.key === "Escape"){ hideAc(); }
});

document.addEventListener("click",(e)=>{
  if (!acBox.contains(e.target) && e.target !== addrInput) hideAc();
});

function hideAc(){ acBox.style.display = "none"; acIndex = -1; }
function setActive(i){
  acIndex = i;
  [...acBox.children].forEach((el,idx)=> el.classList.toggle("active", idx===i));
}
function moveAc(step){
  if (!acItems.length) return;
  acIndex = ( (acIndex + step) % acItems.length + acItems.length ) % acItems.length;
  setActive(acIndex);
  acBox.children[acIndex].scrollIntoView({ block:"nearest" });
}
function chooseAc(i){
  const it = acItems[i]; if (!it) return;
  addrInput.value = it.display;
  selectedCoords = { lat: it.lat, lon: it.lon };
  hideAc();
}

/* ===== API & Rendering ===== */
async function callEstimate(){
  const body = {
    address: $("addr").value.trim(),
    mpds: Number($("mpds").value || 0),
    diesel: Number($("diesel").value || 0)
  };
  if (selectedCoords) { body.siteLat = selectedCoords.lat; body.siteLon = selectedCoords.lon; }
  const r=await fetch("/estimate",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
  const t=await r.text(); if(!r.ok) throw new Error(`HTTP ${r.status}\n${t.slice(0,1200)}`); return JSON.parse(t);
}

async function estimate(){
  try{
    goBtn.disabled = true;
    setOut("<span class='muted'>Working…</span>");
    setOverlay("Loading, this can take up to 3 minutes to research");
    const d = await callEstimate();
    renderReport(d);
    renderMap(d.map);
    renderDevs(d.developments, d.developments_ai);
    $("summary").textContent = d.summary && d.summary.trim().length ? d.summary : "—";
    setDebug(d);
  }catch(e){
    setOut(`<pre class="mono">${esc(e.message)}</pre>`);
    setOverlay("Error — see details above");
  }finally{
    goBtn.disabled = false;
  }
}

function renderReport(d){
  const i=d.inputs||{}, c=d.competition||{};
  const html = `
    <div class="grid">
      <div>
        <div class="h3" style="margin-bottom:6px;">Base Estimate (gal/mo)</div>
        <div style="font-size:30px;font-weight:800;">${fmt(d.base)}</div>
        <div class="muted">Low–High: ${fmt(d.low)} – ${fmt(d.high)}</div>
      </div>
      <div class="right">
        <div>Year-2: <b>${fmt(d.year2)}</b></div>
        <div style="margin-top:6px;">Year-3: <b>${fmt(d.year3)}</b></div>
      </div>
    </div>
    <hr>
    <div>Inputs: AADT used <b>${fmt(i.aadt_used)}</b>; MPDs ${i.mpds}${i.diesel ? " + diesel "+i.diesel : ""}</div>
    <div>Competition: ${c.count ?? 0} within 1 mi${c.nearest_mi != null ? "; nearest "+c.nearest_mi.toFixed(3)+" mi" : ""}${(c.notable_brands||[]).length ? "; notable: "+c.notable_brands.join(", ") : ""}; impact ${(Number(c.impact_score||0)*100|0)}%</div>
    <div class="muted" style="margin-top:8px">${esc(d.rationale||"")}</div>
  `;
  setOut(html);
}

function ensureLeaflet(){
  if(mapInited) return;
  map = L.map("map",{zoomControl:true});
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap"}).addTo(map);
  mapInited = true;
}
function renderMap(m){
  ensureLeaflet();
  if(markersLayer) markersLayer.remove();
  markersLayer = L.layerGroup().addTo(map);

  if(!m || !m.site){ mapOverlay.textContent = "—"; return; }

  const site = [m.site.lat, m.site.lon];
  L.marker(site, { title: "Site" }).addTo(markersLayer).bindPopup("<b>Site</b>");
  const comps = Array.isArray(m.competitors) ? m.competitors : [];
  for(const c of comps){
    L.circleMarker([c.lat,c.lon],{radius:6,weight:1,color:c.heavy?"#ff7f50":"#4ade80",fillOpacity:.85})
      .addTo(markersLayer).bindPopup(`<b>${esc(c.name||"Fuel station")}</b><br>${c.miles} mi`);
  }
  const bounds=L.latLngBounds([site, ...comps.map(c=>[c.lat,c.lon])]);
  map.fitBounds(bounds.pad(0.25));
  clearOverlay();
}

function renderDevs(osm, ai){
  const el=$("devs");
  const left = (Array.isArray(osm)&&osm.length)
    ? "<ul>"+osm.map(d=>`<li>${esc(d.name)} • ${esc(d.status)} • ${d.miles} mi</li>`).join("")+"</ul>"
    : "<span class='muted'>OSM/Overpass: none found</span>";
  const right = (ai && Array.isArray(ai.items) && ai.items.length)
    ? "<ul>"+ai.items.map(x=>`<li>${esc(x.name)} • ${esc(x.status||"planned")} • ~${x.approx_miles ?? "?"} mi</li>`).join("")+"</ul><div class='muted'>GPT confidence: ${(ai.confidence*100|0)}%</div>"
    : "<span class='muted'>GPT: none reported</span>";
  el.innerHTML = `<div class="grid"><div>${left}</div><div>${right}</div></div>`;
}

/* Init */
$("go").addEventListener("click", estimate);
setOverlay("—"); // neutral until the first run
</script>
</body>
</html>
