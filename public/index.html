<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sunoco, LP Fuel IQ - Fuel Site Analyzer</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <!-- Optional: MarkerCluster + Heatmap -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    :root { --bg:#0b0e15; --panel:#111725; --panel2:#0f1421; --line:#263145; --text:#eaeef7; --muted:#97a3b8; --brand:#0ea5e9; --brand2:#22d3ee; --pill:#0f1929; }
    *{ box-sizing:border-box; }
    body{ background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:0; padding-bottom:84px; }
    .wrap{ max-width:1120px; margin:24px auto; padding:0 16px; }
    header{ display:flex; align-items:center; gap:14px; margin-bottom:6px; }
    header h1{ font-size:28px; margin:0; letter-spacing:.2px; }
    .build{ margin-left:auto; font-size:12px; color:#8aa2c0; }
    .instructions{ margin:4px 0 12px; color:#cfe3ff; font-size:13px; }

    .card{ background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line); border-radius:12px; padding:16px; margin:12px 0; }
    label{ display:block; font-weight:600; margin:8px 0 6px; color:#d8e3f6; }
    input, select, textarea{ width:100%; padding:12px; border-radius:10px; border:1px solid var(--line); background:#0b1220; color:#eaeef7; }
    textarea{ min-height:96px; resize:vertical; }
    button{ background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#fff; border:0; padding:12px 16px; border-radius:10px; font-weight:700; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .row{ display:grid; grid-template-columns:1.6fr repeat(4,minmax(0,0.6fr)) minmax(0,1fr); gap:12px; align-items:start; }
    .input-row > div{ display:flex; flex-direction:column; }
    .input-row label{ min-height:38px; display:flex; align-items:flex-end; }
    .input-row button{ margin-top:auto; }
    @media (min-width:981px){ .input-row label{ white-space:nowrap; } }
    @media (max-width:980px){ .row{ grid-template-columns:1fr; } }

    .toolbar{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:12px; }
    .notes-toolbar{ flex-direction:column; align-items:stretch; }
    .notes-toolbar textarea{ margin-top:6px; }
    .muted{ color:var(--muted); }
    .subtle{ font-size:12px; opacity:.9; }

    #map,#aadtMap{ height:420px; border-radius:12px; border:1px solid var(--line); position: relative; }
    #overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(11,14,21,.55); border-radius:12px; font-weight:800; color:#cde9ff; font-size:18px; padding:20px; text-align:center; display:none; }

    #svWrap{ margin-top:10px; }
    #sv{
      width:100%;
      height:380px;
      border-radius:12px;
      border:1px solid var(--line);
      background:radial-gradient(circle at 20% 20%, rgba(46,74,109,.6), transparent 60%), #0b1220;
      overflow:hidden;
      position:relative;
    }
    #sv iframe{
      width:100%;
      height:100%;
      border:0;
      display:block;
    }
    #sv::after{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(120deg, rgba(14,165,233,.05), rgba(34,211,238,.03));
      opacity:0;
      transition:opacity .3s ease;
      pointer-events:none;
    }
    #sv.sv-loading::after{ opacity:1; }

    .ac-wrap{ position:relative; }
    .ac-list{ position:absolute; top:100%; left:0; right:0; z-index:30; margin-top:6px; background:#0b1220; border:1px solid var(--line); border-radius:12px; max-height:320px; overflow:auto; box-shadow: 0 18px 36px rgba(0,0,0,.35); }
    .ac-item{ padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,.04); }
    .ac-item:last-child{ border-bottom:0; }
    .ac-item:hover, .ac-item.active{ background:#101a2b; }
    .badge{ display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--line); background:var(--pill); color:#a9c5ff; margin-left:8px; }

    details summary{ cursor:pointer; }
    .adv-line{ display:flex; align-items:center; gap:16px; flex-wrap:wrap; margin-top:12px; }
    .chip{ display:inline-flex; align-items:center; gap:8px; background:#0f1929; border:1px solid var(--line); padding:8px 10px; border-radius:999px; font-size:13px; }
    .chip input{ width:auto; accent-color:#22d3ee; }
    .radio-row{ display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; }

    .hero{ display:flex; justify-content:space-between; align-items:flex-end; gap:12px; }
    .hero .num{ font-size:44px; font-weight:900; letter-spacing:.5px; }
    .hero .sub{ font-size:13px; color:#a9b6d0; }
    .num-row{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }

    .stop-chip{ display:inline-flex; align-items:center; gap:10px; padding:8px 12px; border-radius:12px; border:2px solid #b91c1c; background:linear-gradient(135deg,#7f1d1d,#991b1b); color:#fff; font-weight:800; box-shadow:0 8px 20px rgba(0,0,0,.3); }
    .stop-chip .stop-icon{ width:34px; height:34px; border-radius:8px; background:#dc2626; border:3px solid #fca5a5; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:11px; }

    .footerbar{ position:fixed; left:0; right:0; bottom:0; background:linear-gradient(180deg,#0c1220,#0a0f1a); border-top:1px solid var(--line); padding:10px 16px; display:flex; justify-content:center; align-items:center; flex-wrap:wrap; gap:12px; z-index:50; }

    .aadt-tabs { display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin:8px 0 12px; }
    .aadt-tab { display:inline-block; padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:var(--pill); color:#fff; text-decoration:none; font-weight:700; font-size:13px; letter-spacing:.2px; }
    .aadt-tab:hover { background:#101a2b; }

    .stop-alert { display:none; position:sticky; top:0; z-index:60; margin-bottom:12px; }
    .stop-inner { display:flex; align-items:center; gap:14px; padding:12px 14px; border-radius:12px; border:2px solid #b91c1c; background:linear-gradient(135deg,#7f1d1d,#991b1b); color:#fff; box-shadow:0 12px 24px rgba(0,0,0,.35); }
    .stop-sign { width:52px; height:52px; flex:0 0 52px; border-radius:12px; background:#dc2626; border:4px solid #fca5a5; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:14px; }

    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; border-bottom:1px solid rgba(255,255,255,.06); padding:8px 6px; }
    th { font-size:12px; color:#cfd8ea; }
    tr:hover { background: rgba(255,255,255,.03); }
    .small { font-size:12px; color:#a9b6d0; }

    .cmp-dot{ display:inline-block; width:10px; height:10px; border-radius:50%; box-shadow:0 0 8px rgba(255,255,255,.18) inset; border:1px solid rgba(0,0,0,.35); }
    #go { width:100%; padding:16px; font-size:18px; margin-top:auto; }
    #refreshAfterChange { width:100%; margin-top:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Sunoco, LP Fuel IQ - Fuel Site Analyzer</h1>
      <span class="build">UI v2025‑10‑03</span>
      <a href="developments.html" style="padding:8px 14px; background:#22d3ee; border-radius:8px; color:#00121e; font-weight:600; text-decoration:none;">Developments Search</a>
      <a href="PA_Signals_AADT_Radius_Map_Final_Generated.html" style="padding:8px 14px; background:#f87171; border-radius:8px; color:#00121e; font-weight:600; text-decoration:none;">PA AADT Map</a>
      <a href="Scraper.html" style="padding:8px 14px; background:#34d399; border-radius:8px; color:#00121e; font-weight:600; text-decoration:none;">Prospector</a>
    </header>

    <div id="stopBox" class="stop-alert">
      <div class="stop-inner">
        <div class="stop-sign">STOP</div>
        <div id="stopText" style="font-weight:800;">Major development identified.</div>
      </div>
    </div>

    <nav class="aadt-tabs" aria-label="State AADT Quick Links">
      <span class="muted">State AADT Quick Links:</span>
      <a class="aadt-tab" href="https://opendata.dc.gov/datasets/DCGIS::2023-traffic-volume/explore" target="_blank" rel="noopener noreferrer">DC</a>
      <a class="aadt-tab" href="https://gis-fdot.opendata.arcgis.com/datasets/annual-average-daily-traffic-tda/explore" rel="noopener noreferrer">FL</a>
      <a class="aadt-tab" href="https://gdottrafficdata.drakewell.com/publicmultinodemap.asp" target="_blank" rel="noopener noreferrer">GA</a>
      <a class="aadt-tab" href="https://mhd.public.ms2soft.com/tcds/tsearch.asp?loc=Mhd&mod" target="_blank" rel="noopener noreferrer">MA</a>
      <a class="aadt-tab" href="https://nysdottrafficdata.drakewell.com/publicmultinodemap.asp" target="_blank" rel="noopener noreferrer">NY</a>
      <a class="aadt-tab" href="https://scdottrafficdata.drakewell.com/publicmultinodemap.asp" target="_blank" rel="noopener noreferrer">SC</a>
      <a class="aadt-tab" href="https://www.arcgis.com/apps/webappviewer/index.html?id=35e4c06de0f84a9c9f3fe18e67cd2c92" target="_blank" rel="noopener noreferrer">VA</a>
      <a class="aadt-tab" href="https://ncdot.public.ms2soft.com/tdms.ui_core/trafficviewer" target="_blank" rel="noopener noreferrer">NC</a>
    </nav>

    <div class="instructions">
      <b>Instructions:</b> Enter Address, Click <i>Estimate</i>. Do not exit your browser or let your phone screen shut off until results are ready. Click <i>Advanced Options</i> to make changes.
    </div>

    <div class="card">
      <div class="row input-row">
        <div>
          <label>Site Search</label>
          <div class="ac-wrap">
            <input id="addr" placeholder="Enter business or address" autocomplete="off" />
            <div id="ac" class="ac-list" style="display:none;"></div>
          </div>
          <div class="muted subtle" style="margin-top:6px" id="apiStatus">API Status: checking…</div>
        </div>
        <div><label>Regular MPDs</label><input id="mpds" type="number" value="3" min="1"/></div>
        <div><label>Diesel MPDs</label><input id="diesel" type="number" value="0" min="0"/></div>
        <div><label>Traffic pull %</label><input id="trafficPullPct" type="number" min="0" step="0.1" placeholder="Default 2"/></div>
        <div><label>Gallons per fill</label><input id="gallonsPerFill" type="number" min="0" step="0.1" placeholder="Default 8"/></div>
        <div>
          <label>AADT Confirmation*Required</label>
          <input id="aadtOverride" type="number" min="1"/>
          <button id="go">Estimate</button>
          <button id="refreshAfterChange" type="button">Refresh After Change</button>
        </div>
      </div>
      <div class="toolbar notes-toolbar">
        <label for="siteNotes" class="muted" style="margin:0;">User Entered Site Notes</label>
        <textarea id="siteNotes" placeholder="Add any site-specific observations that should appear in the summary and PDF."></textarea>
        <div class="muted subtle">Notes are saved with the estimate and exported to PDF.</div>
      </div>
    </div>

    <div class="card" id="mathCard">
      <b>Math & Assumptions (always shown)</b>
      <div id="mathTable" class="small" style="margin-top:8px; line-height:1.6">—</div>
    </div>

    <div class="card">
      <details>
        <summary><b>Advanced options</b></summary>
        <div class="adv-line">
          <label class="chip"><input type="checkbox" id="ex_large_dev"> Large residential or commercial developments being built (+7.5%)</label>
          <label class="chip"><input type="checkbox" id="ex_hours18"> Operating hours 18h (−7.5%)</label>
          <label class="chip"><input type="checkbox" id="ex_highincome"> Higher-income trade area (+2.5%)</label>
          <label class="chip"><input type="checkbox" id="ex_lowrating"> Ratings below 4.0 / Poorly run site (−30%)</label>
          <label class="chip"><input type="checkbox" id="ex_competitive_pricing"> Competitive site gas pricing (+10%)</label>
          <label class="chip"><input type="checkbox" id="ex_rural"> Rural Location Bonus (No competition within 3 miles) (+30%)</label>
        </div>
        <div style="margin-top:8px;">
          <label><b>Gas pricing vs area</b></label>
          <div class="radio-row">
            <label class="chip"><input type="radio" name="pricepos" value="below"> Below competition (+10%)</label>
            <label class="chip"><input type="radio" name="pricepos" value="inline" checked> In line (0%)</label>
            <label class="chip"><input type="radio" name="pricepos" value="above"> Above competition (−10%)</label>
          </div>
        </div>
        <div class="adv-line">
          <span class="chip" id="addExtra" style="cursor:pointer;">+ Add adj. (%)</span>
          <span id="activeExtras" class="subtle"></span>
        </div>
        <div id="extraList" style="margin-top:8px;"></div>
      </details>
    </div>

    <div class="card" id="estimateCard">
      <div class="hero">
        <div>
          <div>Adjusted Base Estimate (BASE)</div>
          <div class="num-row">
            <div class="num" id="estNum">—</div>
            <span id="fallbackChip" class="stop-chip" style="display:none;">
              <span class="stop-icon">STOP</span>
              Fallback AADT Used — Verify and Override AADT
            </span>
          </div>
          <div class="sub" id="estRange">Full range: —</div>
        </div>
        <div class="right sub">
          <div>Year-2: <b id="y2">—</b></div>
          <div>Year-3: <b id="y3">—</b></div>
        </div>
      </div>
      <hr/>
      <div id="aadtBanner" class="muted">—</div>
      <div id="compLine" class="muted">—</div>
    </div>

    <div class="card">
      <b>Competitors (independent layer)</b>
      <div class="adv-line" style="margin-top:4px">
        <label class="chip"><input type="checkbox" id="cmp_show" checked> Show Competitors</label>
        <label class="chip"><input type="checkbox" id="cmp_heat"> Heatmap</label>
        <label class="chip"><input type="checkbox" id="cmp_cluster" checked> Cluster markers</label>
        <span class="subtle" id="cmpStatus">—</span>
      </div>
      <details style="margin-top:8px;">
        <summary><b>Legend</b></summary>
        <div id="brandLegend" class="small" style="display:grid; grid-template-columns:1fr 1fr; gap:6px 14px; margin-top:8px;"></div>
      </details>
    </div>

    <div class="card">
      <b>Brand Filters & Live Stats</b>
      <div id="brandFilters" class="adv-line" style="flex-wrap:wrap; margin-top:8px;">
        <span class="subtle">Load competitors to see brand filters.</span>
      </div>
      <div class="adv-line" style="margin-top:8px;">
        <button id="brandsClear" class="chip" type="button">Clear</button>
        <button id="brandsAll" class="chip" type="button">Select All</button>
      </div>
      <div class="small" style="margin-top:8px; line-height:1.6;">
        <div>Visible competitors in view: <b id="liveCount">0</b></div>
        <div>Unique brands: <b id="liveUnique">0</b></div>
        <div id="liveBreakdown" style="margin-top:6px;"></div>
      </div>
    </div>

    <div class="card">
      <div class="muted" id="mapTitle">Map: Site & competitors (1.5 mi) + AADT dots + ⭐ AADT used</div>
      <div id="map"><div id="overlay" class="muted"></div></div>
      <div id="svWrap">
        <div class="muted" style="margin-top:10px;">Street View</div>
        <div id="sv" role="region" aria-label="Google Street View panorama" title="Google Street View panorama">
          <iframe
            id="svFrame"
            title="Google Street View"
            loading="lazy"
            allowfullscreen
            referrerpolicy="no-referrer-when-downgrade"
          ></iframe>
        </div>
        <div id="svStatus" class="muted subtle" style="margin-top:6px;">Street View will load after selecting a site.</div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <div class="muted">AADT Sources (within 1 mile)</div>
        <div id="aadtSourceLine" class="small">Source: state’s official AADT layer</div>
      </div>
      <div id="aadtMap" style="margin-top:8px;"></div>
      <div style="margin-top:10px; overflow:auto;">
        <table id="aadtTable">
          <thead><tr><th>Distance</th><th>AADT (Year)</th><th>Route</th><th>Location</th><th>Source</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card"><div id="devs" class="muted">—</div></div>

    <div class="card"><b>Google Rating</b><div id="ratingLine" class="muted">—</div></div>
    <div class="card"><b>Summary (GPT)</b><div id="summary" class="muted">—</div></div>
  </div>

  <div class="footerbar">
    <button id="exportPDF">Export to PDF</button>
  </div>

  <script>
/* -------------------- Shortcuts -------------------- */
const $ = (id) => document.getElementById(id);
const apiStatus = $("apiStatus"), aadtBanner = $("aadtBanner"), compLine = $("compLine"),
      overlay = $("overlay"), outNum = $("estNum"), outRange = $("estRange"),
      outY2 = $("y2"), outY3 = $("y3"), devsBox = $("devs"),
      summaryBox = $("summary"), ratingLine = $("ratingLine"),
      addrInput = $("addr"), acBox = $("ac"), goBtn = $("go"),
      trafficPullInput = $("trafficPullPct"), gallonsPerFillInput = $("gallonsPerFill"),
      aadtOverrideInput = $("aadtOverride"), siteNotesInput = $("siteNotes"),
      addExtraBtn = $("addExtra"), extraList = $("extraList"), activeExtras = $("activeExtras"),
      ex_large_dev = $("ex_large_dev"), ex_hours18 = $("ex_hours18"), ex_highincome = $("ex_highincome"),
      ex_lowrating = $("ex_lowrating"), ex_competitive_pricing = $("ex_competitive_pricing"),
      ex_rural = $("ex_rural"), aadtSourceLine = $("aadtSourceLine"), mathTableEl = $("mathTable"),
      fallbackChip = $("fallbackChip"), mapTitle = $("mapTitle"),
      exportBtn = $("exportPDF"), refreshBtn = $("refreshAfterChange"),
      svStatusLine = $("svStatus");

let svFrameCache = null;
function getStreetViewFrame(){
  if (svFrameCache && svFrameCache.isConnected) return svFrameCache;
  const el = document.getElementById("svFrame");
  if (!el) return null;
  svFrameCache = el;
  try { window.svFrame = el; } catch {}
  return el;
}

let streetViewUpdateToken = 0;
let lastStreetViewUrl = "";
let streetViewLoadTimer = null;

function setStreetViewMessage(text){ if (svStatusLine) svStatusLine.textContent = text || ""; }
function toggleStreetViewLoading(active){
  const wrap = document.getElementById("sv");
  if (!wrap) return;
  wrap.classList.toggle("sv-loading", !!active);
}

function buildStreetViewUrl(lat, lon){
  const clampedLat = Math.min(85, Math.max(-85, Number(lat) || 0));
  const clampedLon = Math.min(180, Math.max(-180, Number(lon) || 0));
  const latFixed = clampedLat.toFixed(6);
  const lonFixed = clampedLon.toFixed(6);
  return `https://maps.google.com/maps?q=&layer=c&cbll=${latFixed},${lonFixed}&cbp=11,0,,0,0&output=svembed`;
}

function clearStreetViewTimer(){
  if (streetViewLoadTimer) {
    clearTimeout(streetViewLoadTimer);
    streetViewLoadTimer = null;
  }
}

function resetStreetViewFrame(frame){
  if (!frame) return;
  try {
    frame.removeAttribute("src");
    frame.dataset.loaded = "";
  } catch {}
  clearStreetViewTimer();
  frame.onload = null;
  frame.onerror = null;
}

/* Competitor UI */
const cmpShow = $("cmp_show"), cmpHeat = $("cmp_heat"), cmpCluster = $("cmp_cluster"), cmpStatus = $("cmpStatus");
const brandLegend = $("brandLegend"), brandFilters = $("brandFilters"), brandsClear = $("brandsClear"), brandsAll = $("brandsAll");
const liveCount = $("liveCount"), liveUnique = $("liveUnique"), liveBreakdown = $("liveBreakdown");

/* State */
let map, layer, serverCompLayer, mapReady = false, selectedCoords = null, selectedPlaceId = null;
let aadtMap, aadtLayer, aadtReady = false;
let acItems = [], acActive = -1; // suggestions & keyboard index
let lastSelectedDisplay = "";     // for extracting road name
let acRequestToken = 0;           // latest autocomplete request id
let skipNextInputReset = false;   // prevent clearing coords when setting value programmatically
let selectedNormalized = null;    // normalized address fields for persistence/server
let lastStoredKey = null;         // dedupe persisted address writes
let baseSummaryText = "";

function updateSummaryDisplay(){
  if (!summaryBox) return;
  const base = (baseSummaryText || "").trim();
  const notes = siteNotesInput ? siteNotesInput.value.trim() : "";
  let text = base;
  if (!text && notes) text = `User Entered Site Notes: ${notes}`;
  summaryBox.textContent = text || "—";
}
if (siteNotesInput) siteNotesInput.addEventListener("input", updateSummaryDisplay);
updateSummaryDisplay();

if (refreshBtn) {
  refreshBtn.addEventListener("click", () => {
    window.location.reload();
  });
}

/* Utils */
function fmt(n){ return (n??0).toLocaleString(undefined,{maximumFractionDigits:0}); }
function fmtFloat(n){
  if(!Number.isFinite(n)) return "";
  return Number(n).toFixed(2).replace(/\.00$/,"").replace(/(\.\d)0$/,"$1");
}
function getBaselineInputs(){
  const pctRaw = +(trafficPullInput?.value || "");
  const gallonsRaw = +(gallonsPerFillInput?.value || "");
  const hasCustomTraffic = Number.isFinite(pctRaw) && pctRaw > 0;
  const hasCustomGallons = Number.isFinite(gallonsRaw) && gallonsRaw > 0;
  const trafficPullPct = hasCustomTraffic ? pctRaw : 2;
  const gallonsPerFill = hasCustomGallons ? gallonsRaw : 8;
  return {
    trafficShare: trafficPullPct / 100,
    trafficPullPct,
    gallonsPerFill,
    hasCustomTraffic,
    hasCustomGallons,
    days: 30,
  };
}
function formatBaselineLine(aadtVal, baselineComponents, baselineValue){
  let pct = null, gallons = null, days = null;
  if (baselineComponents) {
    if (Number.isFinite(baselineComponents.trafficPullPct)) pct = baselineComponents.trafficPullPct;
    else if (Number.isFinite(baselineComponents.traffic_share_pct)) pct = baselineComponents.traffic_share_pct;
    else if (Number.isFinite(baselineComponents.trafficShare)) pct = baselineComponents.trafficShare * 100;
    if (Number.isFinite(baselineComponents.gallonsPerFill)) gallons = baselineComponents.gallonsPerFill;
    else if (Number.isFinite(baselineComponents.gallons_per_fill)) gallons = baselineComponents.gallons_per_fill;
    if (Number.isFinite(baselineComponents.days)) days = baselineComponents.days;
  }
  if (!Number.isFinite(days)) days = 30;
  const defaults = (!Number.isFinite(pct) || !Number.isFinite(gallons)) ? getBaselineInputs() : null;
  if (!Number.isFinite(pct) && defaults) pct = defaults.trafficPullPct;
  if (!Number.isFinite(gallons) && defaults) gallons = defaults.gallonsPerFill;
  const aadtText = Number.isFinite(aadtVal) ? fmt(aadtVal) : "—";
  const baselineText = Number.isFinite(baselineValue) ? fmt(baselineValue) : "—";
  const parts = [`AADT ${aadtText}`];
  if (Number.isFinite(pct)) parts.push(`${fmtFloat(pct)}% traffic pull`);
  if (Number.isFinite(gallons)) parts.push(`${fmtFloat(gallons)} gal/fill`);
  if (Number.isFinite(days)) parts.push(`${fmtFloat(days)} days`);
  return `<b>AADT math</b>: ${parts.join(" × ")} = <b>${baselineText}</b>`;
}
function esc(s){ return (s??"").toString().replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function formatNominatimDisplay(row){
  if(!row) return "";
  const addr = row.address || {};
  const street = (()=>{
    const road = addr.road || addr.residential || addr.pedestrian || addr.path || addr.cycleway || addr.footway;
    const house = addr.house_number || addr.house_name || "";
    const parts = [];
    if (house) parts.push(String(house));
    if (road) parts.push(String(road));
    return parts.join(" ").trim();
  })();
  const locality = addr.city || addr.town || addr.village || addr.hamlet || addr.county || "";
  const regionParts = [locality, addr.state || addr.state_district || "", addr.postcode || ""].filter(Boolean);
  const tail = regionParts.join(", ");
  if (street && tail) return `${street}, ${tail}`;
  if (street) return street;
  if (tail) return tail;
  return row.display_name || "";
}
function buildOsmNormalized(row){
  if(!row) return null;
  const addr = row.address || {};
  const lat = Number(row.lat), lon = Number(row.lon);
  if(!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
  const number = addr.house_number || addr.house_name || "";
  const road = addr.road || addr.residential || addr.pedestrian || addr.path || addr.cycleway || addr.footway || "";
  const line1Raw = [number, road].filter(Boolean).join(" ").trim();
  const city = addr.city || addr.town || addr.village || addr.hamlet || "";
  const county = addr.county || "";
  const state = addr.state || addr.state_district || "";
  const postcode = addr.postcode || "";
  const countryCode = addr.country_code ? String(addr.country_code).toUpperCase() : "";
  const country = countryCode || addr.country || "";
  const formatted = row.display_name || [line1Raw, city, state, postcode].filter(Boolean).join(", ");
  const line1 = line1Raw || (formatted.split(",")[0] || "").trim();
  return {
    formatted,
    line1,
    city,
    county,
    state,
    postcode,
    country,
    lat,
    lon,
    source: "OSM",
    place_id: row.place_id || null,
    raw: addr,
  };
}
function storageKeyForItem(it){
  if (!it) return null;
  if (it.storageKey) return it.storageKey;
  if (it.place_id) return `${it.type||""}:${it.place_id}`;
  const n = it.normalized;
  if (n && Number.isFinite(n.lat) && Number.isFinite(n.lon)) {
    return `${it.type||""}:${n.lat.toFixed(6)},${n.lon.toFixed(6)}`;
  }
  return null;
}
async function persistNormalizedSelection(item){
  if(!item || !item.normalized) return;
  const key = storageKeyForItem(item);
  if(key && key === lastStoredKey) return;
  try{
    const payload = {
      input: addrInput.value.trim(),
      normalized: item.normalized,
      source: item.type || item.normalized?.source || null,
      place_id: item.place_id || item.normalized?.place_id || null
    };
    await fetch("/api/addresses", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    if(key) lastStoredKey = key;
  }catch(err){
    console.warn("Failed to store normalized address", err);
    if(key) lastStoredKey = null;
  }
}
function setOverlayWorking(msg="Working…"){ overlay.textContent = msg; overlay.style.display = "flex"; }
function clearOverlay(){ overlay.style.display = "none"; }

/* -------------------- Map & SV -------------------- */
function initMap(){ if(mapReady) return;
  map = L.map("map",{zoomControl:true}); window.map = map;
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{ attribution:"&copy; OpenStreetMap", crossOrigin:true }).addTo(map);
  layer = L.layerGroup().addTo(map);
  serverCompLayer = L.layerGroup().addTo(map);
  mapReady = true;
  map.on("moveend", () => { if (cmpShow.checked) refreshCompetitors(); updateLiveStats(); });
}
function initAADTMap(){ if(aadtReady) return;
  aadtMap = L.map("aadtMap",{zoomControl:true}); window.aadtMap = aadtMap;
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{ attribution:"&copy; OpenStreetMap", crossOrigin:true }).addTo(aadtMap);
  aadtLayer = L.layerGroup().addTo(aadtMap); aadtReady = true;
}
function updateStreetView(lat, lon){
  const frame = getStreetViewFrame();
  if (!frame) return;
  if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
    resetStreetViewFrame(frame);
    lastStreetViewUrl = "";
    toggleStreetViewLoading(false);
    setStreetViewMessage("Street View will load after selecting a site.");
    return;
  }
  const url = buildStreetViewUrl(lat, lon);
  if (url === lastStreetViewUrl && frame.dataset.loaded === "1") {
    setStreetViewMessage("Street View ready. Drag to explore this site.");
    return;
  }
  const token = ++streetViewUpdateToken;
  lastStreetViewUrl = url;
  resetStreetViewFrame(frame);
  toggleStreetViewLoading(true);
  setStreetViewMessage("Loading Street View…");

  frame.onload = () => {
    if (token !== streetViewUpdateToken) return;
    frame.dataset.loaded = "1";
    clearStreetViewTimer();
    frame.onload = null;
    frame.onerror = null;
    setStreetViewMessage("Street View ready. Drag to explore this site.");
    toggleStreetViewLoading(false);
  };
  frame.onerror = () => {
    if (token !== streetViewUpdateToken) return;
    lastStreetViewUrl = "";
    clearStreetViewTimer();
    frame.onload = null;
    frame.onerror = null;
    setStreetViewMessage("Street View unavailable at this location.");
    toggleStreetViewLoading(false);
  };

  streetViewLoadTimer = setTimeout(() => {
    if (token !== streetViewUpdateToken) return;
    frame.onload = null;
    frame.onerror = null;
    toggleStreetViewLoading(false);
    setStreetViewMessage("Street View may be unavailable for this spot.");
  }, 12000);

  try {
    frame.src = url;
  } catch (err) {
    console.warn("Street View iframe update failed", err);
    frame.onerror?.();
  }
}
function renderAADTMarkers(list, used) {
  if (!Array.isArray(list)) return;
  for (const rec of list) {
    if (!Number.isFinite(rec.lat) || !Number.isFinite(rec.lon) || !Number.isFinite(rec.aadt)) continue;
    const val = rec.aadt;
    let color = (val>=30000)?"#be123c":(val>=20000)?"#f97316":(val>=10000)?"#eab308":"#84cc16";
    L.circleMarker([rec.lat, rec.lon], { radius: 5, weight: 1, color, fillColor: color, fillOpacity: 0.8 })
      .addTo(layer).bindPopup("AADT: " + fmt(val) + (rec.year?` (${rec.year})`:""));
  }
  if (used && Number.isFinite(used.lat) && Number.isFinite(used.lon)) {
    L.marker([used.lat, used.lon], { title:"AADT used", icon: L.divIcon({ className:"aadt-used", html:'<div style="font-size:18px;">⭐</div>', iconSize:[24,24], iconAnchor:[12,12] }) })
      .addTo(layer).bindPopup(`<b>USED AADT</b><br>${fmt(used.aadt)}${used.year?` (${used.year})`:''}<br>${esc(used.route||'')}`);
  }
}
function initOrUpdateMainMap(m){
  if(!mapReady) initMap();
  layer.clearLayers(); serverCompLayer.clearLayers();
  if(!m || !m.site) return;
  const site = [m.site.lat, m.site.lon];
  L.marker(site,{title:"Site"}).addTo(layer).bindPopup("<b>Site</b>");
  const pts = [site];
  if (m.aadt) renderAADTMarkers(m.aadt, m.aadt_used);
  const comps = m.all_competitors || m.competitors || [];
  for(const c of comps){
    if(!Number.isFinite(c.lat)||!Number.isFinite(c.lon)) continue;
    pts.push([c.lat,c.lon]);
    const dot = L.circleMarker([c.lat,c.lon],{ radius:7, weight:1.5, color:c.heavy?"#ff7f50":"#4ade80", fillColor:c.heavy?"#ff7f50":"#4ade80", fillOpacity:.95 })
      .addTo(serverCompLayer).bindPopup(`${esc(c.name||"Fuel")} - ${c.miles} mi`);
    if (dot.bringToFront) dot.bringToFront();
  }
  if (cmpShow.checked) { if (map.hasLayer(serverCompLayer)) map.removeLayer(serverCompLayer); }
  else { if (!map.hasLayer(serverCompLayer)) serverCompLayer.addTo(map); }
  map.fitBounds(L.latLngBounds(pts).pad(0.25));
  updateStreetView(site[0], site[1]);
}
function initOrUpdateAADTMap(site, items, used){
  if(!aadtReady) initAADTMap();
  aadtLayer.clearLayers();
  if(!site) return;
  const siteLL = [site.lat, site.lon];
  const bounds = [siteLL];
  L.marker(siteLL,{title:"Site"}).addTo(aadtLayer).bindPopup("<b>Site</b>");
  for (const s of (items||[])) {
    const color = s.aadt >= 30000 ? "#be123c" : s.aadt >= 20000 ? "#f97316" : s.aadt >= 10000 ? "#eab308" : "#84cc16";
    L.circleMarker([s.lat, s.lon], { radius: 5, weight:1, color, fillColor: color, fillOpacity:.85 })
      .addTo(aadtLayer)
      .bindPopup(`<b>${fmt(s.aadt)}${s.year?` (${s.year})`:''}</b><br>${esc(s.route||'')}${s.location?`<br>${esc(s.location)}`:''}<br><span class="small">~${s.miles} mi</span>`);
    bounds.push([s.lat, s.lon]);
  }
  if (used && Number.isFinite(used.lat) && Number.isFinite(used.lon)) {
    L.marker([used.lat, used.lon], { title:"AADT used", icon: L.divIcon({ className:"aadt-used-2", html:'<div style="font-size:18px;">⭐</div>', iconSize:[24,24], iconAnchor:[12,12] }) })
      .addTo(aadtLayer).bindPopup(`<b>USED AADT</b><br>${fmt(used.aadt)}${used.year?` (${used.year})`:''}<br>${esc(used.route||'')}`);
    bounds.push([used.lat, used.lon]);
  }
  aadtMap.fitBounds(L.latLngBounds(bounds).pad(0.25));
}
function renderAADTTable(items){
  const tb = document.querySelector("#aadtTable tbody");
  tb.innerHTML = (items||[]).map(s => {
    const src = s.source_url ? `<a href="${s.source_url}" target="_blank">Source</a>` : "";
    return `<tr><td>~${s.miles} mi</td><td>${fmt(s.aadt)}${s.year?` <span class="small">(${s.year})</span>`:''}</td><td>${esc(s.route||'')}</td><td>${esc(s.location||'')}</td><td>${src}</td></tr>`;
  }).join("");
}

/* -------------------- Advanced pills -------------------- */
function pills(){
  const p=[];
  if($("ex_large_dev").checked) p.push("+7.5% Large development nearby");
  if($("ex_hours18").checked)  p.push("−7.5% 18h ops");
  if($("ex_highincome").checked) p.push("+2.5% Higher-income");
  if($("ex_lowrating").checked)  p.push("−30% Rating < 4.0");
  if($("ex_competitive_pricing").checked)  p.push("+10% Competitive site gas pricing");
  if($("ex_rural").checked) p.push("+30% Rural bonus (0 comps within 3 mi)");
  $("activeExtras").innerHTML = p.map(x=>`<span class="badge">${esc(x)}</span>`).join(" ");
}
["ex_large_dev","ex_hours18","ex_highincome","ex_lowrating","ex_competitive_pricing","ex_rural"].forEach(id=>$(id).addEventListener("change",pills));

function addExtraRow(pct="",note=""){
  const row=document.createElement("div");
  row.style.marginTop="6px";
  row.innerHTML=`<span class="chip"><input class="extraPct" type="number" step="0.1" style="width:90px" placeholder="% e.g. 5 or -3" value="${pct}">
  <input class="extraNote" style="width:320px" placeholder="Comment" value="${esc(note)}"> <button class="rm" type="button">×</button></span>`;
  row.querySelector(".rm").addEventListener("click",()=>row.remove());
  $("extraList").appendChild(row);
}
$("addExtra").addEventListener("click",()=>addExtraRow());

function collectExtras(){
  const out=[];
  if($("ex_large_dev").checked) out.push({pct:7.5, note:"Large residential/commercial developments"});
  if($("ex_hours18").checked)  out.push({pct:-7.5, note:"18h ops"});
  if($("ex_highincome").checked) out.push({pct:2.5, note:"Higher income"});
  if($("ex_lowrating").checked)  out.push({pct:-30, note:"Rating < 4.0"});
  if($("ex_competitive_pricing").checked)  out.push({pct:10, note:"Competitive site gas pricing"});
  for(const chip of $("extraList").querySelectorAll(".chip")){
    const pct = +chip.querySelector(".extraPct").value;
    const note = chip.querySelector(".extraNote").value.trim();
    if(Number.isFinite(pct)) out.push({pct, note});
  }
  return out;
}
function getExtrasMultiplierPreview(){
  const extras = collectExtras();
  let mult = extras.reduce((m,e) => m * (1 + (Number(e.pct) || 0) / 100), 1);
  if (ex_rural?.checked) mult *= 1.30;
  return mult;
}
function getFlags(){ return { rural: $("ex_rural").checked === true }; }
function getPricePosition(){ const r=document.querySelector('input[name="pricepos"]:checked'); return r ? r.value : "inline"; }

/* -------------------- API helpers -------------------- */
function parseRoadFromDisplay(display){
  // Use first comma section, then strip leading house number/Apt/Suite
  let first = String(display||"").split(",")[0] || "";
  first = first.replace(/\b(Suite|Ste|Apt|Unit)\b.*$/i, "");
  first = first.replace(/^\s*\d+[A-Za-z-]?\s*,?\s*/, "");
  return first.trim();
}
async function safeJSON(url,opts){ const r=await fetch(url,opts); const t=await r.text(); try{ return JSON.parse(t);}catch{ throw new Error("Bad JSON"); } }
async function callEstimate(){
  const baselineInputs = getBaselineInputs();
  const body = {
    address: addrInput.value.trim(),
    mpds: +$("mpds").value || 0,
    diesel: +$("diesel").value || 0,
    advanced: { extra: collectExtras(), flags: getFlags(), price_position: getPricePosition() },
    enteredRoad: parseRoadFromDisplay(lastSelectedDisplay || addrInput.value.trim())
  };
  if (baselineInputs.hasCustomTraffic) body.trafficPullPct = baselineInputs.trafficPullPct;
  if (baselineInputs.hasCustomGallons) body.gallonsPerFill = baselineInputs.gallonsPerFill;
  if(selectedCoords){ body.siteLat = selectedCoords.lat; body.siteLon = selectedCoords.lon; }
  if(selectedNormalized){ body.normalizedAddress = selectedNormalized; }
  const notes = siteNotesInput ? siteNotesInput.value.trim() : "";
  if (notes) body.siteNotes = notes;
  const ov = +(aadtOverrideInput.value || ""); if(Number.isFinite(ov) && ov > 0) body.aadtOverride = ov;
  return await safeJSON("/estimate", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)});
}
/* -------------------- Math rendering -------------------- */
function canEstimate(){
  const val = +(aadtOverrideInput.value || "");
  return Number.isFinite(val) && val > 0;
}
function updateGoButtonState(){
  const enabled = canEstimate();
  goBtn.disabled = !enabled;
  return enabled;
}
aadtOverrideInput.addEventListener("input", () => updateGoButtonState());
updateGoButtonState();
function renderMathFromServer(d){
  const B = d && d.calc_breakdown;
  if(!B){ renderMathFallback(buildCalcFallback(d)); return; }

  const baseline    = B.baseline || 0;
  const compAfter   = B.compRule?.afterComp ?? baseline;
  const baseMult    = B.compRule?.baseMult ?? 1;
  const heavyPen    = B.compRule?.heavyPenalty ?? 0;
  const compMult    = B.compRule?.compMult ?? 1;
  const compCount   = d?.competition?.count ?? B.compRule?.compCount ?? (d?.map?.competitors?.length ?? 0);
  const heavyCount  = d?.competition?.heavy_count ?? B.compRule?.heavyCount ?? (d?.map?.competitors?.filter?.(c=>c.heavy)?.length ?? 0);
  const capEquip    = B.caps?.capEquip ?? compAfter;
  const capSoft     = B.caps?.capSoftTotal ?? compAfter;
  const capHard     = B.caps?.capHardTotal ?? compAfter;
  const minCap      = Math.min(compAfter, capEquip, capHard);
  const softHit     = compAfter > capSoft;
  const afterCap    = Math.round(softHit ? minCap * 0.9 : minCap);
  const priceMult   = B.priceMult ?? 1;
  const afterPrice  = Math.round(afterCap * priceMult);
  const extrasMult  = B.extrasMult ?? 1;
  const preClamp    = B.preClamp ?? Math.round(afterPrice * extrasMult);
  const finalBase   = B.finalClampedToBaseline ?? Math.min(preClamp, baseline);
  const base        = d?.estimate?.base ?? d?.base ?? finalBase;
  const low         = d?.estimate?.low ?? d?.low ?? (Number.isFinite(base) ? Math.round(base * 0.86) : null);
  const high        = d?.estimate?.high ?? d?.high ?? (Number.isFinite(base) ? Math.round(base * 1.06) : null);
  const rangeTxt    = d?.estimate?.range || (Number.isFinite(low) && Number.isFinite(high) ? `${fmt(low)}–${fmt(high)}` : "—");
  const y2          = d?.estimate?.year2 ?? d?.year2 ?? (Number.isFinite(base) ? Math.round(base * 1.027) : null);
  const y3          = d?.estimate?.year3 ?? d?.year3 ?? (Number.isFinite(base) ? Math.round(base * 1.027 * 1.0125) : null);
  const aadtUsed    = d?.inputs?.aadt_used ?? null;
  const y2Txt       = Number.isFinite(y2) ? fmt(y2) : "—";
  const y3Txt       = Number.isFinite(y3) ? fmt(y3) : "—";
  const baseTxt     = Number.isFinite(base) ? fmt(base) : "—";

  const rows = [
    formatBaselineLine(aadtUsed, B.baselineComponents, baseline),
    `<b>Competitors in area</b> (1.5 mi): <b>${compCount}</b> total • Big box <b>${heavyCount}</b>`,
    `Competition rule: base ${baseMult.toFixed ? baseMult.toFixed(2) : baseMult} − Big box ${heavyPen.toFixed ? heavyPen.toFixed(2) : heavyPen} = × ${compMult.toFixed ? compMult.toFixed(2) : compMult} → <b>${fmt(compAfter)}</b>`,
    `Capacity caps (equipment/soft/hard): ${fmt(capEquip)} / ${fmt(capSoft)} / ${fmt(capHard)}${softHit ? " • soft penalty −10%" : ""} → <b>${fmt(afterCap)}</b>`,
    `Pricing factor: × ${priceMult} → <b>${fmt(afterPrice)}</b>`,
    `Extras: × ${extrasMult} → <b>${fmt(preClamp)}</b>`,
    `Baseline clamp: min(pre‑clamp, baseline) → <b>${fmt(finalBase)}</b>`,
    `<b>Final (BASE)</b>: <b>${baseTxt}</b> | Range: ${rangeTxt} | Y2: ${y2Txt} | Y3: ${y3Txt}`
  ];
  $("mathTable").innerHTML = rows.map(r=>`<div>${r}</div>`).join('');
}
function buildCalcFallback(d){
  try{
    const aadt = (d?.map?.aadt_used?.aadt) || (+(aadtOverrideInput.value || 0)) || null;
    const mpd = +($("mpds").value || 0);
    const diesel = +($("diesel").value || 0);
    if(!aadt) return null;
    const baselineInputs = getBaselineInputs();
    const ceiling = aadt * baselineInputs.trafficShare * baselineInputs.gallonsPerFill * baselineInputs.days;
    const mpd_cap = (mpd + diesel) * 25 * 12 * 30; // UI rough
    const after_cap = Math.min(ceiling, mpd_cap);
    const priceMult = getPricePosition()==='below'?1.10:(getPricePosition()==='above'?0.90:1.00);
    const extrasMult = getExtrasMultiplierPreview();
    const priceApplied = Math.round(after_cap * priceMult);
    const extrasApplied = Math.round(priceApplied * extrasMult);
    const base = Math.min(extrasApplied, Math.round(ceiling));
    return {
      aadt,
      ceiling,
      regular_mpd: mpd,
      diesel_mpd: diesel,
      mpd_cap,
      after_cap,
      priceMult,
      extrasMult,
      priceApplied,
      after_extras: extrasApplied,
      base,
      low: Math.round(base*0.86),
      high: Math.round(base*1.06),
      year2: Math.round(base*1.027),
      year3: Math.round(base*1.027*1.0125),
      baselineComponents: baselineInputs,
    };
  }catch{return null;}
}
function renderMathFallback(calc){
  if(!calc){ $("mathTable").innerHTML = '<em>— (no calc available)</em>'; return; }
  const rows = [
    formatBaselineLine(calc.aadt, calc.baselineComponents, calc.ceiling),
    `Capacity cap (MPDs ${calc.regular_mpd}+${calc.diesel_mpd} diesel): <b>${fmt(calc.mpd_cap)}</b>`,
    `After cap: <b>${fmt(calc.after_cap)}</b>`,
  ];
  if (Number.isFinite(calc.priceMult)) {
    rows.push(`Pricing factor: × ${fmtFloat(calc.priceMult)} → <b>${fmt(calc.priceApplied)}</b>`);
  }
  if (Number.isFinite(calc.extrasMult) && Math.abs(calc.extrasMult - 1) > 0.0001) {
    rows.push(`Extras: × ${fmtFloat(calc.extrasMult)} → <b>${fmt(calc.after_extras)}</b>`);
  }
  const baseTxt = Number.isFinite(calc.base) ? fmt(calc.base) : "—";
  const y2Txt = Number.isFinite(calc.year2) ? fmt(calc.year2) : "—";
  const y3Txt = Number.isFinite(calc.year3) ? fmt(calc.year3) : "—";
  rows.push(`Clamp to baseline: min(${fmt(calc.after_extras ?? calc.priceApplied)}, ${fmt(calc.ceiling)}) → <b>${baseTxt}</b>`);
  rows.push(`<b>Final (BASE)</b>: <b>${baseTxt}</b> | Range: ${fmt(calc.low)}–${fmt(calc.high)} | Y2: ${y2Txt} | Y3: ${y3Txt}`);
  $("mathTable").innerHTML = rows.map(r=>`<div>${r}</div>`).join('');
}

/* -------------------- Fallback detection -------------------- */
function isFallbackAADT(d){ const m = d?.inputs?.aadt_components?.method || d?.map?.aadt_used?.method || ""; return m === "fallback_no_dot_found" || m === "fallback_low_aadt"; }

/* -------------------- Rendering (Estimate) -------------------- */
function renderAll(d){
  const base = d.estimate?.base ?? d.base ?? d.estimate?.low ?? d.low ?? null;
  const low = d.estimate?.low ?? d.low ?? (Number.isFinite(base) ? Math.round(base * 0.86) : null);
  const high = d.estimate?.high ?? d.high ?? (Number.isFinite(base) ? Math.round(base * 1.06) : null);
  if (Number.isFinite(base)) $("estNum").textContent = fmt(base);
  else $("estNum").textContent = "—";
  const rangeTxt = d.estimate?.range || (Number.isFinite(low) && Number.isFinite(high) ? `${fmt(low)}–${fmt(high)}` : "—");
  $("estRange").textContent = "Full range: " + rangeTxt;
  const y2Val = d.estimate?.year2 ?? d.year2 ?? (Number.isFinite(base) ? Math.round(base * 1.027) : null);
  const y3Val = d.estimate?.year3 ?? d.year3 ?? (Number.isFinite(base) ? Math.round(base * 1.027 * 1.0125) : null);
  $("y2").textContent = Number.isFinite(y2Val) ? fmt(y2Val) : "—";
  $("y3").textContent = Number.isFinite(y3Val) ? fmt(y3Val) : "—";

  const fallback = isFallbackAADT(d);
  const usedRec  = d?.map?.aadt_used || {};
  const usedVal  = usedRec?.aadt ?? d?.inputs?.aadt_used ?? null;
  if (fallback && usedVal) { $("aadtBanner").textContent = `AADT: ${fmt(usedVal)} vehicles/day (fallback)`; $("fallbackChip").style.display = "inline-flex"; }
  else { $("aadtBanner").textContent = d.aadtText || (usedVal ? `AADT: ${fmt(usedVal)} vehicles/day` : "—"); $("fallbackChip").style.display = "none"; }

  if (d.calc_breakdown) renderMathFromServer(d);
  else renderMathFallback(buildCalcFallback(d));

  $("compLine").textContent = d.competitionText || "—";

  const hasDevs = Array.isArray(d.csv) && d.csv.length > 0;
  if (hasDevs) {
    const lines = d.csv.slice(0,6).map((x) => {
      const parts = [];
      if (x.name) parts.push(esc(x.name));
      if (x.status) parts.push(esc(x.status));
      if (x.details) parts.push(esc(x.details));
      if (x.date) parts.push(esc(x.date));
      return parts.join("; ");
    }).join(" // ");
    $("stopText").innerHTML = `Development flagged: <b>${lines}</b>`;
    $("stopBox").style.display = "block";
    $("devs").innerHTML = "<ul>"+d.csv.map((x) => {
      const parts = [];
      if (x.name) parts.push(esc(x.name));
      if (x.status) parts.push(esc(x.status));
      if (x.details) parts.push(esc(x.details));
      if (x.date) parts.push(esc(x.date));
      return `<li>${parts.join("; ")}</li>`;
    }).join("")+"</ul>";
  } else { $("stopBox").style.display = "none"; $("devs").innerHTML = "<em>No developments flagged</em>"; }

  baseSummaryText = (d.summary_base ?? d.summary ?? "").replace(/\s{2,}/g," ").trim();
  if (siteNotesInput) {
    const returnedNotes = typeof d.siteNotes === "string" ? d.siteNotes : "";
    siteNotesInput.value = returnedNotes;
  }
  updateSummaryDisplay();

  initOrUpdateMainMap(d.map);
  if (d?.map?.competitor_radius_mi) $("mapTitle").textContent = `Map: Site & competitors (${d.map.competitor_radius_mi} mi) + AADT dots + ⭐ AADT used`;

  if (d?.map?.site) {
    fetch(`/aadt/nearby?lat=${encodeURIComponent(d.map.site.lat)}&lon=${encodeURIComponent(d.map.site.lon)}&radiusMi=1`)
      .then(r => r.json()).then(j => {
        if (j.ok) { initOrUpdateAADTMap(d.map.site, j.items, d.map.aadt_used || null); renderAADTTable(j.items);
          const st = j.state || "NC";
          const srcMap = { NC: "NCDOT AADT Stations (official)", VA: "VDOT Traffic Volume ADT (official)", DC: "DDOT 2023 Traffic Volume (official)", FL: "FDOT AADT (TDA/RCI) (official)" };
          $("aadtSourceLine").textContent = "Source: " + (srcMap[st] || "official state AADT");
        }
      }).catch(()=>{});
  }
  showRating(addrInput.value.trim());
}

/* -------------------- Rating helpers -------------------- */
async function resolvePlaceIdIfNeeded(address){
  if (selectedPlaceId) return selectedPlaceId;
  try {
    const bias = mapReady && map ? (()=>{ const c = map.getCenter(); return `&lat=${encodeURIComponent(c.lat)}&lon=${encodeURIComponent(c.lng)}&radius=50000`; })() : "";
    const r = await fetch("/google/findplace?input=" + encodeURIComponent(address) + bias);
    const j = await r.json();
    if (j.ok && j.place_id) { selectedPlaceId = j.place_id; return j.place_id; }
  } catch {}
  return null;
}
async function showRating(address){
  let rating = null, total = null;
  const pid = await resolvePlaceIdIfNeeded(address);
  if (pid) {
    try { const r = await fetch("/google/rating?place_id=" + encodeURIComponent(pid)); const j = await r.json(); if (j.ok) { rating = j.rating ?? null; total = j.total ?? null; } } catch {}
  }
  if ((rating == null || rating === undefined) && selectedCoords) {
    try { const r2 = await fetch("/google/rating_by_location?lat=" + encodeURIComponent(selectedCoords.lat) + "&lon=" + encodeURIComponent(selectedCoords.lon));
      const j2 = await r2.json(); if (j2.ok) { rating = j2.rating ?? null; total = j2.total ?? null; } } catch {}
  }
  $("ratingLine").innerHTML = (rating != null && rating !== undefined) ? `\u2B50 ${rating} (${total||0} reviews)` : "—";
}

/* -------------------- Autocomplete (always on) -------------------- */
function hideAc(){ acBox.style.display = "none"; acActive = -1; }
function rankAutocompleteItems(q, items){
  const Q = q.trim().toLowerCase();
  return [...items].sort((a,b)=>{
    const A = (a.display||"").toLowerCase(), B = (b.display||"").toLowerCase();
    const aw = Number.isFinite(a.score)?a.score:(a.type==="Google"?1.2:0.8);
    const bw = Number.isFinite(b.score)?b.score:(b.type==="Google"?1.2:0.8);
    const aStarts = A.startsWith(Q)?3: (A.includes(Q)?1:0);
    const bStarts = B.startsWith(Q)?3: (B.includes(Q)?1:0);
    const aIdx = A.indexOf(Q); const bIdx = B.indexOf(Q);
    const aPen = aIdx>=0 ? aIdx/40 : 1.5;
    const bPen = bIdx>=0 ? bIdx/40 : 1.5;
    const as = aw + aStarts - aPen;
    const bs = bw + bStarts - bPen;
    return bs - as;
  });
}
function renderAc(list){
  if(!list.length){ hideAc(); return; }
  acBox.innerHTML = list.map((it,i) =>
    `<div class="ac-item${i===acActive?" active":""}" data-i="${i}">${esc(it.display)} <span class="badge">${it.type}</span></div>`
  ).join("");
  [...acBox.children].forEach(el => el.onclick = () => chooseAc(+el.dataset.i));
  acBox.style.display = "block";
}
async function googleSearch(q){
  try {
    const bias = mapReady && map ? (()=>{ const c = map.getCenter(); return `&lat=${encodeURIComponent(c.lat)}&lon=${encodeURIComponent(c.lng)}&radius=50000`; })() : "";
    const r = await fetch("/google/autocomplete?input=" + encodeURIComponent(q) + bias);
    const j = await r.json();
    if(!j.ok) return [];
    return (j.items||[]).map(it => ({...it, type:"Google", score:Number.isFinite(it.score)?it.score:1.3}));
  } catch { return []; }
}
async function nominatimSearch(q){
  try {
    const r = await fetch("/osm/autocomplete?q=" + encodeURIComponent(q));
    const j = await r.json();
    if(!j.ok) return [];
    return (j.items||[]).map(it => ({...it, type: it.type || "OSM", score: Number.isFinite(it.score)?it.score:0.7}));
  } catch { return []; }
}
async function fetchGoogleDetails(placeId){
  if(!placeId) return null;
  try {
    const r = await fetch("/google/place_details?place_id=" + encodeURIComponent(placeId));
    const j = await r.json();
    if(j.ok && j.item) return j.item;
  } catch {}
  return null;
}
async function chooseAc(i){
  try {
    const base = acItems[i];
    if (!base) return;
    acRequestToken++; // cancel any in-flight autocomplete responses
    lastSelectedDisplay = base.display || "";

    skipNextInputReset = true;
    addrInput.value = base.display || "";
    hideAc();
    setTimeout(() => { skipNextInputReset = false; }, 0);

    let it = base;
    if (it.type === "Google" && it.place_id && (!Number.isFinite(it.lat) || !Number.isFinite(it.lon))) {
      const detail = await fetchGoogleDetails(it.place_id);
      if (detail) {
        it = { ...it, ...detail };
        acItems[i] = it;
      }
    }

    selectedPlaceId = it.place_id || null;
    selectedNormalized = it.normalized || null;
    const coords = (Number.isFinite(it.lat) && Number.isFinite(it.lon)) ? { lat: it.lat, lon: it.lon } : null;
    selectedCoords = coords || null;

    if (coords && mapReady) {
      map.setView([coords.lat, coords.lon], 15);
      if (cmpShow.checked) refreshCompetitors();
    }

    persistNormalizedSelection(it);
    showRating(addrInput.value.trim());
  } catch (err) {
    console.warn("Failed to apply autocomplete selection", err);
  }
}
addrInput.addEventListener("input", () => {
  const q = addrInput.value.trim();
  if (!skipNextInputReset) { selectedCoords = null; selectedPlaceId = null; selectedNormalized = null; lastStoredKey = null; }
  skipNextInputReset = false;
  lastSelectedDisplay = q; // keep current typed text (used to extract road if user doesn't click a suggestion)
  const requestId = ++acRequestToken;
  if (q.length < 2) { hideAc(); return; }
  Promise.all([googleSearch(q), nominatimSearch(q)]).then(([g,n])=>{
    if (requestId !== acRequestToken) return; // stale response
    if (addrInput.value.trim() !== q) return; // input changed after request started
    const ranked = rankAutocompleteItems(q, [...g, ...n]);
    acItems = ranked.slice(0, 8);
    acActive = acItems.length ? 0 : -1; // highlight best match when available
    renderAc(acItems);
  });
});
addrInput.addEventListener("keydown", (e) => {
  if (acBox.style.display !== "none" && acItems.length) {
    if (e.key === "ArrowDown") { e.preventDefault(); acActive = Math.min(acActive+1, acItems.length-1); renderAc(acItems); }
    if (e.key === "ArrowUp")   { e.preventDefault(); acActive = Math.max(acActive-1, 0); renderAc(acItems); }
    if (e.key === "Enter")     { e.preventDefault(); chooseAc(Math.max(0, acActive)); }
  } else if (e.key === "Enter") {
    e.preventDefault();
    if (goBtn.disabled) { alert("Please enter an AADT override before estimating."); return; }
    onEstimateClick();
  }
});
document.addEventListener("keydown", (e) => { if (e.key === "Escape") hideAc(); });
document.addEventListener("pointerdown", (e) => { if (e.target !== addrInput && !acBox.contains(e.target)) hideAc(); });

/* -------------------- Competitors live layer -------------------- */
const COMP_API = "/api/competitors";
const CMP_MIN_MI = 0.5, CMP_MAX_MI = 2.0;
let cmpMarkers = [], cmpClusterGroup = null, cmpHeatLayer = null, cmpCache = new Map();
let cmpBrandSet = new Set(), cmpActiveBrands = new Set(); const BRAND_COLORS = {};
function colorForBrand(b){ if(!b) return "#9aa4b2"; if(!BRAND_COLORS[b]){ let h=0; for(let i=0;i<b.length;i++) h=(h*31 + b.charCodeAt(i))%360; BRAND_COLORS[b] = `hsl(${h},70%,58%)`; } return BRAND_COLORS[b]; }
function mapRadiusMi(){ if (!mapReady || !map) return 1.0; const b = map.getBounds(), c = b.getCenter(); const meters = map.distance(c, b.getNorthEast()); return Math.max(CMP_MIN_MI, Math.min(CMP_MAX_MI, meters / 1609.344)); }
function keyFor(c, r){ const q = (x,n)=>Math.round(x*Math.pow(10,n))/Math.pow(10,n); return `${q(c.lat,4)},${q(c.lon,4)}:${q(r,1)}`; }
function clearLiveMarkers(){ if (cmpClusterGroup){ cmpClusterGroup.clearLayers(); } cmpMarkers.forEach(m => map.removeLayer(m)); cmpMarkers = []; cmpBrandSet.clear(); }
function isBrandAllowed(b){ return cmpActiveBrands.size === 0 || cmpActiveBrands.has(b||"Unknown"); }
function updateLegendAndFilters(){
  const brands = [...cmpBrandSet].sort((a,b)=>a.localeCompare(b));
  brandLegend.innerHTML = brands.map(b => `<span><span class="cmp-dot" style="background:${colorForBrand(b)}"></span> ${esc(b)}</span>`).join("");
  if (brands.length === 0) { brandFilters.innerHTML = '<span class="subtle">No brands yet.</span>'; return; }
  brandFilters.innerHTML = brands.map(b=>{
    const checked = (cmpActiveBrands.size===0 || cmpActiveBrands.has(b)) ? "checked" : "";
    return `<label class="chip"><input type="checkbox" class="bf" data-brand="${esc(b)}" ${checked}> ${esc(b)}</label>`;
  }).join("");
}
function updateLiveStats(){
  const b = map.getBounds(); let total=0; const counts=new Map();
  for (const m of cmpMarkers){
    const allowed = isBrandAllowed(m.__brand);
    if (!allowed) continue;
    const latlng = m.getLatLng();
    if (!b || b.contains(latlng)) { total++; counts.set(m.__brand, (counts.get(m.__brand)||0)+1); }
  }
  $("liveCount").textContent = fmt(total);
  $("liveUnique").textContent = fmt(counts.size);
  const rows = [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,16).map(([br,n])=>`<div><span class="cmp-dot" style="background:${colorForBrand(br)}"></span> ${esc(br)} — <b>${fmt(n)}</b></div>`);
  $("liveBreakdown").innerHTML = rows.join("") || '<span class="subtle">No competitors visible.</span>';
}
function markerHTML(brand){ return `<span class="cmp-dot" style="background:${colorForBrand(brand)}"></span>`; }
function makeMarker(lat, lon, brand, name, addr){ const icon = L.divIcon({ className:"", html: markerHTML(brand), iconSize:[10,10], iconAnchor:[5,5] }); const m = L.marker([lat,lon], { icon, title: `${brand||"Brand"} — ${name||""}`, keyboard:false }); m.__brand = brand || "Unknown"; m.bindPopup(`<b>${esc(brand||"Brand")}</b> — ${esc(name||"")}<div class="small" style="opacity:.8">${esc(addr||"")}</div>`); return m; }
async function fetchCompetitorsForView(){
  if (!mapReady) return null;
  const b = map.getBounds(), c = b.getCenter(); const rMi = mapRadiusMi(); const key = keyFor({lat:c.lat, lon:c.lon}, rMi);
  const cached = cmpCache.get(key); const headers = {}; if (cached?.etag) headers["If-None-Match"] = cached.etag;
  $("cmpStatus").textContent = `Loading… (~${rMi.toFixed(1)} mi)`;
  try {
    const res = await fetch(`${COMP_API}?lat=${encodeURIComponent(c.lat)}&lon=${encodeURIComponent(c.lng)}&radiusMi=${encodeURIComponent(rMi.toFixed(2))}`, { headers });
    if (res.status === 304 && cached?.geo) { $("cmpStatus").textContent = `Ready (cached)`; return cached.geo; }
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const etag = res.headers.get("ETag") || null; const geo = await res.json(); cmpCache.set(key, { etag, geo });
    $("cmpStatus").textContent = `Ready`; return geo;
  } catch (e) { $("cmpStatus").textContent = `Load failed`; return null; }
}
function applyBrandFilterAndRedraw(){
  if (cmpCluster.checked && window.L && L.MarkerClusterGroup) { if (!cmpClusterGroup) cmpClusterGroup = L.markerClusterGroup(); cmpClusterGroup.clearLayers(); }
  else { if (cmpClusterGroup) { map.removeLayer(cmpClusterGroup); cmpClusterGroup = null; } }
  const visible = [];
  for (const m of cmpMarkers) {
    const allowed = isBrandAllowed(m.__brand);
    if (!cmpClusterGroup) { if (allowed) { if (!map.hasLayer(m)) m.addTo(map); } else { if (map.hasLayer(m)) map.removeLayer(m); } }
    if (allowed) visible.push(m);
  }
  if (cmpClusterGroup) { cmpMarkers.forEach(m => { if (map.hasLayer(m)) map.removeLayer(m); }); cmpClusterGroup.addLayers(visible); if (!map.hasLayer(cmpClusterGroup)) cmpClusterGroup.addTo(map); }
  if (cmpHeat.checked && window.L && L.heatLayer) {
    const pts = []; const bounds = map.getBounds();
    for (const m of visible) { const latlng = m.getLatLng(); if (!bounds || bounds.contains(latlng)) pts.push([latlng.lat, latlng.lng, 0.7]); }
    if (!cmpHeatLayer) cmpHeatLayer = L.heatLayer(pts, { radius: 24, blur: 18, maxZoom: 18 }); else cmpHeatLayer.setLatLngs(pts);
    if (!map.hasLayer(cmpHeatLayer)) cmpHeatLayer.addTo(map);
  } else { if (cmpHeatLayer && map.hasLayer(cmpHeatLayer)) map.removeLayer(cmpHeatLayer); }
  updateLegendAndFilters(); updateLiveStats();
}
async function refreshCompetitors(){
  const geo = await fetchCompetitorsForView(); if (!geo || !Array.isArray(geo.features)) return;
  if (cmpHeatLayer && map.hasLayer(cmpHeatLayer)) map.removeLayer(cmpHeatLayer);
  clearLiveMarkers();
  for (const f of geo.features){
    const g = f.geometry, p = f.properties || {}; const coords = Array.isArray(g?.coordinates) ? g.coordinates : null;
    if (!coords || coords.length < 2) continue; const lon = +coords[0], lat = +coords[1];
    if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;
    const brand = p.brand || "Unknown"; const m = makeMarker(lat, lon, brand, p.name, p.address);
    cmpMarkers.push(m); cmpBrandSet.add(brand);
  }
  if (map.hasLayer(serverCompLayer)) map.removeLayer(serverCompLayer);
  updateLegendAndFilters(); applyBrandFilterAndRedraw();
}
cmpShow.addEventListener("change", () => {
  if (cmpShow.checked) { if (!mapReady) initMap(); refreshCompetitors(); }
  else {
    if (cmpHeatLayer && map.hasLayer(cmpHeatLayer)) map.removeLayer(cmpHeatLayer);
    if (cmpClusterGroup) { cmpClusterGroup.clearLayers(); map.removeLayer(cmpClusterGroup); }
    cmpMarkers.forEach(m => map.removeLayer(m));
    if (!map.hasLayer(serverCompLayer)) serverCompLayer.addTo(map);
    $("cmpStatus").textContent = "—";
  }
});
cmpHeat.addEventListener("change", applyBrandFilterAndRedraw);
cmpCluster.addEventListener("change", applyBrandFilterAndRedraw);
$("brandFilters").addEventListener("change", (e)=>{
  const t = e.target;
  if (t && t.matches('input.bf[data-brand]')){
    const b = t.getAttribute("data-brand");
    if (t.checked) cmpActiveBrands.add(b); else cmpActiveBrands.delete(b);
    applyBrandFilterAndRedraw();
  }
});
$("brandsClear").addEventListener("click", () => { cmpActiveBrands.clear(); updateLegendAndFilters(); applyBrandFilterAndRedraw(); });
$("brandsAll").addEventListener("click", () => { cmpActiveBrands = new Set(cmpBrandSet); updateLegendAndFilters(); applyBrandFilterAndRedraw(); });

/* -------------------- Main actions -------------------- */
function tidyUI(){ hideAc(); }
async function onEstimateClick(){
  if(!addrInput.value.trim() && !selectedCoords){ alert("Please select a valid address first."); return; }
  if(!updateGoButtonState()){ alert("Please enter an AADT override before estimating."); return; }
  try {
    goBtn.disabled = true;
    setOverlayWorking("Working…");
    tidyUI();
    const resp = await callEstimate();
    if (!resp || resp.ok !== true) { alert("Estimate failed: " + (resp?.status || "Unknown error")); return; }
    renderAll(resp); pills();
    if (cmpShow.checked && map && serverCompLayer && map.hasLayer(serverCompLayer)) { map.removeLayer(serverCompLayer); }
  } catch (e) { alert("Error: " + (e?.message || e)); }
  finally { updateGoButtonState(); clearOverlay(); }
}
goBtn.addEventListener("click", onEstimateClick);
/* -------------------- PDF export (server-side) -------------------- */
exportBtn?.addEventListener("click", async ()=>{
  if(!addrInput.value.trim() && !selectedCoords){ alert("Please select a valid address first."); return; }
  if(!updateGoButtonState()){ alert("Please enter an AADT override before exporting."); return; }
  if (exportBtn.disabled) return;

  const baseInputs = getBaselineInputs();
  const body = {
    address: addrInput.value.trim(),
    mpds: +$("mpds").value || 0,
    diesel: +$("diesel").value || 0,
    aadtOverride: +(aadtOverrideInput.value || "") || null,
    advanced: { price_position: getPricePosition(), flags: getFlags(), extra: collectExtras() },
    enteredRoad: parseRoadFromDisplay(lastSelectedDisplay || addrInput.value.trim())
  };
  if (baseInputs.hasCustomTraffic) body.trafficPullPct = baseInputs.trafficPullPct;
  if (baseInputs.hasCustomGallons) body.gallonsPerFill = baseInputs.gallonsPerFill;
  if (selectedCoords) { body.siteLat = selectedCoords.lat; body.siteLon = selectedCoords.lon; }
  const notes = siteNotesInput ? siteNotesInput.value.trim() : "";
  if (notes) body.siteNotes = notes;

  let previousLabel = null;
  let toggled = false;
  if (exportBtn) {
    try {
      previousLabel = exportBtn.textContent;
      exportBtn.disabled = true;
      exportBtn.textContent = "Exporting…";
      toggled = true;
    } catch {}
  }

  try {
    setOverlayWorking("Building PDF report…");
    const resp = await fetch("/report/pdf", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
    if (!resp.ok) {
      const t = await resp.text().catch(()=>null);
      throw new Error("Server PDF failed: " + (t || resp.statusText));
    }
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "FuelIQ_Site_Report.pdf";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }catch(e){
    alert("PDF export failed: " + (e?.message || e));
  }finally{
    clearOverlay();
    if (exportBtn && toggled) {
      exportBtn.disabled = false;
      try {
        if (previousLabel != null) exportBtn.textContent = previousLabel;
      } catch {}
    }
  }
});

/* -------------------- Init -------------------- */
document.addEventListener("DOMContentLoaded", async () => {
  getStreetViewFrame();
  try {
    const r = await fetch("/google/status");
    const j = await r.json();
    const detailParts = [];
    if (j?.details?.autocomplete?.status) detailParts.push(`Autocomplete: ${j.details.autocomplete.status}`);
    if (j?.details?.streetview?.status) detailParts.push(`Street View: ${j.details.streetview.status}`);
    const suffix = detailParts.length ? ` (${detailParts.join("; ")})` : "";
    $("apiStatus").textContent = j.ok
      ? `API: Google — Working${suffix}`
      : `API: Google — ${j.status || "Unavailable"}${suffix}`;
  }
  catch { $("apiStatus").textContent = "API: Google — unavailable"; }
  initMap();
});
  </script>
</body>
</html>
