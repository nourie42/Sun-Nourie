<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sunoco, LP Fuel IQ - Fuel Site Analyzer</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- leaflet-image (for optional map capture) -->
  <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>

  <style>
    :root { --bg:#0b0e15; --panel:#111725; --panel2:#0f1421; --line:#263145; --text:#eaeef7; --muted:#97a3b8;
            --brand:#0ea5e9; --brand2:#22d3ee; --pill:#0f1929; }
    *{ box-sizing:border-box; }
    body{ background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
          margin:0; padding-bottom:72px; }
    .wrap{ max-width:1120px; margin:24px auto; padding:0 16px; }
    header{ display:flex; align-items:center; gap:14px; margin-bottom:6px; }
    header h1{ font-size:28px; margin:0; letter-spacing:.2px; }
    .build{ margin-left:auto; font-size:12px; color:#8aa2c0; }

    .aadt-tabs{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin:8px 0 12px; }
    .aadt-tab{ display:inline-block; padding:8px 12px; border-radius:999px; border:1px solid var(--line);
               background:var(--pill); color:var(--text); text-decoration:none; font-weight:700; font-size:13px; }
    .aadt-tab:hover{ background:#101a2b; }
    @media(max-width:680px){ .aadt-tabs{ overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:4px; }
                              .aadt-tab{ white-space:nowrap; } }

    .instructions{ margin:4px 0 12px; color:#cfe3ff; font-size:13px; }

    .card{ background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line);
           border-radius:12px; padding:16px; margin:12px 0; }
    label{ display:block; font-weight:600; margin:8px 0 6px; color:#d8e3f6; }
    input, select{ width:100%; padding:12px; border-radius:10px; border:1px solid var(--line); background:#0b1220; color:#eaeef7; }
    button{ background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#fff; border:0; padding:12px 16px;
            border-radius:10px; font-weight:700; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .row{ display:grid; grid-template-columns:1.6fr 0.7fr 0.7fr 0.8fr; gap:12px; align-items:end; }
    @media(max-width:980px){ .row{ grid-template-columns:1fr; } }
    .toolbar{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:12px; }
    .muted{ color:var(--muted); }
    .subtle{ font-size:12px; opacity:.9; }
    .hero{ display:flex; justify-content:space-between; align-items:flex-end; gap:12px; }
    .hero .num{ font-size:44px; font-weight:900; letter-spacing:.5px; }
    .hero .sub{ font-size:13px; color:#a9b6d0; }

    #map{ height:420px; border-radius:12px; border:1px solid var(--line); position:relative; }
    #overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(11,14,21,.55);
              border-radius:12px; font-weight:800; color:#cde9ff; font-size:18px; padding:20px; text-align:center; }
    #svWrap{ margin-top:10px; }
    #sv{ width:100%; height:380px; border:0; border-radius:12px; border:1px solid var(--line); background:#0b1220; }

    .ac-wrap{ position:relative; }
    .ac-list{ position:absolute; top:100%; left:0; right:0; z-index:30; margin-top:6px; background:#0b1220; border:1px solid var(--line);
              border-radius:12px; max-height:320px; overflow:auto; box-shadow:0 18px 36px rgba(0,0,0,.35); }
    .ac-item{ padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,.04); }
    .ac-item:last-child{ border-bottom:0; }
    .ac-item:hover, .ac-item.active{ background:#101a2b; }

    .footerbar{ position:fixed; left:0; right:0; bottom:0; background:linear-gradient(180deg,#0c1220,#0a0f1a);
                border-top:1px solid var(--line); padding:10px 16px; display:flex; justify-content:center; gap:12px; z-index:50; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Sunoco, LP Fuel IQ - Fuel Site Analyzer</h1>
      <span class="build">UI v2025-09-17</span>
    </header>

    <!-- State AADT quick links -->
    <nav class="aadt-tabs" aria-label="State AADT Quick Links">
      <span class="muted">State AADT Quick Links:</span>
      <a class="aadt-tab" href="https://opendata.dc.gov/datasets/DCGIS::2023-traffic-volume/explore" target="_blank" rel="noopener">DC</a>
      <a class="aadt-tab" href="https://gis-fdot.opendata.arcgis.com/datasets/fdot::annual-average-daily-traffic-tda/explore" target="_blank" rel="noopener">FL</a>
      <a class="aadt-tab" href="https://gdottrafficdata.drakewell.com/publicmultinodemap.asp" target="_blank" rel="noopener">GA</a>
      <a class="aadt-tab" href="https://mhd.public.ms2soft.com/tcds/tsearch.asp?loc=Mhd&mod" target="_blank" rel="noopener">MA</a>
      <a class="aadt-tab" href="https://nysdottrafficdata.drakewell.com/publicmultinodemap.asp" target="_blank" rel="noopener">NY</a>
      <a class="aadt-tab" href="https://scdottrafficdata.drakewell.com/publicmultinodemap.asp" target="_blank" rel="noopener">SC</a>
      <a class="aadt-tab" href="https://www.arcgis.com/apps/webappviewer/index.html?id=35e4c06de0f84a9c9f3fe18e67cd2c92" target="_blank" rel="noopener">VA</a>
      <a class="aadt-tab" href="https://ncdot.public.ms2soft.com/tdms.ui_core/trafficviewer" target="_blank" rel="noopener">NC</a>
    </nav>

    <div class="instructions">
      <b>Instructions:</b> Enter Address, click <i>Estimate</i>. <b>State AADT only:</b> we use the nearest centerline segment intersecting the address road (no radius). If state AADT can’t be retrieved, you’ll see a clear comment.
    </div>

    <!-- Inputs -->
    <div class="card">
      <div class="row">
        <div>
          <label>Site search</label>
          <div class="ac-wrap">
            <input id="addr" placeholder="Enter business or address" autocomplete="off"/>
            <div id="ac" class="ac-list" style="display:none;"></div>
          </div>
          <div class="muted subtle" style="margin-top:6px" id="apiStatus">Geocoder: ready</div>
        </div>
        <div><label>Regular MPDs</label><input id="mpds" type="number" value="3" min="1"/></div>
        <div><label>Diesel MPDs</label><input id="diesel" type="number" value="0" min="0"/></div>
        <div><label>AADT override</label><input id="aadtOverride" type="number"/></div>
      </div>
      <div class="toolbar">
        <button id="go">Estimate</button>
        <span class="muted">Baseline (AADT × 2% × 8 × 30). State AADT only.</span>
      </div>
    </div>

    <!-- Estimate -->
    <div class="card" id="estimateCard">
      <div class="hero">
        <div>
          <div>Adjusted Base Estimate (LOW)</div>
          <div class="num" id="estNum">—</div>
          <div class="sub" id="estRange">Full range: —</div>
        </div>
        <div class="right sub">
          <div>Year-2: <b id="y2">—</b></div>
          <div>Year-3: <b id="y3">—</b></div>
        </div>
      </div>
      <hr/>
      <div id="aadtBanner" class="muted">—</div>
      <div id="compLine" class="muted">—</div>
      <div id="commentLine" class="muted" style="margin-top:6px;">—</div>
    </div>

    <!-- Map & SV -->
    <div class="card">
      <div class="muted">Map: Site</div>
      <div id="map"><div id="overlay" class="muted">—</div></div>
      <div id="svWrap">
        <div class="muted" style="margin-top:10px;">Street View</div>
        <iframe id="sv" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </div>
  </div>

  <div class="footerbar"><span class="muted subtle">Sunoco Fuel IQ — State AADT Only</span></div>

<script>
/* ============================= DOM & helpers ============================= */
const $=id=>document.getElementById(id);
const apiStatus=$("apiStatus"), aadtBanner=$("aadtBanner"), compLine=$("compLine"), commentLine=$("commentLine"),
      overlay=$("overlay"), svFrame=$("sv"),
      outNum=$("estNum"), outRange=$("estRange"), outY2=$("y2"), outY3=$("y3"),
      addrInput=$("addr"), acBox=$("ac"), goBtn=$("go");

let map, layer, mapReady=false, selectedCoords=null;
function fmt(n){ return (n??0).toLocaleString(undefined,{maximumFractionDigits:0}); }
function setOverlayWorking(){ overlay.textContent="Working…"; overlay.style.display="flex"; }
function clearOverlay(){ overlay.style.display="none"; }

function initMap(){
  if(mapReady) return;
  map=L.map("map",{zoomControl:true}); window.map=map;
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(map);
  layer=L.layerGroup().addTo(map);
  mapReady=true;
}
function updateStreetView(lat, lon){
  svFrame.src=`https://maps.google.com/maps?q=&layer=c&cbll=${lat},${lon}&cbp=12,0,,0,0&output=svembed`;
}
function initOrUpdateMap(site){
  if(!mapReady) initMap();
  layer.clearLayers();
  if(!site){ setOverlayWorking(); return; }
  const siteLatLng=[site.lat,site.lon];
  L.marker(siteLatLng,{title:"Site"}).addTo(layer).bindPopup("<b>Site</b>");
  map.setView(siteLatLng, 16);
  clearOverlay();
  updateStreetView(site.lat,site.lon);
}

/* ============================= Simple autocomplete (Nominatim) ============================= */
let acItems=[]; let acActive=-1;
async function nominatimSearch(q){
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=6&countrycodes=us&q=${encodeURIComponent(q)}`,{
      headers:{ "Accept-Language":"en-US" }
    });
    const a=await r.json();
    return a.map(row=>({ type:"OSM", display:row.display_name, lat:+row.lat, lon:+row.lon, address:row.address }));
  }catch{ return []; }
}
function renderAc(list){
  if(!list.length){ acBox.style.display="none"; return; }
  acBox.innerHTML=list.map((it,i)=>`<div class="ac-item${i===acActive?" active":""}" data-i="${i}">${it.display}</div>`).join("");
  [...acBox.children].forEach(el=>el.onclick=()=>chooseAc(+el.dataset.i));
  acBox.style.display="block";
}
function chooseAc(i){
  const it=acItems[i]; if(!it) return;
  addrInput.value=it.display;
  selectedCoords={lat:it.lat,lon:it.lon, address:it.address};
  acBox.style.display="none";
}
addrInput.addEventListener("input", async ()=>{
  const q=addrInput.value.trim(); if(q.length<3){ acBox.style.display="none"; return; }
  const n=await nominatimSearch(q); acItems=n.slice(0,8); renderAc(acItems);
});
addrInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); $("go").click(); } });

/* ============================= State AADT sources ============================= */
/* ArcGIS Feature Services that are CORS-friendly from the browser */
const STATE_AADT_SOURCES = {
  "DC": { type:"arcgis", layerUrl:"https://rh.dcgis.dc.gov/dcgis/rest/services/DDOT/DDOTLRS/FeatureServer/24", aadtFields:["AADT","AADT_VALUE"], note:"DDOT LRS AADT" },
  "FL": { type:"arcgis", layerUrl:"https://gis.fdot.gov/arcgis/rest/services/RCI_Layers/FeatureServer/0", aadtFields:["AADT","AADT_TOTAL","AADT_CUR"], note:"FDOT RCI AADT" },
  "VA": { type:"arcgis", layerUrl:"https://services.arcgis.com/p5v98VHDX9Atv3l7/arcgis/rest/services/VDOTTrafficVolume/FeatureServer/0", aadtFields:["AADT","TOTAL_V"], note:"VDOT Traffic Volume" },
  "NC": { type:"arcgis", layerUrl:"https://services.arcgis.com/NuWFvHYDMVmmxMeM/arcgis/rest/services/NCDOT_AADT_Traffic_Segmentation/FeatureServer/1", aadtFields:["AADT","AADT_TOTAL"], note:"NCDOT AADT Segments" },

  /* Not CORS-friendly public endpoints (Drakewell/MS2 in public UI) — we mark as unavailable for client-side */
  "GA": { type:"drakewell", note:"GDOT Drakewell (no CORS API from browser)" },
  "NY": { type:"drakewell", note:"NYSDOT Drakewell (no CORS API from browser)" },
  "SC": { type:"drakewell", note:"SCDOT Drakewell (no CORS API from browser)" },
  "MA": { type:"ms2", note:"MassDOT MS2 (no CORS API from browser)" }
};
const SUPPORTED_STATES = Object.keys(STATE_AADT_SOURCES);

/* ============================= Geometry helpers ============================= */
function pointToPolylineDistanceMeters(pt, paths){
  // paths = ArcGIS polyline geometry {paths:[[ [lon,lat], ... ], ... ]}
  let best=Infinity;
  for(const path of (paths||[])){
    for(let i=0;i<path.length-1;i++){
      const [x1,y1]=path[i], [x2,y2]=path[i+1];
      const P=proj(pt.lon,pt.lat), A=proj(x1,y1), B=proj(x2,y2);
      const ABx=B.x-A.x, ABy=B.y-A.y;
      const APx=P.x-A.x, APy=P.y-A.y;
      const ab2=ABx*ABx + ABy*ABy || 1e-9;
      let t=(APx*ABx+APy*ABy)/ab2; t=Math.max(0,Math.min(1,t));
      const Cx=A.x+t*ABx, Cy=A.y+t*ABy;
      const dx=P.x-Cx, dy=P.y-Cy;
      best=Math.min(best, Math.sqrt(dx*dx+dy*dy));
    }
  }
  return best;
}
function proj(lon,lat){
  // crude local meters projection near the site (enough for 10s of meters)
  const kx = 111320 * Math.cos(lat*Math.PI/180);
  return { x: lon*kx, y: lat*110574 };
}

/* ============================= ArcGIS query for same-road segment ============================= */
async function queryArcGISPoint(layerUrl, lat, lon){
  const params = new URLSearchParams({
    f: "json",
    where: "1=1",
    geometry: JSON.stringify({x:+lon,y:+lat, spatialReference:{wkid:4326}}),
    geometryType: "esriGeometryPoint",
    inSR: "4326",
    spatialRel: "esriSpatialRelIntersects",
    distance: "35",                 // <= 35 m tolerance to hit the same road centerline
    units: "esriSRUnit_Meter",
    outFields: "*",
    returnGeometry: "true",
    outSR: "4326"
  });
  const r=await fetch(`${layerUrl}/query`,{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body: params.toString()
  });
  if(!r.ok) throw new Error(`ArcGIS HTTP ${r.status}`);
  const j=await r.json();
  if(!j || !Array.isArray(j.features)) return [];
  return j.features;
}
function pickAADTFromFeature(attrs, fields){
  for(const f of fields){
    const v=attrs?.[f];
    if(typeof v==="number" && Number.isFinite(v) && v>0) return {field:f, value:v};
    if(v!=null){ const n=+v; if(Number.isFinite(n)&&n>0) return {field:f, value:n}; }
  }
  return null;
}

async function lookupStateAADT(lat, lon, state){
  const cfg=STATE_AADT_SOURCES[state];
  if(!cfg) return {ok:false, reason:"state_not_supported"};

  if(cfg.type==="arcgis"){
    const feats=await queryArcGISPoint(cfg.layerUrl, lat, lon);
    if(!feats.length) return {ok:false, reason:"no_feature_near_point"};
    let best=null;
    for(const f of feats){
      const aadt=pickAADTFromFeature(f.attributes||{}, cfg.aadtFields||[]);
      if(!aadt) continue;
      const dist=pointToPolylineDistanceMeters({lat,lon},{paths:f.geometry?.paths||[]});
      if(!best || dist<best.dist) best={feature:f, dist, aadt};
    }
    if(!best) return {ok:false, reason:"no_aadt_on_features"};
    const year = best.feature.attributes.AADT_YEAR || best.feature.attributes.YEAR || null;
    return { ok:true, aadt:best.aadt.value, field:best.aadt.field, year, source:cfg.note, method:`state-${state}`, where:`nearest segment intersecting ${lat.toFixed(5)},${lon.toFixed(5)}` };
  }

  // Public UIs without simple CORS JSON APIs
  return {ok:false, reason:`unavailable_public_api_${cfg.type}`, hint:cfg.note};
}

/* ============================= Estimate math ============================= */
function gallonsFromAADT(aadt){
  // Baseline ceiling: AADT × 2% × 8 gallons × 30 days
  const baseline = aadt * 0.02 * 8 * 30;
  // Return conservative low + high band (+/- 15%)
  const low = Math.max(0, baseline * 0.85);
  const high = baseline * 1.15;
  return {low, high, y2: low*1.05, y3: low*1.1};
}

/* ============================= Address → state helper ============================= */
function extractStateAbbrevFromOSMAddress(addr){
  // OSM address object can include 'state' (full) and 'ISO3166-2-lvl4' or 'state_code' sometimes
  // We'll try to pull a two-letter US state code from the 'state' or 'state_code'
  if(!addr) return null;
  if(addr.state_code && /^[A-Z]{2}$/.test(addr.state_code)) return addr.state_code.toUpperCase();
  if(addr.state){
    // crude map from full state names to USPS codes if needed
    const map = {
      "District of Columbia":"DC","Florida":"FL","Georgia":"GA","Massachusetts":"MA",
      "New York":"NY","South Carolina":"SC","Virginia":"VA","North Carolina":"NC"
    };
    if(map[addr.state]) return map[addr.state];
  }
  return null;
}

/* ============================= Main click ============================= */
goBtn.addEventListener("click", async ()=>{
  try{
    goBtn.disabled=true; setOverlayWorking(); commentLine.textContent="—";
    const addr=addrInput.value.trim();
    if(addr.length<3){ alert("Enter a valid address"); return; }

    // Use selection if available, else geocode now
    let lat, lon, addrObj=null;
    if(selectedCoords){
      lat=selectedCoords.lat; lon=selectedCoords.lon; addrObj=selectedCoords.address||null;
    }else{
      const n=await nominatimSearch(addr);
      if(!n.length){ alert("Could not geocode address."); return; }
      lat=n[0].lat; lon=n[0].lon; addrObj=n[0].address||null;
    }
    initOrUpdateMap({lat,lon});

    const state = extractStateAbbrevFromOSMAddress(addrObj);
    if(!state || !SUPPORTED_STATES.includes(state)){
      aadtBanner.textContent = `State ${state||"—"} not supported for automatic AADT.`;
      // No gallons if no state AADT
      outNum.textContent="0"; outRange.textContent="Full range: 0 – 0"; outY2.textContent="0"; outY3.textContent="0";
      compLine.textContent = "—";
      commentLine.textContent = "State AADT could not be found.";
      return;
    }

    // If user entered an override, use that; else query state
    let usedAADT = null; let note=null; let method=null; let year=null;
    const ov=+($("aadtOverride").value||"");
    if(Number.isFinite(ov)&&ov>0){
      usedAADT=ov; method="override";
      note="Manual override";
    }else{
      const res=await lookupStateAADT(lat,lon,state);
      if(!res.ok){
        aadtBanner.textContent = `State-level AADT could not be found for ${state} (${res.reason}).`;
        outNum.textContent="0"; outRange.textContent="Full range: 0 – 0"; outY2.textContent="0"; outY3.textContent="0";
        compLine.textContent="—";
        commentLine.textContent="State AADT could not be found.";
        return;
      }
      usedAADT=res.aadt; method=res.method; note=res.source; year=res.year;
      $("aadtOverride").value = Math.round(usedAADT); // populate field for visibility
    }

    // Render gallons
    const g=gallonsFromAADT(usedAADT);
    outNum.textContent = fmt(g.low);
    outRange.textContent = `Full range: ${fmt(g.low)} – ${fmt(g.high)}`;
    outY2.textContent=fmt(g.y2); outY3.textContent=fmt(g.y3);
    aadtBanner.textContent = `AADT used ${fmt(usedAADT)} (${method}${year?`, ${year}`:""}${note?`; ${note}`:""})`;

    // Minimal competition info placeholder (same-road only focus)
    compLine.textContent = `Same-road segment used. No radius search.`;

    clearOverlay();
  }catch(e){
    alert("Error: "+(e.message||e));
  }finally{
    goBtn.disabled=false;
    clearOverlay();
  }
});
</script>
</body>
</html>
