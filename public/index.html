<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fuel Gallons Estimator — Chat</title>
  <style>
    body { background:#0e1117; color:#e6e6e6; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap { max-width: 900px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 40px; margin: 0 0 8px; }
    .card { background:#161a22; border:1px solid #2a2f3a; border-radius:12px; padding:16px; margin:12px 0; }
    label { display:block; font-weight:600; margin:10px 0 6px; }
    input { width:100%; padding:12px; border-radius:8px; border:1px solid #2a2f3a; background:#0f1320; color:#e6e6e6; }
    .row { display:flex; gap:12px; }
    .row > div { flex:1; }
    button { background:#3b82f6; color:white; border:0; padding:12px 16px; border-radius:10px; font-weight:700; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    pre { white-space:pre-wrap; word-break:break-word; }
    .muted { color:#9aa4b2; font-size: 0.92rem; }
    details { border-top:1px solid #2a2f3a; padding-top:10px; }
    .pill { display:inline-block; background:#0f1320; border:1px solid #2a2f3a; border-radius:999px; padding:4px 10px; margin-right:6px; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Fuel Gallons Estimator — Chat</h1>
    <div class="card">
      <div class="row">
        <div>
          <label>Site address (one line)</label>
          <input id="addr" placeholder="4173 Knightdale Blvd, Knightdale NC" />
        </div>
        <div>
          <label>Regular MPDs</label>
          <input id="mpds" type="number" value="3" />
        </div>
        <div>
          <label>Diesel positions (optional)</label>
          <input id="diesel" type="number" value="0" />
        </div>
      </div>
      <div style="margin-top:12px">
        <button id="go">Estimate</button>
        <button id="ping" style="margin-left:8px; background:#64748b">Test AADT</button>
      </div>
      <p class="muted" style="margin-top:8px">
        I’ll search DOT layers for AADT, pull stations & planned developments from OSM (1 mi),
        compute gallons with competition and capacity checks, then format the report.
      </p>
    </div>

    <div class="card">
      <h3>Result</h3>
      <pre id="out" class="muted">—</pre>
    </div>

    <div class="card">
      <details>
        <summary>Data used (debug)</summary>
        <pre id="debug">/ waiting…</pre>
      </details>
    </div>
  </div>

<script>
const out = document.getElementById("out");
const debug = document.getElementById("debug");
const goBtn = document.getElementById("go");
const pingBtn = document.getElementById("ping");

function setOut(msg){ out.textContent = msg; }
function setDebug(obj){ debug.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2); }

async function safeFetchJSON(url, opts) {
  const res = await fetch(url, opts);
  const ct = res.headers.get("content-type") || "";
  const text = await res.text();
  if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}\n` + text.slice(0, 800));
  if (!ct.includes("application/json")) throw new Error(`Expected JSON but got "${ct}"\n` + text.slice(0, 800));
  return JSON.parse(text);
}

function fmt(n){ return (n ?? 0).toLocaleString(undefined, {maximumFractionDigits: 0}); }

async function estimate() {
  try {
    goBtn.disabled = true;
    setOut("Thinking… searching AADT, competition, and developments.");
    const address = document.getElementById("addr").value.trim();
    const mpds = Number(document.getElementById("mpds").value || 0);
    const diesel = Number(document.getElementById("diesel").value || 0);

    const body = { address, mpds, diesel };
    const data = await safeFetchJSON("/estimate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const lines = [];
    lines.push(`**Base Estimate (gal/mo)** ${fmt(data.base_monthly_gallons)}, **Low–High** ${fmt(data.low_high.low)}–${fmt(data.low_high.high)}, **Year-2** ${fmt(data.year2)}, **Year-3** ${fmt(data.year3)}`);
    lines.push("");
    const i = data.inputs || {};
    const a = i.aadt || {};
    lines.push(`**Inputs used**: AADT ${fmt(a.value)} (source: ${a.source}${a.year ? ", " + a.year : ""}${a.distance_mi != null ? ", ~" + a.distance_mi + " mi" : ""}), MPDs ${i.mpds}${i.diesel ? " + diesel " + i.diesel : ""}, truck share ${Math.round((i.truck_share_assumed || 0) * 100)}% (assumed)`);
    const c = data.competition || {};
    lines.push(`**Competition summary**: ${c.count ?? 0} within 1 mi${c.nearest_mi != null ? "; nearest " + c.nearest_mi.toFixed(3) + " mi" : ""}${(c.notable_brands || []).length ? "; notable: " + c.notable_brands.join(", ") : ""}; impact ${(c.impact_score*100|0)}%`);
    lines.push(`**Developments**: ${(data.developments || []).length ? data.developments.map(d => `${d.name} • ${d.status} • ${d.miles} mi`).join(" · ") : "none found (OSM/planning tags)"}`);
    lines.push(`**Assumptions**: auto stop 2.0%, truck stop 1.2%; gallons/stop auto 10.2, truck 16.0; availability 1.00; competition 1/d decay + ≤0.03 mi heavy penalty; capacity cap = positions × 25 × gal/cycle × 365/12.`);
    lines.push(data.rationale || "");
    setOut(lines.join("\n"));

    setDebug({ request: body, response: data });
  } catch (e) {
    setOut("Network error:\n" + e.message);
  } finally {
    goBtn.disabled = false;
  }
}

async function testAADT() {
  try {
    pingBtn.disabled = true;
    setOut("Testing AADT lookup…");
    // Knightdale approx
    const test = await safeFetchJSON(`/aadt?lat=35.786&lon=-78.49`);
    setOut(`AADT test: ${JSON.stringify(test)}`);
  } catch (e) {
    setOut("AADT test failed:\n" + e.message);
  } finally {
    pingBtn.disabled = false;
  }
}

goBtn.addEventListener("click", estimate);
pingBtn.addEventListener("click", testAADT);
</script>
</body>
</html>
