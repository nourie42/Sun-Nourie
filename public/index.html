<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sunoco, LP Fuel IQ - Fuel Site Analyzer</title>

<!-- Leaflet & plugins -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/markercluster.js"></script>
<script src="https://unpkg.com/leaflet-geometryutil"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
:root {
  --bg:#0b0e15; --panel:#111725; --panel2:#0f1421; --line:#263145; --text:#eaeef7;
  --muted:#97a3b8; --brand:#0ea5e9; --brand2:#22d3ee; --pill:#0f1929; --warn:#f59e0b; --bad:#dc2626; --good:#22c55e;
}
*{ box-sizing:border-box; }
body{ background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:0; padding-bottom:90px; }
a{ color:#8dd2ff; text-decoration:none; }
a:hover{ text-decoration:underline; }
.wrap{ max-width:1240px; margin:24px auto; padding:0 16px; }
header{ display:flex; align-items:center; gap:14px; margin-bottom:6px; }
header h1{ font-size:28px; margin:0; letter-spacing:.2px; }
.build{ margin-left:auto; font-size:12px; color:#8aa2c0; }
.instructions{ margin:4px 0 12px; color:#cfe3ff; font-size:13px; }

.card{ background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line); border-radius:12px; padding:16px; margin:12px 0; }
label{ display:block; font-weight:600; margin:8px 0 6px; color:#d8e3f6; }
input, select{ width:100%; padding:12px; border-radius:10px; border:1px solid var(--line); background:#0b1220; color:#eaeef7; }
button{ background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#fff; border:0; padding:12px 16px; border-radius:10px; font-weight:700; cursor:pointer; }
button:disabled{ opacity:.6; cursor:not-allowed; }
hr{ border:0; height:1px; background:linear-gradient(90deg,transparent,var(--line),transparent); margin:14px 0; }

.row{ display:grid; grid-template-columns:1.8fr 0.6fr 0.6fr 0.9fr; gap:12px; align-items:start; }
@media (max-width:1060px){ .row{ grid-template-columns:1fr; } }

#map{ height:520px; border-radius:12px; border:1px solid var(--line); position:relative; overflow:hidden; }
#overlay{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(11,14,21,.55); border-radius:12px; font-weight:800; color:#cde9ff; font-size:18px; padding:20px; text-align:center; }
.map-toolbar{ position:absolute; right:10px; top:10px; z-index:20; display:flex; flex-direction:column; gap:8px; }
.tool{ background:#0f1929; border:1px solid var(--line); color:#cfe3ff; padding:6px 10px; border-radius:8px; font-size:12px; display:flex; align-items:center; gap:8px; }

.ac-wrap{ position:relative; }
.ac-list{ position:absolute; top:100%; left:0; right:0; z-index:30; margin-top:6px; background:#0b1220; border:1px solid var(--line); border-radius:12px; max-height:360px; overflow:auto; box-shadow:0 18px 36px rgba(0,0,0,.35); }
.ac-item{ padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,.04); }
.ac-item:last-child{ border-bottom:0; }
.ac-item:hover, .ac-item.active{ background:#101a2b; }
.badge{ display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--line); background:var(--pill); color:#a9c5ff; margin-left:8px; }

details summary{ cursor:pointer; }
.adv-line{ display:flex; align-items:center; gap:16px; flex-wrap:wrap; margin-top:12px; }
.chip{ display:inline-flex; align-items:center; gap:8px; background:#0f1929; border:1px solid var(--line); padding:8px 10px; border-radius:999px; font-size:13px; }
.chip input{ width:auto; accent-color:#22d3ee; }
.radio-row{ display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; }
.small { font-size:12px; color:#a9b6d0; }
.warn { color:var(--warn); font-weight:700; }
.good { color:var(--good); font-weight:700; }

.hero{ display:flex; justify-content:space-between; align-items:flex-end; gap:12px; }
.hero .num{ font-size:44px; font-weight:900; letter-spacing:.5px; }
.hero .sub{ font-size:13px; color:#a9b6d0; }
.num-row{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }

.stop-chip{ display:inline-flex; align-items:center; gap:10px; padding:8px 12px; border-radius:12px; border:2px solid #b91c1c; background:linear-gradient(135deg,#7f1d1d,#991b1b); color:#fff; font-weight:800; box-shadow:0 8px 20px rgba(0,0,0,.3); }
.stop-chip .stop-icon{ width:34px; height:34px; border-radius:8px; background:#dc2626; border:3px solid #fca5a5; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:11px; }

.kv{ display:grid; grid-template-columns:1fr 2fr; gap:8px 16px; font-size:13px; margin-top:6px; }
.kv b{ color:#d8e3f6; }
.footerbar{ position:fixed; left:0; right:0; bottom:0; background:linear-gradient(180deg,#0c1220,#0a0f1a); border-top:1px solid var(--line); padding:10px 16px; display:flex; justify-content:center; gap:12px; z-index:50; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Sunoco, LP Fuel IQ - Fuel Site Analyzer</h1>
    <span class="build">UI v2025‑10‑03 (full)</span>
  </header>

  <div class="card">
    <div class="row">
      <div>
        <label>Site Search — Enter full address and click the correct result</label>
        <div class="ac-wrap">
          <input id="addr" placeholder="Address or place" autocomplete="off" />
          <div id="ac" class="ac-list" style="display:none;"></div>
        </div>
        <div class="small" id="apiStatus">API Status: checking…</div>
      </div>
      <div><label>Regular MPDs</label><input id="mpds" type="number" value="3" min="1"></div>
      <div><label>Diesel MPDs</label><input id="diesel" type="number" value="0" min="0"></div>
      <div>
        <label>AADT override</label><input id="aadtOverride" type="number">
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="go">Estimate</button>
          <button id="exportPDF">Export PDF</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <details open>
      <summary><b>Advanced options</b></summary>
      <div class="adv-line">
        <label class="chip"><input type="checkbox" id="ex_large_dev"> Large residential or commercial developments being built (+7.5%)</label>
        <label class="chip"><input type="checkbox" id="ex_hours18"> Operating hours 18h (−7.5%)</label>
        <label class="chip"><input type="checkbox" id="ex_highincome"> Higher-income trade area (+2.5%)</label>
        <label class="chip"><input type="checkbox" id="ex_lowrating"> Ratings below 4.0 / Poorly run site (−30%)</label>
        <label class="chip"><input type="checkbox" id="ex_competitive_pricing"> Competitive site gas pricing (+10%)</label>
        <label class="chip"><input type="checkbox" id="ex_rural"> Rural Location Bonus (No competition within 3 miles) (+30%)</label>
        <span class="small" id="ruralNote"></span>
      </div>
      <div style="margin-top:8px;">
        <label><b>Gas pricing vs area</b></label>
        <div class="radio-row">
          <label class="chip"><input type="radio" name="pricepos" value="below"> Below competition (+10%)</label>
          <label class="chip"><input type="radio" name="pricepos" value="inline" checked> In line (0%)</label>
          <label class="chip"><input type="radio" name="pricepos" value="above"> Above competition (−10%)</label>
        </div>
      </div>
      <div class="adv-line">
        <span class="chip" id="addExtra" style="cursor:pointer;">+ Add adj. (%)</span>
        <span id="activeExtras" class="small"></span>
      </div>
      <div id="extraList" style="margin-top:8px;"></div>
    </details>
  </div>

  <div class="card" id="estimateCard">
    <div class="hero">
      <div>
        <div>Adjusted Base Estimate (LOW)</div>
        <div class="num-row">
          <div class="num" id="estNum">—</div>
          <span id="fallbackChip" class="stop-chip" style="display:none;">
            <span class="stop-icon">STOP</span>
            Fallback AADT Used — Verify and Override AADT
          </span>
        </div>
        <div class="sub" id="estRange">Full range: —</div>
      </div>
      <div class="right small">
        <div>Year‑2: <b id="y2">—</b></div>
        <div>Year‑3: <b id="y3">—</b></div>
      </div>
    </div>
    <hr/>
    <div class="kv">
      <div><b>AADT</b></div><div id="aadtBanner">—</div>
      <div><b>Competition</b></div><div id="compLine">—</div>
    </div>
  </div>

  <div class="card" id="mathCard">
    <b>Math & Assumptions</b>
    <div id="mathTable" class="small" style="margin-top:8px; line-height:1.6">—</div>
  </div>

  <div class="card" id="devCard" style="display:none;">
    <div class="stop-chip"><div class="stop-icon">STOP</div> Large developments flagged nearby</div>
    <div id="devList" class="small" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <b>Map: Site & competitors (3.0 mi) + AADT dots + ⭐ used AADT</b>
    <div id="map">
      <div id="overlay">Working…</div>
      <div class="map-toolbar">
        <label class="tool"><input type="checkbox" id="toggleCompetitors" checked> Show competitors</label>
        <label class="tool"><input type="checkbox" id="toggleAADT" checked> Show AADT sources (1 mi)</label>
        <label class="tool"><input type="checkbox" id="toggleHeat"> Density heatmap</label>
      </div>
    </div>
  </div>

  <!-- OPTIONAL: YOUR EXTRA PANELS HERE (copy any custom sections you had) -->

  <div class="footerbar"><button id="exportPDF2">Export PDF</button></div>
</div>

<script>
/* ====== Shortcuts ====== */
const $ = (id) => document.getElementById(id);

/* Inputs & UI nodes */
const addrInput = $("addr"), acBox = $("ac"), goBtn = $("go");
const apiStatus = $("apiStatus"), overlay = $("overlay");
const estNum = $("estNum"), estRange = $("estRange"), y2 = $("y2"), y3 = $("y3");
const aadtBanner = $("aadtBanner"), compLine = $("compLine"), fallbackChip = $("fallbackChip");
const mathTable = $("mathTable"), ruralNote = $("ruralNote"), devCard = $("devCard"), devList = $("devList");

const ex_large_dev = $("ex_large_dev"), ex_hours18 = $("ex_hours18"), ex_highincome = $("ex_highincome");
const ex_lowrating = $("ex_lowrating"), ex_comp_price = $("ex_competitive_pricing"), ex_rural = $("ex_rural");
const addExtra = $("addExtra"), extraList = $("extraList"), activeExtras = $("activeExtras");

/* Map globals */
let map, layerSite, layerComps, layerAADT, layerHeat;
let mapReady = false, siteCenter = null;

/* Autocomplete state */
let acItems = [], acActive = -1, selectedCoords = null, selectedPlaceId = null, lastSelectedDisplay = "";

/* Debounce for auto‑recalc */
let recalcTimer = null, recalcInFlight = false;
function debounce(fn, ms=420){ clearTimeout(recalcTimer); recalcTimer = setTimeout(()=>fn(), ms); }
function scheduleRecalc(){ if (!addrInput.value.trim() && !selectedCoords) return; debounce(()=>onEstimateClick(true), 450); }

/* Helpers */
function esc(s){ return (s??"").toString().replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function fmt(n){ return (n??0).toLocaleString(undefined,{maximumFractionDigits:0}); }
function parseRoadFromDisplay(display){ let f=String(display||"").split(",")[0]||""; f=f.replace(/\b(Suite|Ste|Apt|Unit)\b.*$/i,""); f=f.replace(/^\s*\d+[A-Za-z-]?\s*,?\s*/,""); return f.trim(); }

/* ================== Map ================== */
function initMap(){
  if(mapReady) return;
  map = L.map("map",{zoomControl:true}); window.map = map;
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap"}).addTo(map);
  layerSite = L.layerGroup().addTo(map);
  layerComps = L.markerClusterGroup({ maxClusterRadius: 45 });
  map.addLayer(layerComps);
  layerAADT = L.layerGroup().addTo(map);
  layerHeat = L.heatLayer([], { radius:28, blur:18, maxZoom:17, minOpacity:0.25 });

  mapReady = true;
}

/* Competitors toggle */
$("toggleCompetitors").addEventListener("change", (e) => {
  if (!mapReady) return;
  if (e.target.checked) map.addLayer(layerComps); else map.removeLayer(layerComps);
});
$("toggleAADT").addEventListener("change", (e) => {
  if (!mapReady) return;
  if (e.target.checked) map.addLayer(layerAADT); else map.removeLayer(layerAADT);
});
$("toggleHeat").addEventListener("change", (e) => {
  if (!mapReady) return;
  if (e.target.checked) layerHeat.addTo(map); else map.removeLayer(layerHeat);
});

/* ================== Extras ================== */
function addExtraRow(pct="",note=""){
  const row=document.createElement("div");
  row.style.marginTop="6px";
  row.innerHTML=`<span class="chip"><input class="extraPct" type="number" step="0.1" style="width:90px" placeholder="% e.g. 5 or -3" value="${pct}">
  <input class="extraNote" style="width:320px" placeholder="Comment" value="${esc(note)}"> <button class="rm" type="button">×</button></span>`;
  row.querySelector(".rm").addEventListener("click",()=>{ row.remove(); scheduleRecalc(); });
  row.querySelector(".extraPct").addEventListener("input", ()=>scheduleRecalc());
  row.querySelector(".extraNote").addEventListener("input", ()=>scheduleRecalc());
  extraList.appendChild(row);
}
addExtra.addEventListener("click",()=>addExtraRow());

function getPricePosition(){ const r=document.querySelector('input[name="pricepos"]:checked'); return r ? r.value : "inline"; }
function collectExtras(){
  const out=[];
  if(ex_large_dev.checked) out.push({pct:7.5, note:"Large residential/commercial developments"});
  if(ex_hours18.checked)  out.push({pct:-7.5, note:"18h ops"});
  if(ex_highincome.checked) out.push({pct:2.5, note:"Higher income"});
  // NOTE: low rating toggle is applied server‑side as ×0.70, not included in extras here (avoid double count).
  if(ex_comp_price.checked) out.push({pct:10, note:"Site gas pricing competitive"});
  for(const chip of extraList.querySelectorAll(".chip")){
    const pct = +chip.querySelector(".extraPct").value;
    const note = chip.querySelector(".extraNote").value.trim();
    if(Number.isFinite(pct)) out.push({pct, note});
  }
  return out;
}
function getFlags(){ return { rural: ex_rural.checked === true }; }
function pills(){
  const p=[];
  if(ex_large_dev.checked) p.push("+7.5% Large development nearby");
  if(ex_hours18.checked)  p.push("−7.5% 18h ops");
  if(ex_highincome.checked) p.push("+2.5% Higher‑income");
  if(ex_lowrating.checked)  p.push("−30% Rating < 4.0");
  if(ex_comp_price.checked)  p.push("+10% Competitive site gas pricing");
  if(ex_rural.checked) p.push("+30% Rural bonus (0 comps within 3 mi)");
  activeExtras.innerHTML = p.map(x=>`<span class="badge">${esc(x)}</span>`).join(" ");
}
["ex_large_dev","ex_hours18","ex_highincome","ex_lowrating","ex_competitive_pricing","ex_rural"].forEach(id=>{
  const el=$(id); el.addEventListener("change",()=>{ pills(); scheduleRecalc(); });
});
document.querySelectorAll('input[name="pricepos"]').forEach(r => r.addEventListener("change", scheduleRecalc));

/* ================== API Calls ================== */
async function callEstimate(silent=false){
  const body = {
    address: addrInput.value.trim(),
    mpds: +$("mpds").value || 0,
    diesel: +$("diesel").value || 0,
    advanced: { extra: collectExtras(), flags: getFlags(), price_position: getPricePosition() },
    enteredRoad: parseRoadFromDisplay(lastSelectedDisplay || addrInput.value.trim()),
    auto_low_rating: ex_lowrating.checked === true
  };
  const ov = +( $("aadtOverride").value || "" ); if(Number.isFinite(ov) && ov > 0) body.aadtOverride = ov;
  if(selectedCoords){ body.siteLat = selectedCoords.lat; body.siteLon = selectedCoords.lon; }
  const r = await fetch("/estimate", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
  const t = await r.text(); let j = {}; try { j = JSON.parse(t); } catch { throw new Error("Bad JSON"); }
  if (!r.ok || j.ok !== true) throw new Error(j?.status || "Estimate failed");
  return j;
}
async function serverAutocomplete(q){
  try{
    const bias = mapReady && map ? (()=>{ const c = map.getCenter(); return `&lat=${encodeURIComponent(c.lat)}&lon=${encodeURIComponent(c.lng)}&radius=50000`; })() : "";
    const r = await fetch(`/autocomplete?input=${encodeURIComponent(q)}${bias}`);
    const j = await r.json(); if (!j.ok) return []; return j.items || [];
  }catch{ return []; }
}
async function aadtNearby(lat, lon, radiusMi=1.0){
  const r = await fetch(`/aadt/nearby?lat=${lat}&lon=${lon}&radiusMi=${radiusMi}`);
  const j = await r.json(); return j?.items || [];
}

/* ================== Renderers ================== */
function renderEstimate(d){
  estNum.textContent = fmt(d.estimate?.low ?? d.low ?? 0);
  const rangeTxt = d.estimate?.range || (d.low!=null && d.high!=null ? `${fmt(d.low)}–${fmt(d.high)}` : "—");
  estRange.textContent = "Full range: " + rangeTxt;
  y2.textContent = fmt(d.estimate?.year2 ?? d.year2 ?? 0);
  y3.textContent = fmt(d.estimate?.year3 ?? d.year3 ?? 0);

  const method = (d?.inputs?.aadt_components?.method || d?.map?.aadt_used?.method || "");
  const usedVal  = d?.map?.aadt_used?.aadt ?? d?.inputs?.aadt_used ?? null;
  const fallback = method === "fallback_no_dot_found";
  if (fallback && usedVal) { aadtBanner.textContent = `AADT: ${fmt(usedVal)} vehicles/day (fallback)`; fallbackChip.style.display = "inline-flex"; }
  else { aadtBanner.textContent = d.aadtText || (usedVal ? `AADT: ${fmt(usedVal)} vehicles/day` : "—"); fallbackChip.style.display = "none"; }

  compLine.textContent = d.competitionText || "—";

  // Rural applied or blocked?
  ruralNote.textContent = "";
  if (ex_rural.checked) {
    if (d.flags?.rural_bonus_applied) ruralNote.innerHTML = `<span class="good">Applied (+30%).</span>`;
    else if (!d.flags?.rural_eligible) ruralNote.innerHTML = `<span class="warn">Requested but not applied — competitors exist within 3 mi.</span>`;
  }

  renderMath(d);
  renderMap(d.map);
  renderDevelopments(d.csv || []);
}
function renderMath(d){
  const B = d && d.calc_breakdown;
  if(!B){ mathTable.innerHTML = "<em>—</em>"; return; }
  const rows = [];
  if (B.baseline && d.inputs?.aadt_used) rows.push(`<b>Baseline ceiling</b> = AADT ${fmt(d.inputs.aadt_used)} × 2% × 8 × 30 = <b>${fmt(B.baseline)}</b>`);
  if (B.compRule) rows.push(`Competition: base ${B.compRule.baseMult?.toFixed(2)} − heavy ${B.compRule.heavyPenalty?.toFixed(2)} = × ${B.compRule.compMult?.toFixed(2)} → ${fmt(B.afterComp)}`);
  if (B.caps) {
    const lim = B.caps.limited_by || {};
    const lims=[]; if(lim.equipment) lims.push("equipment"); if(lim.hard) lims.push("hard cap");
    rows.push(`Capacity caps: equipment ${fmt(B.caps.capEquip)} • soft ${fmt(B.caps.capSoftTotal)} • hard ${fmt(B.caps.capHardTotal)}${lims.length?` (limited by ${lims.join(" & ")})`:""}${lim.soft?" • soft penalty −10%":""} → ${fmt(B.caps.afterCap)}`);
  }
  rows.push(`Pricing factor: × ${Number(B.priceMult).toFixed(2)} → ${fmt(B.afterPrice)}`);
  if (d.flags?.auto_low_rating) rows.push(`Low reviews penalty: × 0.70 (applied)`);
  rows.push(`Extras multiplier (incl. toggles): × ${Number(B.extrasMult).toFixed(2)} → pre‑clamp ${fmt(B.preClamp)}`);
  if (B.clamped_to_baseline) rows.push(`<span class="warn">Baseline ceiling ACTIVE: final = min(pre‑clamp, baseline) → <b>${fmt(B.finalClampedToBaseline)}</b></span>`);
  else rows.push(`Final (no baseline clamp): <b>${fmt(B.finalClampedToBaseline)}</b>`);
  mathTable.innerHTML = rows.map(r=>`<div>${r}</div>`).join('');
}
function renderDevelopments(list){
  if(!Array.isArray(list) || list.length===0){ devCard.style.display="none"; devList.innerHTML=""; return; }
  devCard.style.display="block";
  devList.innerHTML = list.slice(0,12).map(r=>{
    const bits = [esc(r.name||"New development"), esc(r.status||""), esc(r.town||""), esc(r.state||""), esc(r.date||"")].filter(Boolean).join(" • ");
    const details = r.details ? `<div class="small" style="margin-top:2px;">${esc(r.details)}</div>` : "";
    return `<div style="margin:6px 0;">${bits}${details}</div>`;
  }).join("");
}

/* ================== Map renderer ================== */
async function renderMap(m){
  if(!mapReady) initMap();
  layerSite.clearLayers(); layerComps.clearLayers(); layerAADT.clearLayers(); layerHeat.setLatLngs([]);
  if(!m || !m.site) return;

  const site = [m.site.lat, m.site.lon];
  siteCenter = { lat: m.site.lat, lon: m.site.lon };
  L.marker(site,{title:"Site"}).addTo(layerSite).bindPopup("<b>Site</b>");
  const pts = [site];

  // Competitors (all within 3 mi)
  const comps = m.all_competitors || m.competitors || [];
  const heatPts = [];
  for(const c of comps){
    if(!Number.isFinite(c.lat)||!Number.isFinite(c.lon)) continue;
    pts.push([c.lat,c.lon]);
    const color = c.heavy ? "#ff7f50" : "#4ade80";
    const marker = L.circleMarker([c.lat,c.lon],{ radius:7, weight:1.5, color, fillColor:color, fillOpacity:.95 })
      .bindPopup(`${esc(c.name||"Fuel")}<br>${esc(c.address||"")}<br>${(c.miles??"?")} mi`);
    layerComps.addLayer(marker);
    heatPts.push([c.lat, c.lon, c.heavy ? 0.7 : 0.4]);
  }
  layerHeat.setLatLngs(heatPts);

  // AADT dots (within 1 mile) + star on used
  if (Array.isArray(m.aadt)) {
    for (const s of m.aadt) {
      if(!Number.isFinite(s.lat)||!Number.isFinite(s.lon)) continue;
      pts.push([s.lat,s.lon]);
      L.circleMarker([s.lat,s.lon],{radius:6,weight:1.4,color:"#60a5fa",fillColor:"#60a5fa",fillOpacity:.85})
        .addTo(layerAADT)
        .bindPopup(`<b>${esc(s.route||"AADT station")}</b><br>${esc(s.location||"")}<br>AADT ${fmt(s.aadt)} (${s.year||"—"})<br>${s.miles ? "~"+s.miles+" mi" : ""}`);
    }
  }
  if (m.aadt_used && Number.isFinite(m.aadt_used.lat) && Number.isFinite(m.aadt_used.lon)) {
    L.marker([m.aadt_used.lat, m.aadt_used.lon], {
      title: "AADT used", icon: L.divIcon({
        className: "aadt-star",
        html: `<div style="font-size:20px; color:#fbbf24; text-shadow:0 0 6px #000;">⭐</div>`
      })
    }).addTo(layerAADT).bindPopup(`AADT used: ${fmt(m.aadt_used.aadt)} (${esc(m.aadt_used.method||"DOT")})`);
    pts.push([m.aadt_used.lat,m.aadt_used.lon]);
  }

  // Fit
  try { map.fitBounds(L.latLngBounds(pts).pad(0.25)); }
  catch { map.setView(site, 13); }
}

/* ================== Autocomplete (server) ================== */
function hideAc(){ acBox.style.display = "none"; acActive = -1; }
function chooseAc(i){
  const it = acItems[i]; if (!it) return;
  lastSelectedDisplay = it.display || "";
  selectedCoords = (Number.isFinite(it.lat) && Number.isFinite(it.lon)) ? { lat: it.lat, lon: it.lon } : null;
  selectedPlaceId = it.place_id || null;
  addrInput.value = it.display;
  hideAc();
  scheduleRecalc();
}
function renderAc(list){
  if(!list.length){ hideAc(); return; }
  acBox.innerHTML = list.map((it,i) =>
    `<div class="ac-item${i===acActive?" active":""}" data-i="${i}">${esc(it.display)} <span class="badge">${it.type}</span></div>`
  ).join("");
  [...acBox.children].forEach(el => el.onclick = () => chooseAc(+el.dataset.i));
  acBox.style.display = "block";
}
addrInput.addEventListener("input", () => {
  const q = addrInput.value.trim();
  lastSelectedDisplay = q;
  if (q.length < 2) { hideAc(); return; }
  serverAutocomplete(q).then(items => { acItems = items.slice(0, 12); acActive = 0; renderAc(acItems); });
});
addrInput.addEventListener("keydown", (e) => {
  if (acBox.style.display !== "none" && acItems.length) {
    if (e.key === "ArrowDown") { e.preventDefault(); acActive = Math.min(acActive+1, acItems.length-1); renderAc(acItems); }
    if (e.key === "ArrowUp")   { e.preventDefault(); acActive = Math.max(acActive-1, 0); renderAc(acItems); }
    if (e.key === "Enter")     { e.preventDefault(); chooseAc(Math.max(0, acActive)); }
  } else if (e.key === "Enter") {
    e.preventDefault(); onEstimateClick(false);
  }
});
document.addEventListener("keydown", (e) => { if (e.key === "Escape") hideAc(); });
document.addEventListener("pointerdown", (e) => { if (e.target !== addrInput && !acBox.contains(e.target)) hideAc(); });

/* ================== Actions ================== */
async function onEstimateClick(silent=false){
  if(recalcInFlight) return;
  if(!addrInput.value.trim() && !selectedCoords){ alert("Please select a valid address first."); return; }
  try {
    recalcInFlight = true;
    if (!silent) { goBtn.disabled = true; overlay.style.display = "flex"; }
    const d = await callEstimate(silent);
    renderEstimate(d);
  } catch (e) {
    if (!silent) alert("Error: " + (e?.message || e));
  } finally {
    if (!silent){ goBtn.disabled = false; overlay.style.display = "none"; }
    recalcInFlight = false;
  }
}
goBtn.addEventListener("click", ()=>onEstimateClick(false));

/* PDF export (both buttons do the same) */
async function exportPdf(){
  try{
    if(!addrInput.value.trim() && !selectedCoords){ alert("Please select a valid address first."); return; }
    const body = {
      address: addrInput.value.trim(),
      mpds: +$("mpds").value || 0,
      diesel: +$("diesel").value || 0,
      aadtOverride: +( $("aadtOverride").value || "" ) || null,
      advanced: { price_position: getPricePosition(), flags: getFlags(), extra: collectExtras() },
      enteredRoad: parseRoadFromDisplay(lastSelectedDisplay || addrInput.value.trim()),
      auto_low_rating: ex_lowrating.checked === true
    };
    if (selectedCoords) { body.siteLat = selectedCoords.lat; body.siteLon = selectedCoords.lon; }
    overlay.style.display = "flex";
    const resp = await fetch("/report/pdf", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
    if (!resp.ok) { const t = await resp.text().catch(()=>null); throw new Error("Server PDF failed: " + (t || resp.statusText)); }
    const blob = await resp.blob(); const url = URL.createObjectURL(blob); const a = document.createElement("a");
    a.href = url; a.download = "FuelIQ_Site_Report.pdf"; a.click(); URL.revokeObjectURL(url);
  }catch(e){ alert("PDF export failed: " + (e?.message || e)); }
  finally{ overlay.style.display = "none"; }
}
$("exportPDF").addEventListener("click", exportPdf);
$("exportPDF2").addEventListener("click", exportPdf);

/* ================== Init ================== */
document.addEventListener("DOMContentLoaded", async () => {
  try {
    const r = await fetch("/google/status"); const j = await r.json();
    apiStatus.textContent = j.ok ? "API: Google — Working" : `API: Google — ${j.status}`;
  } catch { apiStatus.textContent = "API: Google — unavailable"; }
  initMap();
  pills(); // reflect default advanced state
});
</script>
</body>
</html>
