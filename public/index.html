<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sun‚ÄëNourie Fuel IQ ‚Äî Pulse Build</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f172a; /* slate-900 */
      --muted: #94a3b8; /* slate-400 */
      --text: #e5e7eb;  /* gray-200 */
      --primary: #0B6EEF;
      --accent: #00C2A8;
      --ok: #10B981;
      --warn: #F59E0B;
      --danger: #EF4444;
      --info: #60A5FA;
      --chip-bg: #111827; /* gray-900 */
      --chip-br: #1f2937; /* gray-800 */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; padding: 0; height: 100%; background: var(--bg);
      color: var(--text); font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    .app {
      display: grid; grid-template-rows: auto auto 1fr auto; height: 100vh; width: 100vw;
      grid-template-columns: 340px 1fr 420px; grid-template-areas:
        "header header header"
        "toolbar toolbar toolbar"
        "left   map    right"
        "footer footer footer";
    }
    header {
      grid-area: header; display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; background: linear-gradient(90deg, #0f172a, #0b1220);
      border-bottom: 1px solid #1e293b;
    }
    header .brand { display: flex; gap: 12px; align-items: center; }
    .logo {
      width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, var(--primary), var(--accent));
      box-shadow: 0 10px 24px rgba(11,110,239,.35);
    }
    .title { font-weight: 800; letter-spacing: .3px; }
    .env { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .status-bar { display: flex; gap: 8px; align-items: center; }
    .chip { padding: 6px 8px; border: 1px solid var(--chip-br); border-radius: 8px; font-size: 12px; background: var(--chip-bg); color: var(--muted); }
    .chip.ok { color: var(--ok); border-color: rgba(16,185,129,.35); }
    .chip.warn { color: var(--warn); border-color: rgba(245,158,11,.35); }
    .chip.info { color: var(--info); border-color: rgba(96,165,250,.35); }
    .chip.bad { color: var(--danger); border-color: rgba(239,68,68,.35); }

    .toolbar { grid-area: toolbar; display: grid; grid-template-columns: 340px 1fr 420px; gap: 12px; padding: 10px 16px; border-bottom: 1px solid #1f2937; background: #0b1220; }

    .panel { background: var(--panel); border: 1px solid #1f2937; border-radius: 14px; padding: 12px; }
    .panel h3 { margin: 0 0 8px; font-size: 14px; color: var(--muted); font-weight: 600; letter-spacing: .2px; }
    .panel .row { display: flex; gap: 8px; margin-bottom: 8px; }
    input[type="text"], input[type="number"] {
      background: #0b1220; color: var(--text); border: 1px solid #1f2937; border-radius: 10px; padding: 10px 10px; width: 100%; outline: none;
    }
    button { background: #0b1220; color: var(--text); border: 1px solid #1f2937; border-radius: 10px; padding: 10px 12px; cursor: pointer; }
    .btn-primary { background: linear-gradient(180deg, rgba(11,110,239,.15), rgba(11,110,239,.05)); border-color: rgba(11,110,239,.45); }
    .btn-accent  { background: linear-gradient(180deg, rgba(0,194,168,.15), rgba(0,194,168,.05)); border-color: rgba(0,194,168,.45); }
    .btn-danger  { background: linear-gradient(180deg, rgba(239,68,68,.15), rgba(239,68,68,.05)); border-color: rgba(239,68,68,.45); }
    .btn-ghost { opacity: .9; }

    #left { grid-area: left; display: grid; grid-template-rows: auto auto 1fr; gap: 12px; padding: 12px 16px; overflow: auto; }
    #map { grid-area: map; position: relative; }
    #map .leaflet-container, #map { height: calc(100vh - 170px); width: 100%; }
    #right { grid-area: right; display: grid; grid-template-rows: auto auto 1fr; gap: 12px; padding: 12px 16px; overflow: auto; }
    footer { grid-area: footer; display: flex; align-items: center; justify-content: space-between; padding: 10px 16px; border-top: 1px solid #1f2937; color: var(--muted); background: #0b1220; }

    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: #0b1220; border: 1px solid #1f2937; border-radius: 6px; padding: 2px 6px; font-size: 12px; color: #9ca3af; }

    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #223045; margin: 2px 4px 0 0; }
    .badge.ok { color: var(--ok); border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.08); }
    .badge.verify { color: var(--warn); border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.08); }
    .badge.info { color: var(--info); border-color: rgba(96,165,250,.35); background: rgba(96,165,250,.08); }
    .badge.bad { color: var(--danger); border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.08); }

    .grid { display: grid; gap: 10px; }
    .grid.two { grid-template-columns: 1fr 1fr; }
    .grid.three { grid-template-columns: 1fr 1fr 1fr; }

    .kv { display: grid; grid-template-columns: 1fr auto; gap: 6px; }
    .kv .key { color: var(--muted); }
    .kv .val { font-weight: 700; }

    .scroll { overflow: auto; max-height: 100%; }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 6px; border-bottom: 1px solid #1f2937; font-size: 13px; }
    th { text-align: left; color: var(--muted); position: sticky; top: 0; background: var(--panel); }

    .sep { height: 1px; background: #1f2937; margin: 8px 0; }

    .switch { display: inline-flex; align-items: center; gap: 8px; cursor: pointer; }
    .switch input { display: none; }
    .switch .track { width: 44px; height: 24px; background: #0b1220; border: 1px solid #1f2937; border-radius: 999px; position: relative; transition: .15s; }
    .switch .thumb { width: 18px; height: 18px; background: #e5e7eb; border-radius: 999px; position: absolute; top: 2px; left: 2px; transition: .15s; }
    .switch input:checked + .track { border-color: rgba(11,110,239,.5); box-shadow: inset 0 0 0 12px rgba(11,110,239,.15); }
    .switch input:checked + .track .thumb { left: 24px; background: #93c5fd; }

    .flash { animation: flash .6s ease-in-out 2; }
    @keyframes flash { 0%{opacity:1} 50%{opacity:.1} 100%{opacity:1} }

    .tooltip { position: relative; display: inline-block; }
    .tooltip .tiptext { visibility: hidden; background-color: #111827; color: #e5e7eb; text-align: center; border-radius: 6px; padding: 6px 8px; position: absolute; z-index: 9999; bottom: 125%; left: 50%; transform: translateX(-50%); border: 1px solid #1f2937; white-space: nowrap; }
    .tooltip:hover .tiptext { visibility: visible; }

    .score { font-size: 28px; font-weight: 800; letter-spacing: .5px; }
    .score.good { color: var(--ok); }
    .score.mid { color: var(--warn); }
    .score.bad { color: var(--danger); }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Sun‚ÄëNourie Fuel IQ <span class="env">‚Äî Pulse QC build</span></div>
          <div class="env" id="envText">Environment: production</div>
        </div>
      </div>
      <div class="status-bar" id="statusBar">
        <span class="chip info" id="apiGoogle">API: Google ‚Äî Unknown</span>
        <span class="chip info" id="apiOverpass">API: Overpass ‚Äî Unknown</span>
        <span class="chip info" id="apiServer">API: Server ‚Äî Unknown</span>
        <span class="chip" id="coordChip">Lat/Lng: ‚Äî</span>
      </div>
    </header>

    <div class="toolbar">
      <div class="panel">
        <h3>Search</h3>
        <div class="row">
          <input id="addr" type="text" placeholder="Enter address or drop a pin on the map" />
        </div>
        <div class="row">
          <input id="lat" type="number" step="0.000001" placeholder="Lat" />
          <input id="lng" type="number" step="0.000001" placeholder="Lng" />
        </div>
        <div class="row">
          <button class="btn-ghost" id="locateBtn">üìç Locate Me</button>
          <button class="btn-primary" id="estimateBtn">üöÄ Estimate</button>
          <button class="btn-ghost" id="clearBtn">Clear</button>
        </div>
        <div class="row">
          <label class="switch">
            <input type="checkbox" id="roadsToggle" checked>
            <span class="track"><span class="thumb"></span></span>
          </label>
          <span>Roads overlay</span>
          <label class="switch" style="margin-left:12px;">
            <input type="checkbox" id="aadtToggle" checked>
            <span class="track"><span class="thumb"></span></span>
          </label>
          <span>AADT overlay</span>
          <button class="btn-accent" id="flashAADT" style="margin-left:auto;">‚ö° Flash AADT</button>
        </div>
      </div>

      <div class="panel">
        <h3>QC & Options</h3>
        <div class="grid three">
          <div class="kv"><div class="key">Max Snap Dist</div><div class="val"><span class="kbd" id="qcSnap">30 m</span></div></div>
          <div class="kv"><div class="key">Max Bearing Œî</div><div class="val"><span class="kbd" id="qcBearing">25¬∞</span></div></div>
          <div class="kv"><div class="key">AADT Min</div><div class="val"><span class="kbd" id="qcMinAADT">100</span></div></div>
        </div>
        <div class="row" style="margin-top:6px;">
          <label class="switch">
            <input type="checkbox" id="maskRamps" checked>
            <span class="track"><span class="thumb"></span></span>
          </label>
          <span>Mask ramps / service roads</span>
        </div>
        <div class="row">
          <button class="btn-ghost" id="refreshBtn">Refresh Overlays</button>
          <button class="btn-ghost" id="recenterBtn">Recenter</button>
          <button class="btn-danger" id="resetBtn">Reset</button>
        </div>
      </div>

      <div class="panel">
        <h3>Export</h3>
        <div class="row">
          <button id="exportPNG" class="btn-ghost">üì∑ Map PNG</button>
          <button id="exportJSON" class="btn-ghost">üßæ Analysis JSON</button>
          <button id="exportZIP" class="btn-primary">üóúÔ∏è ZIP (PNG + JSON)</button>
        </div>
        <div class="row">
          <button id="exportCSV" class="btn-ghost">üìÑ Competitors CSV</button>
          <button id="exportPDF" class="btn-accent" style="margin-left:auto;">üìë PDF Report</button>
        </div>
        <div class="env">Exports include QC flags, competitor counts, and ProspectScore.</div>
      </div>
    </div>

    <div id="left">
      <div class="panel" id="mathPanel">
        <h3>Math & Assumptions</h3>
        <div id="qcBadges" style="margin-bottom:6px;"></div>
        <div class="grid two">
          <div class="kv"><div class="key">AADT</div><div class="val" id="kvAADT">‚Äî</div></div>
          <div class="kv"><div class="key">Route</div><div class="val" id="kvRoute">‚Äî</div></div>
          <div class="kv"><div class="key">Bearing</div><div class="val" id="kvBearing">‚Äî</div></div>
          <div class="kv"><div class="key">Direction</div><div class="val" id="kvDir">‚Äî</div></div>
        </div>
        <div class="sep"></div>
        <div class="grid two">
          <div class="kv"><div class="key">Competitors in 1.5 mi</div><div class="val" id="kvCompetitors">0</div></div>
          <div class="kv"><div class="key">Independent vs Chain</div><div class="val" id="kvIndChain">‚Äî</div></div>
        </div>
        <div class="sep"></div>
        <div class="grid two">
          <div class="kv"><div class="key">Formula</div><div class="val" id="kvFormula">AADT √ó 0.02 √ó 8 √ó 30</div></div>
          <div class="kv"><div class="key">Monthly Gallons</div><div class="val" id="kvGallons">‚Äî</div></div>
        </div>
        <div class="sep"></div>
        <div class="grid two">
          <div class="kv"><div class="key">ProspectScore</div><div class="val score" id="kvScore">‚Äî</div></div>
          <div class="kv"><div class="key">Score Breakdown</div><div class="val" id="kvScoreBreak">‚Äî</div></div>
        </div>
        <div class="env" style="margin-top:6px;">Competitor count is always shown (even when AADT is valid). QC must pass to compute gallons. ProspectScore reflects AADT, QC, competitor pressure, and mix.</div>
      </div>

      <div class="panel" id="assumptionsPanel">
        <h3>Assumptions</h3>
        <ul style="margin:0 0 0 18px; padding:0; color: var(--muted); font-size: 13px; line-height: 1.45;">
          <li>2% of vehicles stop for gas.</li>
          <li>Average purchase is 8 gallons.</li>
          <li>30 days per month for coarse planning.</li>
          <li>Ramps/service roads masked for mainline traffic, unless toggled off.</li>
          <li>QC checks: max 30 m snap distance, 25¬∞ bearing delta, route normalization.</li>
        </ul>
      </div>

      <div class="panel" id="flagsPanel">
        <h3>Flags</h3>
        <div id="flagsList" class="env">No flags yet.</div>
      </div>
    </div>

    <div id="map"></div>

    <div id="right">
      <div class="panel" id="summaryPanel">
        <h3>Summary</h3>
        <div id="summaryText" style="white-space: pre-wrap; line-height: 1.45;">Run an estimate to see the QC‚Äëaware summary. Any mention of ‚ÄúCSV‚Äù will be suppressed.</div>
      </div>

      <div class="panel" id="competitorsPanel">
        <h3>Competitors (1.5 mi)</h3>
        <div class="scroll" style="max-height: 260px;">
          <table id="competitorsTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Brand</th>
                <th>Dist (mi)</th>
                <th>Lat</th>
                <th>Lng</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="sep"></div>
        <div class="grid two">
          <div class="kv"><div class="key">Total</div><div class="val" id="compTotal">0</div></div>
          <div class="kv"><div class="key">Ind / Chain</div><div class="val" id="compMix">‚Äî</div></div>
        </div>
      </div>

      <div class="panel" id="legendPanel">
        <h3>Legend</h3>
        <div>
          <span class="badge ok">QC Passed</span>
          <span class="badge verify">VERIFY: checks needed</span>
          <span class="badge info">INFO</span>
          <span class="badge bad">ERROR</span>
        </div>
        <div class="env" style="margin-top:8px;">Specific verify badges replace generic ‚ÄúFallback AADT Used‚Äù.</div>
      </div>
    </div>

    <footer>
      <div>Fuel IQ ‚Ä¢ AADT + Competitor QC ‚Ä¢ Build: <span id="buildId">2025‚Äë10‚Äë02</span></div>
      <div>Shortcuts: <span class="kbd">F</span>lash AADT ‚Ä¢ <span class="kbd">R</span>efresh ‚Ä¢ <span class="kbd">E</span>stimate</div>
    </footer>
  </div>

  <script>
    // --- Inline config reflecting Pulse ---
    const CONFIG = {
      env: 'production',
      data: {
        roads: '/data/state_roads.geojson',
        aadt: '/data/aadt.geojson',
        competitors: '/data/competitors.csv'
      },
      qc: { snap_m: 30, bearing_deg: 25, min_aadt: 100, mask_ramps: true },
      competitors: { radius_mi: 1.5, independentTags: ['Independent','Unbranded','Unknown'], chainTags: ['Sunoco','BP','Shell','Exxon','Marathon','Circle K','7-Eleven','Wawa','RaceTrac','Sheetz','QuikTrip','Speedway'] }
    };

    // --- Global state ---
    const state = {
      map: null,
      pin: null,
      layers: { roads: null, aadtPoints: null, aadtLines: null, competitors: null },
      lastAnalysis: null,
      lastSnapshot: { png: null, json: null },
      status: { server: 'Unknown', google: 'Unknown', overpass: 'Unknown' },
      competitorsInRadius: [],
    };

    // --- Utilities ---
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
    const haversineMi = (a, b) => {
      const R = 3958.7613; // miles
      const dLat = (b.lat - a.lat) * Math.PI/180;
      const dLng = (b.lng - a.lng) * Math.PI/180;
      const lat1 = a.lat * Math.PI/180;
      const lat2 = b.lat * Math.PI/180;
      const sinDLat = Math.sin(dLat/2);
      const sinDLng = Math.sin(dLng/2);
      const h = sinDLat*sinDLat + Math.cos(lat1)*Math.cos(lat2)*sinDLng*sinDLng;
      return 2*R*Math.asin(Math.sqrt(h));
    };
    const fmt = {
      int: (n) => n==null||isNaN(n)?'‚Äî':Math.round(n).toLocaleString(),
      num: (n, d=1) => n==null||isNaN(n)?'‚Äî':Number(n).toFixed(d),
      deg: (n) => n==null||isNaN(n)?'‚Äî':`${Math.round(n)}¬∞`,
      miles: (n,d=2) => n==null||isNaN(n)?'‚Äî':Number(n).toFixed(d),
    };

    function setChip(id, text, kind='info') {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.remove('ok','warn','bad','info');
      el.classList.add(kind);
      el.textContent = text;
    }

    function setCoordChip(lat, lng) {
      const t = (lat && lng) ? `${lat.toFixed(6)}, ${lng.toFixed(6)}` : '‚Äî';
      setChip('coordChip', `Lat/Lng: ${t}`);
    }

    // --- Map setup ---
    function initMap() {
      const map = L.map('map', { zoomControl: true }).setView([35.7879, -78.6447], 10);
      state.map = map;

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      map.on('click', (e) => {
        setPin(e.latlng.lat, e.latlng.lng);
      });

      document.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'f') flashAADT();
        if (e.key.toLowerCase() === 'r') refreshOverlays();
        if (e.key.toLowerCase() === 'e') runEstimate();
      });
    }

    function setPin(lat, lng) {
      if (!state.map) return;
      if (state.pin) state.map.removeLayer(state.pin);
      state.pin = L.marker([lat, lng], { draggable: true }).addTo(state.map);
      state.pin.on('dragend', () => {
        const { lat, lng } = state.pin.getLatLng();
        document.getElementById('lat').value = lat.toFixed(6);
        document.getElementById('lng').value = lng.toFixed(6);
        setCoordChip(lat, lng);
      });
      state.map.setView([lat, lng], 15);
      document.getElementById('lat').value = lat.toFixed(6);
      document.getElementById('lng').value = lng.toFixed(6);
      setCoordChip(lat, lng);
    }

    // --- Overlays ---
    async function loadRoads() {
      try {
        const resp = await fetch(CONFIG.data.roads);
        if (!resp.ok) throw new Error('roads fetch failed');
        const gj = await resp.json();
        if (state.layers.roads) state.map.removeLayer(state.layers.roads);
        state.layers.roads = L.geoJSON(gj, { style: { weight: 3, opacity: 0.6, color: '#616161' } }).addTo(state.map);
      } catch (e) { console.warn('roads overlay error', e); }
    }

    async function loadAADT() {
      try {
        const resp = await fetch(CONFIG.data.aadt);
        if (!resp.ok) throw new Error('aadt fetch failed');
        const gj = await resp.json();
        // Split points and lines
        const pts = { type:'FeatureCollection', features: gj.features.filter(f=>f.geometry.type==='Point') };
        const lns = { type:'FeatureCollection', features: gj.features.filter(f=>f.geometry.type!=='Point') };
        if (state.layers.aadtPoints) state.map.removeLayer(state.layers.aadtPoints);
        if (state.layers.aadtLines) state.map.removeLayer(state.layers.aadtLines);
        state.layers.aadtPoints = L.geoJSON(pts, {
          pointToLayer: (f, latlng) => L.circleMarker(latlng, {
            radius: clamp(((f.properties?.AADT||0)/5000), 3, 12),
            opacity: 0.9, weight: 1, color: '#111827', fillOpacity: 0.25
          }),
          onEachFeature: (f, layer) => {
            const v = f.properties?.AADT ?? '‚Äî';
            const r = f.properties?.ROUTE ?? '‚Äî';
            layer.bindPopup(`AADT: ${v}<br>Route: ${r}`);
          }
        }).addTo(state.map);
        state.layers.aadtLines = L.geoJSON(lns, {
          style: { weight: 4, opacity: 0.9, color: '#111827' },
          onEachFeature: (f, layer) => {
            const v = f.properties?.AADT ?? '‚Äî';
            const r = f.properties?.ROUTE ?? '‚Äî';
            layer.bindPopup(`AADT: ${v}<br>Route: ${r}`);
          }
        }).addTo(state.map);
      } catch (e) { console.warn('aadt overlay error', e); }
    }

    async function loadCompetitors() {
      try {
        const csvText = await fetch(CONFIG.data.competitors).then(r=>r.text());
        const parsed = Papa.parse(csvText, { header: true });
        const rows = parsed.data.filter(r => r && r.lat && r.lng);
        if (state.layers.competitors) state.map.removeLayer(state.layers.competitors);
        state.layers.competitors = L.layerGroup();
        rows.forEach((r,i) => {
          const lat = Number(r.lat), lng = Number(r.lng);
          if (isNaN(lat) || isNaN(lng)) return;
          const m = L.circleMarker([lat,lng], { radius: 6, color: '#0B6EEF', fillColor:'#93C5FD', fillOpacity:.75, weight:1 });
          m.bindPopup(`<b>${r.name||'Unknown'}</b><br>Brand: ${r.brand||'‚Äî'}<br>${fmt.num(lat,6)}, ${fmt.num(lng,6)}`);
          state.layers.competitors.addLayer(m);
        });
        state.layers.competitors.addTo(state.map);
      } catch (e) { console.warn('competitors overlay error', e); }
    }

    function toggleLayer(layer, on) {
      if (!layer) return;
      if (on) layer.addTo(state.map); else state.map.removeLayer(layer);
    }

    function flashAADT() {
      const containers = [];
      if (state.layers.aadtPoints) containers.push(state.layers.aadtPoints);
      if (state.layers.aadtLines) containers.push(state.layers.aadtLines);
      containers.forEach(l => {
        const el = l.getLayers ? l.getLayers().map(x=>x._path || x._container).filter(Boolean) : [];
        el.forEach(e => { e.classList.add('flash'); setTimeout(()=>e.classList.remove('flash'), 600); });
      });
    }

    async function refreshOverlays() {
      await Promise.all([loadRoads(), loadAADT(), loadCompetitors()]);
      document.getElementById('statusBar').classList.add('flash');
      setTimeout(()=>document.getElementById('statusBar').classList.remove('flash'), 600);
    }

    // --- Analysis ---
    const ANALYZE_ENDPOINTS = ['/api/analyze','/analyze'];

    async function callAnalyze(payload) {
      for (const url of ANALYZE_ENDPOINTS) {
        try {
          const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
          if (!resp.ok) throw new Error(`analyze bad status ${resp.status}`);
          setChip('apiServer', 'API: Server ‚Äî OK', 'ok');
          return await resp.json();
        } catch (e) { console.warn('analyze failed at', url, e); setChip('apiServer', 'API: Server ‚Äî Retry', 'warn'); }
      }
      setChip('apiServer', 'API: Server ‚Äî Unreachable', 'bad');
      throw new Error('All analyze endpoints failed');
    }

    function sanitizeSummary(text) {
      if (!text) return '';
      return text.replace(/\bCSV\b/gi, '');
    }

    function qcBadgeEl(kind, text) {
      const span = document.createElement('span');
      span.className = `badge ${kind}`;
      span.textContent = text;
      return span;
    }

    function setQCBadges(qc) {
      const c = document.getElementById('qcBadges');
      c.innerHTML = '';
      if (!qc) return;
      if (qc.status === 'ok') c.appendChild(qcBadgeEl('ok','QC Passed'));
      (qc.flags||[]).forEach(f => {
        let label = f;
        if (f === 'MISSING_BASELINE_ROAD') label = 'VERIFY: Missing baseline road';
        if (f === 'BEARING_MISMATCH') label = 'VERIFY: Bearing mismatch';
        if (f === 'ROUTE_MISMATCH') label = 'VERIFY: Route mismatch';
        if (f === 'SUSPECT_DUPLICATE') label = 'VERIFY: Suspect duplicate';
        if (f === 'MASKED_RAMP') label = 'INFO: Ramp/service road masked';
        const kind = f === 'MASKED_RAMP' ? 'info' : 'verify';
        c.appendChild(qcBadgeEl(kind, label));
      });
    }

    function setFlagsList(qc) {
      const el = document.getElementById('flagsList');
      if (!qc || !qc.flags || qc.flags.length === 0) { el.textContent = 'No flags.'; return; }
      el.innerHTML = '<ul style="margin:0 0 0 18px; padding:0;">' +
        qc.flags.map(f => `<li>${f}</li>`).join('') + '</ul>';
    }

    function setMath(analysis) {
      const a = analysis || {};
      document.getElementById('kvAADT').textContent = a.aadt != null ? fmt.int(a.aadt) : '‚Äî';
      document.getElementById('kvRoute').textContent = a.route || '‚Äî';
      document.getElementById('kvBearing').textContent = a.bearing != null ? fmt.deg(a.bearing) : '‚Äî';
      document.getElementById('kvDir').textContent = a.direction || '‚Äî';
      document.getElementById('kvGallons').textContent = a.monthly_gallons != null ? fmt.int(a.monthly_gallons) : '‚Äî';
      document.getElementById('kvFormula').textContent = 'AADT √ó 0.02 √ó 8 √ó 30';

      // Prospect score styling and breakdown
      const kvScore = document.getElementById('kvScore');
      const kvScoreBreak = document.getElementById('kvScoreBreak');
      kvScore.classList.remove('good','mid','bad');
      if (a.prospect_score && typeof a.prospect_score.total === 'number') {
        kvScore.textContent = a.prospect_score.total + ' / 100';
        if (a.prospect_score.total >= 75) kvScore.classList.add('good');
        else if (a.prospect_score.total >= 50) kvScore.classList.add('mid');
        else kvScore.classList.add('bad');
        const b = a.prospect_score.breakdown || {};
        kvScoreBreak.textContent = `AADT ${b.aadt_points||0}, Comp ${b.comp_pressure_points||0}, QC ${b.qc_points||0}, Mix ${b.mix_points||0}`;
      } else {
        kvScore.textContent = '‚Äî';
        kvScoreBreak.textContent = '‚Äî';
      }
    }

    function setCompetitors(list) {
      const tbody = document.querySelector('#competitorsTable tbody');
      tbody.innerHTML = '';
      const rows = (list||[]).map((r, i) => ({
        idx: i+1,
        name: r.name || 'Unknown',
        brand: r.brand || '‚Äî',
        dist: r.distance_mi != null ? r.distance_mi : (r.center ? haversineMi(r.center, {lat: r.lat, lng: r.lng}) : null),
        lat: r.lat, lng: r.lng
      }));
      rows.sort((a,b)=> (a.dist||0)-(b.dist||0));
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.idx}</td><td>${r.name}</td><td>${r.brand}</td><td>${fmt.miles(r.dist)}</td><td>${fmt.num(r.lat,6)}</td><td>${fmt.num(r.lng,6)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('compTotal').textContent = rows.length;
      const ind = rows.filter(r => CONFIG.competitors.independentTags.includes(String(r.brand))).length;
      const chn = rows.filter(r => CONFIG.competitors.chainTags.includes(String(r.brand))).length;
      document.getElementById('compMix').textContent = `${ind} / ${chn}`;
      document.getElementById('kvCompetitors').textContent = rows.length;
      document.getElementById('kvIndChain').textContent = `${ind} / ${chn}`;
    }

    function computeMonthlyGallons(aadt) {
      if (aadt == null || isNaN(aadt)) return null;
      return Math.round(aadt * 0.02 * 8 * 30);
    }

    function withinRadiusCompetitors(center) {
      const out = [];
      // Pull from map overlay markers
      if (state.layers.competitors) {
        state.layers.competitors.eachLayer(layer => {
          if (!layer.getLatLng) return;
          const { lat, lng } = layer.getLatLng();
          const d = haversineMi(center, { lat, lng });
          if (d <= CONFIG.competitors.radius_mi + 1e-9) {
            const html = layer.getPopup()?.getContent?.() || '';
            const name = (html.match(/<b>(.*?)<\/b>/)||[])[1] || 'Unknown';
            const brandMatch = html.match(/Brand: ([^<]+)/);
            const brand = brandMatch ? brandMatch[1] : '‚Äî';
            out.push({ name, brand, lat, lng, distance_mi: d, center });
          }
        });
      }
      return out;
    }

    async function runEstimate() {
      const lat = parseFloat(document.getElementById('lat').value);
      const lng = parseFloat(document.getElementById('lng').value);
      if (isNaN(lat) || isNaN(lng)) { alert('Set a valid Lat/Lng or click the map.'); return; }
      setChip('apiServer','API: Server ‚Äî Running‚Ä¶','info');

      const payload = {
        lat, lng,
        options: {
          qc: CONFIG.qc,
          maskRamps: document.getElementById('maskRamps').checked,
          radius_mi: CONFIG.competitors.radius_mi
        }
      };

      try {
        const res = await callAnalyze(payload);
        // Expected shape:
        // { qc:{status:'ok'|'verify'|'error', flags:[]}, aadt, route, bearing, direction, monthly_gallons?, competitors:[...], prospect_score:{total,breakdown}, summary }
        const center = { lat, lng };

        // Always compute competitors locally to guarantee count even if backend omits it
        const localComps = withinRadiusCompetitors(center);
        state.competitorsInRadius = localComps;

        // Merge backend comps if provided
        const competitors = Array.isArray(res.competitors) && res.competitors.length ? res.competitors : localComps;
        setCompetitors(competitors);

        // QC badges
        const qc = res.qc || { status: 'ok', flags: [] };
        setQCBadges(qc);
        setFlagsList(qc);

        // Monthly gallons only if QC passes and AADT present
        let monthly = null;
        if (qc.status === 'ok' && (res.aadt != null) && (res.aadt >= CONFIG.qc.min_aadt)) {
          monthly = computeMonthlyGallons(res.aadt);
        }

        const analysis = {
          aadt: res.aadt ?? null,
          route: res.route || null,
          bearing: res.bearing ?? null,
          direction: res.direction || null,
          monthly_gallons: monthly,
          prospect_score: res.prospect_score || null
        };
        state.lastAnalysis = { ...res, analysis, center, competitors };
        setMath({ ...analysis, prospect_score: res.prospect_score });

        const cleanSummary = sanitizeSummary(res.summary || '');
        const flaggedPrefix = (qc.flags && qc.flags.length)
          ? `QC Flags: ${qc.flags.join(', ')}\n\n` : '';
        document.getElementById('summaryText').textContent = flaggedPrefix + cleanSummary;

        // Drop a pin / move if necessary
        setPin(lat, lng);
      } catch (e) {
        console.error(e);
        alert('Analysis failed. Check server logs.');
      }
    }

    // --- Geolocation ---
    function locateMe() {
      if (!navigator.geolocation) { alert('Geolocation unsupported.'); return; }
      navigator.geolocation.getCurrentPosition((pos) => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        setPin(lat, lng);
      }, (err) => {
        alert('Unable to get your location.');
      });
    }

    // --- Exports ---
    async function exportPNG() {
      const mapEl = document.querySelector('#map .leaflet-container');
      const canvas = await html2canvas(mapEl, { useCORS: true, backgroundColor: '#0b1220', logging: false });
      canvas.toBlob((blob) => { saveAs(blob, 'fueliq_map.png'); });
    }

    function exportJSON() {
      const data = state.lastAnalysis || { note: 'No analysis yet' };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      saveAs(blob, 'fueliq_analysis.json');
    }

    async function exportZIP() {
      const zip = new JSZip();
      // PNG
      const mapEl = document.querySelector('#map .leaflet-container');
      const canvas = await html2canvas(mapEl, { useCORS: true, backgroundColor: '#0b1220', logging: false });
      const pngBlob = await new Promise(res => canvas.toBlob(res));
      zip.file('fueliq_map.png', pngBlob);
      // JSON
      const data = state.lastAnalysis || { note: 'No analysis yet' };
      zip.file('fueliq_analysis.json', JSON.stringify(data, null, 2));
      const content = await zip.generateAsync({ type: 'blob' });
      saveAs(content, 'fueliq_export.zip');
    }

    function exportCSV() {
      const rows = state.competitorsInRadius || [];
      const header = ['name','brand','distance_mi','lat','lng'];
      const csv = [header.join(',')].concat(rows.map(r => [
        JSON.stringify(r.name||''), JSON.stringify(r.brand||''), (r.distance_mi||'').toString(), r.lat, r.lng
      ].join(','))).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      saveAs(blob, 'fueliq_competitors.csv');
    }

    async function exportPDF() {
      const payload = state.lastAnalysis || null;
      if (!payload) { alert('Run an estimate first.'); return; }
      try {
        const resp = await fetch('/api/export/pdf', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        if (!resp.ok) throw new Error('PDF export failed');
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'fueliq_report.pdf'; a.click();
        URL.revokeObjectURL(url);
      } catch (e) {
        console.error(e); alert('PDF export failed');
      }
    }

    // --- Event wiring ---
    function wireUI() {
      document.getElementById('locateBtn').addEventListener('click', locateMe);
      document.getElementById('estimateBtn').addEventListener('click', runEstimate);
      document.getElementById('clearBtn').addEventListener('click', () => {
        document.getElementById('addr').value = '';
        document.getElementById('lat').value = '';
        document.getElementById('lng').value = '';
        if (state.pin) { state.map.removeLayer(state.pin); state.pin = null; }
        setCoordChip();
      });
      document.getElementById('roadsToggle').addEventListener('change', (e) => toggleLayer(state.layers.roads, e.target.checked));
      document.getElementById('aadtToggle').addEventListener('change', (e) => {
        toggleLayer(state.layers.aadtPoints, e.target.checked);
        toggleLayer(state.layers.aadtLines, e.target.checked);
      });
      document.getElementById('flashAADT').addEventListener('click', flashAADT);
      document.getElementById('refreshBtn').addEventListener('click', refreshOverlays);
      document.getElementById('recenterBtn').addEventListener('click', () => { if (state.pin) state.map.setView(state.pin.getLatLng(), 15); });
      document.getElementById('resetBtn').addEventListener('click', async () => {
        if (!confirm('Reset overlays and UI?')) return;
        await refreshOverlays();
        document.getElementById('summaryText').textContent = 'Run an estimate to see the QC‚Äëaware summary.';
        document.getElementById('flagsList').textContent = 'No flags yet.';
        document.getElementById('kvAADT').textContent = '‚Äî';
        document.getElementById('kvRoute').textContent = '‚Äî';
        document.getElementById('kvBearing').textContent = '‚Äî';
        document.getElementById('kvDir').textContent = '‚Äî';
        document.getElementById('kvGallons').textContent = '‚Äî';
        document.getElementById('kvCompetitors').textContent = '0';
        document.querySelector('#competitorsTable tbody').innerHTML = '';
        document.getElementById('kvScore').textContent = '‚Äî';
        document.getElementById('kvScoreBreak').textContent = '‚Äî';
      });
      document.getElementById('exportPNG').addEventListener('click', exportPNG);
      document.getElementById('exportJSON').addEventListener('click', exportJSON);
      document.getElementById('exportZIP').addEventListener('click', exportZIP);
      document.getElementById('exportCSV').addEventListener('click', exportCSV);
      document.getElementById('exportPDF').addEventListener('click', exportPDF);

      // Show QC config numbers
      document.getElementById('qcSnap').textContent = CONFIG.qc.snap_m + ' m';
      document.getElementById('qcBearing').textContent = CONFIG.qc.bearing_deg + '¬∞';
      document.getElementById('qcMinAADT').textContent = CONFIG.qc.min_aadt;
      document.getElementById('maskRamps').checked = CONFIG.qc.mask_ramps;

      document.getElementById('envText').textContent = `Environment: ${CONFIG.env}`;
    }

    // --- Boot ---
    (async function boot(){
      initMap();
      wireUI();
      await refreshOverlays();
      setChip('apiGoogle', 'API: Google ‚Äî Working', 'ok'); // optimistic until health checks wired
      setChip('apiOverpass', 'API: Overpass ‚Äî Working', 'ok');
      setChip('apiServer', 'API: Server ‚Äî Ready', 'ok');
    })();
  </script>
</body>
</html>
