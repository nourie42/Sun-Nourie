<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sunoco LP Gas Station Analyzer</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root { --bg:#0e1117; --panel:#161a22; --line:#2a2f3a; --text:#e6e6e6; --muted:#9aa4b2; --primary:#3b82f6; }
    *{ box-sizing:border-box; }
    body { background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 40px; margin: 0 0 12px; }
    .card { background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:16px; margin:12px 0; }
    label { display:block; font-weight:600; margin:10px 0 6px; }
    input, select { width:100%; padding:12px; border-radius:8px; border:1px solid var(--line); background:#0f1320; color:var(--text); }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .row>div { flex:1; min-width:260px; }
    button { background:var(--primary); color:#fff; border:0; padding:12px 16px; border-radius:10px; font-weight:700; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .muted { color:var(--muted); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .right { text-align:right; }
    #map { height:420px; border-radius:12px; border:1px solid var(--line); position: relative; }
    #mapOverlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(14,17,23,0.6); border-radius:12px; font-weight:700; }
    ul { margin: 8px 0 0 18px; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
    .summary { white-space: pre-wrap; }
    datalist option { color:#000; }
    .pill { display:inline-flex; align-items:center; gap:8px; background:#0f1320; border:1px solid var(--line); padding:8px 10px; border-radius:999px;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Sunoco LP Gas Station Analyzer</h1>

    <div class="card">
      <div class="row">
        <div>
          <label>Search by <span class="muted">address, city+state, lat,lng, or station name</span></label>
          <input id="addr" list="addr_suggest" placeholder="6132 Knightdale Blvd, Knightdale NC 27545 or 'Sheetz Knightdale'" autocomplete="off" />
          <datalist id="addr_suggest"></datalist>
          <div class="muted" style="margin-top:6px;font-size:12px;">
            Tip: you can paste a Google Maps URL or raw <span class="mono">lat,lon</span>.
          </div>
        </div>
        <div>
          <label>Regular MPDs</label>
          <input id="mpds" type="number" value="3" />
        </div>
        <div>
          <label>Diesel positions (optional)</label>
          <input id="diesel" type="number" value="0" />
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button id="go">Estimate</button>
        <span class="muted">Results include AADT sanity, competition, developments, capacity cap, and a detailed summary.</span>
      </div>
      <div id="chips" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;"></div>
    </div>

    <div class="card">
      <div id="out" class="muted">—</div>
    </div>

    <div class="card">
      <div class="muted" style="margin-bottom:6px;">Map: site & competition (1 mile)</div>
      <div id="map">
        <div id="mapOverlay" class="muted">—</div>
      </div>
    </div>

    <div class="card">
      <b>Developments (planned/proposed/permit/coming-soon/construction)</b>
      <div id="devs" class="muted">—</div>
    </div>

    <div class="card">
      <b>Summary</b>
      <div id="summary" class="summary muted">—</div>
    </div>

    <div class="card">
      <details>
        <summary>Debug JSON</summary>
        <pre id="debug" class="mono muted">/ waiting…</pre>
      </details>
    </div>
  </div>

<script>
const $ = id => document.getElementById(id);
const out = $("out"), debug = $("debug"), goBtn = $("go");
const mapBox = $("map"), overlay = $("mapOverlay");
let map, markersLayer, mapInited=false;

function setOut(html){ out.innerHTML = html; }
function setDebug(obj){ debug.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2); }
function fmt(n){ return (n ?? 0).toLocaleString(undefined, { maximumFractionDigits: 0 }); }
function esc(s){ return (s ?? "").toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function setOverlay(msg){ overlay.textContent = msg; overlay.style.display = "flex"; }
function clearOverlay(){ overlay.style.display = "none"; }

async function callEstimate(){
  const body = {
    address: $("addr").value.trim(),
    mpds: Number($("mpds").value || 0),
    diesel: Number($("diesel").value || 0)
  };
  const r=await fetch("/estimate",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
  const t=await r.text(); if(!r.ok) throw new Error(`HTTP ${r.status}\n${t.slice(0,1200)}`);
  return JSON.parse(t);
}

async function estimate(){
  try{
    goBtn.disabled = true;
    setOut("<span class='muted'>Working…</span>");
    setOverlay("Loading, this can take up to 3 minutes to research");
    const d = await callEstimate();
    renderReport(d);
    renderMap(d.map);
    renderDevs(d.developments);
    renderSummary(d.summary);
    setDebug(d);
    renderChips(d);
  }catch(e){
    setOut(`<pre class="mono">${esc(e.message)}</pre>`);
    setOverlay("Error — see details above");
  }finally{
    goBtn.disabled = false;
  }
}

function renderReport(d){
  const i=d.inputs||{}, c=d.competition||{};
  const html = `
    <div class="grid">
      <div>
        <b>Base Estimate (gal/mo)</b>
        <div style="font-size:28px;font-weight:800;">${fmt(d.base)}</div>
        <div class="muted">Low–High: ${fmt(d.low)} – ${fmt(d.high)}</div>
      </div>
      <div class="right">
        <div>Year-2: <b>${fmt(d.year2)}</b></div>
        <div style="margin-top:6px;">Year-3: <b>${fmt(d.year3)}</b></div>
      </div>
    </div>
    <hr>
    <div>Inputs: AADT used <b>${fmt(i.aadt_used)}</b>; MPDs ${i.mpds}${i.diesel ? " + diesel "+i.diesel : ""}</div>
    <div>Competition (Overpass): ${c.count ?? 0} within 1 mi${c.nearest_mi != null ? "; nearest "+c.nearest_mi.toFixed(3)+" mi" : ""}${(c.notable_brands||[]).length ? "; notable: "+c.notable_brands.join(", ") : ""}; multiplier <b>${(c.multiplier||1).toFixed(2)}×</b></div>
    <div style="margin-top:8px">${esc(d.rationale||"")}</div>
  `;
  setOut(html);
}

function renderDevs(list){
  const el=$("devs");
  if(!Array.isArray(list)||!list.length){ el.innerHTML="<span class='muted'>none found</span>"; return; }
  el.innerHTML = "<ul>"+list.map(d=>`<li>${esc(d.name)} • ${esc(d.status)} • ${d.miles} mi</li>`).join("")+"</ul>";
}

function renderSummary(s){
  $("summary").textContent = s && s.trim().length ? s : "—";
}

function ensureLeaflet(){
  if(mapInited) return;
  map = L.map("map",{zoomControl:true});
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap"}).addTo(map);
  mapInited = true;
}

function renderMap(m){
  ensureLeaflet();
  if(markersLayer) markersLayer.remove();
  markersLayer = L.layerGroup().addTo(map);

  if(!m || !m.site){ overlay.textContent = "—"; return; }

  const site = [m.site.lat, m.site.lon];
  L.marker(site, { title: "Site" }).addTo(markersLayer).bindPopup(`<b>Site</b><br>${esc(m.site.label||"")}`);
  const comps = Array.isArray(m.competitors) ? m.competitors : [];
  for(const c of comps){
    L.circleMarker([c.lat,c.lon],{radius:6,weight:1,color:c.heavy?"#ff7f50":"#4ade80",fillOpacity:.85})
      .addTo(markersLayer).bindPopup(`<b>${esc(c.name||"Fuel station")}</b><br>${c.miles} mi`);
  }
  const bounds=L.latLngBounds([site, ...comps.map(c=>[c.lat,c.lon])]);
  map.fitBounds(bounds.pad(0.25));
  clearOverlay();
}

/* ---------- Address/Name Autocomplete (backend aggregator) ---------- */
let acTimer=null;
$("addr").addEventListener("input", ()=>{
  const q = $("addr").value.trim();
  if(acTimer) clearTimeout(acTimer);
  if(!q || q.length < 3){ $("addr_suggest").innerHTML=""; return; }
  acTimer = setTimeout(async ()=>{
    try{
      const r = await fetch(`/suggest?q=${encodeURIComponent(q)}`);
      if(!r.ok) return;
      const arr = await r.json();
      const dl = $("addr_suggest");
      dl.innerHTML = arr.map(x=>`<option value="${esc(x.label)}"></option>`).join("");
    }catch(_){}
  }, 250);
});

function renderChips(d){
  const chips=$("chips");
  chips.innerHTML="";
  const items=[];
  if(d.inputs?.class_bucket) items.push({k:"Road",v:d.inputs.class_bucket});
  if(d.inputs?.aadt_note) items.push({k:"AADT",v:d.inputs.aadt_note});
  if(d.competition?.count!=null) items.push({k:"Competitors",v:String(d.competition.count)});
  if(d.competition?.multiplier) items.push({k:"Comp ×",v:d.competition.multiplier.toFixed(2)});
  if(d.inputs?.aadt_actual?.value) items.push({k:"DOT",v:String(d.inputs.aadt_actual.value)});
  for(const it of items){
    const el=document.createElement("div"); el.className="pill";
    el.innerHTML=`<b>${esc(it.k)}</b><span class="muted">${esc(it.v)}</span>`;
    chips.appendChild(el);
  }
}

$("go").addEventListener("click", estimate);
setOverlay("—");
</script>
</body>
</html>
