<!-- Fuel IQ UI v2025-08-29m -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sunoco, LP Fuel IQ - Fuel Site Analyzer</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>

<style>
:root{ --bg:#0b0e15; --panel:#111725; --panel2:#0f1421; --line:#263145; --text:#eaeef7; --muted:#97a3b8; --brand:#0ea5e9; --brand2:#22d3ee; --pill:#0f1929; --warn:#ff6b6b; }
*{ box-sizing:border-box; } body{ background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; padding-bottom:72px; }
.wrap{ max-width:1120px; margin:24px auto; padding:0 16px; }
header{ display:flex; align-items:center; gap:14px; margin-bottom:6px; }
header h1{ font-size:28px; margin:0; } .build{ margin-left:auto; font-size:12px; color:#8aa2c0; }
.instructions{ margin:4px 0 12px; color:#cfe3ff; font-size:13px; }

.card{ background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line); border-radius:12px; padding:16px; margin:12px 0; }
label{ display:block; font-weight:600; margin:8px 0 6px; color:#d8e3f6; }
input, select{ width:100%; padding:12px; border-radius:10px; border:1px solid var(--line); background:#0b1220; color:#eaeef7; }
button{ background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#fff; border:0; padding:12px 16px; border-radius:10px; font-weight:700; cursor:pointer; }
button:disabled{ opacity:.6; cursor:not-allowed; }

.row{ display:grid; grid-template-columns:1.6fr 0.7fr 0.7fr 0.8fr; gap:12px; align-items:start; }
@media (max-width:980px){ .row{ grid-template-columns:1fr; } }

.toolbar{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:12px; }
.muted{ color:var(--muted); } .subtle{ font-size:12px; opacity:.9; }

#map{ height:420px; border-radius:12px; border:1px solid var(--line); position:relative; }
#overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(11,14,21,.55); border-radius:12px; font-weight:800; color:#cde9ff; font-size:18px; padding:20px; text-align:center; }

#svWrap{ margin-top:10px; } /* allow navigation */ 
#sv{ width:100%; height:380px; border:0; border-radius:12px; border:1px solid var(--line); background:#0b1220; }

.ac-wrap{ position:relative; }
.ac-list{ position:absolute; top:100%; left:0; right:0; z-index:30; margin-top:6px; background:#0b1220; border:1px solid var(--line); border-radius:12px; max-height:320px; overflow:auto; box-shadow:0 18px 36px rgba(0,0,0,.35); }
.ac-item{ padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,.04); } .ac-item:last-child{ border-bottom:0; }
.ac-item:hover{ background:#101a2b; } .badge{ display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--line); background:var(--pill); color:#a9c5ff; margin-left:8px; }

details summary{ cursor:pointer; }
.adv-line{ display:flex; align-items:center; gap:10px; overflow-x:auto; white-space:nowrap; padding-bottom:6px; }
.chip{ display:inline-flex; align-items:center; gap:8px; background:#0f1929; border:1px solid var(--line); padding:8px 10px; border-radius:999px; font-size:13px; }
.chip input{ width:auto; accent-color:#22d3ee; }
.radio-row{ display:inline-flex; gap:10px; white-space:nowrap; }

.hero{ display:flex; justify-content:space-between; align-items:flex-end; gap:12px; }
.hero .num{ font-size:44px; font-weight:900; letter-spacing:.5px; }
.hero .num.red{ color:var(--warn); }
.hero .sub{ font-size:13px; color:#a9b6d0; }
.stop-flag{ display:none; align-items:center; gap:10px; color:#ff6b6b; font-weight:800; margin-top:6px; }
.stop-flag .icon{ font-size:22px; background:#ff3b30; color:#fff; border-radius:6px; padding:2px 6px; }

.footerbar{ position:fixed; left:0; right:0; bottom:0; background:linear-gradient(180deg,#0c1220,#0a0f1a); border-top:1px solid var(--line); padding:10px 16px; display:flex; justify-content:center; gap:12px; z-index:50; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Sunoco, LP Fuel IQ - Fuel Site Analyzer</h1>
    <span class="build">UI v2025-08-29m</span>
  </header>
  <div class="instructions">
    <b>Instructions:</b> Enter Address, click <i>Estimate</i>. Do not exit your browser or let your phone screen shut off until results are ready or you will encounter errors. Click <i>Advanced Options</i> to make changes.
  </div>

  <!-- Inputs -->
  <div class="card">
    <div class="row">
      <div>
        <label>Site search</label>
        <div class="ac-wrap">
          <input id="addr" placeholder="Enter business or address" autocomplete="off"/>
          <div id="ac" class="ac-list" style="display:none;"></div>
        </div>
        <div class="muted subtle" id="acHint" style="margin-top:6px; display:none;">Searching suggestionsâ€¦</div>
        <div class="muted subtle" id="apiStatus" style="margin-top:6px">API Status: checkingâ€¦</div>
      </div>
      <div><label>Regular MPDs</label><input id="mpds" type="number" value="3" min="1"/></div>
      <div><label>Diesel positions</label><input id="diesel" type="number" value="0" min="0"/></div>
      <div><label>AADT override</label><input id="aadtOverride" type="number"/></div>
    </div>
    <div class="toolbar">
      <button id="go">Estimate</button>
      <span id="goStatus" class="muted" style="display:none;">Estimating, please waitâ€¦</span>
      <span class="muted">Please click Estimate again if you change address, Advanced Options or AADT.</span>
    </div>
  </div>

  <!-- Advanced -->
  <div class="card">
    <details>
      <summary><b>Advanced options</b></summary>
      <div class="adv-line" id="advRow">
        <label class="chip"><input type="checkbox" id="ex_large_dev"> Large residential or commercial developments (+7.5%)</label>
        <label class="chip"><input type="checkbox" id="ex_hours18"> Operating hours 18h (âˆ’7.5%)</label>
        <label class="chip"><input type="checkbox" id="ex_highincome"> Higher-income trade area (+2.5%)</label>
        <label class="chip"><input type="checkbox" id="ex_competitive_pricing"> Competitive site gas pricing (+10%)</label>
        <label class="chip"><input type="checkbox" id="ex_rural"> Rural bonus (0 comps within 3 mi) (+30%)</label>
        <label class="chip"><input type="checkbox" id="ex_lowrating"> Ratings below 4.0 (âˆ’30%)</label>
      </div>
      <div style="margin-top:8px;">
        <label><b>Gas pricing vs area</b></label>
        <div class="radio-row">
          <label class="chip"><input type="radio" name="pricepos" value="below"> Below competition (+10%)</label>
          <label class="chip"><input type="radio" name="pricepos" value="inline" checked> In line (0%)</label>
          <label class="chip"><input type="radio" name="pricepos" value="above"> Above competition (âˆ’10%)</label>
        </div>
      </div>
      <div class="adv-line" style="margin-top:8px;">
        <span class="chip" id="addExtra" style="cursor:pointer;">+ Add adj. (%)</span>
        <span id="activeExtras" class="subtle"></span>
      </div>
      <div id="extraList" style="margin-top:8px;"></div>
    </details>
  </div>

  <!-- Estimate -->
  <div class="card" id="estimateCard">
    <div class="hero">
      <div>
        <div>Adjusted Base Estimate (LOW)</div>
        <div class="num" id="estNum">â€”</div>
        <div class="sub" id="estRange">Full range: â€”</div>
        <div id="lowReviewMsg" class="sub" style="color:#ff8a80; display:none;">Estimate lowered due to low reviews per NACS estimates.</div>
        <div id="sunocoStop" class="stop-flag"><span class="icon">ðŸ›‘</span> Sunoco station within 1 mile â€” verify brand conflict.</div>
      </div>
      <div class="right sub">
        <div>Year-2: <b id="y2">â€”</b></div>
        <div>Year-3: <b id="y3">â€”</b></div>
      </div>
    </div>
    <hr/>
    <div id="aadtBanner" class="muted">â€”</div>
    <div id="compLine" class="muted">â€”</div>
  </div>

  <div class="card">
    <b>How this estimate was calculated</b>
    <div id="calcBox" class="muted">â€”</div>
  </div>

  <div class="card">
    <div class="muted">Map: Site & competitors (1.5 mi)</div>
    <div id="map"><div id="overlay" class="muted">â€”</div></div>
    <div id="svWrap"><div class="muted" style="margin-top:10px;">Street View</div><iframe id="sv" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div>
  </div>

  <div class="card"><b>Developments â€” OSM</b><div id="devs" class="muted">â€”</div></div>
  <div class="card"><b>Developments â€” News</b><div id="devsExternalNews" class="muted">â€”</div></div>
  <div class="card"><b>Developments â€” Permits / Boards</b><div id="devsExternalPermits" class="muted">â€”</div></div>

  <div class="card"><b>Google Rating</b><div id="ratingLine" class="muted">â€”</div></div>
  <div class="card"><b>Summary (GPT)</b><div id="summary" class="muted">â€”</div></div>
</div>

<div class="footerbar"><button id="exportPDF">Export to PDF</button></div>

<script>
const $=id=>document.getElementById(id);
const apiStatus=$("apiStatus"), aadtBanner=$("aadtBanner"), compLine=$("compLine"), overlay=$("overlay"), svFrame=$("sv"), calcBox=$("calcBox"), stopFlag=$("sunocoStop");
const outNum=$("estNum"), outRange=$("estRange"), outY2=$("y2"), outY3=$("y3"), lowReviewMsg=$("lowReviewMsg");
const devsBox=$("devs"), devsExtNews=$("devsExternalNews"), devsExtPermits=$("devsExternalPermits"), summaryBox=$("summary"), ratingLine=$("ratingLine");
const addrInput=$("addr"), acBox=$("ac"), acHint=$("acHint"), goBtn=$("go"), goStatus=$("goStatus");
const addExtraBtn=$("addExtra"), extraList=$("extraList"), activeExtras=$("activeExtras");
const ex_large_dev=$("ex_large_dev"), ex_hours18=$("ex_hours18"), ex_highincome=$("ex_highincome"), ex_lowrating=$("ex_lowrating"), ex_competitive_pricing=$("ex_competitive_pricing"), ex_rural=$("ex_rural");

let map, layer, mapReady=false, selectedCoords=null, selectedPlaceId=null, lastRating=null;

/* helpers */
function fmt(n){ return (n??0).toLocaleString(undefined,{maximumFractionDigits:0}); }
function esc(s){ return (s??"").toString().replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;"," >":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
let dotsTimer=null, dotsState=0;
function setOverlay(text){
  overlay.textContent=text;
  overlay.style.display="flex";
  if(dotsTimer) clearInterval(dotsTimer);
  dotsState=0;
  dotsTimer=setInterval(()=>{ dotsState=(dotsState+1)%4; overlay.textContent=text + ".".repeat(dotsState); }, 500);
}
function clearOverlay(){ overlay.style.display="none"; if(dotsTimer){ clearInterval(dotsTimer); dotsTimer=null; } }
function initMap(){ if(mapReady) return; map=L.map("map",{zoomControl:true}); window.map=map; L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap"}).addTo(map); layer=L.layerGroup().addTo(map); mapReady=true; }
function updateStreetView(lat,lon){ svFrame.src=`https://maps.google.com/maps?q=&layer=c&cbll=${lat},${lon}&cbp=12,0,,0,0&output=svembed`; }

/* Google status */
let GOOGLE_OK=false;
async function checkGoogleStatus(){
  try{ const r=await fetch("/google/status"); const j=await r.json(); GOOGLE_OK=!!j.ok; apiStatus.textContent=j.ok?"API: Google â€” Working":`API: Google â€” ${j.status}`; }
  catch{ GOOGLE_OK=false; apiStatus.textContent="API: Google â€” unavailable"; }
} document.addEventListener("DOMContentLoaded", checkGoogleStatus);

/* ultra-fast suggestions (300ms debounce + cancellation) */
let acItems=[], acTimer=null, acController=null;
function renderAc(list){ if(!list.length){ acBox.style.display="none"; return; } acBox.innerHTML=list.map((it,i)=>`<div class="ac-item" data-i="${i}">${esc(it.display)} <span class="badge">${it.type}</span></div>`).join(""); [...acBox.children].forEach(el=>el.onclick=()=>chooseAc(+el.dataset.i)); acBox.style.display="block"; }
function chooseAc(i){ const it=acItems[i]; if(!it) return; addrInput.value=it.display; selectedCoords=(Number.isFinite(it.lat)&&Number.isFinite(it.lon))?{lat:it.lat,lon:it.lon}:null; selectedPlaceId=it.place_id||null; acBox.style.display="none"; acHint.style.display="none"; fetchRating(addrInput.value); }
async function googleSearch(q,signal){ if(!GOOGLE_OK) return []; try{ const r=await fetch(`/google/autocomplete?input=${encodeURIComponent(q)}`,{signal}); const j=await r.json(); if(!j.ok) return []; return (j.items||[]).map(it=>({...it,type:"Google",score:1.3})); }catch{return[];} }
async function nominatimSearch(q,signal){ try{ const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=6&countrycodes=us&q=${encodeURIComponent(q)}`,{signal}); const a=await r.json(); return a.map(row=>({ type:"OSM", display:row.display_name, lat:+row.lat, lon:+row.lon, score:0.6 })); }catch{return[];} }
addrInput.addEventListener("input", ()=>{
  const q=addrInput.value.trim();
  acBox.style.display="none";
  selectedCoords=null; selectedPlaceId=null; lastRating=null; ratingLine.innerHTML="â€”";
  if(acTimer){ clearTimeout(acTimer); acTimer=null; }
  if(acController){ acController.abort(); acController=null; }
  if(q.length<3){ acHint.style.display="none"; return; }
  acHint.style.display="block"; acHint.textContent="Searching suggestionsâ€¦";
  acTimer=setTimeout(async ()=>{
    acController=new AbortController();
    try{
      const [g,n]=await Promise.all([googleSearch(q,acController.signal), nominatimSearch(q,acController.signal)]);
      acItems=[...g,...n].slice(0,8);
      renderAc(acItems);
    }catch{} finally{ acHint.style.display="none"; }
  }, 300);
});

/* advanced pills */
function pills(){
  const p=[];
  if(ex_large_dev.checked)p.push("+7.5% Large development");
  if(ex_hours18.checked)p.push("âˆ’7.5% 18h ops");
  if(ex_highincome.checked)p.push("+2.5% Higher-income");
  if(ex_competitive_pricing.checked)p.push("+10% Competitive pricing");
  if(ex_rural.checked)p.push("+30% Rural bonus");
  if(ex_lowrating.checked)p.push("âˆ’30% Rating <4.0");
  activeExtras.innerHTML=p.map(x=>`<span class="badge">${esc(x)}</span>`).join(" ");
}
[ex_large_dev,ex_hours18,ex_highincome,ex_lowrating,ex_competitive_pricing,ex_rural].forEach(el=>el.addEventListener("change",pills));

function addExtraRow(pct="",note=""){
  const row=document.createElement("div");
  row.style.marginTop="6px";
  row.innerHTML=`<span class="chip"><input class="extraPct" type="number" step="0.1" style="width:90px" placeholder="% e.g. 5 or -3" value="${pct}"> <input class="extraNote" style="width:320px" placeholder="Comment" value="${esc(note)}"> <button class="rm" type="button">Ã—</button></span>`;
  row.querySelector(".rm").addEventListener("click",()=>row.remove());
  extraList.appendChild(row);
}
$("addExtra").addEventListener("click",()=>addExtraRow());

function collectExtras(){
  const out=[];
  if(ex_large_dev.checked) out.push({pct:7.5, note:"Large residential/commercial developments"});
  if(ex_hours18.checked) out.push({pct:-7.5, note:"18h ops"});
  if(ex_highincome.checked) out.push({pct:2.5, note:"Higher income"});
  if(ex_competitive_pricing.checked) out.push({pct:10, note:"Competitive site gas pricing"});
  if(ex_lowrating.checked) out.push({pct:-30, note:"Rating <4.0 (auto)"});  // can be set automatically by rating
  for(const chip of extraList.querySelectorAll(".chip")){
    const pct=+chip.querySelector(".extraPct").value;
    const note=chip.querySelector(".extraNote").value.trim();
    if(Number.isFinite(pct)) out.push({pct, note});
  }
  return out;
}
function getFlags(){ return { rural: ex_rural.checked === true }; }
function getPricePosition(){ const r=document.querySelector('input[name="pricepos"]:checked'); return r? r.value : "inline"; }

/* rating */
async function resolvePlaceIdIfNeeded(address){
  if (selectedPlaceId) return selectedPlaceId;
  try{ const r=await fetch(`/google/findplace?input=${encodeURIComponent(address)}`); const j=await r.json(); if(j.ok && j.place_id) return j.place_id; }catch{}
  try{ const r=await fetch(`/google/searchplace?q=${encodeURIComponent(address)}`); const j=await r.json(); if(j.ok && j.place_id) return j.place_id; }catch{}
  return null;
}
async function fetchRating(address){
  const pid=await resolvePlaceIdIfNeeded(address);
  if(!pid){ ratingLine.innerHTML="â€”"; lastRating=null; return; }
  try{ const r=await fetch(`/google/rating?place_id=${encodeURIComponent(pid)}`); const j=await r.json(); if(!j.ok){ ratingLine.innerHTML="â€”"; lastRating=null; return; }
    lastRating = (j.rating!=null)? +j.rating : null;
    ratingLine.innerHTML = `â­ ${j.rating ?? "â€”"} (${j.total||0} reviews)`;
    // auto apply low-rating toggle if <4.0
    if(lastRating!=null && lastRating < 4.0){ ex_lowrating.checked = true; pills(); }
  }catch{ ratingLine.innerHTML="â€”"; lastRating=null; }
}

/* API helpers */
async function safeJSON(url,opts){
  const r=await fetch(url,opts);
  const t=await r.text();
  let j=null; try{ j=JSON.parse(t);}catch{}
  if(!r.ok){
    const msg = (j && (j.error || j.detail)) ? `${j.error}${j.detail?": "+j.detail:""}` : `HTTP ${r.status}`;
    throw new Error(msg);
  }
  return j;
}
async function callEstimate(){
  const body={ address: addrInput.value.trim(), mpds:+$("mpds").value||0, diesel:+$("diesel").value||0,
    advanced:{ extra: collectExtras(), flags: getFlags(), price_position: getPricePosition() } };
  if(selectedCoords){ body.siteLat=selectedCoords.lat; body.siteLon=selectedCoords.lon; }
  const ov=+($("aadtOverride").value||""); if(Number.isFinite(ov)&&ov>0) body.aadtOverride=ov;
  return await safeJSON("/estimate",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
}

/* map */
function initOrUpdateMap(m){
  if(!mapReady){ initMap(); }
  layer.clearLayers();
  if(!m||!m.site){ setOverlay("Working"); return; }
  const site=[m.site.lat,m.site.lon];
  L.marker(site,{title:"Site"}).addTo(layer).bindPopup("<b>Site</b>");
  const pts=[site];
  for(const c of (m.competitors||[])){
    if(!Number.isFinite(c.lat)||!Number.isFinite(c.lon)) continue;
    pts.push([c.lat,c.lon]);
    L.circleMarker([c.lat,c.lon],{radius:6,weight:1,color:c.heavy?"#ff7f50":"#4ade80",fillColor:c.heavy?"#ff7f50":"#4ade80",fillOpacity:.9}).addTo(layer).bindPopup(`${esc(c.name||"Fuel")} â€¢ ${c.miles} mi`);
  }
  map.fitBounds(L.latLngBounds(pts).pad(0.25));
  clearOverlay();
  updateStreetView(site[0],site[1]);
}

/* render */
function renderCalc(bk, low, base, high){
  const rows=[
    `LOW estimate (shown): ${fmt(low)}  â€¢  BASE: ${fmt(base)}  â€¢  HIGH: ${fmt(high)}`,
    `Baseline ceiling: AADTÃ—2%Ã—8Ã—30 = ${fmt(bk.baseline)} (AADT used: ${fmt(bk.aadt)})`,
    `Competition rule: count=${bk.compRule.compCount} â†’ baseMult=${bk.compRule.baseMult.toFixed(2)} âˆ’ heavyPenalty=${bk.compRule.heavyPenalty.toFixed(2)} â†’ compMult=${bk.compRule.compMult.toFixed(2)} â†’ afterComp=${fmt(bk.compRule.afterComp)}`,
    `Caps: equipment=${fmt(bk.caps.capEquip)}, soft=${fmt(bk.caps.capSoftTotal)}, hard=${fmt(bk.caps.capHardTotal)}`,
    `Pricing multiplier: ${bk.priceMult.toFixed(2)} â€¢ User extras multiplier: ${bk.extrasMult.toFixed(3)}`,
    `Pre-clamp result: ${fmt(bk.preClamp)} â†’ Final base (clamped to baseline if needed): ${fmt(bk.finalClampedToBaseline)}`,
    `LOW/HIGH bands: baseÃ—0.86 / baseÃ—1.06`
  ];
  calcBox.innerHTML = "<ul style='margin:6px 0 0 18px'>" + rows.map(r=>`<li>${esc(r)}</li>`).join("") + "</ul>";
}
function renderAll(d){
  const ratingLow = (lastRating!=null && lastRating < 4.0);
  outNum.textContent = fmt(d.low);
  outNum.classList.toggle("red", ratingLow);
  lowReviewMsg.style.display = ratingLow ? "block" : "none";
  outRange.textContent = `Full range: ${fmt(d.low)} â€“ ${fmt(d.high)}`;
  outY2.textContent=fmt(d.year2); outY3.textContent=fmt(d.year3);

  const method = d.inputs?.aadt_components?.method || "model";
  aadtBanner.textContent=`AADT used ${fmt(d.inputs.aadt_used)} (${method})`;

  let compTxt=`Competition: ${d.competition.count} within 1.5 mi`;
  if(d.competition.nearest_mi!=null) compTxt += `; nearest ${(+d.competition.nearest_mi).toFixed(3)} mi`;
  if((d.competition.notable_brands||[]).length) compTxt += `; heavy: ${d.competition.notable_brands.join(", ")}`;
  if(d.flags?.rural_bonus_applied) compTxt += `; rural bonus +30% applied`;
  compLine.textContent = compTxt;

  stopFlag.style.display = d.flags?.sunoco_within_1mi ? "flex" : "none";

  const osm=d.developments||[], news=d.developments_external?.news||[], perm=d.developments_external?.permits||[];
  devsBox.innerHTML = osm.length ? "<ul>"+osm.map(x=>`<li>${esc(x.name)} â€¢ ${esc(x.status)}${x.approx_miles!=null?` â€¢ ~${x.approx_miles} mi`:''}</li>`).join("")+"</ul>" : "<em>none</em>";
  devsExtNews.innerHTML = news.length ? "<ul>"+news.map(x=>`<li>${esc(x.name)}${x.link?` â€¢ <a href="${x.link}" target="_blank">source</a>`:''}</li>`).join("")+"</ul>" : "<em>none</em>";
  devsExtPermits.innerHTML = perm.length ? "<ul>"+perm.map(x=>`<li>${esc(x.name)}${x.link?` â€¢ <a href="${x.link}" target="_blank">source</a>`:''}</li>`).join("")+"</ul>" : "<em>none</em>";
  if(!news.length && !perm.length){ devsExtNews.innerHTML="<em>none found via news</em>"; devsExtPermits.innerHTML="<em>none found via permits/boards</em>"; }

  summaryBox.textContent = (d.summary||"").trim() || `AADT ${fmt(d.inputs?.aadt_used)} (${method}); comp ${d.competition?.count??0}; est LOW ${fmt(d.low)} (range ${fmt(d.low)}â€“${fmt(d.high)}).`;

  renderCalc(d.calc_breakdown, d.low, d.base, d.high);
  initOrUpdateMap(d.map);
}

/* main */
$("go").addEventListener("click", async ()=>{
  try{
    $("ac").style.display="none";
    goBtn.disabled=true; goStatus.style.display="inline";
    setOverlay("Searching for addressâ€¦ please wait");
    // ensure rating is fetched before estimating so auto-penalty applies
    if(!lastRating){ await fetchRating(addrInput.value.trim()); }
    const d=await callEstimate();
    renderAll(d); pills();
  }catch(e){
    alert("Estimate failed: " + (e.message||e));
  }finally{
    goBtn.disabled=false; goStatus.style.display="none";
    clearOverlay();
  }
});
addrInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); $("go").click(); } });

/* PDF export (clean layout) */
document.getElementById("exportPDF").addEventListener("click", async ()=>{
  const { jsPDF } = window.jspdf || {}; if(!jsPDF){ alert("PDF lib failed to load"); return; }
  const doc=new jsPDF({unit:"pt",format:"a4"}); const pageW=595, pageH=842, M=36, W=pageW-M*2;

  doc.setFont("helvetica","bold"); doc.setFontSize(18);
  doc.text("Sunoco, LP Fuel IQ â€” Fuel Site Analyzer", M, M+6);

  doc.setFont("helvetica","normal"); doc.setFontSize(12);
  const summary = document.getElementById("summary").innerText || "";
  const sumLines = doc.splitTextToSize(summary, W);
  doc.text(sumLines, M, M+30);

  let y = M + 30 + sumLines.length*14 + 12;

  // key metrics
  const key = [
    `Address: ${document.getElementById("addr").value || "-"}`,
    `MPDs: ${document.getElementById("mpds").value}   Diesel: ${document.getElementById("diesel").value}`,
    document.getElementById("aadtBanner").innerText,
    `Estimate (LOW): ${document.getElementById("estNum").innerText}`,
    document.getElementById("estRange").innerText.replace("Full range: ","Range: "),
    document.getElementById("compLine").innerText,
    document.getElementById("ratingLine").innerText
  ].join("\n");
  const keyLines = doc.splitTextToSize(key, W);
  doc.text(keyLines, M, y); y += keyLines.length*14 + 12;

  // calculation
  const calc = "How calculated:\n" + (document.getElementById("calcBox").innerText || "");
  const calcLines = doc.splitTextToSize(calc, W);
  doc.text(calcLines, M, y); y += calcLines.length*14 + 12;

  // map image
  const mapImg = await new Promise(resolve=>{
    if(!window.leafletImage || !window.map){ resolve(null); return; }
    leafletImage(window.map, (err, canvas)=> resolve(err?null:canvas.toDataURL("image/png")));
  });
  const imgH=250;
  if (mapImg) {
    if (y + imgH > pageH - M) { doc.addPage(); y = M; }
    doc.setFont("helvetica","bold"); doc.text("Map & Competitors (1.5 mi)", M, y); y += 12;
    doc.addImage(mapImg, "PNG", M, y, W, imgH); y += imgH + 12;
  }

  // developments
  const devText = "Developments â€” News:\n" + (document.getElementById("devsExternalNews").innerText || "â€”")
               + "\n\nDevelopments â€” Permits / Boards:\n" + (document.getElementById("devsExternalPermits").innerText || "â€”");
  const devLines = doc.splitTextToSize(devText, W);
  if (y + devLines.length*14 > pageH - M) { doc.addPage(); y = M; }
  doc.setFont("helvetica","bold"); doc.text("Developments", M, y); y += 14;
  doc.setFont("helvetica","normal"); doc.text(devLines, M, y);

  doc.save("FuelIQ_Site_Analyzer.pdf");
});

/* init */
overlay.textContent="â€”";
</script>
</body>
</html>
