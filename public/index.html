<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fuel Gallons Estimator — Chat</title>
  <style>
    :root { --bg:#0e1117; --panel:#161a22; --line:#2a2f3a; --text:#e6e6e6; --muted:#9aa4b2; --primary:#3b82f6; }
    *{ box-sizing: border-box; }
    body { background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 40px; margin: 0 0 12px; }
    .card { background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:16px; margin:12px 0; }
    label { display:block; font-weight:600; margin:10px 0 6px; }
    input { width:100%; padding:12px; border-radius:8px; border:1px solid var(--line); background:#0f1320; color:var(--text); }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .row > div { flex:1; min-width: 220px; }
    button { background:var(--primary); color:white; border:0; padding:12px 16px; border-radius:10px; font-weight:700; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .muted { color:var(--muted); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .right { text-align:right; }
    .heading { font-size:18px; font-weight:700; margin: 0 0 8px; }
    .pill { display:inline-block; background:#0f1320; border:1px solid var(--line); border-radius:999px; padding:4px 10px; margin-right:6px; font-size:12px; }
    details { border-top: 1px solid var(--line); padding-top: 10px; }
    #out b { font-weight:800; }
    .cmp { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .cmp .box { background:#0f1320; border:1px solid var(--line); border-radius:10px; padding:10px 12px; }
    .cmp .label { font-size:12px; color:var(--muted); }
    .cmp .value { font-size:18px; font-weight:800; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Fuel Gallons Estimator — Chat</h1>

    <div class="card">
      <div class="row">
        <div>
          <label>Site address (one line)</label>
          <input id="addr" placeholder="4173 Knightdale Blvd, Knightdale NC" />
        </div>
        <div>
          <label>Regular MPDs</label>
          <input id="mpds" type="number" value="3" />
        </div>
        <div>
          <label>Diesel positions (optional)</label>
          <input id="diesel" type="number" value="0" />
        </div>
      </div>
      <div class="row" style="margin-top:12px;">
        <div>
          <label>AADT override (optional)</label>
          <input id="aadtOverride" type="number" placeholder="enter AADT to force (e.g., 10449)" />
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
        <button id="go">Estimate</button>
        <span class="muted">Pulls NCDOT actual AADT, gets GPT’s AADT estimate, lets you override, then computes gallons & comparison.</span>
      </div>
    </div>

    <div class="card" id="report">
      <div class="heading">Result</div>
      <div id="out" class="muted">—</div>
      <div id="cmp" class="cmp" style="display:none;">
        <div class="box">
          <div class="label">Actual AADT (DOT)</div>
          <div class="value" id="valActual">—</div>
          <div class="muted" id="valActualMeta"></div>
        </div>
        <div class="box">
          <div class="label">GPT AADT estimate</div>
          <div class="value" id="valGpt">—</div>
          <div class="muted" id="valGptMeta"></div>
        </div>
        <div class="box">
          <div class="label">Override (used if entered)</div>
          <div class="value" id="valOver">—</div>
        </div>
        <div class="box">
          <div class="label">AADT used for gallons</div>
          <div class="value" id="valUsed">—</div>
        </div>
      </div>
    </div>

    <div class="card">
      <details>
        <summary>Debug JSON</summary>
        <pre id="debug" class="mono muted">/ waiting…</pre>
      </details>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);
const out = $("out"), debug = $("debug"), goBtn = $("go");

function setOut(html){ out.innerHTML = html; }
function setDebug(obj){ debug.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2); }
function fmt(n){ return (n ?? 0).toLocaleString(undefined, {maximumFractionDigits: 0}); }
function esc(s){ return (s ?? "").toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

async function estimate() {
  try {
    goBtn.disabled = true;
    setOut(`<span class="muted">Working… pulling NCDOT AADT, asking GPT for its AADT estimate, applying override if present, then computing gallons.</span>`);
    $("cmp").style.display = "none";

    const address = $("addr").value.trim();
    const mpds = Number($("mpds").value || 0);
    const diesel = Number($("diesel").value || 0);
    const aadtOverride = $("aadtOverride").value.trim();

    const res = await fetch("/estimate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ address, mpds, diesel, aadtOverride })
    });

    const text = await res.text();
    if (!res.ok) {
      setOut(`<div class="muted">HTTP ${res.status}<br><pre class="mono">${esc(text).slice(0,1200)}</pre></div>`);
      setDebug(text);
      return;
    }

    let d;
    try { d = JSON.parse(text); } catch(e){
      setOut(`<div class="muted">Parse error\n<pre class="mono">${esc(text).slice(0,1200)}</pre></div>`);
      setDebug(text);
      return;
    }

    setDebug(d);
    renderReport(d);
  } catch (e) {
    setOut(`<div class="muted">Network error:<br><pre class="mono">${esc(e.message)}</pre></div>`);
  } finally {
    goBtn.disabled = false;
  }
}

function renderReport(d){
  const sectionTop = `
    <div class="grid">
      <div><b>Base Estimate (gal/mo)</b><br><div style="font-size:28px; font-weight:800;">${fmt(d.base)}</div></div>
      <div class="right">
        <div><span class="pill">Low</span> <b>${fmt(d.low)}</b></div>
        <div style="margin-top:6px;"><span class="pill">High</span> <b>${fmt(d.high)}</b></div>
        <div style="margin-top:6px;">Year-2: <b>${fmt(d.year2)}</b></div>
        <div style="margin-top:6px;">Year-3: <b>${fmt(d.year3)}</b></div>
      </div>
    </div>
  `;

  const i = d.inputs || {};
  const aUsed = i.aadt_used;
  const aActual = i.aadt_actual || {};
  const aGpt = i.aadt_gpt || {};
  const aOver = i.aadt_override;

  // Comparison pills
  $("cmp").style.display = "flex";
  $("valActual").textContent = aActual.value != null ? fmt(aActual.value) : "—";
  $("valActualMeta").textContent = aActual.value != null ? `${aActual.source || "DOT"}${aActual.year ? " • " + aActual.year : ""}${aActual.distance_mi != null ? " • ~" + aActual.distance_mi + " mi" : ""}` : "";
  $("valGpt").textContent = aGpt.value != null ? fmt(aGpt.value) : "—";
  $("valGptMeta").textContent = aGpt.value != null ? `${aGpt.class_used || ""}${aGpt.low ? " • " + fmt(aGpt.low) + "–" + fmt(aGpt.high) : ""}` : "";
  $("valOver").textContent = aOver != null ? fmt(aOver) : "—";
  $("valUsed").textContent = aUsed != null ? fmt(aUsed) : "—";

  const assumptions = Array.isArray(d.assumptions) && d.assumptions.length
    ? `<ul>${d.assumptions.map(a => `<li>${esc(a)}</li>`).join("")}</ul>`
    : `<div class="muted">defaults applied where unknown; cap = positions × 25 × gal/cycle × 365/12.</div>`;

  const c = d.competition || {};
  const notable = (c.notable_brands || []).join(", ");
  const comp = `
    <div class="heading" style="margin-top:12px;">Competition summary</div>
    <div class="muted">
      ${c.count ?? 0} within 1 mi${c.nearest_mi != null ? `; nearest ${Number(c.nearest_mi).toFixed(3)} mi` : ""}${notable ? `; notable: ${esc(notable)}` : ""}; impact ${(Number(c.impact_score||0)*100|0)}%
    </div>
  `;

  const devs = Array.isArray(d.developments) ? d.developments : [];
  const devHtml = devs.length
    ? `<ul>${devs.map(x => `<li>${esc(x.name)} • ${esc(x.status)} • ${esc(x.miles)} mi</li>`).join("")}</ul>`
    : `<div class="muted">developments not found (planned/proposed/permit/coming-soon/construction only)</div>`;

  const rationale = esc(d.rationale || "");

  setOut(`
    ${sectionTop}
    <hr>
    <div class="heading">Inputs used</div>
    <div class="muted">
      AADT used ${fmt(aUsed)}; MPDs ${esc(i.mpds)}${i.diesel ? " + diesel " + esc(i.diesel) : ""}; truck share ${Math.round((i.truck_share_assumed ?? 0)*100)}% (assumed)
    </div>
    ${comp}
    <div class="heading" style="margin-top:12px;">Developments</div>
    ${devHtml}
    <div class="heading" style="margin-top:12px;">Assumptions</div>
    ${assumptions}
    <div class="heading" style="margin-top:12px;">One-paragraph rationale</div>
    <div>${rationale || "<span class='muted'>—</span>"}</div>
  `);
}

$("go").addEventListener("click", estimate);
</script>
</body>
</html>
