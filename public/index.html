<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sunoco LP Gas Station Analyzer</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root { --bg:#0b0e15; --panel:#111725; --panel2:#0f1421; --line:#263145; --text:#eaeef7; --muted:#97a3b8; --brand:#0ea5e9; --brand2:#22d3ee; --pill:#0f1929; }
    *{ box-sizing:border-box; }
    body{ background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap{ max-width:1120px; margin:24px auto; padding:0 16px; }
    header{ display:flex; align-items:center; gap:14px; margin-bottom:16px; }
    header .logo{
      width:46px; height:46px; border-radius:10px;
      background: radial-gradient(60% 60% at 30% 30%, var(--brand2), transparent 60%), linear-gradient(145deg, var(--brand), var(--panel2));
      box-shadow: 0 10px 30px rgba(14,165,233,.25), inset 0 0 12px rgba(34,211,238,.2);
    }
    header h1{ font-size:28px; margin:0; letter-spacing:.2px; }

    .card{ background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line);
           border-radius:12px; padding:16px; margin:12px 0; }
    label{ display:block; font-weight:600; margin:8px 0 6px; color:#d8e3f6; }
    input, select, textarea{
      width:100%; padding:12px; border-radius:10px; border:1px solid var(--line);
      background:#0b1220; color:#eaeef7;
    }
    textarea{ min-height:70px; }
    button{
      background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#fff; border:0; padding:12px 16px;
      border-radius:10px; font-weight:700; cursor:pointer;
    }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .row{ display:grid; grid-template-columns:1.8fr 0.8fr 0.8fr; gap:12px; }
    @media (max-width:900px){ .row{ grid-template-columns:1fr; } }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }
    .right{ text-align:right; }
    .muted{ color:var(--muted); }
    .mono{ font-family: ui-monospace, Menlo, Consolas, monospace; white-space:pre-wrap; }
    .subtle{ font-size:12px; opacity:.9; }

    #map{ height:420px; border-radius:12px; border:1px solid var(--line); position: relative; }
    #overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(11,14,21,.55); border-radius:12px; font-weight:700; color:#cde9ff; }

    /* Street View */
    #svWrap{ margin-top:10px; }
    #sv{ width:100%; height:380px; border:0; border-radius:12px; border:1px solid var(--line); background:#0b1220; }

    /* Autocomplete dropdown */
    .ac-wrap{ position:relative; }
    .ac-list{ position:absolute; top:100%; left:0; right:0; z-index:30; margin-top:6px;
      background:#0b1220; border:1px solid var(--line); border-radius:12px; max-height:320px; overflow:auto;
      box-shadow: 0 18px 36px rgba(0,0,0,.35); }
    .ac-item{ padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,.04); }
    .ac-item:last-child{ border-bottom:0; }
    .ac-item:hover, .ac-item.active{ background:#101a2b; }
    .badge{ display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--line);
            background:var(--pill); color:#a9c5ff; margin-left:8px; }

    .toolbar{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .checkbox{ display:inline-flex; align-items:center; gap:8px; font-size:14px; }
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:#0f1929; margin-right:6px; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"></div>
      <h1>Sunoco LP Gas Station Analyzer</h1>
    </header>

    <div class="card">
      <div class="row">
        <div>
          <label>Site search</label>
          <div class="ac-wrap">
            <input id="addr" placeholder="Enter Business Name or Address and wait a moment to load" autocomplete="off"/>
            <div id="ac" class="ac-list" style="display:none;"></div>
          </div>
          <div class="muted subtle" style="margin-top:6px" id="apiStatus">API Status: checking…</div>
        </div>
        <div>
          <label>Regular MPDs</label>
          <input id="mpds" type="number" value="3"/>
        </div>
        <div>
          <label>Diesel positions (optional)</label>
          <input id="diesel" type="number" value="0"/>
        </div>
      </div>
      <div style="margin-top:12px;" class="toolbar">
        <button id="go">Estimate</button>
        <button id="copySummary" title="Copy summary">Copy Summary</button>
        <label class="checkbox"><input type="checkbox" id="includeAI"/>Include AI (unverified) developments</label>
        <button id="checkGoogle">Check Google API</button>
      </div>
    </div>

    <div class="card">
      <details>
        <summary><b>Advanced options (optional)</b> — collapsed by default</summary>
        <div style="margin-top:12px" class="grid">
          <div>
            <label>Scenario toggles</label>
            <div class="checkbox"><input type="checkbox" id="ex_worksites"> Worksites nearby <span class="muted subtle">(+7.5% fueling, esp. AM/PM peaks)</span></div>
            <div class="checkbox"><input type="checkbox" id="ex_hours18"> Operating hours 18h <span class="muted subtle">(−7.5% vs 24h)</span></div>
            <div class="checkbox"><input type="checkbox" id="ex_highincome"> Higher-income trade area <span class="muted subtle">(+2.5% — “more travel & higher discretionary spending”)</span></div>
            <div id="activeExtras" style="margin-top:6px" class="muted subtle"></div>
          </div>
          <div>
            <label>Additional percentage adjustments (with comments)</label>
            <div id="extraList"></div>
            <button id="addExtra" type="button" style="margin-top:8px;">+ Add adjustment</button>
            <div class="muted subtle" style="margin-top:6px">Example: +5% (new signage), −3% (restricted left turns)</div>
          </div>
        </div>
      </details>
    </div>

    <div class="card">
      <div id="out" class="muted">—</div>
    </div>

    <div class="card">
      <div id="aadtBanner" class="muted" style="margin-bottom:6px;">—</div>
      <div class="muted subtle" id="capNote" style="margin-bottom:6px;">
        Capacity guidance: <b>caps peak gallons at ~22–28k gal/MPD/month</b>. Too few pumps ⇒ queuing & <b>≥10% lost volume</b> at peaks.
      </div>
      <div class="muted" style="margin-bottom:6px;">
        Map: Site & competitors (1 mile) <span class="badge">Legend</span> Site marker • Heavy ● • Regular ●
      </div>
      <div id="map"><div id="overlay" class="muted">—</div></div>
      <div id="svWrap">
        <div class="muted" style="margin:10px 0 6px;"><b>Street View</b> (best effort)</div>
        <iframe id="sv" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        <div id="svNote" class="muted subtle">If exact imagery is unavailable, Google shows the nearest panorama.</div>
      </div>
    </div>

    <div class="card">
      <b>Computation Details</b>
      <div id="details" class="muted">—</div>
    </div>

    <div class="card">
      <b>Developments (multi-source)</b>
      <div id="devs" class="muted">—</div>
    </div>

    <div class="card">
      <b>Summary (GPT)</b>
      <div id="summary" class="muted">—</div>
    </div>

    <div class="card">
      <details><summary>Debug</summary><pre id="debug" class="mono muted">/ waiting…</pre></details>
    </div>
  </div>

<script>
/* ========= Globals & helpers ========= */
const $ = id => document.getElementById(id);
const out=$("out"), devs=$("devs"), summary=$("summary"), dbg=$("debug"),
      goBtn=$("go"), includeAI=$("includeAI"),
      aadtBanner=$("aadtBanner"), apiStatus=$("apiStatus"), checkGoogleBtn=$("checkGoogle");
const acBox=$("ac"), addrInput=$("addr"), overlay=$("overlay"), detailsBox=$("details");
const addExtraBtn=$("addExtra"), extraList=$("extraList"), activeExtras=$("activeExtras");
const ex_worksites=$("ex_worksites"), ex_hours18=$("ex_hours18"), ex_highincome=$("ex_highincome");
const svFrame=$("sv");
let map, layer, mapReady=false, selectedCoords=null;

/* Base helpers */
function setOut(html){ out.innerHTML=html; }
function setDbg(o){ dbg.textContent=typeof o==="string"?o:JSON.stringify(o,null,2); }
function fmt(n){ return (n??0).toLocaleString(undefined,{maximumFractionDigits:0}); }
function esc(s){ return (s??"").toString().replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function setOverlay(msg){ overlay.textContent=msg; overlay.style.display="flex"; }
function clearOverlay(){ overlay.style.display="none"; }
function initMap(){ if(mapReady) return; map=L.map("map",{zoomControl:true});
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap"}).addTo(map);
  layer=L.layerGroup().addTo(map); mapReady=true; }

/* ========= Google API status (never hangs) ========= */
async function checkGoogleStatus(){
  const controller=new AbortController(); const timer=setTimeout(()=>controller.abort(),9000);
  apiStatus.textContent="API Status: checking…";
  try{
    const res=await fetch("/google/status",{signal:controller.signal});
    const text=await res.text();
    let j; try{ j=JSON.parse(text);}catch{ j={ok:false,status:"PARSE_ERROR",error:text.slice(0,200)}; }
    if(j.ok){ apiStatus.textContent="API Status: Google — Working"; }
    else{ apiStatus.textContent=`API Status: Google — Error (${j.status}${j.error?": "+j.error:""})`; }
  }catch(e){ apiStatus.textContent="API Status: Google — failed to fetch (server down, CORS, or timeout)"; }
  finally{ clearTimeout(timer); }
}
checkGoogleBtn?.addEventListener("click", checkGoogleStatus);
document.addEventListener("DOMContentLoaded", checkGoogleStatus);

/* ========= Advanced options UI ========= */
function addExtraRow(pct="", note=""){
  const div=document.createElement("div"); div.className="adj-row";
  div.innerHTML=`
    <input class="extraPct" type="number" step="0.1" placeholder="% e.g. 5 or -3" value="${pct}">
    <input class="extraNote" placeholder="Comment (e.g. signage, access limits)" value="${esc(note)}">
    <button type="button" class="rm">Remove</button>`;
  div.querySelector(".rm").addEventListener("click",()=>div.remove());
  extraList.appendChild(div);
}
addExtraBtn?.addEventListener("click",()=> addExtraRow());

function listActiveExtrasPills(){
  const pills=[];
  if(ex_worksites.checked) pills.push("+7.5% Worksites nearby");
  if(ex_hours18.checked) pills.push("−7.5% 18h operations");
  if(ex_highincome.checked) pills.push("+2.5% Higher-income area");
  activeExtras.innerHTML = pills.length ? pills.map(p=>`<span class="pill">${esc(p)}</span>`).join("") : "";
}
[ex_worksites, ex_hours18, ex_highincome].forEach(el=> el?.addEventListener("change", listActiveExtrasPills));

function readAdvanced(){
  const extras=[...document.querySelectorAll("#extraList .adj-row")].map(row=>{
    const pct=+row.querySelector(".extraPct").value;
    const note=row.querySelector(".extraNote").value.trim();
    return Number.isFinite(pct) ? { pct, note } : null;
  }).filter(Boolean);
  if(ex_worksites?.checked) extras.push({ pct: 7.5, note: "Worksites nearby add 7.5% fueling, especially AM/PM peaks" });
  if(ex_hours18?.checked)  extras.push({ pct:-7.5, note: "Operating hours 18 hours (−7.5% vs 24h)" });
  if(ex_highincome?.checked) extras.push({ pct: 2.5, note: "Higher income area leads to more travel & higher discretionary spending" });
  return extras.length ? { extra: extras } : null;
}

/* ========= Autocomplete (Google + Nominatim fallback) ========= */
let acTimer=null, acItems=[], acIndex=-1;

async function googleSearch(q){
  try{
    const r=await fetch(`/google/autocomplete?input=${encodeURIComponent(q)}`);
    const j=await r.json();
    if(!j.ok){
      apiStatus.textContent = `API Status: Google — Error (${j.status}${j.error?": "+j.error:""})`;
      return [];
    }
    apiStatus.textContent = "API Status: Google — Working";
    return (j.items||[]).map(it=>({ ...it, type:"Google", score:1.3 }));
  }catch(_){
    apiStatus.textContent = "API Status: Google — failed to fetch (server down, CORS, or network)";
    return [];
  }
}
async function nominatimSearch(q){
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=6&countrycodes=us&q=${encodeURIComponent(q)}`);
    const a=await r.json();
    return a.map(row=>({ type:"Address", display:row.display_name, lat:+row.lat, lon:+row.lon, score:0.6 }));
  }catch{return [];}
}
function renderAc(list){
  if(!list.length){ acBox.style.display="none"; return; }
  acBox.innerHTML=list.map((it,i)=>`<div class="ac-item" data-i="${i}">${esc(it.display)} <span class="badge">${it.type}</span></div>`).join("");
  [...acBox.children].forEach(el=> el.addEventListener("click",()=> chooseAc(+el.dataset.i)));
  acBox.style.display="block";
}
function hideAc(){ acBox.style.display="none"; acIndex=-1; }
function chooseAc(i){
  const it=acItems[i]; if(!it) return;
  addrInput.value=it.display;
  selectedCoords = (it.lat!=null && it.lon!=null) ? { lat: it.lat, lon: it.lon } : null;
  hideAc();
}
addrInput.addEventListener("input", ()=>{
  const q=addrInput.value.trim(); selectedCoords=null; hideAc();
  if(q.length<3) return;
  if(acTimer) clearTimeout(acTimer);
  acTimer=setTimeout(async()=>{
    try{
      const [g, n] = await Promise.all([googleSearch(q), nominatimSearch(q)]);
      acItems = [...g, ...n];
      renderAc(acItems);
    }catch{}
  },250);
});

/* ========= Copy Summary ========= */
document.getElementById("copySummary")?.addEventListener("click",()=>{
  try{ navigator.clipboard.writeText(summary.textContent||""); alert("Summary copied."); }
  catch(e){ alert("Copy failed: "+e.message); }
});

/* ========= Client → server ========= */
async function safeJSON(url, opts){
  const r=await fetch(url, opts); const t=await r.text();
  if(!r.ok) throw new Error(`HTTP ${r.status}\n${t.slice(0,1200)}`);
  try{ return JSON.parse(t); }catch{ throw new Error("Bad JSON from server: "+t.slice(0,200)); }
}
async function callEstimate(){
  const body={ address: addrInput.value.trim(), mpds:+$("mpds").value||0, diesel:+$("diesel").value||0 };
  if(selectedCoords){ body.siteLat=selectedCoords.lat; body.siteLon=selectedCoords.lon; }
  const adv = readAdvanced(); if(adv) body.advanced = adv;
  return await safeJSON("/estimate",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
}

/* ========= Renderers ========= */
function updateStreetView(lat, lon){
  const url = `https://maps.google.com/maps?q=&layer=c&cbll=${lat},${lon}&cbp=12,0,,0,0&output=svembed`;
  if(svFrame) svFrame.src = url;
}
function renderMap(m){
  initMap(); layer.clearLayers();
  if(!m || !m.site){ overlay.textContent="—"; return; }
  const site=[m.site.lat,m.site.lon];
  L.marker(site,{title:"Site"}).addTo(layer).bindPopup("<b>Site</b>");
  const comps = Array.isArray(m.competitors)?m.competitors:[];
  const pts=[site];
  for(const c of comps){
    if(!(Number.isFinite(c.lat) && Number.isFinite(c.lon))) continue;
    pts.push([c.lat,c.lon]);
    L.circleMarker([c.lat,c.lon],{
      radius:6, weight:1, color:c.heavy?"#ff7f50":"#4ade80", fillColor:c.heavy?"#ff7f50":"#4ade80", fillOpacity:.85
    }).addTo(layer).bindPopup(`${esc(c.name||"Fuel")} • ${c.miles} mi`);
  }
  map.fitBounds(L.latLngBounds(pts).pad(0.25)); clearOverlay();
  updateStreetView(site[0], site[1]);
}
function renderReport(d){
  const i=d.inputs||{}, c=d.competition||{}, comp=i?.aadt_components||{};
  const dot=comp.dot, gpt=comp.gpt;
  const parts=[];
  parts.push(`USED (AVG): ${fmt(i.aadt_used)}`);
  if(dot?.value) parts.push(`DOT ${fmt(dot.value)} (${dot.source||"DOT"} ${dot.year||"n/a"}${dot.source==='custom'?'':`, ~${dot.distance_mi} mi`})`);
  if(gpt?.value) parts.push(`GPT ${fmt(gpt.value)} (conf ${((gpt.confidence||0)*100|0)}%)`);
  aadtBanner.textContent = "AADT → " + parts.join(" | ");

  const userMult = i.user_multiplier ? ` (user mult ×${i.user_multiplier.toFixed(3)})` : "";
  setOut(`
    <div class="grid">
      <div>
        <div style="font-weight:700;margin-bottom:6px;">Adjusted Base Estimate (gal/mo)${userMult}</div>
        <div style="font-size:30px;font-weight:800;">${fmt(d.base)}</div>
        <div class="muted">Low–High: ${fmt(d.low)} – ${fmt(d.high)}</div>
      </div>
      <div class="right">
        <div>Year-2: <b>${fmt(d.year2)}</b></div>
        <div style="margin-top:6px;">Year-3: <b>${fmt(d.year3)}</b></div>
      </div>
    </div>
  `);

  // Always show the reasoning details
  const rule = "0–1=100%, 2=75%, 3+=60%; Heavy: −20% / −35%";
  const userAdj = (i.user_multiplier_breakdown && Object.keys(i.user_multiplier_breakdown).length)
    ? JSON.stringify(i.user_multiplier_breakdown)
    : "none";
  detailsBox.innerHTML = `
    <div><b>Inputs</b> — MPDs ${i.mpds}${i.diesel? " + diesel "+i.diesel:""}; AADT used <b>${fmt(i.aadt_used)}</b></div>
    <div><b>Competition</b> — ${c.count ?? 0} within 1 mi${c.nearest_mi!=null? "; nearest "+c.nearest_mi.toFixed(3)+" mi":""}${(c.notable_brands||[]).length ? "; notable: "+c.notable_brands.join(", ") : ""}</div>
    <div class="muted subtle" style="margin-top:4px"><b>Rule</b>: ${rule}</div>
    <div class="muted subtle">Floor: ${fmt(d.floor)} • Capacity cap: ${fmt(d.cap)} • Comp multiplier: ${(d.compMult*100|0)}%</div>
    <div class="muted subtle">User adjustments: ${esc(userAdj)}</div>
  `;
}
function renderDevs(osm, ai){
  const showUnverified = includeAI ? includeAI.checked : false;
  const verified = (ai && Array.isArray(ai.verified)) ? ai.verified : [];
  const unverified = (ai && Array.isArray(ai.unverified)) ? ai.unverified : [];
  const left = (Array.isArray(osm)&&osm.length)
    ? "<ul>"+osm.map(d=>`<li>${esc(d.name)} • ${esc(d.status)} • ${d.miles} mi</li>`).join("")+"</ul>"
    : "<span class='muted'>OSM/Overpass: none found</span>";
  const right = (verified.length || (showUnverified && unverified.length))
    ? `<div><div><b>GPT (verified)</b></div><ul>`+
        verified.map(x=>`<li>${esc(x.name)} • ${esc(x.status||"planned")} • ~${x.approx_miles ?? "?"} mi</li>`).join("")+
      `</ul>`+
      (showUnverified && unverified.length
        ? `<div class='muted' style='margin-top:6px'><b>GPT (unverified)</b></div><ul>`+
          unverified.map(x=>`<li>${esc(x.name)} • ${esc(x.status||"planned")} • ~${x.approx_miles ?? "?"} mi</li>`).join("")+
         `</ul><div class='muted'>GPT confidence: ${((ai.confidence||0)*100|0)}%</div>`
        : `<div class='muted'>GPT confidence: ${((ai?.confidence||0)*100|0)}%</div>`)
    : "<span class='muted'>GPT: none reported</span>";
  devs.innerHTML = `<div class="grid"><div>${left}</div><div>${right}</div></div>`;
}

/* ========= Main flow ========= */
async function estimate(){
  try{
    goBtn.disabled=true;
    setOut("<span class='muted'>Working…</span>");
    setOverlay("Researching (geocode, AADT sources, competition, GPT)...");
    const d=await callEstimate();
    renderReport(d);
    renderMap(d.map);
    renderDevs(d.developments, d.developments_ai);

    // Robust summary handling (prevents trim errors)
    let s = "";
    if (typeof d.summary === "string") s = d.summary;
    else if (d.summary && typeof d.summary.summary === "string") s = d.summary.summary;
    summary.textContent = (s && s.trim) ? s.trim() : (s || "—");

    setDbg(d);
  }catch(e){
    setOut(`<pre class="mono">${esc(e.message||String(e))}</pre>`);
    overlay.textContent="Error — see details above";
  }finally{
    goBtn.disabled=false;
  }
}

$("go").addEventListener("click", estimate);
addrInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); estimate(); } });

/* Initial state */
overlay.textContent="—";
</script>
</body>
</html>
