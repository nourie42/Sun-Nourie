
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sunoco, LP Fuel IQ – Fuel Site Analyzer</title>
  <meta name="description" content="Fuel IQ estimator using server-side /estimate (state AADT logic)">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
  <style>
    :root {
      --bg:#0b0e15; --panel:#111725; --panel2:#0f1421; --line:#263145;
      --text:#eaf2ff; --muted:#9fb0cf; --brand:#22d3ee; --brand2:#0ea5e9;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --btn:#0f2236; --btnb:#1b2b45;
    }
    * { box-sizing:border-box; }
    html, body {height:100%}
    body {
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      padding-bottom:80px;
    }
    .wrap { max-width:1220px; margin:0 auto; padding:18px 16px 40px; }
    header { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    h1 { margin:0; font-size:32px; font-weight:900; }
    .build { margin-left:auto; font-size:12px; color:#86a2c8; }
    .pill {
      display:inline-block; padding:10px 16px; border-radius:999px;
      border:1px solid var(--line); background:#0e1729; color:#d7edff; font-weight:800; text-decoration:none;
    }
    .pill:hover{ background:#102038; }
    .pill.primary { background:linear-gradient(135deg,#22d3ee,#0ea5e9); color:#06202a; border:0; }
    .pill.alert { background:#fecaca; color:#2a0f14; border:0; }
    .aadt-tabs { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:12px 0 14px; }
    .tab { padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:#0e1729;
           color:#eaf2ff; text-decoration:none; font-weight:800; }
    .tab:hover { background:#102038; }
    .instructions { color:#cfe3ff; font-size:13px; margin:8px 0 12px; }
    .card {
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid var(--line); border-radius:12px; padding:16px; margin:12px 0;
    }
    label { display:block; font-weight:800; margin:8px 0 6px; color:#d3e7ff; }
    input, select, textarea {
      width:100%; padding:12px; background:#0c1424; color:#eaf2ff; border:1px solid var(--line); border-radius:10px;
    }
    textarea { resize:vertical; min-height:46px; }
    .row { display:grid; grid-template-columns:1.6fr 0.7fr 0.7fr 0.8fr; gap:12px; align-items:end; }
    @media(max-width:980px){ .row { grid-template-columns:1fr; } }
    button {
      background:linear-gradient(135deg,#22d3ee,#0ea5e9); color:#06202a; border:0; padding:12px 18px; border-radius:10px;
      font-weight:900; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.25);
    }
    button.secondary { background:#13233c; color:#bfe0ff; border:1px solid var(--line); box-shadow:none; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    .hero { display:flex; justify-content:space-between; align-items:flex-end; flex-wrap:wrap; gap:12px; }
    .hero .num { font-size:46px; font-weight:900; }
    .hero .sub { color:#9fb0cf; font-size:13px; }
    .kpi { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    @media(max-width:860px){ .kpi { grid-template-columns:1fr; } }
    .kpi .box { background:#0d1628; border:1px solid var(--line); border-radius:10px; padding:10px; }
    .kpi .box h3 { margin:0 0 6px; font-size:12px; color:#9fb0cf; letter-spacing:.7px; text-transform:uppercase; }
    .kpi .val { font-weight:900; font-size:20px; }
    #map { height:420px; border-radius:12px; border:1px solid var(--line); }
    #overlay { position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(7,10,16,.55);
               color:#cde9ff; font-weight:900; border-radius:12px; }
    #mapWrap { position:relative; }
    .small { font-size:12px; }
    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media(max-width:900px){ .grid2 { grid-template-columns:1fr; } }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:8px; border-bottom:1px solid var(--line); font-size:13px; }
    th { color:#9fb0cf; text-transform:uppercase; font-size:11px; letter-spacing:.6px; }
    .footerbar { position:fixed; left:0; right:0; bottom:0; padding:10px 16px; border-top:1px solid var(--line);
                 background:linear-gradient(180deg,#0d1424,#0a0f1a); display:flex; gap:10px; justify-content:center; z-index:100; }
    .note { color:#9fb0cf; font-size:12px; }
    .tag { display:inline-block; padding:5px 10px; border:1px solid var(--line); border-radius:999px; background:#0e1729; font-weight:800; }
    .err { color:#fecaca; }
    .ok { color:#a7f3d0; }
    .divider { height:1px; background:var(--line); margin:12px 0; }
    .adj-row { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .adj-row input[type="number"]{ width:120px; }
    .list-links { display:flex; flex-wrap:wrap; gap:8px; }
    .btn-link { background:#0f2236; border:1px solid var(--line); color:#bfe6ff; text-decoration:none; padding:10px 14px; border-radius:10px; font-weight:900; }
    .btn-link:hover { background:#102a45; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Sunoco, LP Fuel IQ – Fuel Site Analyzer</h1>
      <a class="pill" href="/gas-finder">Prospector</a>
      <a class="pill primary" href="/developments.html" target="_blank" rel="noopener">Developments Search</a>
      <a class="pill alert" href="/pa-aadt.html" target="_blank" rel="noopener">PA AADT Map</a>
      <div class="build">UI v2025‑09‑18 (State AADT only)</div>
    </header>

    <div class="aadt-tabs">
      <span class="note" style="font-weight:800;">State AADT Quick Links:</span>
      <a class="tab" href="#" data-s="DC">DC</a>
      <a class="tab" href="#" data-s="FL">FL</a>
      <a class="tab" href="#" data-s="GA">GA</a>
      <a class="tab" href="#" data-s="MA">MA</a>
      <a class="tab" href="#" data-s="NY">NY</a>
      <a class="tab" href="#" data-s="SC">SC</a>
      <a class="tab" href="#" data-s="VA">VA</a>
      <a class="tab" href="#" data-s="NC">NC</a>
    </div>

    <div class="instructions">
      <b>Instructions:</b> Enter Address, click <i>Estimate</i>. <b>State AADT is always used.</b> If unavailable, you’ll see a clear comment.
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label for="addr">Site search</label>
          <input id="addr" placeholder="123 Main St, City, ST" autocomplete="off">
          <div class="note" id="apiStatus">API Status: ready</div>
        </div>
        <div>
          <label for="mpds">Regular MPDs</label>
          <input id="mpds" type="number" min="1" value="2">
        </div>
        <div>
          <label for="diesel">Diesel MPDs</label>
          <input id="diesel" type="number" min="0" value="0">
        </div>
        <div>
          <label for="aadtOv">AADT override</label>
          <input id="aadtOv" type="number" placeholder="Optional exact AADT">
        </div>
      </div>

      <div class="toolbar">
        <button id="estimate">Estimate</button>
        <button id="reset" class="secondary" title="Clear inputs">Reset</button>
        <span class="note">Baseline ceiling (AADT×2%×8×30) • competition rule • pricing effect • caps • road layout</span>
      </div>

      <div class="divider"></div>

      <div class="grid2">
        <div>
          <label>Pricing Position</label>
          <div class="list-links">
            <label><input type="radio" name="price" value="inline" checked> Inline</label>
            <label><input type="radio" name="price" value="below"> Below market</label>
            <label><input type="radio" name="price" value="above"> Above market</label>
          </div>
        </div>
        <div>
          <label>Flags</label>
          <div class="list-links">
            <label><input type="checkbox" id="flagRural"> Apply rural bonus (0 comps within 3 mi)</label>
            <label><input type="checkbox" id="flagAutoLow"> Auto low-rating penalty (client &lt; 4.0)</label>
          </div>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Client rating (optional)</label>
          <input id="clientRating" type="number" min="0" max="5" step="0.1" placeholder="e.g., 3.8">
        </div>
        <div>
          <label>Extra adjustments</label>
          <div id="extraList"></div>
          <div class="adj-row">
            <input id="extraPct" type="number" step="1" value="0" title="Percent (e.g., -10 or 12)"> 
            <input id="extraNote" placeholder="Note">
            <button class="secondary" id="addExtra">Add</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card hero">
      <div>
        <div class="num" id="nBase">—</div>
        <div class="sub" id="nRange">Full range: —</div>
      </div>
      <div class="kpi">
        <div class="box"><h3>Year‑2</h3><div class="val" id="nY2">—</div></div>
        <div class="box"><h3>Year‑3</h3><div class="val" id="nY3">—</div></div>
        <div class="box"><h3 id="banner">Baseline: AADT × 2% × 8 × 30</h3></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 6px;">Summary</h3>
      <div class="note" id="summary">—</div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px;">Map</h3>
      <div id="mapWrap">
        <div id="map"></div>
        <div id="overlay">Working…</div>
      </div>
      <div class="note" id="mapMsg" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px;">Details</h3>
      <div class="grid2">
        <div>
          <table id="tblA"></table>
        </div>
        <div>
          <table id="tblB"></table>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px;">Competition</h3>
      <table id="tblComp"></table>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px;">Developments</h3>
      <div class="grid2">
        <div>
          <h4 style="margin:0 0 6px;">OpenStreetMap (proposed / construction)</h4>
          <table id="tblDev"></table>
        </div>
        <div>
          <h4 style="margin:0 0 6px;">External (news & permits)</h4>
          <table id="tblDevExt"></table>
        </div>
      </div>
    </div>

    <div class="footerbar">
      <a class="pill" href="/gas-finder">Prospector</a>
      <a class="pill primary" href="/developments.html" target="_blank" rel="noopener">Developments Search</a>
      <a class="pill alert" href="/pa-aadt.html" target="_blank" rel="noopener">PA AADT Map</a>
      <a class="pill" id="btnDownload" href="#" download="estimate.json">Download JSON</a>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <script>
    // Short helpers
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>document.querySelectorAll(s);
    const fmt = (n)=> (n==null||!isFinite(n)) ? "—" : Number(n).toLocaleString();

    const overlay = $("#overlay");
    const mapMsg = $("#mapMsg");
    let map, siteMarker, compLayer, aadtLayer;

    function setOverlay(on){
      overlay.style.display = on ? "flex" : "none";
    }

    function makeRow(key, val){
      return `<tr><th>${key}</th><td>${val}</td></tr>`;
    }

    function renderTable(table, rows){
      table.innerHTML = rows.join("
");
    }

    function ensureMap(){
      if(map) return;
      map = L.map("map");
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
        maxZoom: 19, attribution: "© OpenStreetMap"
      }).addTo(map);
      map.setView([35.78, -78.64], 12);
    }

    function drawMarkers(site, competitors, aadtStations){
      ensureMap();
      if(site && isFinite(site.lat) && isFinite(site.lon)){
        map.setView([site.lat, site.lon], 14);
        if(!siteMarker){
          siteMarker = L.marker([site.lat, site.lon], {title: site.label || "Site"}).addTo(map);
        } else {
          siteMarker.setLatLng([site.lat, site.lon]);
        }
      }
      if(compLayer){ compLayer.remove(); }
      if(aadtLayer){ aadtLayer.remove(); }
      if(Array.isArray(competitors) && competitors.length){
        compLayer = L.layerGroup(competitors.map(c=> L.circleMarker([c.lat, c.lon], {radius:6})
          .bindPopup(`${c.name||"Fuel"} • ${fmt(c.miles)} mi`))).addTo(map);
      }
      if(Array.isArray(aadtStations) && aadtStations.length){
        aadtLayer = L.layerGroup(aadtStations.map(s=> L.circleMarker([s.lat, s.lon], {radius:5, color:"#0ea5e9"})
          .bindPopup(`AADT ${fmt(s.aadt)}${s.year? " ("+s.year+")":""}`))).addTo(map);
      }
    }

    function collectExtras(){
      const rows = Array.from(document.querySelectorAll(".extra-item"));
      return rows.map(r=> ({
        pct: Number(r.querySelector(".pct").value),
        note: String(r.querySelector(".note").value||"").slice(0, 180)
      })).filter(x => Number.isFinite(x.pct));
    }

    // Add extra row
    $("#addExtra").addEventListener("click", ()=>{
      const pct = Number($("#extraPct").value||0);
      const note = $("#extraNote").value||"";
      const row = document.createElement("div");
      row.className = "adj-row extra-item";
      row.innerHTML = `<input class="pct" type="number" step="1" value="${pct}"><input class="note" placeholder="Note" value="${note}"><button class="secondary remove">Remove</button>`;
      $("#extraList").appendChild(row);
      row.querySelector(".remove").addEventListener("click", ()=> row.remove());
      $("#extraPct").value = "0"; $("#extraNote").value = "";
    });

    // Reset button
    $("#reset").addEventListener("click", ()=>{
      $("#addr").value = "";
      $("#mpds").value = "2";
      $("#diesel").value = "0";
      $("#aadtOv").value = "";
      $("#clientRating").value = "";
      $("#flagRural").checked = false;
      $("#flagAutoLow").checked = false;
      $("#extraList").innerHTML = "";
      $("#nBase").textContent = "—";
      $("#nRange").textContent = "Full range: —";
      $("#nY2").textContent = "—";
      $("#nY3").textContent = "—";
      $("#banner").textContent = "Baseline: AADT × 2% × 8 × 30";
      $("#summary").textContent = "—";
      renderTable($("#tblA"), []);
      renderTable($("#tblB"), []);
      renderTable($("#tblComp"), []);
      renderTable($("#tblDev"), []);
      renderTable($("#tblDevExt"), []);
      mapMsg.textContent = "";
    });

    // Estimate function
    async function estimate(){
      try {
        setOverlay(true);
        const address = $("#addr").value.trim();
        const mpds = Number($("#mpds").value);
        const diesel = Number($("#diesel").value);
        const aadtOverride = Number($("#aadtOv").value);
        const price_position = (Array.from($$("input[name='price']")).find(r=>r.checked)||{}).value || "inline";
        const flags = { rural: $("#flagRural").checked === true };
        const client_rating = $("#clientRating").value ? Number($("#clientRating").value) : undefined;
        const auto_low_rating = $("#flagAutoLow").checked === true;
        const extra = collectExtras();

        const payload = {
          address, mpds, diesel,
          aadtOverride: Number.isFinite(aadtOverride) && aadtOverride>0 ? aadtOverride : undefined,
          advanced: { price_position, extra, flags },
          client_rating,
          auto_low_rating
        };

        const r = await fetch("/estimate", {
          method:"POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if(!r.ok || j.error){
          const msg = j.error || ("HTTP_"+r.status);
          $("#summary").innerHTML = `<span class="err">Estimate failed: ${msg}</span>`;
          setOverlay(false);
          return;
        }

        // Headline numbers
        $("#nBase").textContent = fmt(j.base);
        $("#nRange").textContent = `Full range: ${fmt(j.low)} – ${fmt(j.high)}`;
        $("#nY2").textContent = fmt(j.year2);
        $("#nY3").textContent = fmt(j.year3);
        $("#banner").textContent = `AADT used ${fmt(j.inputs.aadt_used)} (${j.inputs.aadt_components.method})`;

        // Summary
        $("#summary").textContent = j.summary || "—";

        // Details table A
        renderTable($("#tblA"), [
          makeRow("MPDs (Regular)", fmt(j.inputs.mpds)),
          makeRow("MPDs (Diesel)", fmt(j.inputs.diesel)),
          makeRow("Price", j.inputs.price_position),
          makeRow("Rural Bonus", j.flags.rural_bonus_applied ? "Applied" : "Not applied"),
          makeRow("Sunoco within 1 mi", j.flags.sunoco_within_1mi ? "Yes" : "No"),
          makeRow("Auto low-rating", j.flags.auto_low_rating ? "Yes" : "No"),
        ]);

        // Details table B
        const caps = j.calc_breakdown?.caps || {};
        renderTable($("#tblB"), [
          makeRow("Baseline", fmt(j.calc_breakdown?.baseline)),
          makeRow("Competition count", fmt(j.competition?.count)),
          makeRow("Nearest competitor (mi)", j.competition?.nearest_mi!=null ? fmt(j.competition.nearest_mi) : "—"),
          makeRow("Cap (equip)", fmt(caps.capEquip)),
          makeRow("Cap (soft total)", fmt(caps.capSoftTotal)),
          makeRow("Cap (hard total)", fmt(caps.capHardTotal)),
          makeRow("Roads", j.roads?.summary || "—"),
        ]);

        // Competition table
        const comp = Array.isArray(j.map?.competitors) ? j.map.competitors : [];
        const compRows = ["<tr><th>Name</th><th>Mi</th></tr>"].concat(comp.slice(0,30).map(c=>`<tr><td>${c.name||"Fuel"}</td><td>${fmt(c.miles)}</td></tr>`));
        renderTable($("#tblComp"), compRows);

        // Developments
        const devOSM = Array.isArray(j.developments) ? j.developments : Array.isArray(j.developments?.osm) ? j.developments.osm : j.developments || [];
        const devExtNews = Array.isArray(j.developments_external?.news) ? j.developments_external.news : [];
        const devExtPerm = Array.isArray(j.developments_external?.permits) ? j.developments_external.permits : [];
        const devRows = ["<tr><th>Name</th><th>Status</th><th>Approx mi</th></tr>"].
            concat(devOSM.slice(0,30).map(d=>`<tr><td>${d.name||"Fuel development"}</td><td>${d.status||""}</td><td>${d.approx_miles!=null?fmt(d.approx_miles):"—"}</td></tr>`));
        renderTable($("#tblDev"), devRows);
        const devExtRows = ["<tr><th>Title</th><th>Source</th></tr>"]
            .concat(devExtNews.slice(0,15).map(d=>`<tr><td><a href="${d.link||"#"}" target="_blank" rel="noopener">${d.name||"News"}</a></td><td>News</td></tr>`))
            .concat(devExtPerm.slice(0,15).map(d=>`<tr><td><a href="${d.link||"#"}" target="_blank" rel="noopener">${d.name||"Permit"}</a></td><td>Permit</td></tr>`));
        renderTable($("#tblDevExt"), devExtRows);

        // Map
        const site = j.map?.site || null;
        const aadtStations = Array.isArray(j.map?.aadt) ? j.map.aadt : [];
        drawMarkers(site, comp, aadtStations);
        mapMsg.textContent = site ? (site.label || `${site.lat}, ${site.lon}`) : "";

        // Enable download
        $("#btnDownload").href = "data:application/json;charset=utf-8," + encodeURIComponent(JSON.stringify(j,null,2));

        setOverlay(false);
      } catch (e){
        $("#summary").innerHTML = `<span class="err">Error: ${String(e.message||e)}</span>`;
        setOverlay(false);
      }
    }

    $("#estimate").addEventListener("click", estimate);
  </script>
</body>
</html>
