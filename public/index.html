<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sunoco, LP Fuel IQ - Fuel Site Analyzer</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>

  <style>
    :root { --bg:#0b0e15; --panel:#111725; --panel2:#0f1421; --line:#263145; --text:#eaeef7; --muted:#97a3b8; --brand:#0ea5e9; --brand2:#22d3ee; --pill:#0f1929; }
    *{ box-sizing:border-box; }
    body{ background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:0; padding-bottom:72px; }
    .wrap{ max-width:1120px; margin:24px auto; padding:0 16px; }
    header{ display:flex; align-items:center; gap:14px; margin-bottom:16px; }
    header h1{ font-size:28px; margin:0; letter-spacing:.2px; }

    .card{ background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line); border-radius:12px; padding:16px; margin:12px 0; }
    label{ display:block; font-weight:600; margin:8px 0 6px; color:#d8e3f6; }
    input, select{ width:100%; padding:12px; border-radius:10px; border:1px solid var(--line); background:#0b1220; color:#eaeef7; }
    button{ background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#fff; border:0; padding:12px 16px; border-radius:10px; font-weight:700; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .row{ display:grid; grid-template-columns:1.6fr 0.7fr 0.7fr 0.8fr; gap:12px; }
    @media (max-width:980px){ .row{ grid-template-columns:1fr; } }

    .toolbar{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:12px; }
    .muted{ color:var(--muted); }
    .subtle{ font-size:12px; opacity:.9; }
    .mono{ font-family: ui-monospace, Menlo, Consolas, monospace; white-space:pre-wrap; }

    #map{ height:420px; border-radius:12px; border:1px solid var(--line); position: relative; }
    #overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(11,14,21,.55); border-radius:12px; font-weight:800; color:#cde9ff; font-size:18px; padding:20px; text-align:center; }

    #svWrap{ margin-top:10px; }
    #sv{ width:100%; height:380px; border:0; border-radius:12px; border:1px solid var(--line); background:#0b1220; }

    .ac-wrap{ position:relative; }
    .ac-list{ position:absolute; top:100%; left:0; right:0; z-index:30; margin-top:6px; background:#0b1220; border:1px solid var(--line); border-radius:12px; max-height:320px; overflow:auto; box-shadow: 0 18px 36px rgba(0,0,0,.35); }
    .ac-item{ padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,.04); }
    .ac-item:last-child{ border-bottom:0; }
    .ac-item:hover, .ac-item.active{ background:#101a2b; }
    .badge{ display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--line); background:var(--pill); color:#a9c5ff; margin-left:8px; }

    details summary{ cursor:pointer; }
    .adv-line{ display:flex; align-items:center; gap:16px; flex-wrap:wrap; margin-top:12px; }
    .chip{ display:inline-flex; align-items:center; gap:8px; background:#0f1929; border:1px solid var(--line); padding:8px 10px; border-radius:999px; font-size:13px; }
    .chip input{ width:auto; accent-color:#22d3ee; }
    .dash{ color:#50607a; opacity:.9; }
    .radio-row{ display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; }

    .hero{ display:flex; justify-content:space-between; align-items:flex-end; gap:12px; }
    .hero .num{ font-size:44px; font-weight:900; letter-spacing:.5px; }
    .hero .sub{ font-size:13px; color:#a9b6d0; }

    .footerbar{ position:fixed; left:0; right:0; bottom:0; background:linear-gradient(180deg,#0c1220,#0a0f1a); border-top:1px solid var(--line); padding:10px 16px; display:flex; justify-content:center; gap:12px; z-index:50; }
  </style>
</head>
<body>
  <div class="wrap">
    <header><h1>Sunoco, LP Fuel IQ - Fuel Site Analyzer</h1></header>

    <!-- Input -->
    <div class="card">
      <div class="row">
        <div>
          <label>Site search</label>
          <div class="ac-wrap">
            <input id="addr" placeholder="Enter business or address" autocomplete="off"/>
            <div id="ac" class="ac-list" style="display:none;"></div>
          </div>
          <div class="muted subtle" style="margin-top:6px" id="apiStatus">API Status: checking…</div>
        </div>
        <div><label>Regular MPDs</label><input id="mpds" type="number" value="3" min="1"/></div>
        <div><label>Diesel positions</label><input id="diesel" type="number" value="0" min="0"/></div>
        <div><label>AADT override</label><input id="aadtOverride" type="number"/></div>
      </div>
      <div class="toolbar">
        <button id="go">Estimate</button>
        <span class="muted">Baseline ceiling AADT×2%×8×30 unless opt-in • comp rule • pricing effect • caps • road layout</span>
      </div>
    </div>

    <!-- Advanced -->
    <div class="card">
      <details>
        <summary><b>Advanced options</b></summary>
        <div class="adv-line">
          <label class="chip"><input type="checkbox" id="ex_worksites"> Worksites (+7.5%)</label>
          <label class="chip"><input type="checkbox" id="ex_hours18"> Hours 18h (−7.5%)</label>
          <label class="chip"><input type="checkbox" id="ex_highincome"> Higher-income (+2.5%)</label>
          <label class="chip"><input type="checkbox" id="ex_lowrating"> Rating < 4.0 (−30%)</label>
        </div>
        <div style="margin-top:8px;">
          <label><b>Gas pricing vs area</b></label>
          <div class="radio-row">
            <label class="chip"><input type="radio" name="pricepos" value="below"> Below comp (+10%)</label>
            <label class="chip"><input type="radio" name="pricepos" value="inline" checked> Inline (0%)</label>
            <label class="chip"><input type="radio" name="pricepos" value="above"> Above comp (−10%)</label>
          </div>
        </div>
        <div class="adv-line">
          <label class="chip"><input type="checkbox" id="ex_elastic"> Allow > baseline</label>
          <span class="chip" id="addExtra" style="cursor:pointer;">+ Add adj. (%)</span>
          <span id="activeExtras" class="subtle"></span>
        </div>
        <div id="extraList" style="margin-top:8px;"></div>
      </details>
    </div>

    <!-- Estimate -->
    <div class="card" id="estimateCard">
      <div class="hero">
        <div>
          <div>Adjusted Base Estimate (LOW)</div>
          <div class="num" id="estNum">—</div>
          <div class="sub" id="estRange">Full range: —</div>
        </div>
        <div class="right sub">
          <div>Year-2: <b id="y2">—</b></div>
          <div>Year-3: <b id="y3">—</b></div>
        </div>
      </div>
      <hr/>
      <div id="aadtBanner" class="muted">—</div>
      <div id="compLine" class="muted">—</div>
    </div>

    <!-- Map -->
    <div class="card">
      <div class="muted">Map: Site & competitors (1.5 mi)</div>
      <div id="map"><div id="overlay" class="muted">—</div></div>
      <div id="svWrap"><div class="muted">Street View</div><iframe id="sv"></iframe></div>
    </div>

    <!-- Developments -->
    <div class="card"><b>Developments — OSM</b><div id="devs" class="muted">—</div></div>
    <div class="card"><b>Developments — News</b><div id="devsExternalNews" class="muted">—</div></div>
    <div class="card"><b>Developments — Permits</b><div id="devsExternalPermits" class="muted">—</div></div>
    <div class="card"><b>Developments — GPT (verified)</b><div id="devsAI" class="muted">—</div></div>

    <!-- Rating & Summary -->
    <div class="card"><b>Google Rating</b><div id="ratingLine" class="muted">—</div></div>
    <div class="card"><b>Summary (GPT)</b><div id="summary" class="muted">—</div></div>
  </div>

  <div class="footerbar"><button id="exportPDF">Export to PDF</button></div>

<script>
const $=id=>document.getElementById(id);
let selectedCoords=null, selectedPlaceId=null;

// Helpers
function fmt(n){return (n??0).toLocaleString();}
function esc(s){return (s??"").toString().replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;"," >":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}

// Google status & autocomplete
let GOOGLE_OK=false;let acItems=[];let acActiveIndex=-1;
async function checkGoogleStatus(){
  try{const r=await fetch("/google/status");const j=await r.json();GOOGLE_OK=!!j.ok;apiStatus.textContent=j.ok?"API: Google — Working":`API: Google — ${j.status}`;}
  catch{GOOGLE_OK=false;apiStatus.textContent="API: Google — unavailable";}
}
document.addEventListener("DOMContentLoaded",checkGoogleStatus);

async function googleSearch(q){if(!GOOGLE_OK)return[];try{const r=await fetch(`/google/autocomplete?input=${encodeURIComponent(q)}`);const j=await r.json();return j.ok?(j.items||[]).map(it=>({...it,type:"Google",score:1.3})):[];}catch{return[];}}
async function nominatimSearch(q){try{const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=6&countrycodes=us&q=${encodeURIComponent(q)}`);const a=await r.json();return a.map(row=>({type:"OSM",display:row.display_name,lat:+row.lat,lon:+row.lon,score:0.6}));}catch{return[];}}
function renderAc(list){if(!list.length){ac.style.display="none";return;}ac.innerHTML=list.map((it,i)=>`<div class="ac-item${i===acActiveIndex?" active":""}" data-i="${i}">${esc(it.display)} <span class="badge">${it.type}</span></div>`).join("");[...ac.children].forEach(el=>el.onclick=()=>chooseAc(+el.dataset.i));ac.style.display="block";}
function chooseAc(i){const it=acItems[i];if(!it)return;addr.value=it.display;selectedCoords={lat:it.lat,lon:it.lon};selectedPlaceId=it.place_id||null;ac.style.display="none";}
addr.oninput=()=>{const q=addr.value.trim();if(q.length<3)return;Promise.all([googleSearch(q),nominatimSearch(q)]).then(([g,n])=>{acItems=[...g,...n].slice(0,8);renderAc(acItems);});};

// Call estimate
async function callEstimate(){
  const body={address:addr.value.trim(),mpds:+mpds.value||0,diesel:+diesel.value||0,
    advanced:{extra:[],price_position:document.querySelector('input[name="pricepos"]:checked').value,
    flags:{allow_above_baseline:ex_elastic.checked}}};
  if(selectedCoords){body.siteLat=selectedCoords.lat;body.siteLon=selectedCoords.lon;}
  if(+aadtOverride.value) body.aadtOverride=+aadtOverride.value;
  const r=await fetch("/estimate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});return await r.json();
}

// Render
function renderAll(d){
  estNum.textContent=fmt(d.low);
  estRange.textContent=`Full range: ${fmt(d.low)} – ${fmt(d.high)}`;
  y2.textContent=fmt(d.year2); y3.textContent=fmt(d.year3);
  aadtBanner.textContent=`AADT used ${fmt(d.inputs.aadt_used)} (${d.inputs.aadt_components.method})`;
  compLine.textContent=`Competition: ${d.competition.count} within 1.5 mi`;
  devs.textContent=d.developments.length?d.developments.map(x=>`${x.name} • ${x.status}`).join("; "):"—";
  devsExternalNews.textContent=(d.developments_external.news||[]).map(x=>`${x.name} • ${x.status}`).join("; ")||"—";
  devsExternalPermits.textContent=(d.developments_external.permits||[]).map(x=>`${x.name} • ${x.status}`).join("; ")||"—";
  devsAI.textContent=(d.developments_ai.verified||[]).map(x=>`${x.name} • ${x.status}`).join("; ")||"—";
  ratingLine.textContent=d.rating?`⭐ ${d.rating} (${d.rating_total} reviews)`:"—";
  summary.textContent=d.summary||"—";
}

go.onclick=async()=>{const d=await callEstimate();renderAll(d);}
</script>
</body>
</html>
