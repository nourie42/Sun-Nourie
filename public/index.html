<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sunoco LP Gas Station Analyzer</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root { --bg:#0b0e15; --panel:#111725; --panel2:#0f1421; --line:#263145; --text:#eaeef7; --muted:#97a3b8; --brand:#0ea5e9; --brand2:#22d3ee; --pill:#0f1929; }
    *{ box-sizing:border-box; }
    body{ background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap{ max-width: 1120px; margin:24px auto; padding:0 16px; }
    header{ display:flex; align-items:center; gap:14px; margin-bottom:16px; }
    header .logo{ width:46px; height:46px; border-radius:10px;
      background: radial-gradient(60% 60% at 30% 30%, var(--brand2), transparent 60%), linear-gradient(145deg, var(--brand), var(--panel2));
      box-shadow: 0 10px 30px rgba(14,165,233,.25), inset 0 0 12px rgba(34,211,238,.2); }
    header h1{ font-size:28px; margin:0; }

    .card{ background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line); border-radius:12px; padding:16px; margin:12px 0; }
    label{ display:block; font-weight:600; margin:8px 0 6px; color:#d8e3f6; }
    input, select{ width:100%; padding:12px; border-radius:10px; border:1px solid var(--line); background:#0b1220; color:var(--text); }
    button{ background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#fff; border:0; padding:12px 16px; border-radius:12px; font-weight:700; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .row{ display:grid; grid-template-columns:1.8fr 0.8fr 0.8fr; gap:12px; }
    @media (max-width:900px){ .row{ grid-template-columns:1fr; } }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }
    .right{ text-align:right; }
    .muted{ color:var(--muted); }
    .mono{ font-family: ui-monospace, Menlo, Consolas, monospace; white-space:pre-wrap; }
    .subtle{ font-size:12px; opacity:.9; }

    #map{ height:420px; border-radius:12px; border:1px solid var(--line); position: relative; }
    #overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(11,14,21,.55); border-radius:12px; font-weight:700; color:#cde9ff; }

    /* Autocomplete */
    .ac-wrap{ position:relative; }
    .ac-list{ position:absolute; top:100%; left:0; right:0; z-index:30; margin-top:6px; background:#0b1220; border:1px solid var(--line); border-radius:12px; max-height:320px; overflow:auto; box-shadow: 0 18px 36px rgba(0,0,0,.35); }
    .ac-item{ padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,.04); }
    .ac-item:last-child{ border-bottom:0; }
    .ac-item:hover, .ac-item.active{ background:#101a2b; }
    .badge{ display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--line); background:var(--pill); color:#a9c5ff; margin-left:8px; }

    .toolbar{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .checkbox{ display:inline-flex; align-items:center; gap:8px; font-size:14px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"></div>
      <h1>Sunoco LP Gas Station Analyzer</h1>
    </header>

    <div class="card">
      <div class="row">
        <div>
          <label>Site search (address or business name)</label>
          <div class="ac-wrap">
            <input id="addr" placeholder="6132 Knightdale Blvd, Knightdale, NC — or — Sheetz Knightdale" autocomplete="off"/>
            <div id="ac" class="ac-list" style="display:none;"></div>
          </div>
          <div class="muted subtle" style="margin-top:6px" id="apiStatus">API Status: checking…</div>
        </div>
        <div>
          <label>Regular MPDs</label>
          <input id="mpds" type="number" value="3"/>
        </div>
        <div>
          <label>Diesel positions (optional)</label>
          <input id="diesel" type="number" value="0"/>
        </div>
      </div>
      <div style="margin-top:12px;" class="toolbar">
        <button id="go">Estimate</button>
        <button id="copySummary" title="Copy summary">Copy Summary</button>
        <label class="checkbox"><input type="checkbox" id="includeAI"/>Include AI (unverified) developments</label>
        <button id="checkGoogle">Check Google API</button>
      </div>
    </div>

    <div class="card"><div id="out" class="muted">—</div></div>

    <div class="card">
      <div id="aadtBanner" class="muted" style="margin-bottom:6px;">—</div>
      <div class="muted" style="margin-bottom:6px;">Map: Site & competitors (1 mile) <span class="badge">Legend</span> Site marker • Heavy ● • Regular ●</div>
      <div id="map"><div id="overlay" class="muted">—</div></div>
    </div>

    <div class="card"><b>Developments (multi-source)</b><div id="devs" class="muted">—</div></div>
    <div class="card"><b>Summary</b><div id="summary" class="muted">—</div></div>
    <div class="card"><details><summary>Debug</summary><pre id="debug" class="mono muted">/ waiting…</pre></details></div>
  </div>

<script>
const $ = id => document.getElementById(id);
const out=$("out"), devs=$("devs"), summary=$("summary"), dbg=$("debug"),
      goBtn=$("go"), includeAI=$("includeAI"), copyBtn=$("copySummary"),
      aadtBanner=$("aadtBanner"), apiStatus=$("apiStatus"), checkGoogleBtn=$("checkGoogle");
const acBox=$("ac"), addrInput=$("addr"), overlay=$("overlay");
let map, layer, mapReady=false, selectedCoords=null;

/* Google API Status */
async function checkGoogleStatus(){
  const controller = new AbortController();
  const timer = setTimeout(()=>controller.abort(), 9000);
  apiStatus.textContent = "API Status: checking…";
  try{
    const r=await fetch("/google/status",{signal:controller.signal});
    const text=await r.text();
    let j;
    try{ j=JSON.parse(text);}catch{ j={ok:false,status:"PARSE_ERROR",error:text.slice(0,200)};}
    if(j.ok){ apiStatus.textContent="API Status: Google — Working"; }
    else{ apiStatus.textContent=`API Status: Google — Error (${j.status}${j.error?": "+j.error:""})`; }
  }catch(e){
    apiStatus.textContent="API Status: Google — failed to fetch (server down, CORS, or timeout)";
  }finally{ clearTimeout(timer);}
}
checkGoogleBtn?.addEventListener("click", checkGoogleStatus);
document.addEventListener("DOMContentLoaded", checkGoogleStatus);

/* Helpers */
function setOut(html){ out.innerHTML=html; }
function setDbg(o){ dbg.textContent=typeof o==="string"?o:JSON.stringify(o,null,2);}
function fmt(n){ return (n??0).toLocaleString(undefined,{maximumFractionDigits:0}); }
function esc(s){ return (s??"").toString().replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function setOverlay(msg){ overlay.textContent=msg; overlay.style.display="flex"; }
function clearOverlay(){ overlay.style.display="none"; }
function initMap(){ if(mapReady) return; map=L.map("map",{zoomControl:true});
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap"}).addTo(map);
  layer=L.layerGroup().addTo(map); mapReady=true; }

/* Autocomplete simplified (Google + Nominatim fallback) */
let acTimer=null, acItems=[], acIndex=-1;
async function googleSearch(q){ try{ const r=await fetch(`/google/autocomplete?input=${encodeURIComponent(q)}`); const j=await r.json(); return j.ok?j.items:[];}catch{return [];} }
async function nominatimSearch(q){ try{ const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=6&countrycodes=us&q=${encodeURIComponent(q)}`); const a=await r.json(); return a.map(row=>({type:"Address",display:row.display_name,lat:+row.lat,lon:+row.lon,score:0.6}));}catch{return [];} }
function renderAc(list){ if(!list.length){ acBox.style.display="none"; return;} acBox.innerHTML=list.map((it,i)=>`<div class="ac-item" data-i="${i}">${esc(it.display)}<span class="badge">${it.type}</span></div>`).join(""); [...acBox.children].forEach(el=>{ el.addEventListener("click",()=>chooseAc(+el.dataset.i)); }); acBox.style.display="block"; }
function hideAc(){ acBox.style.display="none"; acIndex=-1; }
function chooseAc(i){ const it=acItems[i]; if(!it) return; addrInput.value=it.display; selectedCoords=(it.lat&&it.lon)?{lat:it.lat,lon:it.lon}:null; hideAc();}
addrInput.addEventListener("input",()=>{ const q=addrInput.value.trim(); selectedCoords=null; hideAc(); if(q.length<3)return; if(acTimer)clearTimeout(acTimer); acTimer=setTimeout(async()=>{ const [g,n]=await Promise.all([googleSearch(q),nominatimSearch(q)]); acItems=[...g,...n]; renderAc(acItems);},250);});

/* Copy Summary */
copyBtn?.addEventListener("click",()=>{ try{navigator.clipboard.writeText(summary.textContent||""); alert("Summary copied.");}catch{alert("Copy failed.");}});

/* Call Estimate */
async function callEstimate(){ const body={ address:$("addr").value.trim(), mpds:+$("mpds").value||0, diesel:+$("diesel").value||0}; if(selectedCoords){ body.siteLat=selectedCoords.lat; body.siteLon=selectedCoords.lon;} const r=await fetch("/estimate",{method:"POST",headers:{ "Content-Type":"application/json"},body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return await r.json(); }

/* Renderers */
function renderReport(d){ const i=d.inputs||{}, c=d.competition||{}; aadtBanner.textContent=`AADT used: ${fmt(i.aadt_used)} (DOT+GPT avg)`; setOut(`<div class="grid"><div><div>Base Estimate</div><div style="font-size:30px;">${fmt(d.base)}</div><div class="muted">Low–High: ${fmt(d.low)} – ${fmt(d.high)}</div></div><div class="right"><div>Year-2: <b>${fmt(d.year2)}</b></div><div>Year-3: <b>${fmt(d.year3)}</b></div></div></div><hr/><div>Inputs: MPDs ${i.mpds}</div><div>Competition: ${c.count??0} within 1 mi</div><div class="muted">${esc(d.rationale||"")}</div>`); }
function renderMap(m){ initMap(); layer.clearLayers(); if(!m||!m.site){ overlay.textContent="—"; return;} const site=[m.site.lat,m.site.lon]; L.marker(site).addTo(layer).bindPopup("Site"); const pts=[site]; for(const c of m.competitors||[]){ pts.push([c.lat,c.lon]); L.circleMarker([c.lat,c.lon],{radius:6,color:c.heavy?"#ff7f50":"#4ade80"}).addTo(layer).bindPopup(`${esc(c.name||"Fuel")} • ${c.miles} mi`);} map.fitBounds(L.latLngBounds(pts).pad(0.25)); clearOverlay();}
function renderDevs(osm, ai){ devs.innerHTML="<pre>"+JSON.stringify({osm,ai},null,2)+"</pre>"; }

/* Main flow */
async function estimate(){ try{ goBtn.disabled=true; setOut("Working…"); setOverlay("Loading..."); const d=await callEstimate(); renderReport(d); renderMap(d.map); renderDevs(d.developments,d.developments_ai); summary.textContent=d.summary||"—"; setDbg(d);}catch(e){ setOut("Error: "+e.message); overlay.textContent="Error";}finally{ goBtn.disabled=false;} }
goBtn.addEventListener("click",estimate);
addrInput.addEventListener("keydown",e=>{ if(e.key==="Enter"){ e.preventDefault(); estimate(); }});
</script>
</body>
</html>
