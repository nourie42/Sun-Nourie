<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ü§ñ AI-Powered Job Match Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family:'Inter',sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); }
    .glass { background:rgba(255,255,255,.9); backdrop-filter:blur(10px); border-radius:1rem; padding:1.5rem; }
    .card { box-shadow:0 10px 25px rgba(0,0,0,0.15); margin-bottom:1.5rem; }
    .spinner { width:18px; height:18px; border:3px solid #ddd; border-top:3px solid #6366f1; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .progress { height:6px; background:#e2e8f0; border-radius:4px; overflow:hidden; }
    #progressBar { height:6px; width:0; background:#6366f1; transition:width .3s; }
  </style>
</head>
<body class="p-4 md:p-10">
  <h1 class="text-3xl font-bold text-white mb-6">ü§ñ AI-Powered Job Match Portal</h1>
  <p class="text-white mb-6">AI matches your resume to jobs and fetches <b>real postings</b> across Indeed, LinkedIn, Glassdoor, ZipRecruiter, etc.</p>

  <!-- Status -->
  <section class="glass card">
    <div class="flex justify-between items-center">
      <span class="text-slate-700 font-semibold">Backend Status:</span>
      <span id="backendStatus" class="text-slate-600">Checking‚Ä¶</span>
      <button id="btnHealth" class="px-3 py-2 rounded bg-indigo-600 text-white text-sm">Recheck</button>
    </div>
    <div class="mt-2 progress"><div id="progressBar"></div></div>
  </section>

  <!-- Mode + API Key -->
  <section class="glass card">
    <h2 class="text-lg font-semibold text-slate-800 mb-3">‚öôÔ∏è Mode & API Key</h2>
    <div class="flex gap-4 items-center">
      <label class="flex items-center gap-2">
        <input id="modeBackend" type="radio" name="mode" checked /> Backend
      </label>
      <label class="flex items-center gap-2">
        <input id="modeAI" type="radio" name="mode" /> OpenAI
      </label>
    </div>
    <input id="apiKey" type="password" class="mt-3 w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="sk-..." />
    <p class="text-xs text-amber-700 mt-1">OpenAI key stored only in your browser (localStorage).</p>
  </section>

  <!-- Profile -->
  <section class="glass card">
    <h2 class="text-lg font-semibold text-slate-800 mb-3">üìã Your Resume Profile</h2>
    <div class="grid md:grid-cols-4 gap-3">
      <input id="exp" class="rounded-lg border border-slate-200 px-3 py-2" value="10+ years Education Leadership" />
      <input id="role" class="rounded-lg border border-slate-200 px-3 py-2" value="Service Projects Coordinator" />
      <input id="expertise" class="rounded-lg border border-slate-200 px-3 py-2" value="Preschool Administration" />
      <input id="edu" class="rounded-lg border border-slate-200 px-3 py-2" value="M.S. Industrial Psychology" />
    </div>
    <textarea id="resumeText" class="mt-3 w-full rounded-lg border border-slate-200 px-3 py-2" rows="6">
Alicia J. Nourie ‚Äî Preschool admin & retail ops leadership. Strengths: Early Childhood Education, Preschool Administration, Staff Supervision, Teacher Training, Family Engagement, Curriculum Development, Licensing Compliance.
Roles: Lowe‚Äôs (Service Projects Coordinator; Customer Experience), English First (ESL Teacher), Green Pines Preschool (Assistant Director), Helping Little Hands Daycare (Owner/Director).
Education: M.S. Industrial Psychology (2017).
    </textarea>

    <div class="mt-6 grid md:grid-cols-4 gap-3">
      <div>
        <label class="text-sm font-semibold text-slate-700">Location</label>
        <input id="location" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2" value="Knightdale, NC" />
      </div>
      <div>
        <label class="text-sm font-semibold text-slate-700">Radius</label>
        <select id="radius" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2">
          <option>10 miles</option><option selected>25 miles</option><option>50 miles</option><option>100 miles</option>
        </select>
      </div>
      <div>
        <label class="text-sm font-semibold text-slate-700">Minimum Match</label>
        <select id="matchThreshold" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2">
          <option value="0">Show All</option><option value="60">60%+</option><option value="70" selected>70%+</option><option value="80">80%+</option>
        </select>
      </div>
      <div class="flex items-center gap-2 mt-6">
        <input id="remoteOnly" type="checkbox" class="w-4 h-4" />
        <label for="remoteOnly" class="text-sm font-semibold text-slate-700">Remote Only</label>
      </div>
    </div>

    <div class="flex items-end gap-2 mt-6">
      <button id="btnSearch" class="px-5 py-3 rounded-xl bg-indigo-600 text-white font-semibold hover:brightness-110 flex items-center gap-2"><span>üîç</span><span>Search & Analyze</span></button>
      <div id="busy" class="hidden items-center gap-3"><div class="spinner"></div><span class="text-slate-600">Working‚Ä¶</span></div>
    </div>
    <p id="err" class="mt-3 hidden text-sm text-red-600"></p>
  </section>

  <!-- Results -->
  <section id="results" class="glass card hidden">
    <div class="flex items-center justify-between mb-4">
      <div id="resultCount" class="text-slate-800 font-semibold">0 jobs found</div>
    </div>
    <div id="grid" class="grid gap-4"></div>
    <div id="empty" class="hidden text-center text-slate-500 py-10">No results found.</div>
  </section>

  <script>
    const backendStatus = document.getElementById("backendStatus");
    const btnHealth = document.getElementById("btnHealth");
    const progressBar = document.getElementById("progressBar");
    const btnSearch = document.getElementById("btnSearch");
    const resultsSection = document.getElementById("results");
    const grid = document.getElementById("grid");
    const resultCount = document.getElementById("resultCount");
    const empty = document.getElementById("empty");
    const busy = document.getElementById("busy");
    const err = document.getElementById("err");
    const apiKeyInput = document.getElementById("apiKey");

    // Mode toggle
    const modeBackend = document.getElementById("modeBackend");
    const modeAI = document.getElementById("modeAI");

    // Save OpenAI key
    apiKeyInput.value = localStorage.getItem("openai_api_key") || "";
    apiKeyInput.addEventListener("input", () => localStorage.setItem("openai_api_key", apiKeyInput.value));

    async function checkHealth() {
      try {
        const res = await fetch("/health");
        backendStatus.textContent = res.ok ? "‚úÖ Online" : "‚ùå Down";
      } catch { backendStatus.textContent = "‚ùå Error"; }
    }
    checkHealth(); btnHealth.onclick = checkHealth;

    function cleanJSON(str) {
      let s = (str||\"\" ).trim();
      s = s.replace(/^```json/i, \"\").replace(/```$/i, \"\").trim();
      try { return JSON.parse(s); } catch {}
      const m = s.match(/(\\{[\\s\\S]*\\}|\\[[\\s\\S]*\\])/);
      if (m) return JSON.parse(m[1]);
      throw new Error(\"AI returned invalid JSON\");
    }

    function renderJobs(list) {
      grid.innerHTML = \"\";
      list.forEach(j => {
        const card = document.createElement(\"div\");
        card.className = \"p-4 border rounded-xl bg-white\";
        card.innerHTML = `
          <h4 class=\"font-semibold text-lg\">${j.title}</h4>
          <p class=\"text-slate-600\">${j.company}</p>
          <p class=\"text-slate-500 text-sm mb-2\">${j.location || \"Remote\"}</p>
          ${j.link ? `<a href=\"${j.link}\" target=\"_blank\" class=\"text-indigo-600 underline\">View Job</a>` : \"\"}
          <p class=\"text-sm mt-2\">Match: ${j.match ?? \"-\"}%</p>
        `;
        grid.appendChild(card);
      });
      resultsSection.classList.remove(\"hidden\");
      resultCount.textContent = `${list.length} jobs found`;
    }

    function renderEstimate(e) {
      grid.innerHTML = \"\";
      const est = e.estimate || e;
      const card = document.createElement(\"div\");
      card.className = \"p-4 border rounded-xl bg-white\";
      card.innerHTML = `
        <h4 class=\"font-semibold text-lg\">Estimate Result</h4>
        <p>Low: ${est.low}</p>
        <p>Range: ${est.range}</p>
        <p>Year 2: ${est.year2}</p>
        <p>Year 3: ${est.year3}</p>
      `;
      grid.appendChild(card);
      resultsSection.classList.remove(\"hidden\");
      resultCount.textContent = `1 result shown`;
    }

    btnSearch.onclick = async () => {
      err.classList.add(\"hidden\"); busy.classList.remove(\"hidden\");
      progressBar.style.width = \"20%\";

      try {
        const query = {
          resume: document.getElementById(\"resumeText\").value,
          role: document.getElementById(\"role\").value,
          expertise: document.getElementById(\"expertise\").value,
          location: document.getElementById(\"location\").value
        };
        let jobs = null;

        if (modeBackend.checked) {
          const payload = { address: query.location||\"Knightdale, NC\", mpds:4, diesel:0 };
          const r = await fetch(\"/estimate\", { method:\"POST\", headers:{\"Content-Type\":\"application/json\"}, body:JSON.stringify(payload) });
          if (r.ok) jobs = await r.json();
          if (jobs?.estimate) renderEstimate(jobs);
        } else if (modeAI.checked) {
          const key = apiKeyInput.value.trim();
          if (!key) throw new Error(\"OpenAI key required for AI mode\");
          const r = await fetch(\"https://api.openai.com/v1/chat/completions\", {
            method:\"POST\", headers:{\"Content-Type\":\"application/json\",\"Authorization\":`Bearer ${key}`},
            body:JSON.stringify({
              model:\"gpt-4o-mini\", messages:[
                {role:\"system\", content:\"Return JSON: [{title, company, location, link, match}]\"},
                {role:\"user\", content:`Find jobs for ${query.resume}, role ${query.role}, expertise ${query.expertise}, location ${query.location}`}
              ]})
          });
          const j = await r.json();
          jobs = cleanJSON(j.choices?.[0]?.message?.content || \"\");
          if (Array.isArray(jobs)) renderJobs(jobs);
          else if (jobs.jobs) renderJobs(jobs.jobs);
        }

      } catch(e) { err.textContent=e.message; err.classList.remove(\"hidden\"); }
      finally { busy.classList.add(\"hidden\"); progressBar.style.width=\"100%\"; setTimeout(()=>progressBar.style.width=\"0%\",1500); }
    };
  </script>
</body>
</html>
