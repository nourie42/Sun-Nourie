<script>
  const backendStatus = document.getElementById("backendStatus");
  const btnHealth = document.getElementById("btnHealth");
  const progressBar = document.getElementById("progressBar");
  const btnSearch = document.getElementById("btnSearch");
  const resultsSection = document.getElementById("results");
  const grid = document.getElementById("grid");
  const resultCount = document.getElementById("resultCount");
  const empty = document.getElementById("empty");
  const busy = document.getElementById("busy");
  const err = document.getElementById("err");
  const apiKeyInput = document.getElementById("apiKey");

  apiKeyInput.value = localStorage.getItem("openai_api_key") || "";
  apiKeyInput.addEventListener("input", () => localStorage.setItem("openai_api_key", apiKeyInput.value));

  async function checkHealth() {
    try {
      const res = await fetch("/health");
      backendStatus.textContent = res.ok ? "✅ Online" : "❌ Down";
    } catch {
      backendStatus.textContent = "❌ Error";
    }
  }
  checkHealth();
  btnHealth.onclick = checkHealth;

  btnSearch.onclick = async () => {
    err.classList.add("hidden");
    busy.classList.remove("hidden");
    progressBar.style.width = "20%";

    try {
      const query = {
        resume: document.getElementById("resumeText").value,
        exp: document.getElementById("exp").value,
        role: document.getElementById("role").value,
        expertise: document.getElementById("expertise").value,
        edu: document.getElementById("edu").value,
        location: document.getElementById("location").value,
        radius: document.getElementById("radius").value,
        matchThreshold: document.getElementById("matchThreshold").value,
        remoteOnly: document.getElementById("remoteOnly").checked
      };

      let jobs = null;

      // Try backend first
      try {
        const res = await fetch("/estimate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(query)
        });
        if (res.ok) {
          jobs = await res.json();
        }
      } catch (e) {
        console.warn("Backend failed:", e.message);
      }

      // If backend fails, try OpenAI fallback
      if (!jobs && apiKeyInput.value) {
        const res = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${apiKeyInput.value}` },
          body: JSON.stringify({
            model: "gpt-4o-mini",
            messages: [
              { role: "system", content: "You are a job search assistant. Return JSON as [{title, company, location, link, match}]" },
              { role: "user", content: `Find jobs for: ${query.resume}, role: ${query.role}, expertise: ${query.expertise}, location: ${query.location}` }
            ]
          })
        });
        const aiData = await res.json();
        if (aiData.choices?.[0]?.message?.content) {
          jobs = JSON.parse(aiData.choices[0].message.content);
        }
      }

      progressBar.style.width = "70%";
      grid.innerHTML = "";

      // Display results
      if (Array.isArray(jobs) && jobs.length) {
        empty.classList.add("hidden");
        jobs.forEach(j => {
          const card = document.createElement("div");
          card.className = "p-4 border rounded-xl bg-white";
          card.innerHTML = `
            <h4 class="font-semibold text-lg">${j.title}</h4>
            <p class="text-slate-600">${j.company}</p>
            <p class="text-slate-500 text-sm mb-2">${j.location || "Remote"}</p>
            <a href="${j.link}" target="_blank" class="text-indigo-600 underline">View Job</a>
            <p class="text-sm mt-2">Match: ${j.match || "-"}%</p>
          `;
          grid.appendChild(card);
        });
        resultsSection.classList.remove("hidden");
        resultCount.textContent = `${jobs.length} jobs found`;
      } else if (jobs?.estimate) {
        // Fallback to showing estimate results
        const card = document.createElement("div");
        card.className = "p-4 border rounded-xl bg-white";
        card.innerHTML = `
          <h4 class="font-semibold text-lg">Estimate Result</h4>
          <p class="text-slate-600">Low: ${jobs.low || jobs.estimate.low}</p>
          <p class="text-slate-600">Range: ${jobs.range || jobs.estimate.range}</p>
          <p class="text-slate-600">Year 2: ${jobs.year2 || jobs.estimate.year2}</p>
          <p class="text-slate-600">Year 3: ${jobs.year3 || jobs.estimate.year3}</p>
        `;
        grid.appendChild(card);
        resultsSection.classList.remove("hidden");
        resultCount.textContent = `1 result shown`;
      } else {
        empty.classList.remove("hidden");
        resultsSection.classList.remove("hidden");
        resultCount.textContent = "0 jobs found";
      }

      progressBar.style.width = "100%";
    } catch (e) {
      err.textContent = e.message;
      err.classList.remove("hidden");
    } finally {
      busy.classList.add("hidden");
      setTimeout(() => progressBar.style.width = "0%", 1500);
    }
  };
</script>
