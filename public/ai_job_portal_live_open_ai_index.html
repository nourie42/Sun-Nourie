<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI‚ÄëPowered Job Match Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand:#667eea; --brand2:#764ba2; --ink:#0f172a; }
    html,body { height:100%; }
    body { font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); }
    .glass { background:rgba(255,255,255,.9); backdrop-filter:blur(10px); }
    .card { border-radius:1rem; box-shadow:0 25px 50px -12px rgba(0,0,0,.25); padding:1.5rem; }
    .chip { padding:.5rem 1rem; border:1px solid #e2e8f0; border-radius:999px; background:#fff; font-size:.9rem; font-weight:600; color:#334155; cursor:pointer; }
    .chip.active { color:#fff; border-color:transparent; background:linear-gradient(135deg,var(--brand),var(--brand2)); }
    .badge { display:inline-flex; align-items:center; padding:.2rem .6rem; border-radius:999px; font-size:.75rem; font-weight:700; }
    .score { position:absolute; top:1rem; right:1rem; width:4rem; height:4rem; border-radius:999px; color:#fff; font-weight:800; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    .excellent{ background:linear-gradient(135deg,#00ff88,#00d084);} .good{background:linear-gradient(135deg,#3b82f6,#2563eb);} .fair{background:linear-gradient(135deg,#fbbf24,#f59e0b);} .poor{background:linear-gradient(135deg,#f87171,#ef4444);} 
    .spinner{ width:40px; height:40px; border:4px solid #e5e7eb; border-top-color:var(--brand); border-radius:999px; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg);} }
    .progress { height:10px; background:#e2e8f0; border-radius:999px; overflow:hidden }
    .progress>div { height:100%; width:0%; background:linear-gradient(90deg,var(--brand),var(--brand2)); transition:width .25s ease }
  </style>
</head>
<body class="min-h-screen p-6">
  <div class="max-w-[1200px] mx-auto space-y-6">
    <!-- Header -->
    <header class="text-center text-white">
      <h1 class="text-3xl font-bold drop-shadow-sm">ü§ñ AI‚ÄëPowered Job Match Portal</h1>
      <p class="opacity-90">AI compares your resume profile to jobs, and links you to Google search for each job.</p>
      <div class="mt-2 inline-flex items-center gap-2 badge bg-emerald-500 text-white">Live AI Enabled</div>
    </header>

    <!-- API / Model / Status -->
    <section class="glass card">
      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <label class="text-sm font-semibold text-slate-700">OpenAI API Key</label>
          <input id="apiKey" type="password" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="sk-..." />
          <p class="text-xs text-amber-700 mt-1">‚ö†Ô∏è Stored only in your browser (localStorage). In production, proxy through a backend.</p>
        </div>
        <div>
          <label class="text-sm font-semibold text-slate-700">Model</label>
          <select id="model" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300">
            <option value="gpt-4o-mini" selected>gpt-4o-mini (fast, $)</option>
            <option value="gpt-4o">gpt-4o (higher quality)</option>
            <option value="o4-mini">o4-mini (reasoning)</option>
          </select>
        </div>
        <div class="flex items-end gap-3">
          <button id="btnCheck" class="h-10 px-4 rounded-lg bg-emerald-600 text-white font-semibold hover:brightness-110">Check API Status</button>
          <span id="apiStatus" class="text-sm"></span>
        </div>
      </div>
      <div class="mt-3 progress"><div id="progressBar"></div></div>
    </section>

    <!-- Profile & controls -->
    <section class="glass card">
      <h2 class="text-lg font-semibold text-slate-800 mb-3">üìã Your Resume Profile</h2>
      <div class="grid md:grid-cols-4 gap-3">
        <input id="exp" class="rounded-lg border border-slate-200 px-3 py-2" value="10+ years Education Leadership" />
        <input id="role" class="rounded-lg border border-slate-200 px-3 py-2" value="Service Projects Coordinator" />
        <input id="expertise" class="rounded-lg border border-slate-200 px-3 py-2" value="Preschool Administration" />
        <input id="edu" class="rounded-lg border border-slate-200 px-3 py-2" value="M.S. Industrial Psychology" />
      </div>
      <textarea id="resumeText" class="mt-3 w-full rounded-lg border border-slate-200 px-3 py-2" rows="6" placeholder="Paste your resume text here (optional)">Alicia J. Nourie ‚Äî Preschool admin & retail ops leadership. Strengths: Early Childhood Education, Preschool Administration, Staff Supervision, Teacher Training, Family Engagement, Curriculum Development, Licensing Compliance. Roles: Lowe‚Äôs (Service Projects Coordinator; Customer Experience), English First (ESL Teacher), Green Pines Preschool (Assistant Director), Helping Little Hands Daycare (Owner/Director). Education: M.S. Industrial Psychology (2017).</textarea>

      <div class="mt-6 grid md:grid-cols-4 gap-3">
        <div>
          <label class="text-sm font-semibold text-slate-700">Location</label>
          <input id="location" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2" value="Knightdale, NC" />
        </div>
        <div>
          <label class="text-sm font-semibold text-slate-700">Radius</label>
          <select id="radius" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2">
            <option>10 miles</option>
            <option selected>25 miles</option>
            <option>50 miles</option>
            <option>100 miles</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-semibold text-slate-700">Minimum Match</label>
          <select id="matchThreshold" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2">
            <option value="0">Show All</option>
            <option value="60">60%+</option>
            <option value="70" selected>70%+</option>
            <option value="80">80%+</option>
          </select>
        </div>
        <div class="flex items-end gap-2">
          <button id="btnSearch" class="px-5 py-3 rounded-xl bg-indigo-600 text-white font-semibold hover:brightness-110 flex items-center gap-2"><span id="searchIcon">üîç</span><span>Search & Analyze with AI</span></button>
          <button id="btnReset" class="px-4 py-3 rounded-xl border">Reset</button>
          <div id="busy" class="hidden items-center gap-3"><div class="spinner"></div><span class="text-slate-600">Working‚Ä¶</span></div>
        </div>
      </div>

      <div class="mt-6">
        <h3 class="text-sm font-semibold text-slate-700 mb-2">Job Categories</h3>
        <div id="chips" class="flex flex-wrap gap-2">
          <button class="chip active" data-category="preschool-director">Preschool Director</button>
          <button class="chip active" data-category="assistant-director">Assistant Director</button>
          <button class="chip active" data-category="education-administrator">Education Administrator</button>
          <button class="chip active" data-category="curriculum-coordinator">Curriculum Coordinator</button>
          <button class="chip active" data-category="childcare-director">Childcare Center Director</button>
          <button class="chip" data-category="program-manager">Program Manager</button>
          <button class="chip" data-category="family-engagement">Family Engagement Specialist</button>
          <button class="chip" data-category="esl-teacher">ESL Teacher</button>
          <button class="chip" data-category="training-coordinator">Training Coordinator</button>
          <button class="chip" data-category="service-coordinator">Service Coordinator</button>
        </div>
      </div>
      <p id="err" class="mt-3 hidden text-sm text-red-600"></p>
    </section>

    <!-- Results -->
    <section id="results" class="glass card hidden">
      <div class="flex items-center justify-between mb-4">
        <div id="resultCount" class="text-slate-800 font-semibold">0 jobs found</div>
        <div class="flex gap-2">
          <button class="px-3 py-2 rounded-lg border" data-sort="match">Best Match</button>
          <button class="px-3 py-2 rounded-lg border" data-sort="recent">Most Recent</button>
          <button class="px-3 py-2 rounded-lg border" data-sort="salary">Highest Salary</button>
        </div>
      </div>
      <div class="mb-3 flex flex-wrap gap-2">
        <button id="openTop5" class="px-3 py-2 rounded-lg bg-emerald-600 text-white">Open Top 5 Google Searches</button>
        <button id="copyAll" class="px-3 py-2 rounded-lg border">Copy All Google Queries</button>
      </div>
      <div id="grid" class="grid gap-4"></div>
      <div id="empty" class="hidden text-center text-slate-500 py-10">No matching jobs found. Try adjusting your filters.</div>
    </section>
  </div>

  <script>
    /********************
     * CONFIG + STATE
     ********************/
    const DEFAULT_MODEL = 'gpt-4o-mini';

    // Sample jobs (expandable). Each entry intentionally lacks a direct posting URL.
    const SAMPLE = [
      {title:'Preschool Director', company:'Bright Horizons Early Learning', salary:'$48,000 - $68,000', category:'preschool-director', req:["Bachelor's in ECE", '5+ yrs leadership', 'NC Director Credential preferred', 'Strong communication'], desc:'Lead center ops, staff, compliance, quality standards.', postedDays: r(1,14)},
      {title:'Assistant Director - Early Learning Center', company:'KinderCare Education', salary:'$42,000 - $58,000', category:'assistant-director', req:['Associate min, BA preferred', '3+ yrs childcare', 'Staff supervision', 'Licensing knowledge'], desc:'Assist director, supervise teachers, manage enrollment and families.', postedDays: r(1,14)},
      {title:'Education Program Administrator', company:'Wake County Public Schools', salary:'$52,000 - $72,000', category:'education-administrator', req:['Masters in Education', '7+ yrs leadership', 'Budget experience', 'Regulations knowledge'], desc:'Oversee programs, budgets, outcomes, compliance.', postedDays: r(1,14)},
      {title:'Childcare Center Director', company:'Primrose Schools', salary:'$45,000 - $65,000', category:'childcare-director', req:['Bachelor required', '5+ yrs childcare mgmt', 'Business acumen', 'Parent comms'], desc:'Direct operations, staff development, parent relations.', postedDays: r(1,14)},
      {title:'Curriculum Development Specialist', company:'Durham Public Schools', salary:'$50,000 - $70,000', category:'curriculum-coordinator', req:['Masters in C&I', 'Teaching exp', 'Standards knowledge', 'PD experience'], desc:'Design curriculum, train teachers, align to standards.', postedDays: r(1,14)},
      {title:'Early Childhood Education Coordinator', company:'YMCA of the Triangle', salary:'$40,000 - $56,000', category:'program-manager', req:['BA in ECE', '3+ yrs coordination', 'Org skills', 'Community partnerships'], desc:'Coordinate programs, partners, scheduling, impact.', postedDays: r(1,14)},
      {title:'Preschool Assistant Director', company:'The Goddard School', salary:'$44,000 - $62,000', category:'assistant-director', req:['Associate or BA in ECE', '2+ yrs leadership', 'NAEYC knowledge'], desc:'Support director in staff management and licensing compliance.', postedDays: r(1,14)},
      {title:'Director of Early Learning Center', company:'Learning Care Group', salary:'$50,000 - $72,000', category:'childcare-director', req:['Bachelor preferred', '5+ yrs ECE mgmt', 'Budget oversight'], desc:'Lead center performance, enrollment growth, quality.', postedDays: r(1,14)},
      {title:'Family Engagement Coordinator', company:'Wake County Head Start', salary:'$40,000 - $55,000', category:'family-engagement', req:['BA in Education/Social Work', 'Community partnerships', 'Bilingual a plus'], desc:'Increase family participation, community resources, outcomes.', postedDays: r(1,14)},
      {title:'ESL Teacher (K‚Äë5)', company:'Raleigh Charter / Public School', salary:'$44,000 - $63,000', category:'esl-teacher', req:['Teaching license', 'ESL certification', 'K‚Äë12 experience'], desc:'Deliver differentiated ESL instruction, assess progress.', postedDays: r(1,14)},
      {title:'Training Coordinator (Education Services)', company:'Chapel Hill Nonprofit', salary:'$45,000 - $60,000', category:'training-coordinator', req:['Program facilitation', 'Curriculum design', 'Reporting'], desc:'Coordinate workshops, PD logistics, and evaluation.', postedDays: r(1,14)},
      {title:'Student Services Coordinator', company:'Cary Academy', salary:'$47,000 - $65,000', category:'service-coordinator', req:['Student services background', 'Data reporting', 'Parent comms'], desc:'Coordinate student support, scheduling, and data.', postedDays: r(1,14)}
    ];

    function r(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

    /********************
     * INIT (persist key/model)
     ********************/
    const keyEl = document.getElementById('apiKey');
    const modelEl = document.getElementById('model');
    keyEl.value   = localStorage.getItem('OPENAI_KEY') || '';
    modelEl.value = localStorage.getItem('OPENAI_MODEL') || DEFAULT_MODEL;
    keyEl.addEventListener('input',()=>localStorage.setItem('OPENAI_KEY', keyEl.value));
    modelEl.addEventListener('change',()=>localStorage.setItem('OPENAI_MODEL', modelEl.value));

    /********************
     * STATUS CHECK (non-blocking)
     ********************/
    document.getElementById('btnCheck').addEventListener('click', checkApi);
    async function checkApi(){
      const s = document.getElementById('apiStatus');
      s.textContent = 'Checking‚Ä¶'; s.className = 'text-sm text-slate-600';
      try{
        const ok = await callOpenAI({
          model: modelEl.value || DEFAULT_MODEL,
          messages: [{role:'user', content:'say ok'}],
          max_tokens: 2
        });
        if(ok){ s.textContent = '‚úÖ API reachable'; s.className = 'text-sm text-emerald-700'; }
        else { throw new Error('Bad response'); }
      }catch(err){ s.textContent = '‚ùå API error ‚Äî check key/model/network'; s.className = 'text-sm text-red-700'; console.error(err); }
    }

    /********************
     * CHIP TOGGLES
     ********************/
    document.getElementById('chips').addEventListener('click', (e)=>{
      if(e.target.classList.contains('chip')) e.target.classList.toggle('active');
    });

    /********************
     * SEARCH & ANALYZE
     ********************/
    document.getElementById('btnSearch').addEventListener('click', runSearch);
    document.getElementById('btnReset').addEventListener('click', ()=>window.location.reload());

    async function runSearch(){
      const active = [...document.querySelectorAll('.chip.active')].map(x=>x.dataset.category);
      if(active.length===0) return showErr('Select at least one job category.');
      hideErr();

      const btn  = document.getElementById('btnSearch');
      const busy = document.getElementById('busy');
      const bar  = document.getElementById('progressBar');
      btn.disabled = true; busy.classList.remove('hidden');

      try{
        const loc = (document.getElementById('location').value||'').trim();
        const jobs = SAMPLE.filter(j=>active.includes(j.category)).map(j=>({ ...j, location: loc, type:'Full-time', tags:['Leadership','Education','Management','Early Childhood'] }));

        const analyzed = [];
        for(let i=0;i<jobs.length;i++){
          const analysis = await aiAnalyzeJob(modelEl.value || DEFAULT_MODEL, getProfile(), jobs[i]);
          analyzed.push({...jobs[i], analysis});
          bar.style.width = `${Math.round(((i+1)/jobs.length)*100)}%`;
        }
        const min = parseInt(document.getElementById('matchThreshold').value,10);
        const finalJobs = analyzed.filter(j=>j.analysis.score>=min).sort((a,b)=>b.analysis.score-a.analysis.score);
        renderResults(finalJobs);
      }catch(err){
        showErr('AI analysis failed. Check key/model/network.');
        console.error(err);
      }finally{
        btn.disabled = false; busy.classList.add('hidden');
      }
    }

    function getProfile(){
      return {
        exp: document.getElementById('exp').value,
        role: document.getElementById('role').value,
        expertise: document.getElementById('expertise').value,
        edu: document.getElementById('edu').value,
        resumeText: document.getElementById('resumeText').value
      };
    }

    /********************
     * OPENAI UTIL (timeout + safe JSON + localStorage key)
     ********************/
    async function callOpenAI(body){
      const key = (keyEl.value||'').trim();
      if(!key) throw new Error('Missing API key');
      const ctl = new AbortController();
      const t = setTimeout(()=>ctl.abort(), 20000);
      try{
        const res = await fetch('https://api.openai.com/v1/chat/completions',{
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${key}` },
          body: JSON.stringify(body),
          signal: ctl.signal
        });
        if(!res.ok) throw new Error(await res.text());
        return await res.json();
      } finally { clearTimeout(t); }
    }

    async function aiAnalyzeJob(model, profile, job){
      const sys = `You are an expert career coach. Return strict JSON with keys: score (0-100), strengths (array), gaps (array), insight (string), recommendation (string).`;
      const user = `Candidate profile (free text allowed):\n${profile.resumeText}\n\nStructured summary:\n- Experience: ${profile.exp}\n- Current role: ${profile.role}\n- Expertise: ${profile.expertise}\n- Education: ${profile.edu}\n\nJob:\n- Title: ${job.title}\n- Company: ${job.company}\n- Location: ${job.location}\n- Salary: ${job.salary}\n- Requirements: ${job.req.join('; ')}\n- Description: ${job.desc}\n\nTask: Compare job to candidate. Score fit 0-100 (integer). Identify strengths and gaps referencing requirements. Provide a short, specific insight and 1-2 sentence recommendation. Output only JSON.`;

      // Try AI first; on failure, use deterministic heuristic fallback.
      try{
        const data = await callOpenAI({
          model,
          temperature: 0.2,
          messages:[{role:'system', content: sys},{role:'user', content: user}],
          response_format: { type: 'json_object' }
        });
        const content = data.choices?.[0]?.message?.content || '{}';
        return normalizeAnalysis(safeParse(content), profile, job);
      }catch(err){
        console.warn('AI error, using heuristic fallback:', err?.message||err);
        return heuristicAnalysis(profile, job);
      }
    }

    function safeParse(t){ try { return JSON.parse(t); } catch{ return {}; } }

    function normalizeAnalysis(a, profile, job){
      // If the model omitted fields, pad them sensibly.
      const score = clampNumber(a.score ?? heuristicScore(profile, job), 0, 100);
      return {
        score,
        strengths: Array.isArray(a.strengths)&&a.strengths.length? a.strengths.slice(0,5) : heuristicStrengths(profile, job),
        gaps: Array.isArray(a.gaps)&&a.gaps.length? a.gaps.slice(0,5) : heuristicGaps(profile, job),
        insight: a.insight || 'Overall alignment looks solid; highlight licensing compliance, staff leadership, and measurable outcomes.',
        recommendation: a.recommendation || 'Lead with director/assistant director wins (enrollment growth, audit results) and quantify team leadership.'
      };
    }

    /********************
     * Heuristic fallback (no API)
     ********************/
    function heuristicScore(profile, job){
      const text = (profile.resumeText + ' ' + profile.expertise + ' ' + profile.role + ' ' + profile.edu).toLowerCase();
      let hits = 0; let total = job.req.length || 1;
      job.req.forEach(rq => { if(text.includes(rq.split(' ')[0].toLowerCase())) hits++; });
      let base = 60 + Math.round((hits/total)*35); // 60..95
      if(/director|lead/i.test(profile.role)) base += 3;
      if(/ms|master/.test(profile.edu.toLowerCase())) base += 2;
      return Math.max(50, Math.min(98, base));
    }
    function heuristicStrengths(profile, job){
      const t = (profile.resumeText + ' ' + profile.expertise).toLowerCase();
      return job.req.filter(rq => t.includes(rq.split(' ')[0].toLowerCase())).slice(0,5);
    }
    function heuristicGaps(profile, job){
      const t = (profile.resumeText + ' ' + profile.expertise).toLowerCase();
      return job.req.filter(rq => !t.includes(rq.split(' ')[0].toLowerCase())).slice(0,5);
    }

    function clampNumber(n, min, max){ n = Number(n); if(Number.isNaN(n)) n = min; return Math.max(min, Math.min(max, n)); }

    /********************
     * RENDER
     ********************/
    function scoreClass(s){ return s>=90?'excellent': s>=80?'good': s>=70?'fair':'poor'; }

    function renderResults(items){
      const results = document.getElementById('results');
      const grid = document.getElementById('grid');
      const empty = document.getElementById('empty');
      const count = document.getElementById('resultCount');
      results.classList.remove('hidden');
      grid.innerHTML='';
      empty.classList.add('hidden');

      if(!items.length){ empty.classList.remove('hidden'); count.textContent='0 jobs found'; return; }

      count.textContent = `${items.length} job${items.length!==1?'s':''} found`;
      items.forEach(job=> grid.appendChild(jobCard(job)) );

      // sorting controls
      document.querySelectorAll('[data-sort]').forEach(btn=>btn.onclick = ()=>sortGrid(btn.dataset.sort));

      // helpers
      document.getElementById('openTop5').onclick = ()=>openTopGoogle(items.slice(0,5));
      document.getElementById('copyAll').onclick = ()=>copyAllQueries(items);
    }

    function googleQuery(job){
      const loc = (job.location||'').trim();
      return `${job.title} ${job.company} ${loc} jobs`;
    }
    function googleUrl(job){
      return `https://www.google.com/search?q=${encodeURIComponent(googleQuery(job))}`;
    }

    function jobCard(job){
      const el = document.createElement('div');
      el.className = 'relative glass card';
      el.dataset.score = job.analysis.score;
      el.dataset.posted = job.postedDays;
      el.dataset.salarymin = extractMinSalary(job.salary);
      const q = googleQuery(job);
      const g = googleUrl(job);
      el.innerHTML = `
        <div class="score ${scoreClass(job.analysis.score)}">${job.analysis.score}%</div>
        <div class="pr-20">
          <h3 class="text-lg font-semibold text-slate-800">${escapeHtml(job.title)}</h3>
          <div class="text-slate-600">${escapeHtml(job.company)}</div>
        </div>
        <div class="mt-2 flex flex-wrap gap-4 text-slate-600">
          <div>üìç ${escapeHtml(job.location||'NC')}</div>
          <div>üíº ${escapeHtml(job.type||'')}</div>
          <div>üí∞ ${escapeHtml(job.salary||'‚Äî')}</div>
          <div>üìÖ ${job.postedDays} day${job.postedDays!==1?'s':''} ago</div>
        </div>
        <div class="mt-4 p-4 rounded-xl border border-indigo-100 bg-indigo-50">
          <div class="text-slate-700 text-sm">${escapeHtml(job.analysis.insight)}</div>
          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <div class="p-3 rounded-lg border bg-white">
              <div class="font-semibold text-slate-800 text-sm mb-1">Strengths</div>
              <ul class="text-sm list-disc ml-5">
                ${job.analysis.strengths.map(s=>`<li>${escapeHtml(s)}</li>`).join('')}
              </ul>
            </div>
            <div class="p-3 rounded-lg border bg-white">
              <div class="font-semibold text-slate-800 text-sm mb-1">Gaps</div>
              <ul class="text-sm list-disc ml-5">
                ${job.analysis.gaps.map(s=>`<li>${escapeHtml(s)}</li>`).join('')}
              </ul>
            </div>
          </div>
          <div class="mt-3 italic text-slate-700 text-sm"><b>AI Recommendation:</b> ${escapeHtml(job.analysis.recommendation)}</div>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
          <a href="${g}" target="_blank" rel="noopener noreferrer" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:brightness-110">Google this job ‚Üí</a>
          <button class="px-4 py-2 rounded-lg border" data-copy="${escapeHtml(q)}">Copy Google query</button>
        </div>
      `;
      // copy handler for this card
      el.querySelector('[data-copy]')?.addEventListener('click', (ev)=>{
        const query = ev.currentTarget.getAttribute('data-copy');
        navigator.clipboard.writeText(query).then(()=>{
          ev.currentTarget.textContent = 'Copied!';
          setTimeout(()=>ev.currentTarget.textContent='Copy Google query', 1000);
        });
      });
      return el;
    }

    function sortGrid(by){
      const grid = document.getElementById('grid');
      const cards = [...grid.children];
      cards.sort((a,b)=>{
        if(by==='match')  return (+b.dataset.score) - (+a.dataset.score);
        if(by==='recent') return (+a.dataset.posted) - (+b.dataset.posted); // fewer days ago first
        if(by==='salary') return (+b.dataset.salarymin) - (+a.dataset.salarymin);
        return 0;
      });
      grid.innerHTML=''; cards.forEach(c=>grid.appendChild(c));
    }

    function openTopGoogle(items){
      items.forEach(j=> window.open(googleUrl(j), '_blank'));
    }
    function copyAllQueries(items){
      const all = items.map(j=>googleQuery(j)).join('\n');
      navigator.clipboard.writeText(all).then(()=>{
        alert('All Google queries copied to clipboard.');
      });
    }

    function extractMinSalary(txt){
      const m = (txt||'').replace(/[,$]/g,'').match(/(\d{2,})/g);
      if(!m||!m.length) return 0; return +m[0];
    }

    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }
    function showErr(msg){ const e=document.getElementById('err'); e.textContent=msg; e.classList.remove('hidden'); }
    function hideErr(){ document.getElementById('err').classList.add('hidden'); }
  </script>
</body>
</html>
