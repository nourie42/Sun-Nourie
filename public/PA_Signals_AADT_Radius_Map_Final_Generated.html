<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PA Signals + AADT - Address Radius Finder</title>
  <!-- Leaflet stylesheets -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    :root{--bg:#0b0e15;--panel:#111725;--panel2:#0f1421;--line:#263145;--text:#e8eefc;--accent:#6cc3ff;}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;}
    #app{display:grid;grid-template-columns:380px 1fr;height:100%;}
    #sidebar{background:var(--panel);border-right:1px solid var(--line);padding:14px 14px 0;overflow:auto;}
    h1{font-size:18px;margin:8px 0 12px;letter-spacing:.2px;}
    label{display:block;font-size:12px;margin:10px 0 6px;color:#bcd;}
    input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--panel2);color:var(--text);}  
    input::placeholder{color:#8aa}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    button{cursor:pointer;background:#1b8ae6;border-color:#1b8ae6;font-weight:600;margin-top:10px;}
    button:hover{filter:brightness(1.1)}
    #map{height:100%;width:100%;}
    .summary{margin:12px 0 6px;font-size:12px;color:#cfe;opacity:.9}
    table{width:100%;border-collapse:collapse;margin:10px 0 16px;font-size:12px;}
    th,td{padding:6px;border-bottom:1px solid #22324a;vertical-align:top;}
    th{position:sticky;top:0;background:var(--panel)}
    .pill{display:inline-block;background:#21324a;color:#cfe;padding:3px 7px;border-radius:999px;font-size:11px;margin-left:6px;}
    .link{color:#9fd;cursor:pointer;text-decoration:underline;}
    .note{font-size:11px;color:#9ab;line-height:1.3;margin-top:6px;}
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <h1>PA Signals ➜ AADT Finder</h1>
    <label>Address (type anything: "123 Main St, Pittsburgh, PA")</label>
    <input id="addr" placeholder="Enter address." autofocus />
    <div class="row">
      <div>
        <label>Radius</label>
        <select id="radius">
          <option value="0.5">0.5 mi</option>
          <option value="1" selected>1 mi</option>
          <option value="2">2 mi</option>
          <option value="5">5 mi</option>
          <option value="10">10 mi</option>
        </select>
      </div>
      <div>
        <label>Max results</label>
        <select id="limit">
          <option value="50" selected>50</option>
          <option value="100">100</option>
          <option value="500">500</option>
          <option value="999999">All</option>
        </select>
      </div>
    </div>
    <div class="row" style="grid-template-columns:1fr;">
      <button id="go">Find Nearby AADT</button>
      <button id="refresh" style="margin-top:10px;background:#444;border-color:#444;">Refresh Map</button>
      <button id="export" style="margin-top:10px;background:#28a745;border-color:#28a745;">Export CSV</button>
    </div>
    <div class="summary" id="summary">Type an address and press “Find Nearby AADT”.</div>
    <div class="note">Tip: Click a row to pan to that signal. Red markers are signals. The blue circle shows your search radius.</div>
    <table id="results">
      <thead>
        <tr>
          <th>#</th>
          <th>SIGNAL_ID</th>
          <th>AADT</th>
          <th>Truck %</th>
          <th>Route</th>
          <th>Dist (mi)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="map"></div>
</div>
<!-- Leaflet and related scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<!-- Load the large SIGNALS dataset from a separate file -->
<script src="signals.js"></script>
<script>
// Setup the map centred roughly on Pennsylvania
const map = L.map('map').setView([40.9,-77.7], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap'
}).addTo(map);

// Add geocoder control with suggest UI
const geocoderCtl = L.Control.geocoder({
  defaultMarkGeocode: false
}).on('markgeocode', function(e) {
  const place = e.geocode;
  document.getElementById('addr').value = place.name;
}).addTo(map);

// Cluster layer for all signals
const cluster = L.markerClusterGroup({disableClusteringAtZoom: 12});
const markers = [];
// Add each signal as a circle marker
for (const s of SIGNALS) {
  if (!isFinite(s.lat) || !isFinite(s.lon)) continue;
  const m = L.circleMarker([s.lat, s.lon], {
    radius:5,
    color:'#ff0000',
    fillColor:'#ff4d4d',
    fillOpacity:0.8,
    weight:1
  }).bindPopup(`Signal ${s.id} AADT: ${fmt(s.aadt)} Truck %: ${fmt(s.truckPct)} Route: ${s.stateRoute || ''} District: ${s.district || ''} County: ${s.countyCode || ''}`);
  m._data = s;
  cluster.addLayer(m);
  markers.push(m);
}
map.addLayer(cluster);

// Variables to hold the search marker and circle
let searchCircle = null;
let searchMarker = null;

// Handle the search button click
document.getElementById('go').addEventListener('click', async () => {
  const q = document.getElementById('addr').value.trim();
  const radiusMiles = parseFloat(document.getElementById('radius').value);
  const limit = parseInt(document.getElementById('limit').value, 10);
  if (!q) { alert('Please enter an address.'); return; }
  // Use Nominatim for geocoding
  const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&q=${encodeURIComponent(q)}`;
  let lat, lon;
  try {
    const resp = await fetch(url, {headers: {'Accept':'application/json'}});
    const data = await resp.json();
    if (!data.length) throw new Error('No match');
    lat = parseFloat(data[0].lat);
    lon = parseFloat(data[0].lon);
  } catch(e) {
    alert('Could not geocode that address. Try a different one.');
    return;
  }
  // Place marker & circle on map
  if (searchMarker) map.removeLayer(searchMarker);
  if (searchCircle) map.removeLayer(searchCircle);
  searchMarker = L.marker([lat, lon], {draggable:true}).addTo(map).bindPopup('Search center').openPopup();
  searchCircle = L.circle([lat, lon], {
    radius: milesToMeters(radiusMiles),
    color:'#1b8ae6',
    fillColor:'#6cc3ff',
    fillOpacity:0.08
  }).addTo(map);
  map.fitBounds(searchCircle.getBounds(), {padding:[40,40]});
  // Compute distances and filter markers
  cluster.clearLayers();
  const results = [];
  for (const m of markers) {
    const dMi = haversineMi(lat, lon, m._data.lat, m._data.lon);
    if (dMi <= radiusMiles) {
      results.push({...m._data, dist:dMi, _marker:m});
      cluster.addLayer(m);
    }
  }
  results.sort((a,b)=>a.dist-b.dist);
  const capped = results.slice(0, limit);
  // Update summary & table
  document.getElementById('summary').textContent = `Found ${results.length} signal(s) within ${radiusMiles} mile(s). Showing ${capped.length}.`;
  const tbody = document.querySelector('#results tbody');
  tbody.innerHTML = '';
  capped.forEach((r, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>#${r.id}</td><td>${fmt(r.aadt)}</td><td>${fmt(r.truckPct)}</td><td>${r.stateRoute || ''}</td><td>${r.dist.toFixed(2)}</td>`;
    tr.addEventListener('click', () => {
      map.setView([r.lat, r.lon], 15);
      r._marker.openPopup();
    });
    tbody.appendChild(tr);
  });
  // Allow user to drag the search marker to refine search centre
  searchMarker.on('dragend', () => {
    const p = searchMarker.getLatLng();
    document.getElementById('addr').value = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
  });
});

// Refresh button resets the map and clears results
document.getElementById('refresh').addEventListener('click', () => {
  cluster.clearLayers();
  markers.forEach(m => cluster.addLayer(m));
  if (searchCircle) { map.removeLayer(searchCircle); searchCircle = null; }
  if (searchMarker) { map.removeLayer(searchMarker); searchMarker = null; }
  document.getElementById('summary').textContent = 'Map reset. Enter a new address to search.';
  document.querySelector('#results tbody').innerHTML = '';
});

// Export current results to a CSV file
document.getElementById('export').addEventListener('click', () => {
  const rows = Array.from(document.querySelectorAll('#results tbody tr'));
  if (!rows.length) { alert('No results to export. Run a search first.'); return; }
  let csv = 'SignalID,AADT,TruckPct,Route,Distance(mi)\n';
  rows.forEach(r => {
    const c = r.querySelectorAll('td');
    // Extract values from table cells
    const sig = c[1].innerText.replace('#','');
    const aadt = c[2].innerText;
    const trk = c[3].innerText;
    const rte = c[4].innerText;
    const dist = c[5].innerText;
    csv += `${sig},${aadt},${trk},${rte},${dist}\n`;
  });
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'aadt_results.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

// Helper functions
function milesToMeters(mi) { return mi * 1609.344; }
function fmt(v) {
  return (v===null || v===undefined || isNaN(v)) ? '' : Number(v).toLocaleString();
}
function haversineMi(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // meters
  const toRad = d => d * Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  const d = 2*R*Math.asin(Math.sqrt(a));
  return d / 1609.344; // miles
}
</script>
</body>
</html>
