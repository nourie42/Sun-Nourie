<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PA Signals ➜ AADT Finder</title>

  <!-- Leaflet + plugins CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css" />

  <style>
    :root{--bg:#0b0e15;--panel:#111725;--panel2:#0f1421;--line:#263145;--text:#e8eefc;--muted:#9fb0cf;--accent:#5ec2ff;}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;}
    #app{display:grid;grid-template-columns:380px 1fr;height:100%;}
    #sidebar{background:var(--panel);border-right:1px solid var(--line);padding:14px 14px 0;overflow:auto}
    h1{font-size:18px;margin:8px 0 12px;letter-spacing:.2px;}
    label{display:block;font-size:12px;margin:10px 0 6px;color:#bcd;}
    input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--panel2);color:var(--text);}
    input::placeholder{color:#8aa}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    button{cursor:pointer;background:#1b8ae6;border-color:#1b8ae6;font-weight:600;margin-top:10px}
    button:hover{filter:brightness(1.1)}
    #map{height:100%;width:100%}
    .summary{margin:12px 0 6px;font-size:12px;color:#cfe;opacity:.9}
    table{width:100%;border-collapse:collapse;margin:10px 0 16px;font-size:12px}
    th,td{padding:6px;border-bottom:1px solid #22324a;vertical-align:top}
    th{position:sticky;top:0;background:var(--panel)}
    .note{font-size:11px;color:#9ab;line-height:1.3;margin-top:6px}
  </style>
</head>
<body>
<div id="app">
  <aside id="sidebar">
    <h1>PA Signals ➜ AADT Finder</h1>

    <label>Address (type anything: "123 Main St, Pittsburgh, PA")</label>
    <input id="addr" placeholder="Enter address.">

    <div class="row">
      <div>
        <label>Radius</label>
        <select id="radius">
          <option value="0.5">0.5 mi</option>
          <option value="1" selected>1 mi</option>
          <option value="2">2 mi</option>
          <option value="5">5 mi</option>
          <option value="10">10 mi</option>
        </select>
      </div>
      <div>
        <label>Max results</label>
        <select id="limit">
          <option value="50" selected>50</option>
          <option value="100">100</option>
          <option value="500">500</option>
          <option value="all">All</option>
        </select>
      </div>
    </div>

    <button id="go">Find Nearby AADT</button>
    <button id="refresh">Refresh Map</button>
    <button id="export">Export CSV</button>

    <p class="summary" id="summary">Type an address and press “Find Nearby AADT”.</p>
    <p class="note">Tip: Click a row to pan to that signal. Red markers are signals. The blue circle shows your search radius.</p>

    <table id="results">
      <thead>
        <tr>
          <th>#</th>
          <th>SIGNAL_ID</th>
          <th>AADT</th>
          <th>Truck %</th>
          <th>Route</th>
          <th>Dist (mi)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </aside>

  <main>
    <div id="map"></div>
  </main>
</div>

<!-- JS libs (order matters) -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>

<!-- Your inline dataset file (must be in the same folder) -->
<script src="signals.js"></script>

<script>
(function(){
  // ---- Utilities
  function milesToMeters(mi){ return mi * 1609.344; }
  function fmt(v){ return (v===null || v===undefined || isNaN(v)) ? '' : Number(v).toLocaleString(); }
  function haversineMi(lat1, lon1, lat2, lon2){
    const R = 6371e3; const toRad = d => d * Math.PI/180;
    const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const d = 2*R*Math.asin(Math.sqrt(a));
    return d / 1609.344;
  }

  // ---- Map
  const map = L.map('map').setView([40.9,-77.7], 7); // center on PA
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19, attribution: '© OpenStreetMap'}).addTo(map);

  // Geocoder control (optional UI)
  L.Control.geocoder({ defaultMarkGeocode:false })
    .on('markgeocode', function(e){ document.getElementById('addr').value = e.geocode.name; })
    .addTo(map);

  // Cluster layer + all markers
  const cluster = L.markerClusterGroup({disableClusteringAtZoom: 12});
  const markers = [];
  for (const s of (window.SIGNALS || [])) {
    if (!Number.isFinite(s.lat) || !Number.isFinite(s.lon)) continue;
    const m = L.circleMarker([s.lat, s.lon], {
      radius:5, color:'#ff0000', fillColor:'#ff4d4d', fillOpacity:0.8, weight:1
    }).bindPopup(`Signal ${s.id}<br>AADT: ${fmt(s.aadt)}<br>Truck %: ${fmt(s.truckPct)}<br>Route: ${s.stateRoute||''} D${s.district||''} C${s.countyCode||''}`);
    m._data = s;
    cluster.addLayer(m);
    markers.push(m);
  }
  map.addLayer(cluster);

  // Search overlays
  let searchCircle = null, searchMarker = null;
  let CURRENT = []; // current results for CSV

  async function geocodeAddress(q){
    // Census first (handles full US addresses well), fallback to Nominatim
    async function census(addr){
      const url = `https://geocoding.geo.census.gov/geocoder/locations/onelineaddress?address=${encodeURIComponent(addr)}&benchmark=Public_AR_Current&format=json`;
      const r = await fetch(url, {headers:{Accept:"application/json"}});
      if(!r.ok) throw new Error("census");
      const j = await r.json();
      const m = j?.result?.addressMatches?.[0];
      if (!m?.coordinates) throw new Error("census no match");
      return { lat:+m.coordinates.y, lon:+m.coordinates.x, label:m.matchedAddress||q };
    }
    async function nominatim(addr){
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=us&q=${encodeURIComponent(addr)}`;
      const r = await fetch(url, {headers:{Accept:"application/json"}});
      if(!r.ok) throw new Error("nominatim");
      const a = await r.json();
      if(!a?.length) throw new Error("nominatim no match");
      return { lat:+a[0].lat, lon:+a[0].lon, label:a[0].display_name };
    }
    // If "lat, lon" typed, use directly
    const m = String(q||"").trim().match(/^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/);
    if(m) return {lat:+m[1], lon:+m[2], label:`${m[1]}, ${m[2]}`};

    try { return await census(q); } catch { return await nominatim(q); }
  }

  // ---- Actions
  document.getElementById('go').addEventListener('click', async () => {
    const q = document.getElementById('addr').value.trim();
    const radiusMiles = parseFloat(document.getElementById('radius').value);
    const limitSel = document.getElementById('limit').value;
    const limit = (limitSel === 'all') ? Infinity : parseInt(limitSel, 10);
    if (!q) { alert('Please enter an address.'); return; }

    let lat, lon;
    try {
      const g = await geocodeAddress(q);
      lat = g.lat; lon = g.lon;
    } catch {
      alert('Could not geocode that address. Try a different one.');
      return;
    }

    if (searchMarker) map.removeLayer(searchMarker);
    if (searchCircle) map.removeLayer(searchCircle);
    searchMarker = L.marker([lat, lon], {draggable:true}).addTo(map).bindPopup('Search center').openPopup();
    searchCircle = L.circle([lat, lon], {radius: milesToMeters(radiusMiles), color:'#1b8ae6', fillColor:'#6cc3ff', fillOpacity:0.08}).addTo(map);
    map.fitBounds(searchCircle.getBounds(), {padding:[40,40]});

    cluster.clearLayers();
    const results = [];
    for (const m of markers) {
      const dMi = haversineMi(lat, lon, m._data.lat, m._data.lon);
      if (dMi <= radiusMiles) {
        results.push({...m._data, dist:dMi, _marker:m});
      }
    }
    results.sort((a,b)=>a.dist-b.dist);
    const capped = results.slice(0, limit);
    CURRENT = capped;

    // show only matches
    capped.forEach(r => cluster.addLayer(r._marker));

    // table
    const tbody = document.querySelector('#results tbody');
    tbody.innerHTML = '';
    capped.forEach((r, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>#${r.id}</td><td>${fmt(r.aadt)}</td><td>${fmt(r.truckPct)}</td><td>${r.stateRoute||''}</td><td>${r.dist.toFixed(2)}</td>`;
      tr.addEventListener('click', () => { map.setView([r.lat, r.lon], 15); r._marker.openPopup(); });
      tbody.appendChild(tr);
    });

    document.getElementById('summary').textContent = `Found ${results.length} signal(s) within ${radiusMiles} mile(s). Showing ${capped.length}.`;

    // allow drag refocus
    searchMarker.on('dragend', () => {
      const p = searchMarker.getLatLng();
      document.getElementById('addr').value = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
    });
  });

  document.getElementById('refresh').addEventListener('click', () => {
    cluster.clearLayers();
    markers.forEach(m => cluster.addLayer(m));
    if (searchCircle) { map.removeLayer(searchCircle); searchCircle = null; }
    if (searchMarker) { map.removeLayer(searchMarker); searchMarker = null; }
    document.getElementById('summary').textContent = 'Map reset. Enter a new address to search.';
    document.querySelector('#results tbody').innerHTML = '';
  });

  document.getElementById('export').addEventListener('click', () => {
    if (!CURRENT.length){ alert('No results to export. Run a search first.'); return; }
    let csv = 'SignalID,AADT,TruckPct,Route,Distance(mi)\n';
    CURRENT.forEach(r => { csv += `${r.id},${r.aadt??''},${r.truckPct??''},${r.stateRoute??''},${r.dist?.toFixed?.(2)??''}\n`; });
    const blob = new Blob([csv], {type:'text/csv'}), url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {href:url, download:'aadt_results.csv'});
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  });
})();
</script>
</body>
</html>
