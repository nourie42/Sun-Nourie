<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ESP32 AMG8833 Thermal Camera (°F)</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      background: #111;
      color: #fff;
      text-align: center;
      font-family: sans-serif;
    }
    #plot {
      width: 480px;
      height: 480px;
      margin: auto;
      position: relative;
    }
    #topStats {
      display: flex;
      justify-content: center;
      gap: 40px;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      text-shadow: 1px 1px 3px #000;
    }
    #topStats span {
      display: inline-block;
    }
  </style>
</head>
<body>
  <h2>ESP32 AMG8833 Thermal Camera (°F)</h2>
  <div id="topStats">
    <span id="minLabel">Min: --°F</span>
    <span id="avgLabel">Avg: --°F</span>
    <span id="maxLabel">Max: --°F</span>
  </div>
  <div id="plot"></div>

  <script>
  const client = mqtt.connect("ws://192.168.4.50:1884", {
    username: "esp32",
    password: "1234"
  });

  client.on("connect", () => {
    console.log("✅ Connected to MQTT broker (ws://192.168.4.50:1884)");
    client.subscribe("amg8833/pixels");
  });

  // --- upscale 8x8 → 64x64 ---
  function upscale8to64(z8) {
    const W = 64, H = 64;
    const z64 = Array.from({ length: H }, () => Array(W).fill(0));
    for (let y = 0; y < H; y++) {
      const gy = y * (7 / (H - 1));
      const y0 = Math.floor(gy), y1 = Math.min(7, y0 + 1);
      const dy = gy - y0;
      for (let x = 0; x < W; x++) {
        const gx = x * (7 / (W - 1));
        const x0 = Math.floor(gx), x1 = Math.min(7, x0 + 1);
        const dx = gx - x0;
        const v00 = z8[y0][x0], v01 = z8[y0][x1];
        const v10 = z8[y1][x0], v11 = z8[y1][x1];
        const v0 = v00 * (1 - dx) + v01 * dx;
        const v1 = v10 * (1 - dx) + v11 * dx;
        z64[y][x] = v0 * (1 - dy) + v1 * dy;
      }
    }
    return z64;
  }

  const colorscale = [
    [0.0, "rgb(0,0,255)"],
    [0.2, "rgb(0,255,255)"],
    [0.4, "rgb(0,255,0)"],
    [0.6, "rgb(255,255,0)"],
    [0.8, "rgb(255,128,0)"],
    [1.0, "rgb(255,0,0)"]
  ];

  const layout = {
    paper_bgcolor: "#111",
    plot_bgcolor: "#111",
    margin: { l: 10, r: 60, t: 10, b: 10 },
    xaxis: { visible: false },
    yaxis: { visible: false },
    coloraxis: {
      colorbar: {
        title: "°F",
        tickfont: { color: "#fff" },
        titlefont: { color: "#fff" }
      }
    }
  };

  let plotInit = false;

  client.on("message", (_, payload) => {
    try {
      const temps = JSON.parse(payload.toString());
      if (!Array.isArray(temps) || temps.length !== 64) return;

      const z8 = [];
      for (let i = 0; i < 8; i++) z8.push(temps.slice(i * 8, (i + 1) * 8));
      const z64 = upscale8to64(z8);

      const min = Math.min(...temps);
      const max = Math.max(...temps);
      const avg = temps.reduce((a,b)=>a+b,0)/temps.length;

      // Update labels
      document.getElementById("minLabel").innerText = `Min: ${min.toFixed(1)}°F`;
      document.getElementById("maxLabel").innerText = `Max: ${max.toFixed(1)}°F`;
      document.getElementById("avgLabel").innerText = `Avg: ${avg.toFixed(1)}°F`;

      if (!plotInit) {
        Plotly.newPlot("plot", [{
          z: z64,
          type: "heatmap",
          colorscale: colorscale,
          reversescale: false,
          colorbar: { title: "°F" }
        }], layout, { responsive: true });
        plotInit = true;
      } else {
        Plotly.update("plot", { z: [z64] });
      }

    } catch (e) {
      console.error("⚠️ Payload error:", e);
    }
  });
  </script>
</body>
</html>
