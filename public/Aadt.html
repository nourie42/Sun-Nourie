<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PA Traffic Volume Map</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha512-XQoYMqMTK8Lvdlx+nKwqgMxQQKfXQp2kzYkN1D2wzHA3Ns2x5Zt9Jg5KdOXgSlhS9KIjDmB3AMT9J1Kzu4taIA=="
        crossorigin="anonymous" />
  <!-- Leaflet Control Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    /* Position the radius input at top-right of map */
    #radiusControl {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 400;
      background: #fff;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #bbb;
      font: 14px/16px Arial, sans-serif;
    }
    /* Sidebar for results (on left side below geocoder control) */
    #sidebar {
      position: absolute;
      top: 60px;
      left: 10px;
      width: 300px;
      max-height: calc(100% - 70px);
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ccc;
      padding: 8px;
      border-radius: 4px;
      z-index: 400;
    }
    #sidebar h3 {
      margin: 0 0 5px;
      font-size: 16px;
    }
    #resultsList div {
      padding: 4px 0;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    #resultsList div:hover {
      background: #f0f0f0;
    }
    /* Ensure Leaflet controls and geocoder appear above the map */
    .leaflet-control-container .leaflet-top, .leaflet-control-container .leaflet-bottom {
      z-index: 500;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <!-- Radius input control -->
  <div id="radiusControl">
    Radius: <input id="radiusInput" type="number" value="5" min="0.1" step="0.1" style="width:60px;" /> miles
  </div>
  <!-- Sidebar for results -->
  <div id="sidebar" style="display:none;">
    <h3>Segments within radius</h3>
    <div id="resultsList"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha512-rNr3I6wi0aI7jT1g3mt/5HbUONTT3MXT+V+U2Qc8+T+GRqtYhZuVAb7J76BJSSBl+jE5x5i0pIrBPOUchSR7AQ=="
          crossorigin="anonymous"></script>
  <!-- Leaflet Control Geocoder JS -->
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script>
    // Embedded segment data: array of segments with coordinates and attributes
    const segments = [
      { lat: 39.9526, lon: -75.1652, route: "4021", aadt: 622,  truck: 8,  date: "2020-10-01" },
      { lat: 40.4406, lon: -79.9959, route: "1092", aadt: 2650, truck: 8,  date: "2020-07-07" },
      { lat: 41.4089, lon: -75.6624, route: "2093", aadt: 1115, truck: 3,  date: "2025-07-08" },
      { lat: 39.9950, lon: -75.1700, route: "A012", aadt: 9611, truck: 13, date: "2025-07-17" },
      { lat: 40.2732, lon: -76.8867, route: "0152", aadt: 1460, truck: 5,  date: "2023-06-21" }
      // ... (additional segments would be listed here)
    ];

    // Initialize the map
    const map = L.map('map').setView([41.203, -77.194], 7);  // centered on Pennsylvania
    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Initialize the geocoder (Nominatim via Control.Geocoder)
    const geocoder = L.Control.geocoder({
      defaultMarkGeocode: false,  // we will handle marking the geocode result
      placeholder: "Search address..."
    }).addTo(map);

    let searchMarker = null;            // Marker for the searched address
    const resultsLayer = L.layerGroup().addTo(map);  // Layer group for segment markers

    // Handle geocode results
    geocoder.on('markgeocode', function(e) {
      const center = e.geocode.center;
      const radiusMiles = parseFloat(document.getElementById('radiusInput').value) || 0;
      if (radiusMiles <= 0) {
        alert("Please enter a valid search radius.");
        return;
      }
      const radiusMeters = radiusMiles * 1609.34;
      // Add marker at geocoded address
      if (searchMarker) {
        map.removeLayer(searchMarker);
      }
      searchMarker = L.marker(center).addTo(map);
      map.setView(center, 13);  // zoom to city level

      // Clear previous results
      resultsLayer.clearLayers();
      const resultsListDiv = document.getElementById('resultsList');
      resultsListDiv.innerHTML = "";
      let foundCount = 0;
      const resultMarkers = [];

      // Filter segments within the radius
      segments.forEach((seg, index) => {
        const distance = L.latLng(seg.lat, seg.lon).distanceTo(center);
        if (distance <= radiusMeters) {
          foundCount++;
          // Create marker for this segment
          const marker = L.marker([seg.lat, seg.lon]).addTo(resultsLayer);
          const popupContent = 
              `<b>Route:</b> ${seg.route}<br>` +
              `<b>AADT:</b> ${seg.aadt}<br>` +
              `<b>Truck %:</b> ${seg.truck}<br>` +
              `<b>Date:</b> ${seg.date}`;
          marker.bindPopup(popupContent);
          resultMarkers.push(marker);
          // Add entry to sidebar list
          const item = document.createElement('div');
          item.textContent = `Route ${seg.route} – AADT ${seg.aadt}`;
          item.onclick = () => {
            // Zoom to segment and open popup
            map.setView([seg.lat, seg.lon], 14);
            marker.openPopup();
          };
          resultsListDiv.appendChild(item);
        }
      });

      // Show or update sidebar with results
      const sidebar = document.getElementById('sidebar');
      if (foundCount > 0) {
        sidebar.style.display = "block";
        sidebar.querySelector('h3').textContent = `Segments within ${radiusMiles} mi: ${foundCount} found`;
      } else {
        sidebar.style.display = "block";
        sidebar.querySelector('h3').textContent = `Segments within ${radiusMiles} mi: 0 found`;
        resultsListDiv.innerHTML = "<i>No segments found in this area.</i>";
      }
    });
  </script>
</body>
</html>
