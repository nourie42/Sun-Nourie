<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AADT Map — Traffic Counts Near an Address</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --accent:#06b6d4; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1150px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border-radius:14px;padding:18px 18px 14px 18px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    h1{margin:0 0 12px;font-weight:800;letter-spacing:.2px}
    .row{display:grid;grid-template-columns:1fr 200px;gap:14px}
    .row + .row{margin-top:10px}
    label{font-size:.9rem;color:var(--muted);margin-bottom:6px;display:block}
    input,button{font-size:1rem}
    input[type=text],input[type=number]{width:100%;padding:12px 12px;border-radius:10px;border:1px solid #1f2937;background:#0b1220;color:var(--text)}
    button{padding:11px 16px;border:0;border-radius:10px;background:var(--accent);color:#002b36;font-weight:700;cursor:pointer}
    #map{height:560px;width:100%;border-radius:12px;border:1px solid #1f2937;overflow:hidden}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin:10px 2px 14px}
    .muted{color:var(--muted);font-size:.92rem}
    .pill{background:#0b1220;border:1px solid #1f2937;border-radius:999px;padding:6px 10px;color:var(--muted)}
    .right{display:flex;gap:10px;align-items:center}
  </style>
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>AADT Map — Traffic Counts Near an Address</h1>

    <div class="card">
      <div class="row">
        <div>
          <label for="addr">Address</label>
          <input id="addr" type="text" placeholder="Enter an address (Google autocomplete)…"/>
        </div>
        <div>
          <label for="radius">Radius (miles)</label>
          <input id="radius" type="number" step="0.1" min="0.1" value="3.0"/>
        </div>
      </div>

      <div class="row toolbar">
        <div>
          <button id="go">Find AADT</button>
          <span id="status" class="muted"></span>
        </div>
        <div class="right">
          <span id="updated" class="pill">—</span>
        </div>
      </div>

      <div id="map"></div>
    </div>
  </div>

  <script>
    // ---------- CONSTANTS ----------
    const CSV_FILE = 'RMSTRAFFIC_with_latlon_full.csv'; // <<<<<< THIS is the file we load
    const DEFAULT_CENTER = { lat: 40.864, lng: -77.797 }; // PA-ish
    const DEFAULT_ZOOM = 7;

    // ---------- STATE ----------
    let map, infoWindow;
    let addressMarker = null;
    let aadtMarkers = [];
    let csvRows = [];

    // ---------- UTIL ----------
    function nowEST(){
      return new Intl.DateTimeFormat('en-US',{
        timeZone:'America/New_York', dateStyle:'medium', timeStyle:'short', hour12:true, timeZoneName:'short'
      }).format(new Date());
    }
    function setUpdated(){ document.getElementById('updated').textContent = 'Updated: '+ nowEST(); }
    function setStatus(msg){ document.getElementById('status').textContent = msg; }

    function redStarIcon(){ return {
      path: "M 0,-24 L 6,-6 L 24,0 L 6,6 L 0,24 L -6,6 L -24,0 L -6,-6 Z",
      fillColor:"#ff3b3b", fillOpacity:1, strokeColor:"#fff", strokeWeight:2, scale:1
    };}

    function blueSquareIcon(){ return {
      path:"M -10 -10 L 10 -10 L 10 10 L -10 10 z",
      fillColor:"#1d4ed8", fillOpacity:1, strokeColor:"#fff", strokeWeight:1,
      labelOrigin:new google.maps.Point(0,0), scale:1
    };}

    function milesToMeters(mi){ return mi * 1609.344; }

    function clearAADTMarkers(){
      for(const m of aadtMarkers){ m.setMap(null); }
      aadtMarkers = [];
    }

    function placeAddressMarker(loc){
      if(addressMarker) addressMarker.setMap(null);
      addressMarker = new google.maps.Marker({ position: loc, map, icon: redStarIcon(), title: "Searched Address" });
    }

    function addAADTMarkers(centerLL, radiusMiles){
      clearAADTMarkers();
      const radiusMeters = milesToMeters(radiusMiles);
      let added = 0;

      for(const row of csvRows){
        // Hard-code expected columns
        const la = +row.latitude, lo = +row.longitude;
        if(!Number.isFinite(la) || !Number.isFinite(lo)) continue;

        const pt = new google.maps.LatLng(la, lo);
        const d = google.maps.geometry.spherical.computeDistanceBetween(centerLL, pt);
        if(d > radiusMeters) continue;

        // AADT column choices
        const aadt = row.CUR_AADT ?? row.AADT ?? row.BASE_ADT ?? row.Base_ADT ?? '';
        const marker = new google.maps.Marker({
          position: pt,
          map,
          icon: blueSquareIcon(),
          label: aadt ? { text: String(aadt), color:"#fff", fontSize:"10px", fontWeight:"700" } : undefined,
          title: aadt ? `AADT: ${aadt}` : 'AADT'
        });

        marker.addListener('click', ()=>{
          const html =
            `<b>Route:</b> ${row.ST_RT_NO ?? '—'}<br>`+
            `<b>AADT:</b> ${aadt || '—'}<br>`+
            `<b>Truck %:</b> ${row.TRK_PCT ?? '—'}<br>`+
            `<b>Year:</b> ${row.BASE_ADT_YR ?? '—'}`;
          infoWindow.setContent(html);
          infoWindow.open(map, marker);
        });

        aadtMarkers.push(marker);
        added++;
      }

      setStatus(`Found ${added.toLocaleString()} segment(s) within ${radiusMiles} mi`);
      setUpdated();
    }

    function handleSearch(loc){
      map.setCenter(loc);
      map.setZoom(13);
      placeAddressMarker(loc);
      const miles = Math.max(0.1, parseFloat(document.getElementById('radius').value) || 3.0);
      addAADTMarkers(loc, miles);
    }

    async function loadCSV(){
      setStatus('Loading AADT CSV…');
      return new Promise((resolve, reject)=>{
        Papa.parse(CSV_FILE, {
          download: true,
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: (res)=>{ csvRows = res.data; setStatus('CSV loaded. Enter an address and click Find AADT.'); setUpdated(); resolve(); },
          error: (err)=>{ console.error(err); setStatus('Failed to load CSV: '+CSV_FILE); reject(err); }
        });
      });
    }

    function init(){
      map = new google.maps.Map(document.getElementById('map'), { center: DEFAULT_CENTER, zoom: DEFAULT_ZOOM, mapTypeId:'roadmap' });
      infoWindow = new google.maps.InfoWindow();

      // Places Autocomplete
      const input = document.getElementById('addr');
      const autocomplete = new google.maps.places.Autocomplete(input, { types: ['address'] });
      autocomplete.addListener('place_changed', ()=>{
        const place = autocomplete.getPlace();
        if(!place.geometry || !place.geometry.location){ setStatus('No details for that address'); return; }
        handleSearch(place.geometry.location);
      });

      // Manual button click (fallback geocode if not selecting from autocomplete)
      document.getElementById('go').addEventListener('click', ()=>{
        const p = autocomplete.getPlace();
        if(p?.geometry?.location){ handleSearch(p.geometry.location); return; }

        const addr = input.value.trim();
        if(!addr){ setStatus('Enter an address'); return; }
        setStatus('Geocoding…');
        const gc = new google.maps.Geocoder();
        gc.geocode({ address: addr }, (results, status)=>{
          if(status==='OK' && results[0]) handleSearch(results[0].geometry.location);
          else setStatus('Address not found');
        });
      });

      // Load data
      loadCSV();
    }

    // Expose for callback
    window._aadti = { init };
  </script>

  <!-- Google Maps JS API (Maps + Places + Geometry). Replace the API key. -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places,geometry&callback=_aadti.init"
    async defer></script>
</body>
</html>
