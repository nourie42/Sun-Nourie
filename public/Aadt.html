<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AADT Map — Traffic Counts Near an Address</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#0f172a; color:#e5e7eb; }
    #map { height: 560px; width: 100%; }
    .controls { padding:10px; background:#111827; }
    label { margin-right:5px; }
    input, button { margin-right:10px; padding:6px; border-radius:6px; border:1px solid #333; }
    button { background:#06b6d4; color:#fff; border:none; cursor:pointer; }
    #status { padding:10px; font-size:.9em; color:#94a3b8; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="controls">
    <label for="addr">Address:</label>
    <input id="addr" type="text" size="50" placeholder="Enter address"/>
    <label for="radius">Radius (miles):</label>
    <input id="radius" type="number" value="5" step="0.5" min="0.1"/>
    <button id="go">Find AADT</button>
  </div>
  <div id="map"></div>
  <div id="status">—</div>

  <script>
    let map, infoWindow, addressMarker=null, aadtMarkers=[];
    let csvRows=[];

    function nowEST() {
      return new Date().toLocaleString("en-US", {
        timeZone: "America/New_York",
        dateStyle: "medium",
        timeStyle: "short",
        hour12: true,
        timeZoneName: "short"
      });
    }

    function redStarIcon(){
      return {
        path:"M 0,-24 L 6,-6 L 24,0 L 6,6 L 0,24 L -6,6 L -24,0 L -6,-6 Z",
        fillColor:"#ff3b3b", fillOpacity:1, strokeColor:"#fff", strokeWeight:2, scale:1
      };
    }
    function blueSquareIcon(){
      return {
        path:"M -10 -10 L 10 -10 L 10 10 L -10 10 z",
        fillColor:"#1d4ed8", fillOpacity:1, strokeColor:"#fff", strokeWeight:1,
        labelOrigin: new google.maps.Point(0,0), scale:1
      };
    }

    function clearMarkers(){
      aadtMarkers.forEach(m=>m.setMap(null));
      aadtMarkers=[]; if(addressMarker){addressMarker.setMap(null);}
    }

    function addAADTMarkers(center, radiusMiles){
      clearMarkers();
      const radiusMeters=radiusMiles*1609.34;
      let count=0;
      for(const row of csvRows){
        const la=+row.latitude, lo=+row.longitude;
        if(!isFinite(la)||!isFinite(lo)) continue;
        const pt=new google.maps.LatLng(la,lo);
        const d=google.maps.geometry.spherical.computeDistanceBetween(center,pt);
        if(d>radiusMeters) continue;
        const aadt=row.CUR_AADT||row.AADT||'';
        const marker=new google.maps.Marker({
          position:pt,map,icon:blueSquareIcon(),
          label:aadt?{text:String(aadt),color:"#fff",fontSize:"10px",fontWeight:"700"}:undefined,
          title:`AADT: ${aadt}`
        });
        marker.addListener("click",()=>{
          infoWindow.setContent(
            `<b>Route:</b> ${row.ST_RT_NO||'—'}<br>`+
            `<b>AADT:</b> ${aadt}<br>`+
            `<b>Truck %:</b> ${row.TRK_PCT||'—'}<br>`+
            `<b>Year:</b> ${row.BASE_ADT_YR||'—'}`
          );
          infoWindow.open(map,marker);
        });
        aadtMarkers.push(marker); count++;
      }
      document.getElementById("status").textContent=`Found ${count} segment(s) within ${radiusMiles} mi • ${nowEST()}`;
    }

    function handleSearch(loc){
      map.setCenter(loc); map.setZoom(13);
      if(addressMarker) addressMarker.setMap(null);
      addressMarker=new google.maps.Marker({position:loc,map,icon:redStarIcon(),title:"Search Address"});
      const miles=parseFloat(document.getElementById("radius").value)||5;
      addAADTMarkers(loc,miles);
    }

    function init(){
      map=new google.maps.Map(document.getElementById("map"),{center:{lat:40.86,lng:-77.79},zoom:7});
      infoWindow=new google.maps.InfoWindow();
      Papa.parse("RMSTRAFFIC_with_latlon_full.csv",{download:true,header:true,dynamicTyping:true,complete:(res)=>{csvRows=res.data;}});
      document.getElementById("go").addEventListener("click",()=>{
        const geocoder=new google.maps.Geocoder();
        const addr=document.getElementById("addr").value;
        geocoder.geocode({address:addr},(results,status)=>{
          if(status==='OK'&&results[0]){handleSearch(results[0].geometry.location);}
          else{document.getElementById("status").textContent="Address not found";}
        });
      });
    }
    window.init=init;
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlm18rIsI1bhOwhx3bpHAX589EahvLbPc&libraries=places,geometry&callback=init" async defer></script>
</body>
</html>
