<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gas Station Developments — Town Search</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<style>
  :root{ --bg:#0b0e15; --panel:#111725; --panel2:#0e1626; --text:#e8eefc; --muted:#9fb0cf; --accent:#5ec2ff; --line:#263145; --warn:#ffe08a; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  .wrap{max-width:1250px;margin:20px auto;padding:0 14px;}
  header{display:flex;gap:12px;align-items:center;margin-bottom:10px;}
  h1{margin:0;font-size:1.6rem;letter-spacing:.2px;}
  .spacer{flex:1}
  .btn{background:var(--accent);color:#00121e;border:0;border-radius:10px;padding:.6rem 1rem;font-weight:700;cursor:pointer}
  .btn.ghost{background:#0f2236;border:1px solid var(--line);color:#bfe6ff}
  .btn.small{padding:.45rem .75rem;font-weight:600}
  a.btn{display:inline-block;text-decoration:none}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
  .tabs{display:flex;gap:.5rem;margin-bottom:12px;flex-wrap:wrap}
  .tabbtn{background:var(--panel2);border:1px solid var(--line);color:var(--text);border-radius:12px;padding:.6rem 1rem;cursor:pointer}
  .tabbtn.active{background:var(--accent);color:#062338;border-color:transparent;font-weight:700}
  label{display:block;margin:.25rem 0 .35rem;color:var(--muted)}
  input[type="text"], input[type="number"]{width:100%;padding:.75rem;border-radius:10px;border:1px solid var(--line);background:#0f1421;color:var(--text);}
  .grid{display:grid;gap:12px}
  .grid.cols-3{grid-template-columns:1.4fr .7fr .6fr}
  @media (max-width:900px){ .grid.cols-3{grid-template-columns:1fr} }
  .muted{color:var(--muted)}
  .pill{display:inline-block;background:#0f2236;color:#bfe6ff;padding:.25rem .5rem;border-radius:999px;font-size:.75rem;border:1px solid var(--line)}
  table{width:100%;border-collapse:collapse;margin-top:8px;font-size:.95rem}
  th,td{border-bottom:1px solid var(--line);text-align:left;padding:.6rem .5rem;vertical-align:top}
  th{color:var(--muted);font-weight:600}
  a{color:#8cd1ff}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
  .right{margin-left:auto}
  .hint{color:var(--muted);font-size:.9rem}
  .ok{color:#86efac}
  .warn{color:var(--warn)}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Gas Station Developments — Town Search (≤ <span id="miLabel">20</span> miles)</h1>
    <div class="spacer"></div>
    <a class="btn small ghost" href="index.html">← Back to Analyzer</a>
  </header>

  <div class="tabs">
    <button class="tabbtn active" data-tab="search">Search</button>
    <button class="tabbtn" data-tab="raw">Raw Data</button>
  </div>

  <!-- SEARCH -->
  <section id="tab-search" class="card">
    <div class="grid cols-3">
      <div>
        <label for="q">Town (use “Town, ST”)</label>
        <input id="q" list="towns" type="text" placeholder="e.g., Knightdale, NC"/>
        <datalist id="towns"></datalist>
      </div>
      <div>
        <label for="miles">Miles radius</label>
        <input id="miles" type="number" min="1" value="20"/>
      </div>
      <div style="align-self:end;">
        <button id="go" class="btn">Search</button>
        <button id="clear" class="btn ghost">Clear</button>
      </div>
    </div>

    <div class="toolbar">
      <span id="meta" class="muted">Loading data…</span>
      <span class="right">
        <button id="dlResultsCsv" class="btn small ghost">Download results CSV</button>
      </span>
    </div>

    <div id="results" style="margin-top:10px"></div>
    <div id="map" style="height:500px; margin-top:12px; border-radius:12px; overflow:hidden;"></div>
  </section>

  <!-- RAW DATA -->
  <section id="tab-raw" class="card" style="display:none;">
    <label for="raw-q">Filter</label>
    <input id="raw-q" type="text" placeholder="Type to filter all columns (e.g., FL, 2024, permit)…"/>
    <div class="toolbar">
      <span id="sourceBadge" class="pill"></span>
      <span class="right">
        <button id="dlAllCsv" class="btn small">Download ALL CSV</button>
      </span>
    </div>
    <div id="rawTable" style="margin-top:8px"></div>
  </section>
</div>

<script>
/* your existing DATA loading, normalize, search helpers stay the same ... */

/* -------------------- Map setup -------------------- */
let map=L.map('map').setView([37.8,-96],4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
let markersLayer=L.layerGroup().addTo(map);

function updateMap(rows){
  markersLayer.clearLayers();
  if(!rows.length) return;
  let bounds=[];
  rows.forEach(r=>{
    if(Number.isFinite(r.lat)&&Number.isFinite(r.lon)){
      let m=L.marker([r.lat,r.lon]).addTo(markersLayer);
      let popup=`<b>${esc(r.name||"")}</b><br>${esc(r.address||""||"")}`;
      if(r.town||r.state) popup+=`<br>${esc(r.town)}, ${esc(r.state)}`;
      if(r.developer) popup+=`<br><i>${esc(r.developer)}</i>`;
      if(r.date) popup+=`<br>${esc(r.date)}`;
      if(r.url) popup+=`<br><a href="${esc(r.url)}" target="_blank">source</a>`;
      m.bindPopup(popup);
      bounds.push([r.lat,r.lon]);
    }
  });
  if(bounds.length) map.fitBounds(bounds,{padding:[30,30]});
}

/* -------------------- Hook map into doSearch -------------------- */
// at the end of your existing doSearch() function, add:
updateMap(results);

</script>
</body>
</html>

