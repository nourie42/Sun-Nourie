<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gas Station Developments — Google Maps</title>
  <style>
    :root {
      --bg: #0b0e15;
      --panel: #111725;
      --text: #e8eefc;
      --muted: #9fb0cf;
      --accent: #5ec2ff;
      --line: #263145;
    }
    body {
      margin: 0;
      padding: 20px;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      margin: 12px 0;
    }
    h1 {
      margin: 0 0 20px 0;
      font-size: 1.6rem;
    }
    .btn {
      background: var(--accent);
      color: #00121e;
      border: 0;
      border-radius: 10px;
      padding: 0.6rem 1rem;
      font-weight: 700;
      cursor: pointer;
      margin: 5px;
    }
    .btn.ghost {
      background: #0f2236;
      border: 1px solid var(--line);
      color: #bfe6ff;
    }
    input[type="text"],
    input[type="number"] {
      width: 200px;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid var(--line);
      background: #0f1421;
      color: var(--text);
      margin: 5px;
    }
    #map {
      height: 500px;
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
    }
    .controls {
      margin: 10px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    th,
    td {
      border-bottom: 1px solid var(--line);
      text-align: left;
      padding: 0.5rem;
    }
    th {
      color: var(--muted);
      font-weight: 600;
    }
    .status {
      color: var(--muted);
      font-size: 0.9rem;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>Gas Station Developments — Google Maps</h1>

  <div class="card">
    <div class="controls">
      <input id="townInput" type="text" placeholder="Town, ST (e.g. Raleigh, NC)" />
      <input id="milesInput" type="number" value="20" min="1" max="100" />
      <button id="searchBtn" class="btn">Search</button>
      <button id="clearBtn" class="btn ghost">Show All</button>
    </div>
    <div id="status" class="status">Loading Google Maps...</div>
  </div>

  <div class="card">
    <div id="map"></div>
  </div>

  <div class="card">
    <div id="results"></div>
  </div>

  <!-- Google Maps JavaScript API -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlm18rIsI1bhOwhx3bpHAX589EahvLbPc&callback=initMap">
  </script>

  <script>
    // Robust CSV parser that handles commas and newlines inside quoted fields
    function parseCSV(csv) {
      const rows = [];
      let row = [];
      let value = '';
      let inQuotes = false;
      for (let i = 0; i < csv.length; i++) {
        const char = csv[i];
        if (char === '"' && csv[i + 1] === '"') {
          value += '"';
          i++;
        } else if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          row.push(value);
          value = '';
        } else if ((char === '\n' || char === '\r') && !inQuotes) {
          // Handle CR+LF or LF line endings
          if (char === '\r' && csv[i + 1] === '\n') {
            i++;
          }
          row.push(value);
          value = '';
          if (row.length > 1 || row[0] !== '') {
            rows.push(row);
          }
          row = [];
        } else {
          value += char;
        }
      }
      // Push the last value/row if not empty
      if (value !== '' || row.length > 0) {
        row.push(value);
        rows.push(row);
      }
      return rows;
    }

    // Convert rows into objects
    function transformData(rows) {
      if (!rows || rows.length === 0) return [];
      const headers = rows[0];
      const data = [];
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const obj = {};
        headers.forEach((h, idx) => (obj[h] = row[idx]));
        const town =
          obj['City/County'] ||
          obj['City/County.1'] ||
          obj['City/County.2'] ||
          '';
        const state = obj['State'] || '';
        const name = obj['Brand'] || '';
        const developer = obj['Brand.1'] || '';
        const date = obj['Date'] || obj['Date.1'] || obj['Date.2'] || '';
        const notes =
          obj['Status'] || obj['Details.1'] || obj['Details.2'] || '';
        // Skip if both town and state are empty
        if (!town && !state) continue;
        data.push({ name, town, state, developer, date, notes });
      }
      return data;
    }

    let map, geocoder, infoWindow;
    let allData = [];
    let currentResults = [];
    let markers = [];

    async function loadData() {
      try {
        const response = await fetch('https://raw.githubusercontent.com/nourie42/Sun-Nourie/main/public/developments_data.csv');
        const csv = await response.text();
        const rows = parseCSV(csv);
        allData = transformData(rows);
        currentResults = allData;
        addMarkersToMap(allData);
        showResults(allData);
        document.getElementById('status').textContent =
          'Loaded ' + allData.length + ' locations';
      } catch (err) {
        console.error('Failed to load CSV:', err);
        document.getElementById('status').textContent =
          'Error loading data';
      }
    }

    function initMap() {
      try {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 6,
          center: { lat: 35.7596, lng: -79.0193 },
          mapTypeId: 'roadmap',
        });
        geocoder = new google.maps.Geocoder();
        infoWindow = new google.maps.InfoWindow();
        setupEventListeners();
        loadData();
      } catch (error) {
        console.error('Google Maps initialization failed:', error);
        document.getElementById('status').textContent =
          'Error: Google Maps failed to load. Check your API key.';
      }
    }

    function clearMarkers() {
      markers.forEach((m) => m.setMap(null));
      markers = [];
    }

    async function addMarkersToMap(data) {
      clearMarkers();
      if (!geocoder) return;
      const bounds = new google.maps.LatLngBounds();
      let count = 0;
      for (const item of data) {
        const address = item.town + ', ' + item.state;
        try {
          const results = await new Promise((resolve, reject) => {
            geocoder.geocode({ address }, (res, status) => {
              if (status === 'OK') resolve(res);
              else reject(status);
            });
          });
          if (results[0]) {
            const position = results[0].geometry.location;
            const marker = new google.maps.Marker({
              position,
              map,
              title: item.name || 'Gas Station Development',
              icon: {
                url:
                  'data:image/svg+xml;base64,' +
                  btoa(
                    '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="8" fill="#FF4444" stroke="white" stroke-width="2"/></svg>'
                  ),
                scaledSize: new google.maps.Size(24, 24),
              },
            });
            let content =
              '<div style="color: #333; font-family: Arial; max-width: 250px;">';
            content +=
              '<h3 style="margin: 0 0 8px 0;">' +
              (item.name || 'Gas Station Development') +
              '</h3>';
            content +=
              '<p style="margin: 4px 0;"><strong>Location:</strong> ' +
              item.town +
              ', ' +
              item.state +
              '</p>';
            if (item.developer)
              content +=
                '<p style="margin: 4px 0;"><strong>Developer:</strong> ' +
                item.developer +
                '</p>';
            if (item.date)
              content +=
                '<p style="margin: 4px 0;"><strong>Date:</strong> ' +
                item.date +
                '</p>';
            if (item.notes)
              content +=
                '<p style="margin: 4px 0;"><strong>Notes:</strong> ' +
                item.notes +
                '</p>';
            content += '</div>';
            marker.addListener('click', () => {
              infoWindow.setContent(content);
              infoWindow.open(map, marker);
            });
            markers.push(marker);
            bounds.extend(position);
            count++;
          }
        } catch (e) {
          console.log('Geocoding failed for', address);
        }
      }
      if (count > 0) {
        map.fitBounds(bounds);
        google.maps.event.addListenerOnce(map, 'bounds_changed', () => {
          if (map.getZoom() > 12) map.setZoom(12);
        });
      }
    }

    function showResults(data) {
      if (data.length === 0) {
        document.getElementById('results').innerHTML = '<p>No results found.</p>';
        return;
      }
      let html =
        '<table><thead><tr><th>Name</th><th>Town</th><th>State</th><th>Developer</th><th>Date</th><th>Notes</th></tr></thead><tbody>';
      data.forEach((item) => {
        html += '<tr>';
        html += '<td>' + (item.name || '') + '</td>';
        html += '<td>' + (item.town || '') + '</td>';
        html += '<td>' + (item.state || '') + '</td>';
        html += '<td>' + (item.developer || '') + '</td>';
        html += '<td>' + (item.date || '') + '</td>';
        html += '<td>' + (item.notes || '') + '</td>';
        html += '</tr>';
      });
      html += '</tbody></table>';
      document.getElementById('results').innerHTML = html;
    }

    function doSearch() {
      const query = document.getElementById('townInput').value
        .trim()
        .toLowerCase();
      currentResults = !query
        ? allData
        : allData.filter((item) => {
            const town = (item.town || '').toLowerCase();
            const state = (item.state || '').toLowerCase();
            const full = town + ', ' + state;
            return (
              town.includes(query) ||
              full.includes(query) ||
              query.includes(town)
            );
          });
      addMarkersToMap(currentResults);
      showResults(currentResults);
      document.getElementById('status').textContent =
        'Found ' + currentResults.length + ' results';
    }

    function showAll() {
      document.getElementById('townInput').value = '';
      currentResults = allData;
      addMarkersToMap(currentResults);
      showResults(currentResults);
      document.getElementById('status').textContent =
        'Showing all ' + allData.length + ' locations';
    }

    function setupEventListeners() {
      document
        .getElementById('searchBtn')
        .addEventListener('click', doSearch);
      document
        .getElementById('clearBtn')
        .addEventListener('click', showAll);
      document
        .getElementById('townInput')
        .addEventListener('keypress', function (e) {
          if (e.key === 'Enter') doSearch();
        });
    }

    // fallback if Google Maps doesn’t load
    setTimeout(() => {
      if (typeof google === 'undefined') {
        document.getElementById('status').textContent =
          'Error: Google Maps failed to load. Please check your API key and internet connection.';
        document.getElementById('map').innerHTML =
          '<div style="padding: 50px; text-align: center; color: #666;">Google Maps could not be loaded. Please add your API key.</div>';
      }
    }, 5000);
  </script>
</body>
</html>

