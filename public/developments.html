<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gas Station Developments — Town Search (Fixed)</title>
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <!-- Leaflet marker cluster CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />
  <!-- Layout styles -->
  <style>
    :root {
      --bg: #0b0e15;
      --panel: #111725;
      --panel2: #0e1626;
      --text: #e8eefc;
      --muted: #9fb0cf;
      --accent: #5ec2ff;
      --line: #263145;
      --warn: #ffe08a;
    }
    html,
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      height: 100%;
    }
    .wrap {
      max-width: 1250px;
      margin: 20px auto;
      padding: 0 14px;
    }
    header {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 10px;
    }
    h1 {
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: 0.2px;
    }
    .spacer {
      flex: 1;
    }
    .btn {
      background: var(--accent);
      color: #00121e;
      border: 0;
      border-radius: 10px;
      padding: 0.6rem 1rem;
      font-weight: 700;
      cursor: pointer;
    }
    .btn.ghost {
      background: #0f2236;
      border: 1px solid var(--line);
      color: #bfe6ff;
    }
    .btn.small {
      padding: 0.45rem 0.75rem;
      font-weight: 600;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      margin: 12px 0;
    }
    label {
      display: block;
      margin: 0.25rem 0 0.35rem;
      color: var(--muted);
    }
    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 0.75rem;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #0f1421;
      color: var(--text);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.95rem;
    }
    th,
    td {
      border-bottom: 1px solid var(--line);
      text-align: left;
      padding: 0.6rem 0.5rem;
      vertical-align: top;
    }
    th {
      color: var(--muted);
      font-weight: 600;
    }
    #map {
      height: 400px;
      border: 1px solid var(--line);
      border-radius: 12px;
      margin-top: 12px;
    }
    .hint {
      color: var(--muted);
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Gas Station Developments — Town Search (≤ 20 miles)</h1>
    </header>
    <div class="card">
      <label for="q">Town (use “Town, ST”)</label>
      <input id="q" type="text" placeholder="e.g., Knightdale, NC" />
      <div style="margin-top: 8px; display: flex; gap: 12px; align-items: flex-end;">
        <div style="flex: 1;">
          <label for="miles">Miles radius</label>
          <input id="miles" type="number" min="1" max="50" value="20" />
        </div>
        <div style="display: flex; gap: 8px;">
          <button id="go" class="btn">Search</button>
          <button id="clear" class="btn ghost">Clear</button>
        </div>
      </div>
      <div class="hint">You’ll see results only if the town is on the list or within the miles radius from it.</div>
      <div id="results"></div>
      <button id="dlResults" class="btn small" style="margin-top: 8px;">Download results CSV</button>
    </div>
    <div id="map"></div>
  </div>
  <!-- Leaflet JS and marker cluster -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // Data array loaded from CSV
    let DATA = [];
    let CURRENT_RESULTS = [];
    // Helper to escape HTML
    function esc(s) {
      return (s ?? '').toString().replace(/[&<>]/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[m]));
    }
    // Haversine distance in miles
    function haversineMi(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const toRad = (d) => (d * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) *
          Math.cos(toRad(lat2)) *
          Math.sin(dLon / 2) ** 2;
      const d = 2 * R * Math.asin(Math.sqrt(a));
      return d / 1609.344;
    }
    // Load CSV dataset
    async function loadData() {
      try {
        const resp = await fetch('developments_data.csv', { cache: 'no-store' });
        if (!resp.ok) throw new Error(resp.status);
        const text = await resp.text();
        const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
        DATA = parsed.data.map((row) => {
          return {
            ...row,
            // normalize latitude/longitude fields if present
            lat: parseFloat(row.lat || row.latitude || row.y || row.centroid_y || '') || null,
            lon: parseFloat(row.lon || row.lng || row.longitude || row.x || row.centroid_x || '') || null,
          };
        });
        // Show basic dataset count in the results area
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = `<div class="hint">Dataset rows: <b>${DATA.length}</b></div>`;

        // Immediately render all markers on the map and list them in the table.  On the live
        // site there are occasionally issues with geocoding and searching; by
        // plotting everything up front users can see that the data loaded and the
        // map is working.  If you prefer not to show all rows initially you can
        // comment out the following two calls.
        try {
          renderResults(DATA);
          updateMap(DATA);
        } catch (e) {
          console.error('Error rendering initial data:', e);
        }
      } catch (e) {
        document.getElementById('results').innerHTML = `<div style="color: var(--warn)">Could not load <b>developments_data.csv</b>. Ensure it is placed next to this page.</div>`;
      }
    }
    // Initialize map
    const map = L.map('map').setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap',
    }).addTo(map);
    const markersLayer = L.layerGroup().addTo(map);
    function updateMap(rows) {
      markersLayer.clearLayers();
      if (!rows || !rows.length) return;
      const bounds = [];
      rows.forEach((r) => {
        if (Number.isFinite(r.lat) && Number.isFinite(r.lon)) {
          const marker = L.marker([r.lat, r.lon]).addTo(markersLayer);
          let popup = `<b>${esc(r.name || '')}</b>`;
          if (r.address) popup += `<br>${esc(r.address)}`;
          if (r.town || r.state) popup += `<br>${esc(r.town || '')}${r.town && r.state ? ', ' : ''}${esc(r.state || '')}`;
          if (r.developer) popup += `<br><i>${esc(r.developer)}</i>`;
          if (r.date) popup += `<br>${esc(r.date)}`;
          if (r.url) popup += `<br><a href="${esc(r.url)}" target="_blank" rel="noopener">source</a>`;
          marker.bindPopup(popup);
          bounds.push([r.lat, r.lon]);
        }
      });
      if (bounds.length) map.fitBounds(bounds, { padding: [30, 30] });
    }
    // ------------------------------------------------------------------------
    // Geocode cache and helper: resolve a town/state to lat/lon using Nominatim
    //
    // Many rows in the dataset do not include latitude/longitude.  To display
    // these results on the map we approximate their location by geocoding
    // the town and state.  Results are cached to avoid repeated API calls.
    const __geocodeCache = {};
    async function geocodeTownState(town, state) {
      if (!town) return null;
      const key = `${town}, ${state || ''}`.trim();
      if (__geocodeCache[key]) return __geocodeCache[key];
      try {
        const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&q=${encodeURIComponent(key)}`;
        const resp = await fetch(url, { headers: { Accept: 'application/json' } });
        const data = await resp.json();
        if (data && data.length) {
          const coords = { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
          __geocodeCache[key] = coords;
          return coords;
        }
      } catch (e) {
        // ignore geocoding errors
      }
      __geocodeCache[key] = null;
      return null;
    }

    // Search handler
    async function doSearch() {
      const townInput = document.getElementById('q').value.trim();
      const miles = Math.max(1, +document.getElementById('miles').value || 20);
      if (!townInput) {
        alert('Please enter a town (e.g., "Knightdale, NC").');
        return;
      }
      // Geocode the search town (centre point)
      let centerLat, centerLon;
      try {
        const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&q=${encodeURIComponent(townInput)}`;
        const resp = await fetch(url, { headers: { Accept: 'application/json' } });
        const data = await resp.json();
        if (!data.length) throw new Error('No match');
        centerLat = parseFloat(data[0].lat);
        centerLon = parseFloat(data[0].lon);
      } catch (e) {
        alert('Could not geocode that town. Try a different query.');
        return;
      }
      // For each row, compute distance using either its own coords or a geocoded town
      const results = [];
      for (const row of DATA) {
        let rowLat = Number.isFinite(row.lat) ? row.lat : null;
        let rowLon = Number.isFinite(row.lon) ? row.lon : null;
        // If lat/lon not provided, geocode the town/state
        if (rowLat === null || rowLon === null) {
          if (row.town) {
            const coords = await geocodeTownState(row.town, row.state);
            if (coords) {
              rowLat = coords.lat;
              rowLon = coords.lon;
            }
          }
        }
        if (rowLat !== null && rowLon !== null) {
          const dMi = haversineMi(centerLat, centerLon, rowLat, rowLon);
          if (dMi <= miles) {
            results.push({ ...row, lat: rowLat, lon: rowLon, dist: dMi });
          }
        } else {
          // As a last fallback, include rows with matching town even without coords
          if (row.town && row.town.toLowerCase() === townInput.split(',')[0].trim().toLowerCase()) {
            results.push({ ...row, dist: null });
          }
        }
      }
      // Sort results by distance (null distances at end)
      results.sort((a, b) => {
        if (a.dist === null && b.dist === null) return 0;
        if (a.dist === null) return 1;
        if (b.dist === null) return -1;
        return a.dist - b.dist;
      });
      CURRENT_RESULTS = results;
      renderResults(results);
      updateMap(results);
    }
    function renderResults(rows) {
      if (!rows || !rows.length) {
        document.getElementById('results').innerHTML = '<div class="hint">No results.</div>';
        return;
      }
      let html = '<table><thead><tr><th>#</th><th>Town</th><th>State</th><th>Name</th><th>Developer</th><th>Date</th><th>Notes</th><th>Dist (mi)</th></tr></thead><tbody>';
      rows.forEach((r, i) => {
        html += `<tr><td>${i + 1}</td><td>${esc(r.town || '')}</td><td>${esc(
          r.state || ''
        )}</td><td>${esc(r.name || '')}</td><td>${esc(r.developer || '')}</td><td>${esc(
          r.date || ''
        )}</td><td>${esc(r.notes || '')}</td><td>${r.dist === null ? '' : r.dist.toFixed(2)}</td></tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('results').innerHTML = html;
    }
    // Download CSV of current results
    function downloadResults() {
      if (!CURRENT_RESULTS || !CURRENT_RESULTS.length) {
        alert('No results to export. Run a search first.');
        return;
      }
      const cols = Object.keys(CURRENT_RESULTS[0]);
      const quote = (v) => '"' + String(v ?? '').replace(/"/g, '""') + '"';
      let csv = cols.map(quote).join(',') + '\n';
      CURRENT_RESULTS.forEach((row) => {
        csv += cols.map((c) => quote(row[c])).join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'developments_results.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    // Event listeners
    document.getElementById('go').addEventListener('click', doSearch);
    document.getElementById('clear').addEventListener('click', () => {
      document.getElementById('q').value = '';
      document.getElementById('results').innerHTML = `<div class="hint">Dataset rows: <b>${DATA.length}</b></div>`;
      map.setView([37.8, -96], 4);
      markersLayer.clearLayers();
    });
    document.getElementById('dlResults').addEventListener('click', downloadResults);
    // Load data on startup
    loadData();
  </script>
</body>
</html>