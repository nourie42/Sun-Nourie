<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fuel Volume Estimator â€¢ Sunoco LP</title>

<!-- Leaflet + helpers -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-image@latest/leaflet-image.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- âœ… Load Google Maps SDK (defines window.google) -->
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_API_KEY_HERE&libraries=places" async defer></script>

<style>
  :root{--bg:#0f172a;--panel:#0b1224;--border:#1f2937;--muted:#94a3b8;--text:#e5e7eb;--accent:#60a5fa;--good:#22c55e}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:linear-gradient(180deg,#0b1224,#081020);border-bottom:1px solid var(--border)}
  header img{height:32px;width:auto}
  .container{max-width:1000px;margin:auto;padding:16px}
  h1{margin:0 0 12px;font-size:20px}
  label{margin-top:12px;display:block;font-size:14px;color:#cbd5e1}
  input,button{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-size:16px}
  button{background:var(--accent);color:#0b1224;font-weight:800;cursor:pointer}
  button[disabled]{opacity:.6;cursor:not-allowed}
  #status{margin-top:12px;font:13px/1.45 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#1e293b;border:1px solid var(--border);border-radius:8px;padding:10px;height:160px;overflow:auto;white-space:pre-line}
  #result{margin-top:14px;font-size:20px;font-weight:900;color:var(--good)}
  #summary,#reviewsBox,#competitors,#developments{margin-top:10px;font-size:14px}
  #map{height:62vh;margin-top:16px;border:1px solid var(--border);border-radius:12px}
  .pin{display:flex;align-items:center;justify-content:center;border-radius:999px;border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.45);font-weight:900;line-height:1}
  .pin.big{width:30px;height:30px;font-size:16px}
  .pin.med{width:22px;height:22px;font-size:13px}
  .small{font-size:12px;color:#94a3b8;margin-top:6px}
</style>
</head>
<body>
<header>
  <img src="sunoco-logo.svg" alt="Sunoco LP" onerror="this.style.display='none'">
  <div>Fuel Volume Estimator</div>
</header>

<div class="container">
  <h1>Monthly Volume Estimate</h1>

  <label>Address</label>
  <input id="address" placeholder="4173 Knightdale Blvd, Knightdale, NC" />

  <label>MPDs</label>
  <input id="mpds" type="number" min="1" value="6" />

  <label>AADT override (optional)</label>
  <input id="aadtOverride" type="number" min="1" placeholder="Enter DOT AADT manually if known" />

  <button id="estimate">Calculate Estimate</button>

  <div id="status" aria-live="polite">Waitingâ€¦</div>
  <div id="result"></div>
  <div id="summary"></div>
  <div id="reviewsBox"></div>
  <div id="competitors"></div>
  <div id="developments"></div>

  <button id="export" style="display:none">ðŸ“„ Export to PDF</button>

  <div class="small">
    Manual AADT viewers: 
    â€¢ NC: <a id="ncLink" href="#" target="_blank" rel="noopener">NCDOT AADT</a> 
    â€¢ USA: <a id="usaLink" href="#" target="_blank" rel="noopener">Esri USA Traffic Counts</a>
  </div>
</div>

<div id="map" role="region" aria-label="Map"></div>

<script>
/* ================== Config ================== */
const CAPTURE_RATE=0.02, GALLONS_PER_STOP=9.2, DAYS_PER_MONTH=30.4;
const MONTHLY_PER_MPD_CAP=8500;     // conservative cap per MPD per month
const ONE_MILE = 1.0;               // competitors cutoff (driving)
const DEV_SEARCH_MI = 5;            // developments cutoff (driving)
const GOOGLE_KEY = "YOUR_GOOGLE_API_KEY_HERE"; // <--- replace once (matches SDK tag)

/* ================== Utilities ================== */
const fmt=n=>Number.isFinite(n)?Math.round(n).toLocaleString():"â€“";
const rad=d=>d*Math.PI/180;
function hav(a,b){const R=3958.8,dLat=rad(b.lat-a.lat),dLng=rad(b.lng-a.lng);
  const s=Math.sin(dLat/2)**2+Math.cos(rad(a.lat))*Math.cos(rad(b.lat))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));}
function logger(el){ el.textContent=""; return (m,ok=false)=>{ el.textContent+=(ok?"âœ… ":"â³ ")+m+"\n"; el.scrollTop=el.scrollHeight; }; }

/* ================== Map (Carto tiles are CORS-friendly for PDF) ================== */
const map = L.map('map').setView([35.7796,-78.6382], 12);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'&copy; OSM & CARTO',subdomains:'abcd',maxZoom:20,crossOrigin:true}).addTo(map);
let siteMarker=null, compLayer=null, devLayer=null;

/* ================== OSRM Driving Distance ================== */
async function driveMiles(a,b){
  try{
    const url=`https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=false&alternatives=false`;
    const r=await fetch(url); const j=await r.json();
    const m=j?.routes?.[0]?.distance; return m? m/1609.344 : hav(a,b);
  }catch(e){ return hav(a,b); }
}
async function osrmTableMiles(origin, pts){
  try{
    const coords=[[origin.lng,origin.lat],...pts.map(p=>[p.lng,p.lat])].map(a=>a.join(",")).join(";");
    const url=`https://router.project-osrm.org/table/v1/driving/${coords}?sources=0&annotations=distance`;
    const r=await fetch(url); const j=await r.json();
    const d=j?.distances?.[0]; if(Array.isArray(d)&&d.length===pts.length+1) return d.slice(1).map(m=>m/1609.344);
  }catch(e){}
  // fallback: sequential routes
  const out=[]; for(const p of pts){ out.push(await driveMiles(origin,p)); } return out;
}

/* ================== Overpass (with fallbacks) ================== */
const OVERPASS = [
  "https://overpass-api.de/api/interpreter",
  "https://overpass.kumi.systems/api/interpreter",
  "https://overpass.openstreetmap.ru/api/interpreter"
];
async function overpassQuery(q){
  for(const ep of OVERPASS){
    try{
      const r=await fetch(ep,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:"data="+encodeURIComponent(q)});
      if(r.ok) return await r.json();
    }catch(e){}
  }
  throw new Error("Overpass unavailable");
}

/* ================== AADT (ArcGIS) ================== */
async function queryArcGISAADT(url, lat, lng, distM){
  const p={where:"1=1",geometry:`${lng},${lat}`,geometryType:"esriGeometryPoint",inSR:"4326",
    spatialRel:"esriSpatialRelIntersects",distance:String(distM),units:"esriSRUnit_Meter",outFields:"*",outSR:"4326",f:"json"};
  const r=await fetch(url+"?"+new URLSearchParams(p)); if(!r.ok) return null; const j=await r.json();
  if(!j.features?.length) return null;
  let best=null,bestD=1e9; for(const f of j.features){const d=hav({lat,lng},{lat:f.geometry.y,lng:f.geometry.x}); if(d<bestD){bestD=d;best=f;}}
  const a=best.attributes||{}; const val=[a.AADT,a.aadt,a.Avg_Daily_Traffic,a.TrafficCount,a.AADT_2022,a.AADT_2021,a.AADT_2020,a.AADT_2019].find(v=>typeof v==="number"&&v>0)||null;
  if(!val) return null;
  const link=url+"?"+new URLSearchParams({...p,f:"html"});
  return {value:val, link};
}
const NC_AADT  ="https://services.arcgis.com/NuWFvHYDMVmmxMeM/ArcGIS/rest/services/NCDOT_AADT_Stations/FeatureServer/0/query";
const USA_AADT ="https://services.arcgis.com/P3ePLMYs2RVChkJx/ArcGIS/rest/services/USA_Traffic_Counts/FeatureServer/0/query";
async function robustAADT(lat,lng,isNC){
  if(isNC){ for(const d of [500,1000,2000,3000,5000,10000,15000]){ const hit=await queryArcGISAADT(NC_AADT,lat,lng,d); if(hit) return {source:"NCDOT",...hit}; } }
  for(const d of [500,1000,2000,3000,5000,10000,15000]){ const hit=await queryArcGISAADT(USA_AADT,lat,lng,d); if(hit) return {source:"Esri USA Traffic Counts",...hit}; }
  return null;
}

/* ================== Heuristic AADT (if no ArcGIS record) ================== */
async function heuristicAADT(lat,lng){
  const q=`[out:json][timeout:25];way(around:900,${lat},${lng})["highway"];out tags center;`;
  const j=await overpassQuery(q);
  const ways=(j.elements||[]).map(w=>{const c=w.center; if(!c) return null;
    const hw=(w.tags?.highway||"").toLowerCase(); const lanes=parseInt(w.tags?.lanes);
    const ms=(w.tags?.maxspeed||"").toString(); let mph=null;
    if(/\b\d+\s*mph\b/i.test(ms)) mph=parseInt(ms); else if(/\b\d+\b/.test(ms)){const n=parseInt(ms); mph=n>70?Math.round(n*0.621):n;}
    return {id:w.id,lat:c.lat,lng:c.lon,highway:hw,lanes:isFinite(lanes)?lanes:null,mph};}).filter(Boolean);
  if(!ways.length) return {value:15000,source:"Heuristic (no roads found)",link:`https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=16/${lat}/${lng}`};
  const BASE={motorway:65000,trunk:45000,primary:25000,secondary:14000,tertiary:8000,primary_link:20000,secondary_link:12000,tertiary_link:7000,residential:2500,unclassified:3000,service:1200,living_street:800};
  function base(hw){return BASE[hw]??5000} function laneF(l){if(!l)return 1; return Math.max(0.6,Math.min(2,l/2))} function speedF(m){if(!m)return 1; if(m>=55)return 1.15; if(m>=45)return 1.08; if(m<=25)return .9;return 1}
  ways.forEach(w=>w.dist=hav({lat,lng},{lat:w.lat,lng:w.lng})); ways.sort((a,b)=>a.dist-b.dist);
  const top=ways.slice(0,3); let num=0,den=0; const linkWay=top[0]?.id;
  top.forEach(w=>{const est=base(w.highway)*laneF(w.lanes)*speedF(w.mph); const wt=1/(w.dist+0.05); num+=est*wt; den+=wt;});
  const val=Math.round(num/Math.max(den,1)); return {value:val,source:"Heuristic (OSM road class/lanes/speed)",link:`https://www.openstreetmap.org/way/${linkWay}`};
}

/* ================== Competitors (driving â‰¤ 1.0 mi) ================== */
async function fetchCompetitorsDriving1mi(lat,lng){
  // query 10km wide so we don't miss anything; then OSRM-table to cut to â‰¤ 1 mi drive
  const q=`[out:json][timeout:25];
    (node["amenity"="fuel"](around:10000,${lat},${lng});
     way["amenity"="fuel"](around:10000,${lat},${lng});
     relation["amenity"="fuel"](around:10000,${lat},${lng}););
    out center tags;`;
  const j=await overpassQuery(q);
  const cand=(j.elements||[]).map(e=>{const c=e.type==='node'?{lat:e.lat,lng:e.lon}:(e.center||null); if(!c) return null;
    return {lat:c.lat,lng:c.lon,name:(e.tags?.brand||e.tags?.name||"Fuel station")};}).filter(Boolean);
  if(!cand.length) return [];
  const dists=await osrmTableMiles({lat,lng},cand);
  const within=cand.map((r,i)=>({...r,drive:dists[i]})).filter(r=>Number.isFinite(r.drive)&&r.drive<=ONE_MILE).sort((a,b)=>a.drive-b.drive);
  return within;
}

/* ================== Developments (universal) ================== */
/* 1) City/County ArcGIS Online search for FeatureServers that might contain development/permit/project layers
   2) Try querying first few layers around the point for fuel/gas/convenience keywords
   3) If nothing, fallback to OSM proposed/construction */
async function arcgisSearchItems(query){
  const url=`https://www.arcgis.com/sharing/rest/search?f=json&q=${encodeURIComponent(query)}&num=10`;
  const r=await fetch(url); if(!r.ok) return []; const j=await r.json(); return j.results||[];
}
async function tryFeatureServerAround(url,lat,lng){
  // try layer indices 0..4 (common); filter rows by keywords
  const idxToTry=[];
  const m=url.match(/\/(FeatureServer|MapServer)(\/\d+)?$/i);
  if(m && m[2]) idxToTry.push(parseInt(m[2].slice(1),10)); else idxToTry.push(0,1,2,3,4);
  const out=[];
  for(const idx of idxToTry){
    const endpoint=url.replace(/\/(FeatureServer|MapServer)(\/\d+)?$/i,`/$1/${idx}/query`);
    const p={where:"1=1",geometry:`${lng},${lat}`,geometryType:"esriGeometryPoint",inSR:"4326",
      spatialRel:"esriSpatialRelIntersects",distance:"20000",units:"esriSRUnit_Meter",
      outFields:"*",outSR:"4326",f:"json"};
    try{
      const r=await fetch(endpoint+"?"+new URLSearchParams(p)); if(!r.ok) continue; const j=await r.json();
      for(const f of (j.features||[])){
        const a=f.attributes||{}; const blob=[a.ProjectName,a.PROJECTNAME,a.Name,a.TITLE,a.Description,a.DESCRIPTION,a.Type,a.TYPE,a.category,a.CATEGORY].map(x=>String(x||"")).join(" ").toLowerCase();
        if(/\b(gas|fuel|convenience|c[-\s]?store|station|mart)\b/.test(blob)){
          out.push({lat:f.geometry?.y,lng:f.geometry?.x,name:a.ProjectName||a.PROJECTNAME||a.Name||a.TITLE||"Fuel-related development",stage:a.Status||a.STATUS||a.Type||a.TYPE||"proposed"});
        }
      }
    }catch(e){}
  }
  return out.filter(x=>x.lat&&x.lng);
}
async function findDevelopmentsUniversal(city,state,lat,lng){
  const queries=[
    `${city} development FeatureServer`,
    `${city} permits FeatureServer`,
    `${city} planning projects FeatureServer`,
    `${state} county permits FeatureServer ${city}`
  ];
  for(const q of queries){
    const items=await arcgisSearchItems(q);
    for(const it of items){
      if(!it.url || !/FeatureServer|MapServer/i.test(it.url)) continue;
      const hits=await tryFeatureServerAround(it.url,lat,lng);
      if(hits.length){
        // compute driving distance and keep â‰¤ DEV_SEARCH_MI
        const dists=await osrmTableMiles({lat,lng},hits);
        return hits.map((h,i)=>({...h,drive:dists[i]})).filter(h=>h.drive<=DEV_SEARCH_MI).sort((a,b)=>a.drive-b.drive);
      }
    }
  }
  // Fallback to OSM proposed/construction
  const q = `[out:json][timeout:25];
    (node["amenity"="fuel"]["proposed"](around:10000,${lat},${lng});
     way["amenity"="fuel"]["proposed"](around:10000,${lat},${lng});
     relation["amenity"="fuel"]["proposed"](around:10000,${lat},${lng});
     node["amenity"="fuel"]["construction"](around:10000,${lat},${lng});
     way["amenity"="fuel"]["construction"](around:10000,${lat},${lng});
     relation["amenity"="fuel"]["construction"](around:10000,${lat},${lng}););
    out center tags;`;
  const j=await overpassQuery(q);
  const rows=(j.elements||[]).map(e=>{
    const c=e.type==='node'?{lat:e.lat,lng:e.lon}:(e.center||null); if(!c) return null;
    const name=e.tags?.brand||e.tags?.name||"New fuel development";
    const stage=e.tags?.proposed?"proposed":(e.tags?.construction?"construction":"planned");
    return {lat:c.lat,lng:c.lon,name,stage};
  }).filter(Boolean);
  if(!rows.length) return [];
  const dists=await osrmTableMiles({lat,lng},rows);
  return rows.map((r,i)=>({...r,drive:dists[i]})).filter(r=>r.drive<=DEV_SEARCH_MI).sort((a,b)=>a.drive-b.drive);
}

/* ================== Google Reviews & Street View ================== */
function streetViewURL(lat,lng){ return `https://maps.googleapis.com/maps/api/streetview?size=640x360&location=${lat},${lng}&key=${GOOGLE_KEY}`; }
async function fetchPlaceDetails(lat,lng){
  // wait for SDK
  await new Promise(resolve=>{
    if(window.google?.maps?.places) return resolve();
    const iv=setInterval(()=>{ if(window.google?.maps?.places){clearInterval(iv); resolve();} },300);
    setTimeout(()=>{clearInterval(iv); resolve();},6000);
  });
  if(!window.google?.maps?.places) return null;
  return new Promise(res=>{
    const svc=new google.maps.places.PlacesService(document.createElement('div'));
    svc.nearbySearch({location:{lat,lng},radius:150,type:['gas_station','convenience_store']},(rs,st)=>{
      if(st!=='OK'||!rs?.length) return res(null);
      const best=rs.sort((a,b)=>(b.user_ratings_total||0)-(a.user_ratings_total||0))[0];
      svc.getDetails({placeId:best.place_id,fields:['name','rating','user_ratings_total','reviews']},(place,st2)=>res(st2==='OK'?place:null));
    });
  });
}

/* ================== Main Click ================== */
document.getElementById('estimate').onclick=async()=>{
  const status=document.getElementById('status'); const log=logger(status);
  const result=document.getElementById('result'); const summary=document.getElementById('summary');
  const reviewsBox=document.getElementById('reviewsBox'); const compsDiv=document.getElementById('competitors'); const devDiv=document.getElementById('developments');
  const exportBtn=document.getElementById('export'); const addrEl=document.getElementById('address');
  const ncLink=document.getElementById('ncLink'); const usaLink=document.getElementById('usaLink');

  // reset
  result.textContent=""; summary.textContent=""; reviewsBox.innerHTML=""; compsDiv.textContent=""; devDiv.textContent="";
  exportBtn.style.display="none"; if(compLayer){map.removeLayer(compLayer);compLayer=null;} if(devLayer){map.removeLayer(devLayer);devLayer=null;} if(siteMarker){map.removeLayer(siteMarker);siteMarker=null;}

  try{
    const addr=addrEl.value.trim(); if(!addr) throw new Error("Please enter an address.");
    const mpds=Math.max(1,parseInt(document.getElementById('mpds').value)||1);
    const aadtOverride=parseInt(document.getElementById('aadtOverride').value)||null;

    // Geocode
    log("Geocoding addressâ€¦");
    const g=await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=1&q=${encodeURIComponent(addr)}`);
    const gj=await g.json(); if(!gj.length) throw new Error("Address not found.");
    const lat=+gj[0].lat,lng=+gj[0].lon; const state=gj[0].address?.state||""; const city=gj[0].address?.city||gj[0].address?.town||gj[0].address?.village||"";
    log(`Found (${lat.toFixed(4)}, ${lng.toFixed(4)}) in ${city||"â€”"}, ${state||"â€”"}`,true);
    siteMarker=L.marker([lat,lng]).addTo(map).bindPopup("Site").openPopup(); map.setView([lat,lng],14);

    // AADT manual viewer links
    ncLink.href=`https://ncdot.maps.arcgis.com/apps/webappviewer/index.html?id=ae42f4ac534a46458c9cf60a98d2bc1d&find=${lat},${lng}`;
    usaLink.href=`https://www.arcgis.com/apps/mapviewer/index.html?url=${encodeURIComponent("https://services.arcgis.com/P3ePLMYs2RVChkJx/ArcGIS/rest/services/USA_Traffic_Counts/FeatureServer/0")}&center=${lng},${lat}&level=15`;

    // AADT: override â†’ ArcGIS â†’ heuristic (never silently default)
    let aadt=null,aadtSource="",aadtLink="";
    if(aadtOverride){ aadt=aadtOverride; aadtSource="User override"; log(`Using override AADT ${aadt}`,true); }
    else{
      log("Finding AADT (DOT/ArcGIS)â€¦");
      const isNC=/north carolina/i.test(state)||/\bNC\b/.test(state);
      const hit=await robustAADT(lat,lng,isNC);
      if(hit){ aadt=hit.value; aadtSource=hit.source; aadtLink=hit.link; log(`AADT ${aadt} (${aadtSource})`,true); }
      else{
        log("No ArcGIS record found. Estimating AADT from OSM road class/lanes/speedâ€¦");
        const h=await heuristicAADT(lat,lng); aadt=h.value; aadtSource=h.source; aadtLink=h.link; log(`Heuristic AADT ${aadt}`,true);
      }
    }

    // Competitors â‰¤ 1.0 mile driving
    log("Fetching competitors by driving distance (â‰¤ 1.0 mi)â€¦");
    const comps=await fetchCompetitorsDriving1mi(lat,lng);
    if(comps.length) log(`Using ${comps.length} competitors.`,true); else log("No competitors within 1 mile drive.",true);
    if(compLayer) map.removeLayer(compLayer);
    compLayer=L.layerGroup(comps.map(c=>{
      const big=/\b(costco|sam'?s|bj'?s|buc-?ee?s|wawa|sheetz|quik\s?trip|^qt\b|racetrac|pilot|flying\s?j|love'?s|ta|petro)\b/i.test(c.name||"");
      const star=big?"â˜…":""; const size=big?"big":"med"; const color=big?"#f59e0b":"#60a5fa";
      const icon=L.divIcon({className:"div-pin",html:`<div class="pin ${size}" style="background:${color}">${star}</div>`,iconSize:null,iconAnchor:[15,15]});
      return L.marker([c.lat,c.lng],{icon}).bindPopup(`${c.name}<br>${c.drive.toFixed(1)} mi drive`);
    })).addTo(map);
    // Competitor list
    compsDiv.innerHTML = comps.length
      ? ("<b>Competitors considered (â‰¤ 1.0 mi drive):</b><ul>"+comps.slice(0,12).map(c=>`<li>${c.name} â€” ${c.drive.toFixed(1)} mi</li>`).join("")+"</ul>")
      : "No stations within 1.0 mile drive.";

    // Developments (universal city/county ArcGIS search â†’ OSM fallback). Always report result + manual links.
    log(`Searching developments for ${city||"this town"} (city/county ArcGIS â†’ OSM)â€¦`);
    const devs=await findDevelopmentsUniversal(city,state,lat,lng);
    if(devLayer) map.removeLayer(devLayer);
    if(devs.length){
      log(`Found ${devs.length} development(s) â‰¤ ${DEV_SEARCH_MI} mi drive.`,true);
      devLayer=L.layerGroup(devs.map(d=>{
        const icon=L.divIcon({className:"div-pin",html:`<div class="pin med" style="background:#a78bfa"></div>`,iconSize:null,iconAnchor:[11,11]});
        return L.marker([d.lat,d.lng],{icon}).bindPopup(`${d.name} â€” ${d.stage}<br>${d.drive.toFixed(1)} mi drive`);
      })).addTo(map);
      devDiv.innerHTML="<b>New developments nearby:</b><ul>"+devs.slice(0,12).map(d=>`<li>${d.name} â€” ${d.stage} â€” ${d.drive.toFixed(1)} mi</li>`).join("")+"</ul>";
    }else{
      log("No developments found via city/county ArcGIS or OSM.",true);
      const cityQ=encodeURIComponent(`${city} development permits`);
      devDiv.innerHTML = `No developments found. <b>Please use the link to search this town's database:</b> `+
        `<a target="_blank" rel="noopener" href="https://www.arcgis.com/sharing/rest/search?q=${cityQ}">ArcGIS search for ${city}</a>`;
    }

    // Google Reviews + Street View (built-in mechanism + clear fallback)
    reviewsBox.innerHTML = ""; 
    const sv = `<img alt="Street View" style="max-width:100%;border:1px solid #444;border-radius:8px" src="https://maps.googleapis.com/maps/api/streetview?size=640x360&location=${lat},${lng}&key=${GOOGLE_KEY}" />`;
    let reviewHTML = "";
    const place = await fetchPlaceDetails(lat,lng);
    if(place){
      const revs=(place.reviews||[]).slice(0,4).map(r=>`<p><b>${r.author_name||"Reviewer"}</b> â€“ ${"â˜…".repeat(Math.round(r.rating||0))}<br>${(r.text||"").slice(0,240)}${(r.text||"").length>240?"â€¦":""}</p>`).join("");
      reviewHTML = `<div><b>${place.name}</b> â€” â˜…${place.rating||"â€“"} (${place.user_ratings_total||0})</div>${revs || "<i>No review text available.</i>"}`;
    }else{
      reviewHTML = `No reviews found automatically. `+
        `<a target="_blank" rel="noopener" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}">Search Google Maps manually</a>`;
    }
    reviewsBox.innerHTML = sv + "<div style='margin-top:8px'>" + reviewHTML + "</div>";

    // Estimate (conservative capacity)
    const demand=aadt*CAPTURE_RATE*GALLONS_PER_STOP*DAYS_PER_MONTH;
    const capacity=mpds*MONTHLY_PER_MPD_CAP;
    const est=Math.min(demand,capacity);
    result.textContent=`Estimated Monthly Gallons: ${fmt(est)}`;
    summary.innerHTML = `AADT <b>${fmt(aadt)}</b> (${aadtSourceText(aadtOverride,aadtLink)}) Â· MPDs ${mpds} Â· Competitors â‰¤1.0 mi: ${comps.length} Â· Developments: ${devs.length}`;

    // Export to PDF (real map snapshot)
    const exportBtnEl=document.getElementById('export'); exportBtnEl.style.display="block";
    exportBtnEl.onclick=()=>{
      const {jsPDF}=window.jspdf;
      leafletImage(map,(err,canvas)=>{
        const doc=new jsPDF({unit:"pt",format:"a4"});
        doc.setFontSize(14); doc.text("Fuel Volume Estimate",40,40);
        doc.setFontSize(11);
        doc.text(`Address: ${addr}`,40,60);
        doc.text(`MPDs: ${mpds}`,40,76);
        doc.text(`AADT: ${fmt(aadt)}`,40,92);
        if(aadtLink) doc.textWithLink("Open AADT source",40,108,{url:aadtLink});
        doc.text(`Estimate: ${fmt(est)} gal/mo`,40,130);
        doc.addImage(canvas.toDataURL("image/png"),"PNG",40,150,515,300);
        doc.save("fuel_estimate.pdf");
      });
    };

    log("âš¡ Estimate complete!",true);
    status.textContent += "\nâ“ Do you want me to run another search?\n";

    function aadtSourceText(override,link){
      if(override) return "User override";
      return link ? "DOT/ArcGIS" : "Heuristic (verify)";
    }

  }catch(e){
    status.textContent += "âŒ " + (e.message||e) + "\n";
  }
};

// Run on Enter
document.getElementById('address').addEventListener('keydown',e=>{ if(e.key==="Enter") document.getElementById('estimate').click(); });
</script>
</body>
</html>

};
</script>
</body>
</html>
