<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fuel Volume Estimator ‚Ä¢ Sunoco LP</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-image@latest/leaflet-image.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --bg:#0f172a; --panel:#0b1224; --border:#1f2937; --muted:#94a3b8; --text:#e5e7eb; --accent:#60a5fa; --good:#22c55e; --purple:#a78bfa;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--text);}
  header{position:sticky; top:0; z-index:10; display:flex; justify-content:space-between; align-items:center; padding:10px 14px; background:linear-gradient(180deg,#0b1224,#081020); border-bottom:1px solid var(--border);}
  header img{height:32px; width:auto;}
  .container{max-width:900px; margin:auto; padding:16px;}
  h1{margin:0 0 12px; font-size:20px;}
  label{margin-top:12px; display:block; font-size:14px; color:#cbd5e1;}
  input,button{width:100%; padding:12px 14px; border-radius:10px; border:1px solid var(--border); background:var(--panel); color:var(--text); font-size:16px;}
  button{background:var(--accent); color:#0b1224; font-weight:800; cursor:pointer;}
  #status{margin-top:12px; font:13px/1.45 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; background:#1e293b; border:1px solid var(--border); border-radius:8px; padding:10px; height:150px; overflow:auto; white-space:pre-line;}
  #result{margin-top:14px; font-size:20px; font-weight:900; color:var(--good);}
  #summary{margin-top:10px; font-size:14px;}
  #competitors, #developments{margin-top:10px; font-size:14px;}
  #map{height:62vh; margin-top:16px; border:1px solid var(--border); border-radius:12px;}
  .small{font-size:12px; color:#94a3b8; margin-top:6px;}
  /* pins */
  .pin{display:flex; align-items:center; justify-content:center; border-radius:999px; border:2px solid #fff; box-shadow:0 2px 8px rgba(0,0,0,.45); font-weight:900; line-height:1}
  .pin.big{width:30px; height:30px; font-size:16px;}
  .pin.med{width:22px; height:22px; font-size:13px;}
  .pin.small{width:18px; height:18px; font-size:12px;}
</style>
</head>
<body>
<header>
  <img src="sunoco-logo.svg" alt="Sunoco LP logo" onerror="this.style.display='none'">
  <div>Fuel Volume Estimator</div>
</header>

<div class="container">
  <h1>Monthly Volume Estimate</h1>

  <label>Address</label>
  <input id="address" placeholder="4173 Knightdale Blvd, Knightdale, NC" />

  <label>MPDs</label>
  <input id="mpds" type="number" min="1" value="6" />

  <label>AADT override (optional)</label>
  <input id="aadtOverride" type="number" min="1" placeholder="Enter DOT AADT manually if known" />

  <label>Google API key (optional ‚Äî Street View & reviews)</label>
  <input id="gkey" placeholder="Paste restricted key (Places + Street View Static)" />

  <button id="estimate">Calculate Estimate</button>

  <div id="status" aria-live="polite"></div>
  <div id="result"></div>
  <div id="summary"></div>
  <div id="competitors"></div>
  <div id="developments"></div>

  <button id="export" style="display:none">üìÑ Export to PDF</button>

  <div class="small">
    AADT viewers for manual verification:<br>
    ‚Ä¢ NC: <a href="https://ncdot.maps.arcgis.com/apps/webappviewer/index.html?id=ae42f4ac534a46458c9cf60a98d2bc1d" target="_blank" rel="noopener">NCDOT AADT Map</a> ¬∑
    ‚Ä¢ USA: <a href="https://livingatlas.arcgis.com/trafficcounts/" target="_blank" rel="noopener">Esri USA Traffic Counts</a>
  </div>
</div>

<div id="map" role="region" aria-label="Map"></div>

<script>
/* ================== Constants / conservative capacity ================== */
const CAPTURE_RATE=0.02, GALLONS_PER_STOP=9.2, DAYS_PER_MONTH=30.4;
const MONTHLY_PER_MPD_CAP = 8500;          // conservative cap per MPD per month
const ONE_MILE = 1.0;                       // competitor drive cutoff
const DEV_SEARCH_MI = 5;                    // search radius for developments (drive)

/* ================== Helpers ================== */
const fmt = n => Number.isFinite(n) ? Math.round(n).toLocaleString() : "‚Äì";
const rad = d => d*Math.PI/180;
function hav(a,b){const R=3958.8, dLat=rad(b.lat-a.lat), dLng=rad(b.lng-a.lng);
  const s=Math.sin(dLat/2)**2 + Math.cos(rad(a.lat))*Math.cos(rad(b.lat))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));}

/* ================== Leaflet Map (CORS-friendly tiles for PDF) ================== */
const cartoAttr = '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>';
const map = L.map('map').setView([35.7796,-78.6382], 12);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: cartoAttr, subdomains: 'abcd', maxZoom: 20, crossOrigin: true
}).addTo(map);

let siteMarker=null, compLayer=null, devLayer=null;

/* ================== Logger ================== */
function logger(el){ el.textContent=""; return (msg, ok=false)=>{ el.textContent += (ok?"‚úÖ ":"‚è≥ ")+msg+"\\n"; el.scrollTop=el.scrollHeight; }; }

/* ================== Overpass (with multiple fallbacks) ================== */
const OVERPASS = [
  "https://overpass-api.de/api/interpreter",
  "https://overpass.kumi.systems/api/interpreter",
  "https://overpass.openstreetmap.ru/api/interpreter"
];
async function overpassQuery(q){
  for(const ep of OVERPASS){
    try{
      const r=await fetch(ep,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:"data="+encodeURIComponent(q)});
      if(r.ok){ return await r.json(); }
    }catch(e){}
  }
  throw new Error("Overpass servers unavailable");
}

/* ================== OSRM driving distance ================== */
async function driveMiles(a,b){
  try{
    const url = `https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=false&alternatives=false`;
    const r = await fetch(url); const j = await r.json();
    const m = j?.routes?.[0]?.distance; // meters
    return m ? (m/1609.344) : hav(a,b);
  }catch(e){ return hav(a,b); }
}

/* ================== ArcGIS AADT queries ================== */
async function queryArcGISAADT(url, lat, lng, distanceMeters){
  const params = {
    where:"1=1", geometry:`${lng},${lat}`, geometryType:"esriGeometryPoint", inSR:"4326",
    spatialRel:"esriSpatialRelIntersects", distance:String(distanceMeters), units:"esriSRUnit_Meter",
    outFields:"*", outSR:"4326", f:"json"
  };
  const res = await fetch(url + "?" + new URLSearchParams(params));
  if(!res.ok) return null;
  const j = await res.json();
  if(!j.features?.length) return null;
  // pick nearest feature
  let best=null, bestD=1e9;
  for(const f of j.features){
    const p={lat:f.geometry.y, lng:f.geometry.x};
    const d=hav({lat,lng},{lat:p.lat,lng:p.lng});
    if(d<bestD){bestD=d; best=f;}
  }
  const a = best.attributes || {};
  const val = [a.AADT, a.aadt, a.Avg_Daily_Traffic, a.TrafficCount, a.AADT_2022, a.AADT_2021, a.AADT_2020, a.AADT_2019]
              .find(v=>typeof v==="number" && v>0) || null;
  if(!val) return null;
  const htmlLink = url + "?" + new URLSearchParams({...params, f:"html"});
  return {value:val, link:htmlLink};
}

const NC_AADT  = "https://services.arcgis.com/NuWFvHYDMVmmxMeM/ArcGIS/rest/services/NCDOT_AADT_Stations/FeatureServer/0/query";
const USA_AADT = "https://services.arcgis.com/P3ePLMYs2RVChkJx/ArcGIS/rest/services/USA_Traffic_Counts/FeatureServer/0/query";

async function robustAADT(lat,lng,isNC){
  if(isNC){
    for(const d of [500,1000,2000,3000,5000,10000,15000]){
      const hit = await queryArcGISAADT(NC_AADT, lat, lng, d);
      if(hit) return {source:"NCDOT", ...hit};
    }
  }
  for(const d of [500,1000,2000,3000,5000,10000,15000]){
    const hit = await queryArcGISAADT(USA_AADT, lat, lng, d);
    if(hit) return {source:"Esri USA Traffic Counts", ...hit};
  }
  return null;
}

/* ================== Heuristic AADT if no ArcGIS record ================== */
async function heuristicAADT(lat,lng){
  // fetch nearest roads with tags
  const q = `[out:json][timeout:25];
    way(around:800,${lat},${lng})["highway"];
    out tags center;`;
  const j = await overpassQuery(q);
  const ways = (j.elements||[]).map(w=>{
    const c = w.center || null; if(!c) return null;
    const hw = (w.tags?.highway||"").toLowerCase();
    const lanes = parseInt(w.tags?.lanes);
    const maxspeedRaw = (w.tags?.maxspeed||"").toString();
    let mph = null;
    if(/\b\d+\s*mph\b/i.test(maxspeedRaw)){ mph = parseInt(maxspeedRaw); }
    else if(/\b\d+\b/.test(maxspeedRaw)){ const n=parseInt(maxspeedRaw); mph = n>70? Math.round(n*0.621): n; }
    return {id:w.id, lat:c.lat, lng:c.lon, highway:hw, lanes:isFinite(lanes)?lanes:null, mph};
  }).filter(Boolean);
  if(!ways.length) return {value:15000, source:"Heuristic (no roads found)", link:`https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=16/${lat}/${lng}`};

  // base AADT by class (rough, conservative-ish)
  const BASE = {
    motorway:65000, trunk:45000, primary:25000, secondary:14000, tertiary:8000,
    'primary_link':20000,'secondary_link':12000,'tertiary_link':7000,
    residential:2500, unclassified:3000, service:1200, living_street:800
  };
  function baseFor(hw){ return BASE[hw] ?? 5000; }

  // adjusters
  function laneFactor(l){ if(!l) return 1.0; return Math.max(0.6, Math.min(2.0, l/2)); }
  function speedFactor(m){ if(!m) return 1.0; if(m>=55) return 1.15; if(m>=45) return 1.08; if(m<=25) return 0.9; return 1.0; }

  // simple urban context: nearby place types
  const qPlace = `[out:json][timeout:25];
    node(around:2500,${lat},${lng})[place~"city|town|village|hamlet"];
    out tags center;`;
  let placeBoost=1.0;
  try{
    const jp = await overpassQuery(qPlace);
    const places = (jp.elements||[]).map(p=>p.tags?.place).join(",")||"";
    if(/city/.test(places)) placeBoost=1.4; else if(/town/.test(places)) placeBoost=1.2; else if(/village/.test(places)) placeBoost=1.05;
  }catch(e){}

  // distance-weighted average of top 3 nearest
  ways.forEach(w=>w.dist=hav({lat,lng},{lat:w.lat,lng:w.lng}));
  ways.sort((a,b)=>a.dist-b.dist);
  const top = ways.slice(0,3);
  let num=0, den=0, linkWay=null;
  top.forEach((w,i)=>{
    const b = baseFor(w.highway);
    const est = b * laneFactor(w.lanes) * speedFactor(w.mph) * placeBoost;
    const wt = 1/(w.dist+0.05);
    num += est * wt; den += wt;
    if(i===0) linkWay=w.id;
  });
  const val = Math.round(num/Math.max(den,1));
  return {value:val, source:"Heuristic (OSM road class/lanes/speed)", link:`https://www.openstreetmap.org/way/${linkWay}`};
}

/* ================== OSM competitors within 1.0 mile driving ================== */
async function fetchCompetitorsDriving1mi(lat,lng){
  // Prefilter by ~3 km crow to keep OSRM calls small
  const q = `[out:json][timeout:25];
    (node["amenity"="fuel"](around:3000,${lat},${lng});
     way["amenity"="fuel"](around:3000,${lat},${lng});
     relation["amenity"="fuel"](around:3000,${lat},${lng}););
    out center tags;`;
  const j = await overpassQuery(q);
  const cand = (j.elements||[]).map(e=>{
    const c = e.type==='node' ? {lat:e.lat,lng:e.lon} : (e.center||null);
    if(!c) return null;
    const name = e.tags?.brand || e.tags?.name || "Fuel station";
    return {lat:c.lat, lng:c.lon, name};
  }).filter(Boolean);

  const out=[];
  for(const r of cand){
    const d = await driveMiles({lat,lng},{lat:r.lat,lng:r.lng});
    if(d <= ONE_MILE) out.push({...r, drive:d});
  }
  out.sort((a,b)=>a.drive-b.drive);
  return out;
}

/* ================== OSM developments (proposed / construction) up to ~5mi drive ================== */
async function fetchDevelopments(lat,lng){
  const q = `[out:json][timeout:25];
    (node["amenity"="fuel"]["proposed"](around:10000,${lat},${lng});
     way["amenity"="fuel"]["proposed"](around:10000,${lat},${lng});
     relation["amenity"="fuel"]["proposed"](around:10000,${lat},${lng});
     node["amenity"="fuel"]["construction"](around:10000,${lat},${lng});
     way["amenity"="fuel"]["construction"](around:10000,${lat},${lng});
     relation["amenity"="fuel"]["construction"](around:10000,${lat},${lng}););
    out center tags;`;
  const j = await overpassQuery(q);
  const rows = (j.elements||[]).map(e=>{
    const c = e.type==='node' ? {lat:e.lat,lng:e.lon} : (e.center||null);
    if(!c) return null;
    const name = e.tags?.brand || e.tags?.name || "New fuel development";
    const stage = e.tags?.proposed ? "proposed" : (e.tags?.construction ? "construction" : "planned");
    return {lat:c.lat,lng:c.lon,name,stage};
  }).filter(Boolean);

  // compute drive distance and keep ‚â§ DEV_SEARCH_MI
  const out=[];
  for(const r of rows){
    const d = await driveMiles({lat,lng},{lat:r.lat,lng:r.lng});
    if(d <= DEV_SEARCH_MI) out.push({...r, drive:d});
  }
  out.sort((a,b)=>a.drive-b.drive);
  return out;
}

/* ================== Main click ================== */
document.getElementById('estimate').onclick = async () => {
  const status = document.getElementById('status'); const log = logger(status);
  const result = document.getElementById('result'); const summary = document.getElementById('summary');
  const compsDiv = document.getElementById('competitors'); const devDiv = document.getElementById('developments');
  const exportBtn = document.getElementById('export');

  // reset
  status.textContent="Calculating estimate‚Ä¶\n"; result.textContent=""; summary.textContent="";
  compsDiv.textContent=""; devDiv.textContent=""; exportBtn.style.display="none";
  if(compLayer){map.removeLayer(compLayer); compLayer=null;}
  if(devLayer){map.removeLayer(devLayer); devLayer=null;}
  if(siteMarker){map.removeLayer(siteMarker); siteMarker=null;}

  try{
    const addr = document.getElementById('address').value.trim();
    const mpds = Math.max(1, parseInt(document.getElementById('mpds').value)||1);
    const aadtOverride = parseInt(document.getElementById('aadtOverride').value)||null;
    if(!addr) throw new Error("Please enter an address.");

    // Geocode with state
    log("Geocoding address‚Ä¶");
    const g = await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=1&q=${encodeURIComponent(addr)}`);
    const gj = await g.json();
    if(!gj.length) throw new Error("Address not found.");
    const lat = +gj[0].lat, lng = +gj[0].lon;
    const state = gj[0].address?.state || "";
    log(`Found (${lat.toFixed(4)}, ${lng.toFixed(4)})`, true);

    siteMarker = L.marker([lat,lng]).addTo(map).bindPopup("Your site").openPopup();
    map.setView([lat,lng], 14);

    // AADT: override ‚Üí ArcGIS ‚Üí heuristic
    let aadt=null, aadtSource="", aadtLink="";
    if(aadtOverride){
      aadt=aadtOverride; aadtSource="User override"; log(`Using override AADT ${aadt}`,true);
    }else{
      log("Finding AADT via DOT/ArcGIS‚Ä¶");
      const isNC = /north carolina/i.test(state) || /\bNC\b/.test(state);
      const hit = await robustAADT(lat,lng,isNC);
      if(hit){ aadt=hit.value; aadtSource=hit.source; aadtLink=hit.link; log(`AADT ${aadt} (${aadtSource})`,true); }
      else{
        log("No ArcGIS record found. Estimating AADT heuristically from road class/lanes/speed‚Ä¶");
        const h = await heuristicAADT(lat,lng);
        aadt = h.value; aadtSource = h.source; aadtLink = h.link;
        log(`Heuristic AADT estimate: ${aadt}`, true);
      }
    }

    // Competitors ‚â§ 1.0 mile driving
    log("Fetching competitors (‚â§ 1.0 mile drive)‚Ä¶");
    const comps = await fetchCompetitorsDriving1mi(lat,lng);
    log(`Using ${comps.length} competitors.`, true);

    // Draw competitors
    if(compLayer) map.removeLayer(compLayer);
    compLayer = L.layerGroup(comps.map(c=>{
      const brand = (c.name||"").toLowerCase();
      const big = /\b(costco|sam'?s|bj'?s|buc-?ee?s|wawa|sheetz|quik\s?trip|^qt\b|racetrac|pilot|flying\s?j|love'?s|ta|petro)\b/.test(brand);
      const star = big ? "‚òÖ" : "";
      const size = big ? "big" : "med";
      const color = big ? "#f59e0b" : "#60a5fa";
      const icon = L.divIcon({className:"div-pin", html:`<div class="pin ${size}" style="background:${color}">${star}</div>`, iconSize:null, iconAnchor:[15,15]});
      return L.marker([c.lat,c.lng],{icon}).bindPopup(`${c.name}<br>${c.drive.toFixed(1)} mi drive`);
    })).addTo(map);

    // Developments (‚â§ ~5 mi drive)
    log("Checking new developments (proposed/construction ‚â§ 5 mi)‚Ä¶");
    const devs = await fetchDevelopments(lat,lng);
    if(devs.length){
      let dl = "<b>New developments nearby:</b><ul>";
      devs.slice(0,10).forEach(d=> dl += `<li>${d.name} ‚Äî ${d.stage} ‚Äî ${d.drive.toFixed(1)} mi</li>`);
      dl += "</ul>";
      devDiv.innerHTML = dl;
    }else{
      devDiv.textContent = "No proposed/under-construction fuel sites found within ~5 miles.";
    }

    // Estimate (conservative cap)
    const demand = aadt * CAPTURE_RATE * GALLONS_PER_STOP * DAYS_PER_MONTH;
    const capacity = mpds * MONTHLY_PER_MPD_CAP;
    const est = Math.min(demand, capacity);

    result.textContent = `Estimated Monthly Gallons: ${fmt(est)}`;
    summary.innerHTML =
      `AADT <b>${fmt(aadt)}</b> (${aadtSource}${aadtLink?`, <a href="${aadtLink}" target="_blank" rel="noopener">source</a>`:""}) ¬∑ `+
      `MPDs ${mpds} ¬∑ Competitors (‚â§1.0 mi drive) ${comps.length} ¬∑ Developments ${devs.length}`;

    // Competitor list
    if(comps.length){
      let html = "<b>Competitors considered (‚â§1.0 mi drive):</b><ul>";
      comps.slice(0,10).forEach(c=> html += `<li>${c.name} ‚Äî ${c.drive.toFixed(1)} mi</li>`);
      html += "</ul>";
      compsDiv.innerHTML = html;
    }else{
      compsDiv.textContent = "No stations within 1.0 mile drive.";
    }

    // Export PDF with real map snapshot (CORS-safe tiles)
    document.getElementById('export').style.display = "block";
    document.getElementById('export').onclick = () => {
      const { jsPDF } = window.jspdf;
      leafletImage(map, (err, canvas) => {
        const doc = new jsPDF({unit:"pt", format:"a4"});
        doc.setFontSize(14);
        doc.text("Fuel Volume Estimate", 40, 40);
        doc.setFontSize(11);
        doc.text(`Address: ${addr}`, 40, 60);
        doc.text(`MPDs: ${mpds}`, 40, 76);
        doc.text(`AADT: ${fmt(aadt)} (${aadtSource})`, 40, 92);
        if(aadtLink) doc.textWithLink("Open AADT source", 40, 108, {url:aadtLink});
        doc.text(result.textContent, 40, 130);
        const img = canvas.toDataURL("image/png");
        doc.addImage(img, "PNG", 40, 150, 515, 300);
        doc.save("fuel_estimate.pdf");
      });
    };

    log("‚ö° Estimate complete!", true);
    status.textContent += "\n‚ùì Do you want me to run another search?\n";

  }catch(e){
    status.textContent += "‚ùå " + (e.message || e) + "\n";
  }
};

// Enter to run
document.getElementById('address').addEventListener('keydown', e => { if(e.key==="Enter") document.getElementById('estimate').click(); });
</script>
</body>
</html>

