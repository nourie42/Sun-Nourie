<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fuel Volume Estimator ‚Ä¢ Sunoco LP</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  :root{
    --bg:#0f172a; --panel:#0b1224; --border:#1f2937; --muted:#94a3b8; --text:#e5e7eb;
    --accent:#60a5fa; --good:#22c55e; --warn:#f59e0b;
  }
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--text);}
  .brandbar{position:sticky; top:0; background:#0b1224; border-bottom:1px solid var(--border); padding:10px 14px; display:flex; align-items:center; justify-content:space-between;}
  .brand img{height:32px; width:auto;}
  .brand-sub{font-size:12px; color:var(--muted);}
  .container{padding:18px; max-width:680px; margin:auto;}
  h1{font-size:20px; margin:0 0 12px;}
  label{display:block; margin:12px 0 6px; color:#cbd5e1;}
  input,button{width:100%; padding:12px 14px; border-radius:10px; border:1px solid var(--border); background:var(--panel); color:var(--text); font-size:16px;}
  button{background:var(--accent); color:#0b1224; font-weight:700; cursor:pointer;}
  #status{margin-top:12px; font-size:14px; background:#1e293b; border:1px solid var(--border); border-radius:8px; padding:10px; height:140px; overflow-y:auto; font-family:monospace; white-space:pre-line;}
  #result{margin-top:16px; font-size:20px; font-weight:900; color:var(--good);}
  #summary,#competitors,#developments{margin-top:10px;}
  #map{height:58vh; margin:18px auto; border:1px solid var(--border); border-radius:12px; max-width:1200px;}
</style>
</head>
<body>
<header class="brandbar">
  <div class="brand">
    <img src="sunoco-logo.svg" alt="Sunoco LP logo" onerror="this.style.display='none';"/>
  </div>
  <div class="brand-sub">Fuel Volume Estimator</div>
</header>

<div class="container">
  <h1>Monthly Volume Estimate</h1>
  <label for="address">Address</label>
  <input id="address" placeholder="4173 Knightdale Blvd, Knightdale, NC" />
  <label for="mpds">MPDs</label>
  <input id="mpds" type="number" min="1" value="6" />
  <button id="estimate">Calculate Estimate</button>

  <div id="status"></div>
  <div id="result"></div>
  <div id="summary"></div>
  <div id="competitors"></div>
  <div id="developments"></div>
  <button id="export" style="display:none;">üìÑ Export to PDF</button>
  <button id="reset" style="display:none;">üîÑ Run Another Search</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// === Basic math ===
const CAPTURE_RATE=0.02, GALLONS_PER_STOP=9.2, DAYS_PER_MONTH=30.4;
const POSITIONS_PER_MPD=2, CYCLE_MIN=6.5, HOURS_OPEN=18, AVG_OCCUPANCY=0.20;
const COMP_RADIUS_M=5000, HUFF_BETA=1.2;
const TRANS_PER_POS_PER_DAY=(60/CYCLE_MIN)*HOURS_OPEN*AVG_OCCUPANCY;
const GPD_PER_POS=TRANS_PER_POS_PER_DAY*GALLONS_PER_STOP;
const MONTHLY_PER_MPD_CAP=GPD_PER_POS*POSITIONS_PER_MPD*DAYS_PER_MONTH;
const fmt=n=>Number.isFinite(n)?Math.round(n).toLocaleString():"‚Äì";
const rad=d=>d*Math.PI/180;
function hav(a,b){const R=3958.8,dLat=rad(b.lat-a.lat),dLng=rad(b.lng-a.lng);
  const s=Math.sin(dLat/2)**2+Math.cos(rad(a.lat))*Math.cos(rad(b.lat))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));}
function clamp(x,lo,hi){return Math.max(lo,Math.min(hi,x));}

// === Map ===
const map=L.map('map').setView([35.7796,-78.6382],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let siteMarker=null,compLayer=null,devLayer=null;

// === Logger ===
function logger(el){el.textContent="";return(msg,ok=false)=>{el.textContent+=(ok?"‚úÖ ":"‚è≥ ")+msg+"\n";el.scrollTop=el.scrollHeight;}}

// === Overpass helper ===
async function overpassQuery(q){
  const ep="https://overpass-api.de/api/interpreter";
  const r=await fetch(ep,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:"data="+encodeURIComponent(q)});
  return await r.json();
}

// === Fetch AADT (NCDOT, fallback to 20k) ===
async function fetchAADT(lat,lng){
  try{
    const url="https://services.arcgis.com/NuWFvHYDMVmmxMeM/ArcGIS/rest/services/NCDOT_AADT_Stations/FeatureServer/0/query";
    const params={where:"1=1",geometry:`${lng},${lat}`,geometryType:"esriGeometryPoint",inSR:"4326",spatialRel:"esriSpatialRelIntersects",distance:"1000",units:"esriSRUnit_Meter",outFields:"*",outSR:"4326",f:"json"};
    const r=await fetch(url+"?"+new URLSearchParams(params)); const j=await r.json();
    if(!j.features?.length) return 20000;
    return j.features[0].attributes.AADT||20000;
  }catch{return 20000;}
}

// === Fetch competitors ===
async function fetchCompetitors(lat,lng){
  const q=`[out:json][timeout:25];node["amenity"="fuel"](around:${COMP_RADIUS_M},${lat},${lng});out center;`;
  const j=await overpassQuery(q);
  return j.elements.map(e=>({lat:e.lat,lng:e.lon,name:e.tags?.brand||e.tags?.name||"Station",dist:hav({lat,lng},{lat:e.lat,lng:e.lon})}));
}

// === Main button ===
document.getElementById('estimate').onclick=async()=>{
  const status=document.getElementById('status'); const log=logger(status);
  const result=document.getElementById('result'); const summary=document.getElementById('summary');
  const compDiv=document.getElementById('competitors'); const exportBtn=document.getElementById('export'); const resetBtn=document.getElementById('reset');

  result.textContent=""; summary.textContent=""; compDiv.textContent="";
  exportBtn.style.display="none"; resetBtn.style.display="none";
  if(compLayer){map.removeLayer(compLayer);} if(siteMarker){map.removeLayer(siteMarker);}

  try{
    const addr=document.getElementById('address').value.trim();
    const mpds=Math.max(1,parseInt(document.getElementById('mpds').value)||6);
    if(!addr) throw new Error("Please enter an address.");
    log("Geocoding address‚Ä¶");
    const g=await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(addr)}`);
    const gj=await g.json(); if(!gj.length) throw new Error("Address not found.");
    const lat=+gj[0].lat, lng=+gj[0].lon; log("Found location.",true);
    siteMarker=L.marker([lat,lng]).addTo(map).bindPopup("Your site").openPopup();
    map.setView([lat,lng],13);

    log("Fetching AADT‚Ä¶");
    const aadt=await fetchAADT(lat,lng); log("AADT="+aadt,true);

    log("Fetching competitors‚Ä¶");
    const comps=await fetchCompetitors(lat,lng); log(`Found ${comps.length}`,true);
    compLayer=L.layerGroup(comps.map(c=>L.circleMarker([c.lat,c.lng],{radius:6,color:"#f59e0b"}).bindPopup(`${c.name}<br>${c.dist.toFixed(1)} mi`))).addTo(map);

    // Estimate
    const share=1.0; // simple (no Huff for this trimmed version)
    const demand=aadt*CAPTURE_RATE*GALLONS_PER_STOP*DAYS_PER_MONTH*share;
    const cap=mpds*MONTHLY_PER_MPD_CAP;
    const est=Math.min(demand,cap);

    result.textContent=`Estimated Monthly Gallons: ${fmt(est)}`;
    summary.textContent=`AADT ${fmt(aadt)} ¬∑ MPDs ${mpds} ¬∑ Competitors ${comps.length}`;

    exportBtn.style.display="block"; resetBtn.style.display="block";
    log("‚úÖ Estimate complete!",true);

    exportBtn.onclick=async()=>{
      const {jsPDF}=window.jspdf; const doc=new jsPDF();
      doc.text("Fuel Volume Estimate",20,20);
      doc.text(`Address: ${addr}`,20,30); doc.text(`MPDs: ${mpds}`,20,40);
      doc.text(`AADT: ${fmt(aadt)}`,20,50);
      doc.text(result.textContent,20,70);
      const canvas=await html2canvas(document.getElementById("map")); const img=canvas.toDataURL("image/png");
      doc.addImage(img,"PNG",20,80,170,90); doc.save("fuel_estimate.pdf");
    };

    resetBtn.onclick=()=>{
      document.getElementById('address').value=""; document.getElementById('mpds').value="6";
      status.textContent=""; result.textContent=""; summary.textContent="";
      compDiv.textContent=""; exportBtn.style.display="none"; resetBtn.style.display="none";
      if(siteMarker){map.removeLayer(siteMarker); siteMarker=null;}
      if(compLayer){map.removeLayer(compLayer); compLayer=null;}
      map.setView([35.7796,-78.6382],11);
    };

  }catch(e){status.textContent+="‚ùå Error: "+e.message;}
};
</script>
</body>
</html>
