<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Prospect Estimator + Competition Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  :root { --bg:#0b0c10; --card:#13151a; --text:#e8e8e8; --muted:#9aa0a6; --accent:#3a82f7; --border:#2a2f3a; }
  *{box-sizing:border-box}
  body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{display:flex;gap:16px;height:100vh;padding:16px}
  .left{width:520px;min-width:360px;display:flex;flex-direction:column;gap:12px}
  .right{flex:1}
  h1{margin:0 0 12px;font-size:22px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  label{display:block;font-weight:600;margin:10px 0 4px}
  input[type="text"],input[type="number"]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#1b1f2a;color:var(--text)}
  .row{display:flex;gap:8px}
  .col{flex:1}
  button{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted);font-size:12px}
  .err{color:#ff9a9a}
  #map{height:calc(100vh - 32px);width:100%;border-radius:12px;border:1px solid var(--border)}
  .num{font-variant-numeric:tabular-nums}
  table{width:100%;border-collapse:collapse}
  td{padding:4px 0;border-bottom:1px dashed #2a2f3a}
  .badge{display:inline-block;min-width:120px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#1b1f2a;margin-right:6px}
  .ok{color:#9ef5b3}.fail{color:#ff9a9a}.pending{color:#e8e8e8;opacity:.7}
</style>
</head>
<body>
  <div class="wrap">
    <div class="left">
      <div class="card">
        <h1 style="margin:0">Prospect Estimator</h1>
      </div>

      <!-- Inputs -->
      <div class="card">
        <div><b>Step 1: Enter address</b></div>
        <label>Prospect site address</label>
        <input id="addr" type="text" placeholder="e.g., 4173 Knightdale BLVD, Knightdale NC">
        <div class="row" style="margin-top:8px">
          <div class="col">
            <label>Step 2: Gasoline MPDs</label>
            <input id="mpd" type="number" min="0" value="6">
          </div>
          <div class="col">
            <label>Diesel positions (optional)</label>
            <input id="dieselpos" type="number" min="0" value="8">
          </div>
        </div>
        <div style="margin-top:8px;display:flex;align-items:center;gap:10px">
          <input id="autoAADT" type="checkbox" checked>
          <label for="autoAADT" style="margin:0;font-weight:600">Try to auto-estimate AADT if not provided</label>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="run">Search & Estimate</button>
          <span id="status" class="muted"></span>
        </div>
      </div>

      <!-- Results (gallons) -->
      <div class="card" id="resultsCard">
        <div><b>Results</b></div>
        <div id="results" class="muted">Enter address + MPDs and click <b>Search & Estimate</b>.</div>
      </div>

      <!-- Advanced -->
      <details class="card">
        <summary><b>Advanced inputs (optional)</b></summary>
        <div class="row">
          <div class="col"><label>Total VPD (AADT)</label><input id="VPD" type="number" value="18024"></div>
          <div class="col"><label>Truck share (%)</label><input id="truckShare" type="number" value="5.5"></div>
        </div>
        <div class="row">
          <div class="col"><label>Frontage F</label><input id="frontShare" type="number" step="0.01" value="0.59"></div>
          <div class="col"><label>Turn T</label><input id="turnShare" type="number" step="0.01" value="0.41"></div>
        </div>
        <div class="row">
          <div class="col"><label>Turn friction f<sub>T</sub> (0–1)</label><input id="turnFric" type="number" step="0.05" min="0" max="1" value="0.70"></div>
          <div class="col"><label>Speed (mph)</label><input id="speed" type="number" value="35"></div>
        </div>
        <div class="row">
          <div class="col"><label>Access points</label><input id="accessPts" type="number" value="4"></div>
          <div class="col"><label>LED price sign? (0/1)</label><input id="ledSign" type="number" min="0" max="1" value="1"></div>
        </div>
        <div class="row">
          <div class="col"><label>Price delta (market − your) $/gal</label><input id="priceDelta" type="number" step="0.01" value="0.00"></div>
          <div class="col"><label>CPR avg index</label><input id="cpr" type="number" value="104"></div>
        </div>
        <div class="row">
          <div class="col"><label>Gasoline score</label><input id="gasScore" type="number" step="0.5" value="105.5"></div>
          <div class="col"><label>Diesel score</label><input id="dieselScore" type="number" step="0.5" value="22.5"></div>
        </div>
        <div class="row">
          <div class="col"><label>Competition radius (mi)</label><input id="radiusMi" type="number" step="0.5" min="0.5" value="2"></div>
          <div class="col"><label>Dev. radius (mi)</label><input id="devRadiusMi" type="number" step="0.5" min="1" value="3"></div>
        </div>
      </details>

      <!-- Live Data Status (moved to bottom) -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <b>Live Data Status</b>
          <button id="recheck">Recheck</button>
        </div>
        <div style="line-height:1.8;margin-top:8px">
          <span class="badge"><b>Backend</b></span> <span id="s-backend" class="pending">checking…</span><br>
          <span class="badge"><b>Geocode</b></span> <span id="s-geocode" class="pending">checking…</span><br>
          <span class="badge"><b>Places</b></span> <span id="s-places" class="pending">checking…</span><br>
          <span class="badge"><b>Developments</b></span> <span id="s-dev" class="pending">checking…</span>
        </div>
        <div class="muted" style="margin-top:6px">Backend: <code id="backendUrl">https://sun-nourie-live.onrender.com</code></div>
      </div>
    </div>

    <div class="right">
      <div id="map"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
  // ---------- CONFIG ----------
  const API_BASE = "https://sun-nourie-live.onrender.com"; // change if backend URL differs
  document.getElementById('backendUrl').textContent = API_BASE;
  const ENDPOINT = {
    backend: API_BASE + "/",
    geocode: API_BASE + "/geocode",
    places: API_BASE + "/places",
    developments: API_BASE + "/developments"
  };

  // robust fetch with CORS + retry
  async function apiFetch(url, opts = {}) {
    const options = Object.assign({ mode: "cors", cache: "no-store", referrerPolicy: "no-referrer" }, opts);
    for (let i=0;i<2;i++){ try { return await fetch(url, options); } catch(e){ if(i===1) throw e; await new Promise(r=>setTimeout(r,700)); } }
  }

  // ---------- STATUS PANEL ----------
  const sBackend = document.getElementById("s-backend");
  const sGeo = document.getElementById("s-geocode");
  const sPlaces = document.getElementById("s-places");
  const sDev = document.getElementById("s-dev");
  const setStatus = (el, ok, ms, extra="") => { el.className = ok ? "ok" : "fail"; el.textContent = (ok ? "OK" : "Fail") + (ms ? ` (${ms}ms)` : "") + (extra ? ` — ${extra}` : ""); };
  async function timed(url){ const t0=performance.now(); const r=await apiFetch(url); return {r,ms:Math.round(performance.now()-t0)}; }
  async function checkAll(){
    try{ const {r,ms}=await timed(ENDPOINT.backend); const text=await r.text(); setStatus(sBackend, r.ok && text.includes("OK"), ms); }catch{ setStatus(sBackend,false); }
    try{ const {r,ms}=await timed(ENDPOINT.geocode+"?address=Raleigh,NC"); setStatus(sGeo, r.ok, ms); }catch{ setStatus(sGeo,false); }
    try{ const {r,ms}=await timed(ENDPOINT.places+"?lat=35.79&lng=-78.52&radius=1609"); setStatus(sPlaces, r.ok, ms); }catch{ setStatus(sPlaces,false); }
    try{ const {r,ms}=await timed(ENDPOINT.developments+"?lat=35.79&lng=-78.52&radius=5000"); setStatus(sDev, r.ok, ms); }catch{ setStatus(sDev,false); }
  }
  document.getElementById("recheck").addEventListener("click", checkAll);
  document.addEventListener("DOMContentLoaded", checkAll);

  // ---------- MAP ----------
  const map=L.map('map').setView([35.7796,-78.6382],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.
