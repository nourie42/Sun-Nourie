<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ask Dan’s Assistant</title>
  <style>
    body { font: 16px/1.4 system-ui, sans-serif; margin: 0; background:#0b0c10; color:#e8e8e8; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    .chat { background:#13151a; border-radius: 12px; padding: 12px; height: 70vh; overflow:auto; }
    .row { margin: 10px 0; display:flex; gap:10px; }
    .role { font-weight:600; min-width:72px; opacity:.8 }
    .msg { white-space: pre-wrap; }
    form { display:flex; gap:8px; margin-top:12px; }
    input, textarea { flex:1; background:#1b1f2a; color:#e8e8e8; border:1px solid #2a2f3a; border-radius:10px; padding:10px; }
    button { background:#3a82f7; border:0; color:white; border-radius:10px; padding:10px 14px; font-weight:600; }
    .sys { font-size:12px; opacity:.8; margin-bottom:8px }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Ask Dan’s Gas-Station Assistant</h1>
    <div class="sys">
      System behavior (optional): <input id="system" value="You are Dan’s gas-station expert. Be concise and numeric when estimating AADT→Gallons.">
    </div>
    <div id="chat" class="chat"></div>
    <form id="f">
      <input id="q" placeholder="Type a question… e.g., ‘Estimate gallons for 1500 Hodge Rd Knightdale NC’" />
      <button>Send</button>
    </form>
  </div>

  <script>
    const PROXY = "YOUR_PROXY_URL"; // e.g., https://your-worker.workers.dev
    const chatEl = document.getElementById('chat');
    const form = document.getElementById('f');
    const q = document.getElementById('q');
    const sys = document.getElementById('system');

    const messages = [
      { role: "assistant", content: "Hi! Ask me anything about sites, AADT→gallons, competition impact, or permits." }
    ];
    render();

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const userText = q.value.trim();
      if (!userText) return;
      messages.push({ role: "user", content: userText });
      q.value = "";
      render();

      // Create a new assistant message placeholder
      const placeholder = { role: "assistant", content: "" };
      messages.push(placeholder);
      render();

      // Call proxy and stream
      const resp = await fetch(PROXY, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          system: sys.value || undefined,
          messages
        })
      });

      const reader = resp.body
        .pipeThrough(new TextDecoderStream())
        .getReader();

      let buffer = "";
      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += value;
        // SSE lines start with "data:"
        for (const line of buffer.split("\n")) {
          if (!line.startsWith("data:")) continue;
          const payload = line.slice(5).trim();
          if (payload === "[DONE]") continue;
          try {
            const json = JSON.parse(payload);
            // Responses API streams deltas — normalize to text
            // Many SDKs expose output_text; here we just grab any text delta
            const chunks = (json.output || json.response || json).content || json.output_text || "";
            // Fallback: try "delta" for token streams
            const delta = json.delta?.content?.[0]?.text ?? json.output_text ?? "";
            if (typeof chunks === "string") {
              placeholder.content = chunks; // full text
            } else if (delta) {
              placeholder.content += delta;
            }
            render(true);
          } catch (_) { /* ignore keepalives */ }
        }
      }
      scrollToBottom();
    });

    function render(scroll=false) {
      chatEl.innerHTML = messages.map(m => `
        <div class="row">
          <div class="role">${m.role === 'user' ? 'You' : 'Assistant'}</div>
          <div class="msg">${escapeHtml(m.content)}</div>
        </div>
      `).join("");
      if (scroll) scrollToBottom();
    }
    function scrollToBottom() { chatEl.scrollTop = chatEl.scrollHeight; }
    function escapeHtml(s) { return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  </script>
</body>
</html>
