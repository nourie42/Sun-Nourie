<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fuel Volume Estimator • Sunoco LP</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-image@latest/leaflet-image.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { margin:0; font-family:system-ui,sans-serif; background:#0f172a; color:#e5e7eb; }
  header { background:#0b1224; padding:10px 14px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #1f2937; }
  header img { height:32px; }
  .container { max-width:800px; margin:auto; padding:16px; }
  h1 { margin:0 0 12px; font-size:20px; }
  label { margin-top:12px; display:block; }
  input, button { width:100%; padding:10px; border-radius:8px; border:1px solid #1f2937; margin-bottom:10px; }
  button { background:#60a5fa; color:#000; font-weight:700; cursor:pointer; }
  #status { background:#1e293b; padding:8px; height:120px; overflow-y:auto; font-family:monospace; font-size:13px; border-radius:8px; }
  #result { margin-top:10px; font-size:18px; font-weight:bold; color:#22c55e; }
  #summary, #competitors, #developments, #insights { margin-top:10px; }
  #map { height:55vh; margin-top:16px; border:1px solid #1f2937; border-radius:8px; }
  .pin { display:flex; align-items:center; justify-content:center; border-radius:50%; border:2px solid #fff; font-weight:900; }
  .pin.big { width:28px; height:28px; font-size:16px; }
  .pin.med { width:20px; height:20px; font-size:13px; }
</style>
</head>
<body>
<header>
  <img src="sunoco-logo.svg" alt="Sunoco LP logo" onerror="this.style.display='none'">
  <div>Fuel Volume Estimator</div>
</header>

<div class="container">
  <h1>Monthly Volume Estimate</h1>
  <label>Address</label>
  <input id="address" placeholder="4173 Knightdale Blvd, Knightdale, NC" />
  <label>MPDs</label>
  <input id="mpds" type="number" value="6" />
  <label>AADT override (optional)</label>
  <input id="aadtOverride" type="number" placeholder="Enter DOT AADT manually if known" />
  <label>Google API key (optional — Street View & reviews)</label>
  <input id="gkey" placeholder="Paste restricted key" />
  <button id="estimate">Calculate Estimate</button>

  <div id="status"></div>
  <div id="result"></div>
  <div id="summary"></div>
  <div id="insights"></div>
  <div id="competitors"></div>
  <div id="developments"></div>
  <button id="export" style="display:none">📄 Export to PDF</button>
</div>

<div id="map"></div>

<script>
// Conservative MPD capacity
const CAPTURE_RATE=0.02, GALLONS_PER_STOP=9.2, DAYS_PER_MONTH=30.4;
const MONTHLY_PER_MPD_CAP=8500; // conservative max

const rad=d=>d*Math.PI/180;
function hav(a,b){const R=3958.8,dLat=rad(b.lat-a.lat),dLng=rad(b.lng-a.lng);
 const s=Math.sin(dLat/2)**2+Math.cos(rad(a.lat))*Math.cos(rad(b.lat))*Math.sin(dLng/2)**2;
 return 2*R*Math.asin(Math.sqrt(s));}
const fmt=n=>Number.isFinite(n)?Math.round(n).toLocaleString():"–";

// Leaflet map
const map=L.map('map').setView([35.77,-78.63],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let siteMarker=null, compLayer=null;

// OSRM driving distance
async function driveMiles(a,b){
 try{
   const url=`https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=false`;
   const r=await fetch(url); const j=await r.json();
   return j.routes?.[0]?.distance/1609.34||hav(a,b);
 }catch{return hav(a,b);}
}

// ArcGIS queries
async function queryArcGISAADT(url,lat,lng,d){
 const params={where:"1=1",geometry:`${lng},${lat}`,geometryType:"esriGeometryPoint",inSR:"4326",spatialRel:"esriSpatialRelIntersects",distance:d,units:"esriSRUnit_Meter",outFields:"*",f:"json"};
 const r=await fetch(url+"?"+new URLSearchParams(params)); const j=await r.json();
 if(!j.features?.length) return null;
 let best=j.features[0]; return {val:Object.values(best.attributes).find(v=>typeof v==="number"&&v>0), link:url+"?"+new URLSearchParams(params)};
}
async function robustAADT(lat,lng){
 const NC="https://services.arcgis.com/NuWFvHYDMVmmxMeM/ArcGIS/rest/services/NCDOT_AADT_Stations/FeatureServer/0/query";
 const USA="https://services.arcgis.com/P3ePLMYs2RVChkJx/ArcGIS/rest/services/USA_Traffic_Counts/FeatureServer/0/query";
 for(const d of [500,1000,2000,5000,10000]){
   let hit=await queryArcGISAADT(NC,lat,lng,d); if(hit) return {src:"NCDOT",...hit};
 }
 for(const d of [500,1000,2000,5000,10000]){
   let hit=await queryArcGISAADT(USA,lat,lng,d); if(hit) return {src:"Esri USA",...hit};
 }
 return null;
}

// Competition via OSM
async function fetchCompetitors(lat,lng){
 const q=`[out:json][timeout:25];node["amenity"="fuel"](around:15000,${lat},${lng});out center;`;
 const r=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:"data="+encodeURIComponent(q)});
 const j=await r.json(); const rows=(j.elements||[]).map(e=>({lat:e.lat,lng:e.lon,name:e.tags?.brand||"Station"}));
 for(let row of rows){row.drive=await driveMiles({lat,lng},{lat:row.lat,lng:row.lng});}
 return rows.sort((a,b)=>a.drive-b.drive);
}

// Main click
document.getElementById('estimate').onclick=async()=>{
 const status=document.getElementById('status'); status.textContent="";
 const result=document.getElementById('result'); result.textContent="";
 const summary=document.getElementById('summary'); summary.textContent="";
 const compsDiv=document.getElementById('competitors'); compsDiv.textContent="";

 const addr=document.getElementById('address').value.trim();
 if(!addr) return alert("Enter an address");
 const mpds=parseInt(document.getElementById('mpds').value)||1;
 const ovr=parseInt(document.getElementById('aadtOverride').value)||null;

 // Geocode
 status.textContent+="⏳ Geocoding…\n";
 const g=await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(addr)}`);
 const gj=await g.json(); if(!gj.length){status.textContent+="❌ Address not found";return;}
 const lat=+gj[0].lat,lng=+gj[0].lon;
 if(siteMarker) map.removeLayer(siteMarker);
 siteMarker=L.marker([lat,lng]).addTo(map).bindPopup("Your site").openPopup();
 map.setView([lat,lng],14);
 status.textContent+="✅ Location found\n";

 // AADT
 let aadt=null, aadtLink="";
 if(ovr){aadt=ovr; status.textContent+=`✅ Using override AADT ${aadt}\n`;}
 else{
   status.textContent+="⏳ Finding AADT…\n";
   const hit=await robustAADT(lat,lng);
   if(hit){aadt=hit.val; aadtLink=hit.link; status.textContent+=`✅ AADT ${aadt} (${hit.src})\n`;}
   else{status.textContent+="❌ No AADT found. Please click DOT link manually.\n"; aadtLink=`https://ncdot.maps.arcgis.com/apps/webappviewer/index.html?id=ae42f4ac534a46458c9cf60a98d2bc1d&find=${lat},${lng}`;}
 }

 // Competition
 status.textContent+="⏳ Finding competitors…\n";
 const comps=await fetchCompetitors(lat,lng);
 status.textContent+=`✅ Found ${comps.length}\n`;
 if(compLayer) map.removeLayer(compLayer);
 compLayer=L.layerGroup(comps.map(c=>L.marker([c.lat,c.lng]).bindPopup(`${c.name}<br>${c.drive.toFixed(1)} mi drive`))).addTo(map);

 // Estimate
 if(!aadt){result.textContent="No AADT found"; return;}
 const demand=aadt*CAPTURE_RATE*GALLONS_PER_STOP*DAYS_PER_MONTH;
 const cap=mpds*MONTHLY_PER_MPD_CAP;
 const est=Math.min(demand,cap);
 result.textContent=`Estimated Monthly Gallons: ${fmt(est)}`;
 summary.innerHTML=`AADT: <b>${fmt(aadt)}</b>${aadtLink?` (<a href="${aadtLink}" target="_blank">source</a>)`:""} · MPDs ${mpds} · Competitors ${comps.length}`;

 // List top comps
 let html="<b>Top competitors:</b><ul>";
 comps.slice(0,5).forEach(c=>html+=`<li>${c.name} — ${c.drive.toFixed(1)} mi drive</li>`);
 html+="</ul>"; compsDiv.innerHTML=html;

 // PDF export with real map
 document.getElementById('export').style.display="block";
 document.getElementById('export').onclick=()=>{
   const {jsPDF}=window.jspdf;
   leafletImage(map,(err,canvas)=>{
     const doc=new jsPDF();
     doc.text("Fuel Volume Estimate",20,20);
     doc.text(result.textContent,20,40);
     if(aadtLink) doc.textWithLink("Open AADT source",20,60,{url:aadtLink});
     doc.addImage(canvas.toDataURL("image/png"),"PNG",20,80,170,100);
     doc.save("fuel_estimate.pdf");
   });
 };
};
</script>
</body>
</html>
