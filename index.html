<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prospect Estimator</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#1a1f29; --muted:#8ea0b7; --text:#e8eef8; --accent:#3b82f6; --ok:#16a34a; --warn:#f59e0b;
      --radius:16px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:920px;margin:24px auto;padding:12px}
    .card{background:var(--panel);border-radius:var(--radius);padding:18px;margin-bottom:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    h1{margin:0 0 8px;font-weight:800;letter-spacing:.2px}
    h2{margin:0 0 12px;font-weight:700;font-size:18px}
    label{display:block;font-size:14px;color:var(--muted);margin:8px 0 6px}
    input[type="text"],input[type="number"]{
      width:100%;padding:14px 12px;border-radius:12px;border:1px solid #2b3443;background:#11151d;color:var(--text);
      outline:none
    }
    .grid{display:grid;gap:12px}
    @media(min-width:720px){.grid-2{grid-template-columns:1fr 1fr}}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .checkbox{display:flex;gap:10px;align-items:center;margin-top:6px}
    .btn{
      appearance:none;border:0;border-radius:12px;background:var(--accent);color:#fff;padding:12px 16px;
      font-weight:700;cursor:pointer;transition:transform .03s ease;box-shadow:0 4px 16px rgba(59,130,246,.35)
    }
    .btn:active{transform:translateY(1px)}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0e1625;color:var(--muted);font-size:12px}
    .result-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #2a3343}
    .result-row:last-child{border-bottom:0}
    .mono{font-variant-numeric:tabular-nums}
    details{margin-top:6px}
    summary{cursor:pointer;color:#c9d7ee}
    .small{font-size:12px}
    .status{min-height:20px;margin-left:10px}
    .status.ok{color:var(--ok)}
    .status.err{color:#ef4444}
    .foot{margin-top:8px;font-size:12px;color:#8aa1be}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Prospect Estimator</h1>
    </div>

    <div class="card">
      <h2>Prospect site address</h2>
      <label for="address">Enter full address</label>
      <input id="address" type="text" placeholder="500 Main St Nashua NH" />

      <div class="grid grid-2" style="margin-top:12px">
        <div>
          <label for="mpds">Gasoline MPDs</label>
          <input id="mpds" type="number" min="0" step="1" value="6" />
        </div>
        <div>
          <label for="diesel">Diesel positions</label>
          <input id="diesel" type="number" min="0" step="1" value="8" />
        </div>
      </div>

      <div class="checkbox">
        <input id="autoFetch" type="checkbox" checked />
        <label for="autoFetch" class="muted">Auto-fetch AADT</label>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="go" class="btn">Search &amp; Estimate</button>
        <span id="status" class="status muted">Ready.</span>
      </div>
    </div>

    <div class="card" id="resultsCard" style="display:none">
      <h2>Results</h2>
      <div class="result-row">
        <div>Year-1 est. (gal/mo)</div>
        <div class="mono" id="y1">—</div>
      </div>
      <div class="result-row">
        <div>Low / High</div>
        <div class="mono" id="lowHigh">—</div>
      </div>
      <div class="result-row">
        <div>Year-2</div>
        <div class="mono" id="y2">—</div>
      </div>
      <div class="result-row">
        <div>Year-3</div>
        <div class="mono" id="y3">—</div>
      </div>
      <div class="result-row">
        <div>Capacity cap</div>
        <div class="mono" id="cap">—</div>
      </div>
      <div class="foot small">
        <span class="pill" id="aadtBadge">AADT: —</span>
        <span class="pill" id="latlngBadge" style="margin-left:6px">loc: —</span>
      </div>
    </div>

    <div class="card">
      <details>
        <summary>▼ Advanced inputs</summary>
        <div class="grid grid-2" style="margin-top:10px">
          <div>
            <label for="aadt">AADT (VPD)</label>
            <input id="aadt" type="number" step="1" value="0" />
          </div>
          <div>
            <label for="truckShare">Truck share (%)</label>
            <input id="truckShare" type="number" step="0.1" value="5.5" />
          </div>
        </div>
        <p class="small muted" style="margin-top:8px">
          You can manually override AADT here (auto-fetch can be toggled above).
        </p>
      </details>
    </div>

    <div class="card">
      <div class="small muted">
        Formula: <strong>Gallons = AADT × 8% × 2 × 30</strong> (then capped by MPD capacity).<br/>
        Capacity cap uses 45 gph per MPD × 24 h × 30 d.
      </div>
    </div>
  </div>

  <script>
    // ---- Helpers
    const $ = sel => document.querySelector(sel);
    const fmt = n => Number.isFinite(n) ? n.toLocaleString() : "—";

    async function fetchAADTForAddress(address) {
      // Calls your backend /aadt endpoint (from server.js you deployed)
      const res = await fetch(`/aadt?address=${encodeURIComponent(address)}`);
      const j = await res.json().catch(() => ({}));
      if (!res.ok || !j.ok) throw new Error(j.error || "AADT fetch failed");
      return j; // { ok:true, aadt, address, location:{lat,lng}, ... }
    }

    function computeCapacityCap(mpds) {
      // 45 gallons/hour × 24 × 30 ≈ 32,400 gal/mo per MPD
      const perMPD = 45 * 24 * 30;
      return mpds * perMPD;
    }

    function computeEstimate(aadt, mpds) {
      // Base rule from user: AADT × 0.08 × 2 × 30
      const y1Raw = aadt * 0.08 * 2 * 30; // monthly gallons
      const cap = computeCapacityCap(mpds);
      const y1 = Math.min(y1Raw, cap);

      // Ranges & forward years (simple deltas for now)
      const low = y1 * 0.86;   // -14%
      const high = y1 * 1.06;  // +6%

      const y2 = y1 * 1.027;   // +2.7%
      const y3 = y2 * 1.0125;  // +1.25%

      return { y1, low, high, y2, y3, cap };
    }

    async function runEstimate() {
      const status = $("#status");
      status.className = "status muted";
      status.textContent = "Working…";

      const address = $("#address").value.trim();
      const mpds = Number($("#mpds").value) || 0;
      const auto = $("#autoFetch").checked;

      let aadt = Number($("#aadt").value) || 0;
      let locBadge = "loc: —";

      try {
        if (auto) {
          const data = await fetchAADTForAddress(address);
          aadt = Number(data.aadt) || 0;
          $("#aadt").value = aadt; // reflect in advanced input
          $("#aadtBadge").textContent = `AADT: ${fmt(aadt)}`;
          if (data.location) {
            const {lat, lng} = data.location;
            locBadge = `loc: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
          }
          status.className = "status ok";
          status.textContent = "Done.";
        } else {
          $("#aadtBadge").textContent = `AADT: ${fmt(aadt)} (manual)`;
          status.className = "status ok";
          status.textContent = "Done (manual AADT).";
        }
      } catch (err) {
        status.className = "status err";
        status.textContent = `Error: ${err.message}`;
        // keep going with whatever AADT is in the box (if any)
      }

      $("#latlngBadge").textContent = locBadge;

      const { y1, low, high, y2, y3, cap } = computeEstimate(aadt, mpds);

      $("#y1").textContent = fmt(Math.round(y1));
      $("#lowHigh").textContent = `${fmt(Math.round(low))} – ${fmt(Math.round(high))}`;
      $("#y2").textContent = fmt(Math.round(y2));
      $("#y3").textContent = fmt(Math.round(y3));
      $("#cap").textContent = fmt(Math.round(cap));

      $("#resultsCard").style.display = "block";
    }

    // Wire up events
    $("#go").addEventListener("click", runEstimate);
    // Enter key convenience
    $("#address").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ runEstimate(); }});
  </script>
</body>
</html>
