<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Monthly Fuel Volume Estimator</title>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  :root {
    --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#60a5fa; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --border:#1f2937;
  }
  html,body {height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
  .app {display:grid; grid-template-columns: 420px 1fr; grid-auto-rows: minmax(0,1fr); height:100%;}
  .panel {padding:18px 18px 120px; overflow:auto; border-right:1px solid var(--border); background:linear-gradient(180deg,#0f172a 0%, #0b1224 100%);}
  h1 {font-size:20px; margin:0 0 12px; font-weight:700;}
  h2 {font-size:15px; margin:18px 0 8px; color:var(--muted); font-weight:600; letter-spacing:.2px;}
  label {display:block; font-size:13px; color:#cbd5e1; margin:10px 0 6px;}
  input, select, button, textarea {
    width:100%; box-sizing:border-box; border:1px solid var(--border); background:#0b1224; color:var(--text);
    padding:10px 12px; border-radius:10px; font-size:14px; outline:none;
  }
  input::placeholder {color:#64748b;}
  .grid {display:grid; grid-template-columns:1fr 1fr; gap:10px;}
  .btn {background:var(--accent); color:#0b1224; font-weight:700; cursor:pointer; border:none;}
  .btn:disabled {opacity:.5; cursor:not-allowed;}
  .muted {color:var(--muted);}
  .pill {display:inline-flex; align-items:center; gap:6px; background:#0b1224; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; color:#cbd5e1;}
  .row {display:flex; gap:10px; align-items:center;}
  .map {height:100%; width:100%;}
  .kpi {display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin:14px 0;}
  .kcard {background:#0b1224; border:1px solid var(--border); border-radius:12px; padding:12px;}
  .kval {font-size:20px; font-weight:800;}
  .kcap {font-size:12px; color:var(--muted); margin-top:4px;}
  .card {background:#0b1224; border:1px solid var(--border); border-radius:14px; padding:14px; margin:12px 0;}
  .small {font-size:12px; line-height:1.4;}
  .list {margin:8px 0; padding:0; list-style:none;}
  .list li {padding:8px 0; border-bottom:1px dashed var(--border); display:flex; justify-content:space-between; gap:8px; align-items:center;}
  .list li:last-child {border-bottom:none;}
  .badge {font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--border); color:#cbd5e1; background:#0f172a;}
  .ok {color:var(--good);} .warn {color:var(--warn);} .bad {color:var(--bad);}
  .foot {position:fixed; bottom:0; left:0; width:420px; background:rgba(15,23,42,.8); backdrop-filter: blur(8px);
         border-top:1px solid var(--border); padding:10px 14px;}
  .mono {font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:12px;}
  a {color:#93c5fd; text-decoration:none;}
  .hint {font-size:12px; color:#9ca3af;}
  .tiny {font-size:11px;}
</style>
</head>
<body>
<div class="app">
  <div class="panel">
    <h1>Monthly Fuel Volume Estimator</h1>
    <div class="small muted">Click the map to set a site pin (or paste lat,lng). Then enter MPDs and hit Estimate.</div>

    <h2>Site</h2>
    <label>Search address (optional, uses OSM; low‑volume only)</label>
    <div class="row">
      <input id="search" placeholder="123 Main St, Knightdale, NC" />
      <button class="btn" id="geocode">Find</button>
    </div>

    <div class="grid">
      <div>
        <label>Latitude</label>
        <input id="lat" placeholder="35.787..." />
      </div>
      <div>
        <label>Longitude</label>
        <input id="lng" placeholder="-78.632..." />
      </div>
    </div>

    <div class="grid">
      <div>
        <label>MPDs (multi‑product dispensers)</label>
        <input id="mpds" type="number" min="1" step="1" value="6" />
      </div>
      <div>
        <label>Competition radius (miles)</label>
        <input id="radius" type="number" min="0.5" step="0.1" value="3.0" />
      </div>
    </div>

    <h2>Traffic → Demand assumptions</h2>
    <div class="grid">
      <div>
        <label>Capture rate of AADT (default 2%)</label>
        <input id="capture" type="number" min="0" max="1" step="0.001" value="0.02" />
      </div>
      <div>
        <label>Gallons per stop (default 8)</label>
        <input id="gallonsPerStop" type="number" min="1" step="0.1" value="8" />
      </div>
    </div>
    <div class="grid">
      <div>
        <label>Days per month</label>
        <input id="dpm" type="number" min="28" step="0.1" value="30.4" />
      </div>
      <div>
        <label>Distance‑decay (β for share)</label>
        <input id="beta" type="number" min="0.1" step="0.1" value="1.2" />
      </div>
    </div>

    <h2>AADT source</h2>
    <div class="card small">
      <div class="row" style="justify-content:space-between">
        <div>
          <div><b>NCDOT Stations FeatureService</b></div>
          <div class="tiny muted">Auto‑used if site is in NC; can be used anywhere via point‑within‑distance.</div>
          <div class="mono tiny" id="aadtUrlShow"></div>
        </div>
        <span class="badge">live</span>
      </div>
      <label style="margin-top:8px;">Override FeatureService URL (optional)</label>
      <input id="aadtUrl" placeholder="ArcGIS FeatureServer .../FeatureServer/0" />
      <div class="hint">Tip: other states often publish AADT layers via ArcGIS. Paste a <code>.../FeatureServer/0</code> URL here to use it.</div>
    </div>

    <h2>Reviews (optional)</h2>
    <label>Google Maps JavaScript API key (loads Places to enrich competitors)</label>
    <input id="gkey" placeholder="AIza..." />
    <div class="hint">Only needed if you want rating + review count. Load once; stored in memory for this session.</div>

    <h2>Run</h2>
    <button class="btn" id="estimate">Estimate monthly gallons</button>
    <div class="foot tiny">
      Data sources: NACS&nbsp;SOI, NCDOT AADT, OpenStreetMap/Overpass, OSRM, Google Places (optional).
    </div>
  </div>

  <div id="map" class="map"></div>
</div>

<!-- Libraries -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/** ------------------ Utilities ------------------ **/
const fmt = {
  int: n => Number.isFinite(n) ? Math.round(n).toLocaleString() : "–",
  one: n => Number.isFinite(n) ? n.toFixed(1) : "–",
  two: n => Number.isFinite(n) ? n.toFixed(2) : "–",
};
const toMiles = m => m / 1609.344;
const toMeters = mi => mi * 1609.344;
const rad = d => d * Math.PI/180;
function haversineMiles(a, b) {
  const R = 3958.7613;
  const dLat = rad(b.lat - a.lat);
  const dLng = rad(b.lng - a.lng);
  const s = Math.sin(dLat/2)**2 + Math.cos(rad(a.lat))*Math.cos(rad(b.lat))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}
function insideNC(lat, lng){
  // quick bbox for NC (approx)
  return lat>33.6 && lat<36.6 && lng>-84.5 && lng<-75.0;
}

/** ------------------ Map & Pin ------------------ **/
const map = L.map('map', { zoomControl: true }).setView([35.7796, -78.6382], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'&copy; OpenStreetMap'
}).addTo(map);

let pin = L.marker([35.7796, -78.6382],{draggable:true}).addTo(map).bindTooltip('Drag me', {permanent:false});
pin.on('move', e => { document.getElementById('lat').value = e.latlng.lat.toFixed(6); document.getElementById('lng').value = e.latlng.lng.toFixed(6); });
map.on('click', e => { pin.setLatLng(e.latlng); map.panTo(e.latlng); document.getElementById('lat').value = e.latlng.lat.toFixed(6); document.getElementById('lng').value = e.latlng.lng.toFixed(6); });

/** Geocode (Nominatim, gentle use only) */
document.getElementById('geocode').onclick = async () => {
  const q = document.getElementById('search').value.trim();
  if(!q) return;
  const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
  try{
    const r = await fetch(url, {headers:{'Accept':'application/json'}});
    const j = await r.json();
    if(j?.length){
      const lat=+j[0].lat, lng=+j[0].lon;
      pin.setLatLng([lat,lng]); map.setView([lat,lng], 14);
      document.getElementById('lat').value = lat.toFixed(6);
      document.getElementById('lng').value = lng.toFixed(6);
    } else alert('No result.');
  }catch(e){ alert('Geocoder failed.'); }
};

/** ------------------ AADT fetch (ArcGIS FeatureServer points) ------------------ **/
const DEFAULT_AADT_URL = 'https://services.arcgis.com/NuWFvHYDMVmmxMeM/ArcGIS/rest/services/NCDOT_AADT_Stations/FeatureServer/0';
document.getElementById('aadtUrlShow').textContent = DEFAULT_AADT_URL;
function getAADTUrl(){ return (document.getElementById('aadtUrl').value.trim() || DEFAULT_AADT_URL); }

async function fetchAADT(lat, lng){
  // ArcGIS query: find stations within 1000 m; return geometry in 4326
  const base = getAADTUrl();
  const q = new URL(base + '/query');
  const params = {
    where:'1=1',
    geometry:`${lng},${lat}`,
    geometryType:'esriGeometryPoint',
    inSR:'4326',
    spatialRel:'esriSpatialRelIntersects',
    distance:'1000',
    units:'esriSRUnit_Meter',
    outFields:'*',
    outSR:'4326',
    returnGeometry:'true',
    f:'json',
    resultRecordCount:'200'
  };
  Object.entries(params).forEach(([k,v])=>q.searchParams.set(k,v));
  const r = await fetch(q.toString());
  if(!r.ok) throw new Error('AADT service error');
  const j = await r.json();
  if(!j.features?.length) throw new Error('No AADT stations nearby (try moving the pin closer to a roadway).');
  // pick nearest
  let nearest=null, best=1e9;
  for(const f of j.features){
    const p = {lat:f.geometry.y, lng:f.geometry.x};
    const d = haversineMiles({lat,lng},{lat:p.lat,lng:p.lng});
    if(d<best){ best=d; nearest=f; }
  }
  // resolve numeric AADT field
  const attrs = nearest.attributes || {};
  let usedYear = null, aadt = null;
  if(typeof attrs.AADT === 'number' && attrs.AADT>0){ aadt = attrs.AADT; }
  else {
    const candidates = Object.keys(attrs).filter(k=>/^AADT(_\d{4})?$/.test(k) && Number.isFinite(+attrs[k]) && +attrs[k]>0);
    if(candidates.length){
      // pick the most recent year suffix
      candidates.sort((a,b)=>{
        const ya = (a.match(/_(\d{4})/)||[])[1]||'0';
        const yb = (b.match(/_(\d{4})/)||[])[1]||'0';
        return +yb - +ya;
      });
      const k = candidates[0];
      aadt = +attrs[k];
      const m = k.match(/_(\d{4})/); if(m) usedYear = +m[1];
    }
  }
  if(!Number.isFinite(aadt)) throw new Error('AADT field not found or not numeric for nearest station.');
  return {
    aadt,
    year: usedYear || attrs.YEAR || null,
    meta: {
      locationId: attrs.LocationID || attrs.Location_ID || null,
      route: attrs.ROUTE || attrs.RTE_NUM || null,
      name: attrs.LOCATION || attrs.LOC_DESC || null,
      distanceMi: best
    }
  };
}

/** ------------------ OSM Overpass competitors ------------------ **/
async function fetchCompetitorsOSM(lat, lng, radiusMi){
  const radiusM = Math.max(300, Math.round(toMeters(radiusMi)));
  const overpass = `[out:json][timeout:25];
    (
      node["amenity"="fuel"](around:${radiusM},${lat},${lng});
      way["amenity"="fuel"](around:${radiusM},${lat},${lng});
    );
    out center;`;
  const r = await fetch('https://overpass-api.de/api/interpreter', {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
    body:'data=' + encodeURIComponent(overpass)
  });
  const j = await r.json();
  const list = [];
  for(const el of (j.elements||[])){
    const center = el.type==='node' ? {lat:el.lat, lng:el.lon} : (el.center || null);
    if(!center) continue;
    list.push({
      id: el.id,
      name: (el.tags && (el.tags.name || el.tags.brand)) || 'Fuel station',
      lat: center.lat, lng: center.lon,
      source: 'OSM',
      rating: null, reviews: null,
      mpds: null
    });
  }
  // de-duplicate near-identical coords
  const dedup = [];
  list.forEach(s=>{
    if(!dedup.some(t=>haversineMiles(s,t)<0.05)) dedup.push(s);
  });
  return dedup;
}

/** ------------------ OSRM driving distance (top-N only) ------------------ **/
async function drivingMilesOSRM(site, target){
  try{
    const url = `https://router.project-osrm.org/route/v1/driving/${site.lng},${site.lat};${target.lng},${target.lat}?overview=false`;
    const r = await fetch(url);
    const j = await r.json();
    const m = j?.routes?.[0]?.distance;
    if(Number.isFinite(m)) return toMiles(m);
  }catch(e){}
  // fallback haversine
  return haversineMiles(site,target);
}

/** ------------------ Google Places enrichment (optional) ------------------ **/
let placesLoaded = false, placesService = null;
async function ensurePlacesLoaded(apiKey){
  if(placesLoaded) return true;
  if(!apiKey) return false;
  return new Promise((resolve)=>{
    const s = document.createElement('script');
    s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(apiKey)}&libraries=places`;
    s.async = true; s.defer = true;
    s.onload = ()=>{ placesLoaded = true; resolve(true); };
    s.onerror = ()=> resolve(false);
    document.head.appendChild(s);
  });
}
function placesNearbyFor(lat,lng){
  return new Promise((resolve)=>{
    if(!window.google || !google.maps) return resolve(null);
    if(!placesService){
      // create dummy map div for PlacesService
      const dv=document.createElement('div'); dv.style.display='none'; document.body.appendChild(dv);
      placesService = new google.maps.places.PlacesService(dv);
    }
    const request = {
      location: new google.maps.LatLng(lat,lng),
      radius: 50, // 50m around OSM centroid
      type: ['gas_station']
    };
    placesService.nearbySearch(request, (results, status)=>{
      if(status !== google.maps.places.PlacesServiceStatus.OK || !results?.length) return resolve(null);
      const p = results[0];
      resolve({
        name: p.name || null,
        rating: typeof p.rating==='number' ? p.rating : null,
        reviews: typeof p.user_ratings_total==='number' ? p.user_ratings_total : null
      });
    });
  });
}

/** ------------------ Rendering helpers ------------------ **/
let competitorsLayer = null, siteCircle = null;
function drawCompetitors(site, comps){
  if(competitorsLayer){ competitorsLayer.remove(); competitorsLayer=null; }
  const markers = comps.map(c=>{
    const m = L.circleMarker([c.lat,c.lng],{radius:6, fill:true, fillOpacity:.8, color:'#60a5fa', weight:1});
    const rtxt = (c.rating!=null) ? `⭐ ${c.rating.toFixed(1)} (${c.reviews??0})` : 'rating: n/a';
    m.bindPopup(`<b>${(c.name||'Fuel station')}</b><br><span class="mono">${fmt.one(c.distanceMi)} mi</span><br>${rtxt}`);
    return m;
  });
  competitorsLayer = L.layerGroup(markers).addTo(map);
  if(siteCircle) siteCircle.remove();
  siteCircle = L.circle([site.lat,site.lng], {radius: toMeters(+document.getElementById('radius').value || 3), color:'#f59e0b', weight:1}).addTo(map);
}

/** ------------------ Volume model ------------------ **/
function attractiveness(mpds, rating, reviews){
  const m = Math.max(1, +mpds || 1);
  const r = Number.isFinite(rating) ? rating : 4.0;
  const n = Number.isFinite(reviews) ? reviews : 0;
  // gentle, bounded lifts from reputation signals
  const ratingLift = 1 + 0.05*(r - 4.0);                 // ±5% per star from 4.0 baseline
  const countLift  = 1 + 0.06*Math.log10(1 + Math.max(0,n)); // ~+6% per 10× reviews
  return m * ratingLift * countLift;
}

function huffShare(siteAttr, siteDist, comps, beta){
  const eps = 0.1; // 0.1 mi floor to avoid div by zero
  const denomParts = [(siteAttr / Math.pow(Math.max(eps, siteDist), beta))];
  comps.forEach(c=>{
    const attr = attractiveness(c.mpds || 4, c.rating, c.reviews);
    denomParts.push(attr / Math.pow(Math.max(eps, c.distanceMi), beta));
  });
  const sitePart = denomParts[0];
  const sum = denomParts.reduce((a,b)=>a+b,0);
  return Math.min(1, Math.max(0, sitePart / sum));
}

function baseMonthlyGallons(aadt, captureRate, gallonsPerStop, daysPerMonth){
  return aadt * captureRate * gallonsPerStop * daysPerMonth;
}

/** ------------------ Main estimate workflow ------------------ **/
document.getElementById('estimate').onclick = async () => {
  try{
    const lat = parseFloat(document.getElementById('lat').value);
    const lng = parseFloat(document.getElementById('lng').value);
    const mpds = parseInt(document.getElementById('mpds').value,10);
    const radiusMi = parseFloat(document.getElementById('radius').value);
    const capture = parseFloat(document.getElementById('capture').value);
    const gps = parseFloat(document.getElementById('gallonsPerStop').value);
    const dpm = parseFloat(document.getElementById('dpm').value);
    const beta = parseFloat(document.getElementById('beta').value);
    const gkey = document.getElementById('gkey').value.trim();

    if(!Number.isFinite(lat) || !Number.isFinite(lng)){ alert('Please set a valid latitude and longitude (click the map).'); return; }
    if(!Number.isFinite(mpds) || mpds<=0){ alert('Please enter a valid MPD count.'); return; }

    // 1) AADT
    const usingNC = insideNC(lat,lng);
    const aadtInfo = await fetchAADT(lat,lng); // works anywhere an ArcGIS feature service is provided
    const aadt = +aadtInfo.aadt;
    if(!Number.isFinite(aadt)){ alert('AADT is not a real number.'); return; }

    // 2) Competition
    const site = {lat,lng};
    let comps = await fetchCompetitorsOSM(lat,lng, radiusMi);
    // remove self if OSM has same location
    comps = comps.filter(c=>haversineMiles(site,c) > 0.05);

    // 3) Driving distance (top 10 nearest by crow-fly)
    comps.sort((a,b)=>haversineMiles(site,a)-haversineMiles(site,b));
    const top = comps.slice(0, Math.min(12, comps.length));
    await Promise.all(top.map(async c=>{
      c.distanceMi = await drivingMilesOSRM(site, c);
    }));
    comps = top;

    // 4) Optional: Google rating & reviews
    if(gkey){
      const ok = await ensurePlacesLoaded(gkey);
      if(ok){
        for(const c of comps){
          const p = await placesNearbyFor(c.lat,c.lng);
          if(p){ c.name = p.name || c.name; c.rating = p.rating; c.reviews = p.reviews; }
        }
      }
    }

    drawCompetitors(site, comps);

    // 5) Share & volume
    const siteDist = 0.1; // treat on-site distance as 0.1 mi for Huff denominator stability
    const siteAttr = attractiveness(mpds, /*rating*/ 4.2, /*reviews*/ 0); // you can tune these or ask user
    const share = comps.length ? huffShare(siteAttr, siteDist, comps, beta) : 1.0;
    const base = baseMonthlyGallons(aadt, capture, gps, dpm);
    const est = base * share;

    // 6) Render results panel on the map side
    renderResults({aadtInfo, aadt, base, est, share, comps, mpds, capture, gps, dpm, beta, usingNC, radiusMi});
  }catch(e){
    console.error(e);
    alert(e.message || 'Estimation failed.');
  }
};

function renderResults(ctx){
  const {aadtInfo,aadt,base,est,share,comps,mpds,capture,gps,dpm,beta,usingNC,radiusMi} = ctx;
  const kpi = `
    <div class="kpi">
      <div class="kcard"><div class="kval">${fmt.int(aadt)}</div><div class="kcap">AADT${aadtInfo.year? ' ('+aadtInfo.year+')':''}</div></div>
      <div class="kcard"><div class="kval">${fmt.int(base)}</div><div class="kcap">Base monthly gallons (AADT × ${fmt.two(capture)} × ${fmt.one(gps)} × ${fmt.one(dpm)})</div></div>
      <div class="kcard"><div class="kval">${fmt.int(est)}</div><div class="kcap">Estimated monthly gallons</div></div>
    </div>`;

  const rivals = comps.map(c=>{
    const r = (c.rating!=null) ? `⭐ ${c.rating.toFixed(1)} (${c.reviews??0})` : '—';
    return `<li><span>${c.name || 'Fuel station'}</span><span class="mono">${fmt.one(c.distanceMi)} mi</span><span class="badge">${r}</span></li>`;
  }).join('');

  const bench = `
    <div class="card small">
      <b>Benchmarks</b>
      <div class="tiny muted" style="margin-top:6px">
        • NACS 2023 average: <b>~141,813 gallons/store/month</b> (industry average, varies widely by site).  
        • NACS typical fueling transaction: <b>~9.2 gallons</b>, ~<b>370 fueling transactions/day</b> for c‑stores selling fuel (context for MPD capacity & turnover).
      </div>
    </div>`;

  const why = `
    <div class="card small">
      <b>Why this estimate?</b>
      <ul class="list">
        <li><span>Traffic → Base demand</span><span class="mono">${fmt.int(aadt)} × ${capture} × ${gps} × ${dpm} = ${fmt.int(base)} gal/mo</span></li>
        <li><span>Competition & reviews (Huff share)</span><span class="mono">${(share*100).toFixed(1)}% of local demand</span></li>
        <li><span>MPDs attractiveness</span><span class="mono">${mpds} MPDs → higher capture vs peers</span></li>
        <li><span>Search radius</span><span class="mono">${radiusMi} mi; distance‑decay β=${beta}</span></li>
      </ul>
      <div class="tiny muted">We allocate a share of nearby demand to the site using a gravity (Huff) model that weights MPDs and (if available) Google ratings + review counts and penalizes by driving distance.</div>
    </div>`;

  const compCard = `
    <div class="card small">
      <b>Nearby competitors (${comps.length})</b>
      <ul class="list">${rivals || '<li class="muted">None found in radius.</li>'}</ul>
    </div>`;

  const src = `
    <div class="card small">
      <b>Sources (auto)</b>
      <div class="tiny muted">
        • AADT: <span class="mono">${usingNC ? 'NCDOT FeatureService' : 'ArcGIS FeatureService'}</span> (nearest station; numeric check enforced).<br/>
        • Competitors: OpenStreetMap / Overpass API; driving distance/time via OSRM public router.<br/>
        • Reviews (optional): Google Maps Places (if key supplied) for rating + review count.<br/>
        • Industry context: NACS State of the Industry & Fuels briefs.
      </div>
    </div>`;

  const html = `<div class="panel" style="border-left:1px solid var(--border);">
    <h1>Results</h1>
    ${kpi}
    ${bench}
    ${compCard}
    ${why}
    ${src}
  </div>`;

  let r = document.getElementById('resultsPanel');
  if(!r){
    r = document.createElement('div');
    r.id='resultsPanel';
    r.style.position='absolute'; r.style.top='0'; r.style.right='0'; r.style.bottom='0'; r.style.width='420px'; r.style.overflow='auto';
    r.style.background='linear-gradient(180deg,#0f172a 0%, #0b1224 100%)';
    r.style.borderLeft='1px solid var(--border)';
    document.body.appendChild(r);
  }
  r.innerHTML = html;
}
</script>
</body>
</html>
